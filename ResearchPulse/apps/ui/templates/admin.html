<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - ResearchPulse</title>
    <script>
        // åŠ¨æ€æ£€æµ‹ä»£ç†å‰ç¼€ï¼ˆæå‰æ‰§è¡Œï¼Œä¾›é™æ€ HTML ä½¿ç”¨ï¼‰
        (function() {
            var path = window.location.pathname;
            var rpIndex = path.indexOf('/researchpulse');
            var prefix = rpIndex > 0 ? path.substring(0, rpIndex) : '';
            window.APP_BASE = prefix + '/researchpulse';
            window.API_BASE = prefix + '/researchpulse/api';
            window.AUTH_BASE = prefix + '/api/v1';
            window.ADMIN_BASE = prefix + '/api/v1/admin';
        })();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }

        .layout { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }

        /* Sidebar */
        .sidebar { background: #1a1a2e; color: white; padding: 0; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-header h2 { font-size: 18px; }
        .sidebar-nav { padding: 12px 0; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; transition: all 0.2s; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: rgba(78,205,196,0.2); color: #4ecdc4; border-right: 3px solid #4ecdc4; }

        /* Main Content */
        .main { padding: 24px; overflow-y: auto; }
        .page-header { margin-bottom: 24px; }
        .page-header h1 { font-size: 24px; color: #1a1a2e; margin-bottom: 8px; }
        .page-header p { color: #666; font-size: 14px; }

        /* Cards */
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 24px; }
        .card-header { padding: 20px 24px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { font-size: 16px; color: #1a1a2e; }
        .card-body { padding: 24px; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .stat-value { font-size: 28px; font-weight: 600; color: #1a1a2e; }
        .stat-label { font-size: 13px; color: #888; margin-top: 4px; }

        /* Table */
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .table th { font-size: 12px; font-weight: 600; color: #888; text-transform: uppercase; }
        .table td { font-size: 14px; color: #333; }
        .table tr:hover { background: #f9fafb; }

        /* Buttons */
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; border: none; transition: all 0.2s; }
        .btn-primary { background: #1a1a2e; color: white; }
        .btn-primary:hover { background: #2d2d4a; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-sm { padding: 4px 12px; font-size: 12px; }

        /* Badge */
        .badge { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .badge-success { background: #dcfce7; color: #059669; }
        .badge-danger { background: #fee2e2; color: #dc2626; }
        .badge-info { background: #dbeafe; color: #2563eb; }
        .badge-warning { background: #fef3c7; color: #d97706; }

        /* Form */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: #333; margin-bottom: 6px; }
        .form-input { width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; }
        .form-input:focus { outline: none; border-color: #4ecdc4; }
        .form-select { width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; background: white; }

        /* Tabs */
        .tabs { display: flex; gap: 4px; background: #f5f5f5; padding: 4px; border-radius: 8px; margin-bottom: 20px; }
        .tab { padding: 8px 16px; border: none; background: transparent; border-radius: 6px; font-size: 13px; cursor: pointer; }
        .tab.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* Toggle */
        .toggle-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .toggle-item:last-child { border-bottom: none; }
        .toggle-info h4 { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
        .toggle-info p { font-size: 12px; color: #888; margin: 0; }
        .toggle-switch { position: relative; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 24px; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #4ecdc4; }
        input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* Category list */
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 8px; max-height: 400px; overflow-y: auto; padding-right: 8px; }
        .category-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: #f9fafb; border-radius: 6px; font-size: 13px; }
        .category-item.enabled { background: #ecfdf5; }
        .category-item code { font-family: monospace; color: #666; }
        .category-item input[type="checkbox"] { width: 16px; height: 16px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 12px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; }
        .modal-close { font-size: 24px; cursor: pointer; color: #999; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 8px; }

        .toggle-list { max-height: 500px; overflow-y: auto; }
        .config-panel { animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Mobile Header */
        .mobile-header { display: none; background: #1a1a2e; color: white; padding: 12px 16px; position: sticky; top: 0; z-index: 100; }
        .mobile-header-inner { display: flex; justify-content: space-between; align-items: center; }
        .mobile-header h2 { font-size: 16px; }

        /* Hamburger Menu Button */
        .mobile-menu-btn { display: none; width: 44px; height: 44px; background: transparent; border: none; cursor: pointer; padding: 10px; flex-direction: column; justify-content: center; align-items: center; gap: 5px; }
        .mobile-menu-btn span { display: block; width: 24px; height: 2px; background: white; transition: all 0.3s; border-radius: 2px; }
        .mobile-menu-btn.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .mobile-menu-btn.active span:nth-child(2) { opacity: 0; }
        .mobile-menu-btn.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }

        /* Mobile Overlay */
        .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; }
        .mobile-overlay.show { display: block; }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            .layout { grid-template-columns: 1fr; }

            .mobile-header { display: block; }
            .mobile-menu-btn { display: flex; }

            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                width: 280px;
                height: 100vh;
                z-index: 999;
                transition: left 0.3s ease;
                overflow-y: auto;
            }
            .sidebar.open { left: 0; }

            .main { padding: 16px; }
            .page-header h1 { font-size: 20px; }
            .page-header p { font-size: 13px; }

            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .stat-card { padding: 16px; }
            .stat-value { font-size: 22px; }

            .card-header { padding: 16px; flex-wrap: wrap; gap: 8px; }
            .card-header h3 { font-size: 14px; }
            .card-body { padding: 16px; overflow-x: auto; }

            .table { min-width: 600px; }

            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .tab { padding: 8px 12px; font-size: 12px; white-space: nowrap; }

            .category-grid { grid-template-columns: 1fr; }

            .form-group { margin-bottom: 12px; }
            .form-input, .form-select { padding: 12px; font-size: 16px; }

            .btn { padding: 10px 14px; }
            .btn-sm { padding: 6px 10px; font-size: 11px; }

            .modal-content { width: 100%; max-width: 100%; border-radius: 0; max-height: 100vh; }
            .modal-header { padding: 16px; }
            .modal-body { padding: 16px; }
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="mobile-header-inner">
            <h2>ç®¡ç†åå°</h2>
            <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </div>

    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>

    <div class="layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ç®¡ç†åå°</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" onclick="switchSection('dashboard')">ğŸ“Š ä»ªè¡¨ç›˜</a>
                <a href="#" class="nav-item" onclick="switchSection('sources')">ğŸ“¡ æ•°æ®æºç®¡ç†</a>
                <a href="#" class="nav-item" onclick="switchSection('crawlers')">ğŸ•·ï¸ æŠ“å–é…ç½®</a>
                <a href="#" class="nav-item" onclick="switchSection('users')">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
                <a href="#" class="nav-item" onclick="switchSection('email')">ğŸ“§ é‚®ä»¶æ¨é€</a>
                <a href="#" class="nav-item" onclick="switchSection('ai')">ğŸ¤– AI é…ç½®</a>
                <a href="#" class="nav-item" onclick="switchSection('embedding')">ğŸ§  å‘é‡åµŒå…¥</a>
                <a href="#" class="nav-item" onclick="switchSection('events')">ğŸ“° äº‹ä»¶ç®¡ç†</a>
                <a href="#" class="nav-item" onclick="switchSection('topics')">ğŸ·ï¸ ä¸»é¢˜ç®¡ç†</a>
                <a href="#" class="nav-item" onclick="switchSection('reports')">ğŸ“„ æŠ¥å‘Šç®¡ç†</a>
                <a href="#" class="nav-item" onclick="switchSection('backups')">ğŸ’¾ å¤‡ä»½ç®¡ç†</a>
                <a href="#" class="nav-item" onclick="switchSection('roles')">ğŸ” è§’è‰²ç®¡ç†</a>
                <a href="#" class="nav-item" onclick="switchSection('audit')">ğŸ“‹ å®¡è®¡æ—¥å¿—</a>
                <a href="#" class="nav-item" onclick="switchSection('config')">âš™ï¸ ç³»ç»Ÿé…ç½®</a>
                <a href="#" class="nav-item" onclick="location.href=APP_BASE+'/'; return false;">ğŸ  è¿”å›é¦–é¡µ</a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main">
            <!-- Dashboard Section -->
            <div id="section-dashboard" class="section">
                <div class="page-header">
                    <h1>ä»ªè¡¨ç›˜</h1>
                    <p>ç³»ç»Ÿæ¦‚è§ˆå’Œç»Ÿè®¡æ•°æ®</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-users">0</div>
                        <div class="stat-label">æ³¨å†Œç”¨æˆ·</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-articles">0</div>
                        <div class="stat-label">æ–‡ç« æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-sources">0</div>
                        <div class="stat-label">æ•°æ®æº</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-subscriptions">0</div>
                        <div class="stat-label">ç”¨æˆ·è®¢é˜…</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>æœ€è¿‘æŠ“å–çš„æ–‡ç« </h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ ‡é¢˜</th>
                                    <th>æ¥æº</th>
                                    <th>åˆ†ç±»</th>
                                    <th>æŠ“å–æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="recent-articles"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sources Section -->
            <div id="section-sources" class="section" style="display:none;">
                <div class="page-header">
                    <h1>æ•°æ®æºç®¡ç†</h1>
                    <p>ç®¡ç† ArXiv åˆ†ç±»ã€RSS æºã€å¾®ä¿¡å…¬ä¼—å·å’Œå¾®åšçƒ­æœ</p>
                </div>

                <div class="stats-grid" id="sources-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-arxiv-total">0</div>
                        <div class="stat-label">ArXiv åˆ†ç±»æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-arxiv-active">0</div>
                        <div class="stat-label">ArXiv æ´»è·ƒåˆ†ç±»</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-rss-total">0</div>
                        <div class="stat-label">RSS æºæ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-rss-active">0</div>
                        <div class="stat-label">RSS æ´»è·ƒæº</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-weibo-total">0</div>
                        <div class="stat-label">å¾®åšæ¦œå•æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-weibo-active">0</div>
                        <div class="stat-label">å¾®åšæ´»è·ƒæ¦œå•</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-hackernews-total">0</div>
                        <div class="stat-label">HackerNews æ¿å—æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-hackernews-active">0</div>
                        <div class="stat-label">HackerNews æ´»è·ƒæ¿å—</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-reddit-total">0</div>
                        <div class="stat-label">Reddit è®¢é˜…æºæ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-reddit-active">0</div>
                        <div class="stat-label">Reddit æ´»è·ƒæº</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-twitter-total">0</div>
                        <div class="stat-label">Twitter ç”¨æˆ·æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-twitter-active">0</div>
                        <div class="stat-label">Twitter æ´»è·ƒç”¨æˆ·</div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchSourceTab('arxiv')">ArXiv åˆ†ç±»</button>
                    <button class="tab" onclick="switchSourceTab('rss')">RSS æº</button>
                    <button class="tab" onclick="switchSourceTab('wechat')">å¾®ä¿¡å…¬ä¼—å·</button>
                    <button class="tab" onclick="switchSourceTab('weibo')">å¾®åšçƒ­æœ</button>
                    <button class="tab" onclick="switchSourceTab('pending')">å¾…å®¡æ‰¹ RSS</button>
                    <button class="tab" onclick="switchSourceTab('hackernews')">HackerNews</button>
                    <button class="tab" onclick="switchSourceTab('reddit')">Reddit</button>
                    <button class="tab" onclick="switchSourceTab('twitter')">Twitter</button>
                </div>

                <!-- ArXiv Categories -->
                <div id="source-arxiv" class="source-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3>ArXiv åˆ†ç±»ç®¡ç†</h3>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="batchToggleArxiv(true)">æ‰¹é‡å¯ç”¨</button>
                                <button class="btn btn-sm" onclick="batchToggleArxiv(false)">æ‰¹é‡ç¦ç”¨</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <input type="text" class="form-input" id="arxiv-search" placeholder="æœç´¢åˆ†ç±»ä»£ç æˆ–åç§°..." oninput="loadArxivCategories()">
                            </div>
                            <div id="arxiv-list" style="max-height: 500px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>

                <!-- RSS Feeds -->
                <div id="source-rss" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>RSS æºç®¡ç†</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddRssModal()">æ·»åŠ  RSS æº</button>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                <input type="text" class="form-input" id="rss-search" placeholder="æœç´¢..." style="flex: 1;" oninput="loadRssFeeds()">
                                <select class="form-select" id="rss-category-filter" style="width: 150px;" onchange="loadRssFeeds()">
                                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                                </select>
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="rss-select-all" onchange="toggleSelectAll('rss')"></th>
                                        <th>æ ‡é¢˜</th>
                                        <th>åˆ†ç±»</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æœ€åæŠ“å–</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="rss-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- WeChat Accounts -->
                <div id="source-wechat" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>å¾®ä¿¡å…¬ä¼—å·ç®¡ç†</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddWechatModal()">æ·»åŠ å…¬ä¼—å·</button>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>åç§°</th>
                                        <th>è´¦å· ID</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æœ€åæŠ“å–</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="wechat-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Weibo Hot Search -->
                <div id="source-weibo" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>å¾®åšçƒ­æœæ¦œå•ç®¡ç†</h3>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="batchToggleWeibo(true)">æ‰¹é‡å¯ç”¨</button>
                                <button class="btn btn-sm" onclick="batchToggleWeibo(false)">æ‰¹é‡ç¦ç”¨</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 4px; font-size: 13px;">
                                <strong>è¯´æ˜ï¼š</strong>çƒ­æœæ¦œä¸ºå…¬å¼€æ¥å£ï¼Œæ— éœ€ç™»å½•å³å¯æŠ“å–ã€‚å…¶ä»–æ¦œå•ï¼ˆè¦é—»ã€æ–‡å¨±ã€ä½“è‚²ã€æ¸¸æˆï¼‰éœ€è¦é…ç½®å¾®åšç™»å½• Cookieã€‚
                                <br>è¯·åœ¨ç³»ç»Ÿé…ç½®ä¸­è®¾ç½® <code>WEIBO_COOKIE</code> ç¯å¢ƒå˜é‡ï¼Œæ ¼å¼ä¸º <code>SUB=xxx; SUBP=xxx; ...</code>
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="weibo-select-all" onchange="toggleSelectAll('weibo')"></th>
                                        <th>æ¦œå•åç§°</th>
                                        <th>æ¦œå•ç±»å‹</th>
                                        <th>è®¤è¯è¦æ±‚</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æœ€åæŠ“å–</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="weibo-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- HackerNews -->
                <div id="source-hackernews" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>HackerNews æ¿å—ç®¡ç†</h3>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="batchToggleHackerNews(true)">æ‰¹é‡å¯ç”¨</button>
                                <button class="btn btn-sm" onclick="batchToggleHackerNews(false)">æ‰¹é‡ç¦ç”¨</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 4px; font-size: 13px;">
                                <strong>è¯´æ˜ï¼š</strong>HackerNews æä¾›å…¬å¼€ APIï¼Œæ— éœ€è®¤è¯å³å¯æŠ“å–ã€‚æ”¯æŒçš„æ¿å—åŒ…æ‹¬ Top Storiesã€New Storiesã€Best Storiesã€Ask HNã€Show HNã€Jobs ç­‰ã€‚
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="hackernews-select-all" onchange="toggleSelectAll('hackernews')"></th>
                                        <th>æ¿å—åç§°</th>
                                        <th>æ¿å—ç±»å‹</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æœ€åæŠ“å–</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="hackernews-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reddit -->
                <div id="source-reddit" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>Reddit è®¢é˜…æºç®¡ç†</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddRedditModal()">æ·»åŠ  Reddit æº</button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 4px; font-size: 13px;">
                                <strong>è¯´æ˜ï¼š</strong>Reddit ä½¿ç”¨å…¬å¼€ RSS æ¥å£ï¼Œæ— éœ€ API å¯†é’¥ã€‚æ”¯æŒè®¢é˜… subredditï¼Œæ ¼å¼å¦‚ <code>programming</code> æˆ– <code>r/programming</code>ã€‚
                            </div>
                            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                <input type="text" class="form-input" id="reddit-search" placeholder="æœç´¢ subreddit..." style="flex: 1;" oninput="loadRedditSources()">
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="reddit-select-all" onchange="toggleSelectAll('reddit')"></th>
                                        <th>Subreddit</th>
                                        <th>æè¿°</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æœ€åæŠ“å–</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="reddit-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Twitter -->
                <div id="source-twitter" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>Twitter ç”¨æˆ·è®¢é˜…ç®¡ç†</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddTwitterModal()">æ·»åŠ  Twitter ç”¨æˆ·</button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 4px; font-size: 13px;">
                                <strong>è¯´æ˜ï¼š</strong>Twitter æ•°æ®æŠ“å–éœ€è¦é…ç½® API å‡­è¯ã€‚è¯·åœ¨ç³»ç»Ÿé…ç½®ä¸­è®¾ç½® <code>TWITTER_BEARER_TOKEN</code> æˆ– <code>TWITTER_API_KEY</code> ç­‰ç¯å¢ƒå˜é‡ã€‚
                            </div>
                            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                <input type="text" class="form-input" id="twitter-search" placeholder="æœç´¢ç”¨æˆ·å..." style="flex: 1;" oninput="loadTwitterSources()">
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="twitter-select-all" onchange="toggleSelectAll('twitter')"></th>
                                        <th>ç”¨æˆ·å</th>
                                        <th>æ˜¾ç¤ºåç§°</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æœ€åæŠ“å–</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="twitter-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pending RSS -->
                <div id="source-pending" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>å¾…å®¡æ‰¹ RSS æº</h3>
                            <span style="color: #888; font-size: 13px;">ç”¨æˆ·æäº¤çš„ RSS æºï¼Œå®¡æ ¸é€šè¿‡åå°†åŠ å…¥æŠ“å–åˆ—è¡¨</span>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>æ ‡é¢˜</th>
                                        <th>Feed URL</th>
                                        <th>æäº¤æ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="pending-rss-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crawlers Section -->
            <div id="section-crawlers" class="section" style="display:none;">
                <div class="page-header">
                    <h1>æŠ“å–é…ç½®</h1>
                    <p>é…ç½®æ•°æ®æºå’ŒæŠ“å–è§„åˆ™</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchCrawlerTab('arxiv')">ArXiv ç±»ç›®</button>
                    <button class="tab" onclick="switchCrawlerTab('rss')">RSS æº</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 id="crawler-title">ArXiv ç±»ç›®é…ç½®</h3>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="saveCrawlConfig()">ä¿å­˜é…ç½®</button>
                            <button class="btn btn-success btn-sm" onclick="triggerCrawl()">ç«‹å³æŠ“å–</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="auto-subscribe" checked>
                                ç”¨æˆ·è®¢é˜…åè‡ªåŠ¨å¯ç”¨ç±»ç›®æŠ“å–
                            </label>
                        </div>
                        <p style="font-size: 12px; color: #888; margin-bottom: 16px;">
                            å‹¾é€‰çš„ç±»ç›®ä¼šå®šæœŸæŠ“å–ã€‚é»˜è®¤æŠ“å–: cs.LG, cs.CV, cs.IR, cs.CL, cs.DC
                        </p>
                        <div id="crawler-list"></div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="section-users" class="section" style="display:none;">
                <div class="page-header">
                    <h1>ç”¨æˆ·ç®¡ç†</h1>
                    <p>ç®¡ç†ç³»ç»Ÿç”¨æˆ·å’Œæƒé™</p>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ç”¨æˆ·å</th>
                                    <th>é‚®ç®±</th>
                                    <th>è§’è‰²</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ³¨å†Œæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="user-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Email Section -->
            <div id="section-email" class="section" style="display:none;">
                <div class="page-header">
                    <h1>é‚®ä»¶æ¨é€</h1>
                    <p>é…ç½®é‚®ä»¶æ¨é€åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§é‚®ä»¶åç«¯å’Œå¤šé…ç½®ä¼˜å…ˆçº§failover</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchEmailTab('general')">æ¨é€è®¾ç½®</button>
                    <button class="tab" onclick="switchEmailTab('configs')">é…ç½®åˆ—è¡¨</button>
                </div>

                <!-- General Settings -->
                <div id="email-general-panel" class="email-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3>å…¨å±€æ¨é€è®¾ç½®</h3>
                        </div>
                        <div class="card-body">
                            <div class="toggle-item">
                                <div class="toggle-info">
                                    <h4>å¯ç”¨é‚®ä»¶æ¨é€</h4>
                                    <p>å®šæœŸå‘ç”¨æˆ·æ¨é€è®¢é˜…çš„æ–°æ–‡ç« </p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="email-enabled">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="form-group" style="margin-top: 16px;">
                                <label class="form-label">æ¨é€é¢‘ç‡</label>
                                <select class="form-select" id="email-frequency">
                                    <option value="daily">æ¯å¤©</option>
                                    <option value="weekly">æ¯å‘¨</option>
                                    <option value="instant">å®æ—¶</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">æ¨é€æ—¶é—´</label>
                                <input type="time" class="form-input" id="email-time" value="09:00">
                            </div>

                            <div class="form-group">
                                <label class="form-label">æ¯å°é‚®ä»¶æœ€å¤§æ–‡ç« æ•°</label>
                                <input type="number" class="form-input" id="email-max-articles" value="20">
                            </div>

                            <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                                <p style="font-size: 13px; color: #0369a1; margin: 0;">
                                    ğŸ’¡ <strong>ä¼˜å…ˆçº§æœºåˆ¶ï¼š</strong>ç³»ç»ŸæŒ‰ä¼˜å…ˆçº§é¡ºåºå°è¯•å‘é€é‚®ä»¶ï¼Œä¼˜å…ˆä½¿ç”¨æ•°å­—å°çš„é…ç½®ã€‚å¦‚æœå‘é€å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé…ç½®ï¼Œç›´åˆ°æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥ã€‚
                                </p>
                            </div>

                            <button class="btn btn-primary" onclick="saveEmailSettings()">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>

                <!-- Configurations List -->
                <div id="email-configs-panel" class="email-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>é‚®ä»¶å‘é€é…ç½®</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddEmailConfigModal()">æ–°å»ºé…ç½®</button>
                        </div>
                        <div class="card-body">
                            <!-- Filter -->
                            <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center;">
                                <select class="form-select" id="email-config-filter" style="width: auto;" onchange="loadEmailConfigs()">
                                    <option value="">å…¨éƒ¨ç±»å‹</option>
                                    <option value="smtp">SMTP</option>
                                    <option value="sendgrid">SendGrid</option>
                                    <option value="mailgun">Mailgun</option>
                                    <option value="brevo">Brevo</option>
                                </select>
                            </div>

                            <!-- Config List Table -->
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ä¼˜å…ˆçº§</th>
                                        <th>åç§°</th>
                                        <th>ç±»å‹</th>
                                        <th>å‘ä»¶é‚®ç®±</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="email-config-list">
                                    <tr><td colspan="6">åŠ è½½ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Configuration Section -->
            <div id="section-ai" class="section" style="display:none;">
                <div class="page-header">
                    <h1>AI é…ç½®</h1>
                    <p>é…ç½® AI å¤„ç†å™¨ï¼Œæ”¯æŒ Ollamaã€OpenAIã€Claude</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchAITab('general')">é€šç”¨è®¾ç½®</button>
                    <button class="tab" onclick="switchAITab('ollama')">Ollama</button>
                    <button class="tab" onclick="switchAITab('openai')">OpenAI</button>
                    <button class="tab" onclick="switchAITab('claude')">Claude</button>
                </div>

                <!-- General Settings -->
                <div id="ai-general-panel" class="ai-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3>é€šç”¨è®¾ç½®</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">AI Provider</label>
                                <select class="form-select" id="ai-provider">
                                    <option value="ollama">Ollama (æœ¬åœ°)</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="claude">Claude</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="ai-cache-enabled" checked>
                                    å¯ç”¨ç¼“å­˜
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç¼“å­˜ TTLï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-input" id="ai-cache-ttl" value="86400">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æœ€å¤§å†…å®¹é•¿åº¦</label>
                                <input type="number" class="form-input" id="ai-max-content" value="1500">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æœ€å¤§æ ‡é¢˜é•¿åº¦</label>
                                <input type="number" class="form-input" id="ai-max-title" value="200">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="ai-thinking-enabled">
                                    å¯ç”¨æ€è€ƒæ¨¡å¼
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="ai-concurrent-enabled">
                                    å¯ç”¨å¹¶å‘å¤„ç†
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="saveAIGeneral()">ä¿å­˜è®¾ç½®</button>
                            <button class="btn" onclick="testAIConnection()">æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>
                </div>

                <!-- Ollama Settings -->
                <div id="ai-ollama-panel" class="ai-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>Ollama é…ç½®</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Base URL</label>
                                <input type="text" class="form-input" id="ai-ollama-url" value="http://localhost:11434">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ä¸»æ¨¡å‹</label>
                                <input type="text" class="form-input" id="ai-ollama-model" value="qwen3:32b">
                            </div>
                            <div class="form-group">
                                <label class="form-label">è½»é‡æ¨¡å‹ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" class="form-input" id="ai-ollama-model-light" placeholder="ç”¨äºç®€å•ä»»åŠ¡">
                            </div>
                            <div class="form-group">
                                <label class="form-label">è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-input" id="ai-ollama-timeout" value="120">
                            </div>
                            <button class="btn btn-primary" onclick="saveAIOllama()">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>
                </div>

                <!-- OpenAI Settings -->
                <div id="ai-openai-panel" class="ai-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>OpenAI é…ç½®</h3>
                        </div>
                        <div class="card-body">
                            <p style="color: #888; margin-bottom: 16px;">
                                OpenAI API Key éœ€è¦åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼ˆOPENAI_API_KEYï¼‰
                            </p>
                            <div class="form-group">
                                <label class="form-label">ä¸»æ¨¡å‹</label>
                                <input type="text" class="form-input" id="ai-openai-model" value="gpt-4o">
                            </div>
                            <div class="form-group">
                                <label class="form-label">è½»é‡æ¨¡å‹</label>
                                <input type="text" class="form-input" id="ai-openai-model-light" value="gpt-4o-mini">
                            </div>
                            <div class="form-group">
                                <label class="form-label">è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-input" id="ai-openai-timeout" value="60">
                            </div>
                            <button class="btn btn-primary" onclick="saveAIOpenAI()">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>
                </div>

                <!-- Claude Settings -->
                <div id="ai-claude-panel" class="ai-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>Claude é…ç½®</h3>
                        </div>
                        <div class="card-body">
                            <p style="color: #888; margin-bottom: 16px;">
                                Claude API Key éœ€è¦åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼ˆANTHROPIC_API_KEYï¼‰
                            </p>
                            <div class="form-group">
                                <label class="form-label">ä¸»æ¨¡å‹</label>
                                <input type="text" class="form-input" id="ai-claude-model" value="claude-sonnet-4-20250514">
                            </div>
                            <div class="form-group">
                                <label class="form-label">è½»é‡æ¨¡å‹</label>
                                <input type="text" class="form-input" id="ai-claude-model-light" value="claude-haiku-4-20250514">
                            </div>
                            <div class="form-group">
                                <label class="form-label">è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-input" id="ai-claude-timeout" value="60">
                            </div>
                            <button class="btn btn-primary" onclick="saveAIClaude()">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Embedding Section -->
            <div id="section-embedding" class="section" style="display:none;">
                <div class="page-header">
                    <h1>å‘é‡åµŒå…¥</h1>
                    <p>ç®¡ç†å‘é‡åµŒå…¥é…ç½®å’Œç»Ÿè®¡</p>
                </div>

                <div class="stats-grid" id="embedding-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-embedding-total">-</div>
                        <div class="stat-label">æ€»æ–‡ç« æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-embedding-computed">-</div>
                        <div class="stat-label">å·²åµŒå…¥æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-embedding-missing">-</div>
                        <div class="stat-label">æœªåµŒå…¥æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-embedding-provider">-</div>
                        <div class="stat-label">Provider</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>åµŒå…¥é…ç½®</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Provider</label>
                            <select class="form-select" id="embedding-provider">
                                <option value="sentence-transformers">sentence-transformers</option>
                                <option value="openai">OpenAI</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ¨¡å‹</label>
                            <input type="text" class="form-input" id="embedding-model" value="all-MiniLM-L6-v2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç›¸ä¼¼åº¦é˜ˆå€¼</label>
                            <input type="number" class="form-input" id="embedding-threshold" value="0.85" step="0.01">
                        </div>
                        <button class="btn btn-primary" onclick="saveEmbeddingConfig()">ä¿å­˜é…ç½®</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Milvus é…ç½®</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 12px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Host</label>
                                <input type="text" class="form-input" id="milvus-host" value="localhost">
                            </div>
                            <div class="form-group" style="width: 120px;">
                                <label class="form-label">Port</label>
                                <input type="number" class="form-input" id="milvus-port" value="19530">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Collection</label>
                            <input type="text" class="form-input" id="milvus-collection" value="article_embeddings">
                        </div>
                        <button class="btn btn-primary" onclick="saveMilvusConfig()">ä¿å­˜é…ç½®</button>
                        <button class="btn" onclick="testMilvusConnection()">æµ‹è¯•è¿æ¥</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>æ‰¹é‡æ“ä½œ</h3>
                    </div>
                    <div class="card-body">
                        <p style="margin-bottom: 16px; color: #666;">
                            é‡æ–°è®¡ç®—åµŒå…¥å‘é‡å¯èƒ½ä¼šæ¶ˆè€—è¾ƒå¤šæ—¶é—´å’Œèµ„æºã€‚
                        </p>
                        <button class="btn" onclick="recomputeMissingEmbeddings()">è®¡ç®—ç¼ºå¤±åµŒå…¥</button>
                        <button class="btn btn-danger" style="margin-left: 8px;" onclick="recomputeAllEmbeddings()">å…¨éƒ¨é‡æ–°è®¡ç®—</button>
                    </div>
                </div>
            </div>

            <!-- Events Section -->
            <div id="section-events" class="section" style="display:none;">
                <div class="page-header">
                    <h1>äº‹ä»¶ç®¡ç†</h1>
                    <p>ç®¡ç†äº‹ä»¶èšç±»ï¼ŒæŸ¥çœ‹ã€ç¼–è¾‘ã€åˆå¹¶ç›¸å…³æ–‡ç« </p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchEventTab('list')">äº‹ä»¶åˆ—è¡¨</button>
                    <button class="tab" onclick="switchEventTab('config')">èšç±»é…ç½®</button>
                </div>

                <div id="event-list-panel" class="event-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3>äº‹ä»¶åˆ—è¡¨</h3>
                            <span id="event-total" style="color: #888; font-size: 13px;">å…± 0 ä¸ªäº‹ä»¶</span>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                <input type="text" class="form-input" id="event-search" placeholder="æœç´¢äº‹ä»¶..." style="flex: 1;" oninput="loadEvents()">
                                <select class="form-select" id="event-active-filter" style="width: 120px;" onchange="loadEvents()">
                                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="true">æ´»è·ƒ</option>
                                    <option value="false">ä¸æ´»è·ƒ</option>
                                </select>
                                <button class="btn btn-primary" onclick="mergeSelectedEvents()">åˆå¹¶é€‰ä¸­</button>
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="event-select-all" onchange="toggleEventSelectAll()"></th>
                                        <th>æ ‡é¢˜</th>
                                        <th>åˆ†ç±»</th>
                                        <th>æ–‡ç« æ•°</th>
                                        <th>æœ€åæ›´æ–°</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="event-list">
                                    <tr><td colspan="7">åŠ è½½ä¸­...</td></tr>
                                </tbody>
                            </table>
                            <div id="event-pagination" style="margin-top: 16px; display: flex; justify-content: center; gap: 8px;"></div>
                        </div>
                    </div>
                </div>

                <div id="event-config-panel" class="event-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>èšç±»é…ç½®</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">è§„åˆ™æƒé‡</label>
                                <input type="number" class="form-input" id="event-rule-weight" value="0.4" step="0.1" min="0" max="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">è¯­ä¹‰æƒé‡</label>
                                <input type="number" class="form-input" id="event-semantic-weight" value="0.6" step="0.1" min="0" max="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æœ€å°ç›¸ä¼¼åº¦</label>
                                <input type="number" class="form-input" id="event-min-similarity" value="0.7" step="0.05" min="0" max="1">
                            </div>
                            <button class="btn btn-primary" onclick="saveEventConfig()">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Topics Section -->
            <div id="section-topics" class="section" style="display:none;">
                <div class="page-header">
                    <h1>ä¸»é¢˜ç®¡ç†</h1>
                    <p>ç®¡ç†ç ”ç©¶ä¸»é¢˜ï¼Œæ”¯æŒæ‰‹åŠ¨åˆ›å»ºå’Œè‡ªåŠ¨å‘ç°</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ä¸»é¢˜åˆ—è¡¨</h3>
                        <button class="btn btn-primary btn-sm" onclick="showAddTopicModal()">åˆ›å»ºä¸»é¢˜</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ä¸»é¢˜åç§°</th>
                                    <th>ç±»å‹</th>
                                    <th>å…³é”®è¯</th>
                                    <th>æ–‡ç« æ•°</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="topic-list">
                                <tr><td colspan="6">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="section-reports" class="section" style="display:none;">
                <div class="page-header">
                    <h1>æŠ¥å‘Šç®¡ç†</h1>
                    <p>ç”Ÿæˆå’Œç®¡ç†ç ”ç©¶æŠ¥å‘Š</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ç”ŸæˆæŠ¥å‘Š</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">æŠ¥å‘Šç±»å‹</label>
                                <select class="form-select" id="report-type">
                                    <option value="weekly">å‘¨æŠ¥</option>
                                    <option value="monthly">æœˆæŠ¥</option>
                                </select>
                            </div>
                            <div class="form-group" style="display: flex; align-items: flex-end;">
                                <button class="btn btn-primary" onclick="generateReport()">ç”ŸæˆæŠ¥å‘Š</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>æŠ¥å‘Šåˆ—è¡¨</h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æŠ¥å‘Šåç§°</th>
                                    <th>ç±»å‹</th>
                                    <th>æ—¶é—´èŒƒå›´</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="report-list">
                                <tr><td colspan="5">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Config Section -->
            <div id="section-config" class="section" style="display:none;">
                <div class="page-header">
                    <h1>ç³»ç»Ÿé…ç½®</h1>
                    <p>ç®¡ç†ç³»ç»Ÿå‚æ•°å’ŒåŠŸèƒ½è®¾ç½®</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchConfigTab('retention')">æ•°æ®ä¿ç•™</button>
                    <button class="tab" onclick="switchConfigTab('scheduler')">è°ƒåº¦è®¾ç½®</button>
                    <button class="tab" onclick="switchConfigTab('features')">åŠŸèƒ½å¼€å…³</button>
                    <button class="tab" onclick="switchConfigTab('advanced')">é«˜çº§è®¾ç½®</button>
                </div>

                <!-- Retention Config -->
                <div id="config-retention-panel" class="config-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3>æ•°æ®ä¿ç•™è®¾ç½®</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">æ–‡ç« ä¿ç•™å¤©æ•°</label>
                                <input type="number" class="form-input" id="config-retention-active-days" value="7">
                                <p style="font-size: 12px; color: #888; margin-top: 4px;">è¶…è¿‡æ­¤å¤©æ•°çš„æ–‡ç« å°†è¢«æ¸…ç†</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">å¤‡ä»½ä¿ç•™å¤©æ•°</label>
                                <input type="number" class="form-input" id="config-retention-archive-days" value="30">
                                <p style="font-size: 12px; color: #888; margin-top: 4px;">å¤‡ä»½æ•°æ®ä¿ç•™æ—¶é—´</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="config-backup-enabled" checked>
                                    å¯ç”¨è‡ªåŠ¨å¤‡ä»½
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="saveConfigGroup('retention')">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>
                </div>

                <!-- Scheduler Config -->
                <div id="config-scheduler-panel" class="config-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>è°ƒåº¦å™¨è®¾ç½®</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">çˆ¬å–é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
                                <input type="number" class="form-input" id="config-crawl-interval" value="6">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ•°æ®æ¸…ç†æ—¶é—´ï¼ˆå°æ—¶ï¼Œ0-23ï¼‰</label>
                                <input type="number" class="form-input" id="config-cleanup-hour" value="3">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å¤‡ä»½æ—¶é—´ï¼ˆå°æ—¶ï¼Œ0-23ï¼‰</label>
                                <input type="number" class="form-input" id="config-backup-hour" value="4">
                            </div>
                            <div class="form-group">
                                <label class="form-label">AI å¤„ç†é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
                                <input type="number" class="form-input" id="config-ai-interval" value="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å‘é‡åµŒå…¥é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
                                <input type="number" class="form-input" id="config-embedding-interval" value="2">
                            </div>
                            <button class="btn btn-primary" onclick="saveConfigGroup('scheduler')">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>
                </div>

                <!-- Features Config -->
                <div id="config-features-panel" class="config-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>åŠŸèƒ½å¼€å…³</h3>
                            <span style="color: #888; font-size: 13px;">å¯ç”¨æˆ–ç¦ç”¨ç³»ç»ŸåŠŸèƒ½æ¨¡å—</span>
                        </div>
                        <div class="card-body" id="features-list">
                            <p>åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>

                <!-- Advanced Config -->
                <div id="config-advanced-panel" class="config-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>é«˜çº§è®¾ç½®</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="config-cache-enabled">
                                    å¯ç”¨ç¼“å­˜
                                </label>
                                <p style="font-size: 12px; color: #888; margin-top: 4px;">å¯ç”¨åå¯æé«˜å“åº”é€Ÿåº¦</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç¼“å­˜ TTLï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-input" id="config-cache-ttl" value="300">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Access Token è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                                <input type="number" class="form-input" id="config-jwt-access-expire" value="30">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Refresh Token è¿‡æœŸæ—¶é—´ï¼ˆå¤©ï¼‰</label>
                                <input type="number" class="form-input" id="config-jwt-refresh-expire" value="7">
                            </div>
                            <button class="btn btn-primary" onclick="saveConfigGroup('advanced')">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backups Section -->
            <div id="section-backups" class="section" style="display:none;">
                <div class="page-header">
                    <h1>å¤‡ä»½ç®¡ç†</h1>
                    <p>ç®¡ç†æ•°æ®å¤‡ä»½ï¼Œæ”¯æŒåˆ›å»ºã€ä¸‹è½½å’Œæ¢å¤</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>æ‰‹åŠ¨å¤‡ä»½</h3>
                    </div>
                    <div class="card-body">
                        <p style="margin-bottom: 16px; color: #666;">
                            ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å°†ç«‹å³æ‰§è¡Œä¸€æ¬¡æ•°æ®å¤‡ä»½ã€‚å¤‡ä»½å°†å¯¼å‡ºè¶…è¿‡ä¿ç•™æœŸé™çš„æ–‡ç« ä¸º JSON æ–‡ä»¶ã€‚
                        </p>
                        <button class="btn btn-primary" onclick="createManualBackup()">åˆ›å»ºå¤‡ä»½</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>å¤‡ä»½åˆ—è¡¨</h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>å¤‡ä»½æ—¶é—´</th>
                                    <th>æ–‡ä»¶å¤§å°</th>
                                    <th>æ–‡ç« æ•°</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="backup-list">
                                <tr><td colspan="6">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Audit Logs Section -->
            <div id="section-audit" class="section" style="display:none;">
                <div class="page-header">
                    <h1>å®¡è®¡æ—¥å¿—</h1>
                    <p>æŸ¥çœ‹ç”¨æˆ·æ“ä½œè®°å½•ï¼Œæ”¯æŒç­›é€‰å’Œå¯¼å‡º</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>ç­›é€‰æ¡ä»¶</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 150px;">
                                <label class="form-label">æ“ä½œç±»å‹</label>
                                <select class="form-select" id="audit-action-filter">
                                    <option value="">å…¨éƒ¨</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 150px;">
                                <label class="form-label">èµ„æºç±»å‹</label>
                                <select class="form-select" id="audit-resource-filter">
                                    <option value="">å…¨éƒ¨</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 150px;">
                                <label class="form-label">ç”¨æˆ· ID</label>
                                <input type="number" class="form-input" id="audit-user-filter" placeholder="ç”¨æˆ· ID">
                            </div>
                            <div class="form-group" style="display: flex; align-items: flex-end;">
                                <button class="btn btn-primary" onclick="loadAuditLogs()">ç­›é€‰</button>
                                <button class="btn" style="margin-left: 8px;" onclick="resetAuditFilters()">é‡ç½®</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>æ“ä½œè®°å½•</h3>
                        <span id="audit-total" style="color: #888; font-size: 13px;">å…± 0 æ¡è®°å½•</span>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>ç”¨æˆ·</th>
                                    <th>æ“ä½œ</th>
                                    <th>èµ„æºç±»å‹</th>
                                    <th>èµ„æº ID</th>
                                    <th>IP åœ°å€</th>
                                    <th>è¯¦æƒ…</th>
                                </tr>
                            </thead>
                            <tbody id="audit-list">
                                <tr><td colspan="7">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                        <div id="audit-pagination" style="margin-top: 16px; display: flex; justify-content: center; gap: 8px;"></div>
                    </div>
                </div>
            </div>
            <!-- Roles Management Section -->
            <div id="section-roles" class="section" style="display:none;">
                <div class="page-header">
                    <h1>è§’è‰²ç®¡ç†</h1>
                    <p>ç®¡ç†ç³»ç»Ÿè§’è‰²ä¸æƒé™åˆ†é…ï¼Œæ”¯æŒåˆ›å»ºè‡ªå®šä¹‰è§’è‰²å¹¶é…ç½®ç»†ç²’åº¦æƒé™</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>è§’è‰²åˆ—è¡¨</h3>
                        <button class="btn btn-primary" onclick="showAddRoleModal()">æ–°å»ºè§’è‰²</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>è§’è‰²åç§°</th>
                                    <th>æè¿°</th>
                                    <th>æƒé™æ•°é‡</th>
                                    <th>ç”¨æˆ·æ•°é‡</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="role-list">
                                <tr><td colspan="7">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // APP_BASE ç­‰å˜é‡å·²åœ¨ <head> ä¸­å®šä¹‰

        let currentCrawlerTab = 'arxiv';
        let currentSourceTab = 'arxiv';
        let currentUser = null;

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const btn = document.getElementById('mobile-menu-btn');

            const isOpen = sidebar.classList.contains('open');
            if (isOpen) {
                closeMobileMenu();
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('show');
                btn.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const btn = document.getElementById('mobile-menu-btn');

            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            btn.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });

        async function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                location.href = APP_BASE + '/';
                return;
            }

            try {
                const res = await fetch(`${AUTH_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    currentUser = await res.json();
                    if (!currentUser.is_superuser && !currentUser.roles?.includes('admin')) {
                        alert('éœ€è¦ç®¡ç†å‘˜æƒé™');
                        location.href = APP_BASE + '/';
                        return;
                    }
                    loadDashboard();
                } else {
                    localStorage.removeItem('access_token');
                    location.href = APP_BASE + '/';
                }
            } catch (e) {
                location.href = APP_BASE + '/';
            }
        }

        // Sections
        function switchSection(name) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(`section-${name}`).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.target.classList.add('active');
            closeMobileMenu();  // Close mobile menu after section switch

            if (name === 'sources') loadSources();
            if (name === 'crawlers') loadCrawlers();
            if (name === 'users') loadUsers();
            if (name === 'email') loadEmailConfig();
            if (name === 'config') loadConfig();
            if (name === 'backups') loadBackups();
            if (name === 'audit') loadAuditLogs();
            if (name === 'ai') loadAIConfig();
            if (name === 'embedding') loadEmbeddingConfig();
            if (name === 'events') loadEvents();
            if (name === 'topics') loadTopics();
            if (name === 'reports') loadReports();
            if (name === 'roles') loadRoles();
        }

        // Dashboard
        async function loadDashboard() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                document.getElementById('stat-users').textContent = data.users || 0;
                document.getElementById('stat-articles').textContent = data.articles || 0;
                document.getElementById('stat-sources').textContent = data.sources || 0;
                document.getElementById('stat-subscriptions').textContent = data.subscriptions || 0;

                // Recent articles
                const artsRes = await fetch(`${API_BASE}/articles?page_size=5`);
                const artsData = await artsRes.json();
                const tbody = document.getElementById('recent-articles');
                tbody.innerHTML = artsData.articles.map(a => `
                    <tr>
                        <td>${escapeHtml(a.title.substring(0, 40))}...</td>
                        <td><span class="badge badge-info">${a.source_type}</span></td>
                        <td>${a.category || '-'}</td>
                        <td>${formatDate(a.crawl_time)}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load dashboard:', e);
            }
        }

        // Sources Management
        function switchSourceTab(tab) {
            currentSourceTab = tab;
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.source-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`source-${tab}`).style.display = 'block';
            
            if (tab === 'arxiv') loadArxivCategories();
            if (tab === 'rss') loadRssFeeds();
            if (tab === 'wechat') loadWechatAccounts();
            if (tab === 'weibo') loadWeiboBoards();
            if (tab === 'pending') loadPendingRss();
            if (tab === 'hackernews') loadHackerNewsSources();
            if (tab === 'reddit') loadRedditSources();
            if (tab === 'twitter') loadTwitterSources();
        }

        async function loadSources() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                document.getElementById('stat-arxiv-total').textContent = data.arxiv?.total || 0;
                document.getElementById('stat-arxiv-active').textContent = data.arxiv?.active || 0;
                document.getElementById('stat-rss-total').textContent = data.rss?.total || 0;
                document.getElementById('stat-rss-active').textContent = data.rss?.active || 0;
                document.getElementById('stat-weibo-total').textContent = data.weibo?.total || 0;
                document.getElementById('stat-weibo-active').textContent = data.weibo?.active || 0;
                document.getElementById('stat-hackernews-total').textContent = data.hackernews?.total || 0;
                document.getElementById('stat-hackernews-active').textContent = data.hackernews?.active || 0;
                document.getElementById('stat-reddit-total').textContent = data.reddit?.total || 0;
                document.getElementById('stat-reddit-active').textContent = data.reddit?.active || 0;
                document.getElementById('stat-twitter-total').textContent = data.twitter?.total || 0;
                document.getElementById('stat-twitter-active').textContent = data.twitter?.active || 0;
                
                loadArxivCategories();
            } catch (e) {
                console.error('Failed to load sources:', e);
            }
        }

        async function loadArxivCategories() {
            const token = localStorage.getItem('access_token');
            const search = document.getElementById('arxiv-search')?.value || '';
            const container = document.getElementById('arxiv-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/arxiv?search=${encodeURIComponent(search)}&page_size=200`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                container.innerHTML = `
                    <div class="category-grid">
                        ${data.categories.map(c => `
                            <div class="category-item ${c.is_active ? 'enabled' : ''}">
                                <div>
                                    <code>${c.code}</code>
                                    <span style="margin-left: 8px; color: #333;">${c.name}</span>
                                </div>
                                <input type="checkbox" 
                                    data-id="${c.id}"
                                    ${c.is_active ? 'checked' : ''}
                                    onchange="toggleArxivCategory(${c.id}, this.checked)">
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                container.innerHTML = '<p>åŠ è½½å¤±è´¥</p>';
            }
        }

        async function toggleArxivCategory(categoryId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/arxiv/${categoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                loadSources();
            } catch (e) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        async function batchToggleArxiv(isActive) {
            const token = localStorage.getItem('access_token');
            const checkboxes = document.querySelectorAll('#arxiv-list input[type="checkbox"]:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            
            if (ids.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„åˆ†ç±»');
                return;
            }
            
            try {
                await fetch(`${ADMIN_BASE}/sources/arxiv/batch`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category_ids: ids, is_active: isActive })
                });
                loadArxivCategories();
            } catch (e) {
                alert('æ‰¹é‡æ“ä½œå¤±è´¥');
            }
        }

        async function loadRssFeeds() {
            const token = localStorage.getItem('access_token');
            const search = document.getElementById('rss-search')?.value || '';
            const category = document.getElementById('rss-category-filter')?.value || '';
            const tbody = document.getElementById('rss-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/rss?search=${encodeURIComponent(search)}&category=${encodeURIComponent(category)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.feeds.map(f => `
                    <tr>
                        <td><input type="checkbox" data-id="${f.id}"></td>
                        <td>
                            <strong>${escapeHtml(f.title)}</strong>
                            <br><small style="color: #888;">${escapeHtml(f.feed_url)}</small>
                        </td>
                        <td>${f.category || '-'}</td>
                        <td><span class="badge ${f.is_active ? 'badge-success' : 'badge-warning'}">${f.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</span></td>
                        <td>${f.last_fetched_at ? formatDate(f.last_fetched_at) : 'ä»æœª'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="showEditRssModal(${f.id}, '${escapeHtml(f.title).replace(/'/g, "\\'")}', '${escapeHtml(f.feed_url || '').replace(/'/g, "\\'")}', '${escapeHtml(f.category || '').replace(/'/g, "\\'")}', '${escapeHtml(f.site_url || '').replace(/'/g, "\\'")}')">ç¼–è¾‘</button>
                            <button class="btn btn-sm ${f.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleRssFeed(${f.id}, ${!f.is_active})">
                                ${f.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRssFeed(${f.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
                
                // Update category filter options
                if (!document.getElementById('rss-category-filter').options.length) {
                    const categories = [...new Set(data.feeds.map(f => f.category).filter(Boolean))];
                    const select = document.getElementById('rss-category-filter');
                    categories.forEach(cat => {
                        const opt = document.createElement('option');
                        opt.value = cat;
                        opt.textContent = cat;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        async function toggleRssFeed(feedId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/rss/${feedId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                loadRssFeeds();
            } catch (e) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        async function deleteRssFeed(feedId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ RSS æºå—ï¼Ÿ')) return;
            
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/rss/${feedId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadRssFeeds();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        async function loadWechatAccounts() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('wechat-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/wechat`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.accounts.length ? data.accounts.map(a => `
                    <tr>
                        <td>${escapeHtml(a.name)}</td>
                        <td>${escapeHtml(a.account_id)}</td>
                        <td><span class="badge ${a.is_active ? 'badge-success' : 'badge-warning'}">${a.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</span></td>
                        <td>${a.last_fetched_at ? formatDate(a.last_fetched_at) : 'ä»æœª'}</td>
                        <td>
                            <button class="btn btn-sm ${a.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleWechatAccount(${a.id}, ${!a.is_active})">
                                ${a.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteWechatAccount(${a.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="5" style="text-align: center; color: #888;">æš‚æ— å¾®ä¿¡å…¬ä¼—å·</td></tr>';
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        async function toggleWechatAccount(accountId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/wechat/${accountId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                loadWechatAccounts();
            } catch (e) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        async function deleteWechatAccount(accountId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å…¬ä¼—å·å—ï¼Ÿ')) return;
            
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/wechat/${accountId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadWechatAccounts();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        function showAddWechatModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>æ·»åŠ å¾®ä¿¡å…¬ä¼—å·</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">Ã—</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">å…¬ä¼—å·åç§° *</label>
                            <input type="text" class="form-input" id="new-wechat-name" placeholder="ä¾‹å¦‚ï¼šæœºå™¨ä¹‹å¿ƒ" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è´¦å· ID (biz) *</label>
                            <input type="text" class="form-input" id="new-wechat-biz" placeholder="ä»æ–‡ç«  URL ä¸­è·å– __biz å‚æ•°" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">åˆ†ç±»</label>
                            <input type="text" class="form-input" id="new-wechat-category" value="å¾®ä¿¡å…¬ä¼—å·">
                        </div>
                        <p style="font-size: 12px; color: #888;">
                            æç¤ºï¼šæ‰“å¼€å…¬ä¼—å·ä»»æ„æ–‡ç« ï¼Œä» URL ä¸­æ‰¾åˆ° __biz å‚æ•°å€¼å³å¯ã€‚
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="addWechatAccount()">æ·»åŠ </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addWechatAccount() {
            const token = localStorage.getItem('access_token');
            const name = document.getElementById('new-wechat-name').value;
            const biz = document.getElementById('new-wechat-biz').value;
            const category = document.getElementById('new-wechat-category').value;
            
            if (!name || !biz) {
                alert('è¯·å¡«å†™å…¬ä¼—å·åç§°å’Œè´¦å· ID');
                return;
            }
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/wechat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, account_id: biz, category })
                });
                
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadWechatAccounts();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'æ·»åŠ å¤±è´¥');
                }
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥');
            }
        }

        // Weibo Hot Search Management
        async function loadWeiboBoards() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('weibo-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/weibo`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.boards.length ? data.boards.map(b => `
                    <tr>
                        <td><input type="checkbox" data-id="${b.id}" class="weibo-checkbox"></td>
                        <td>${escapeHtml(b.board_name)}</td>
                        <td><code>${escapeHtml(b.board_type)}</code></td>
                        <td>
                            ${b.requires_cookie 
                                ? '<span class="badge badge-warning">éœ€è¦ Cookie</span>' 
                                : '<span class="badge badge-success">å…¬å¼€æ¥å£</span>'}
                        </td>
                        <td><span class="badge ${b.is_active ? 'badge-success' : 'badge-warning'}">${b.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</span></td>
                        <td>${b.last_fetched_at ? formatDate(b.last_fetched_at) : 'ä»æœª'}</td>
                        <td>
                            <button class="btn btn-sm ${b.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleWeiboBoard(${b.id}, ${!b.is_active})">
                                ${b.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="7" style="text-align: center; color: #888;">æš‚æ— å¾®åšçƒ­æœæ¦œå•</td></tr>';
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="7">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        async function toggleWeiboBoard(boardId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/weibo/${boardId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    alert(error.detail || 'æ“ä½œå¤±è´¥');
                    return;
                }
                
                loadWeiboBoards();
                loadSources();
            } catch (e) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        async function batchToggleWeibo(isActive) {
            const token = localStorage.getItem('access_token');
            const checkboxes = document.querySelectorAll('.weibo-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            
            if (ids.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„æ¦œå•');
                return;
            }
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/weibo/batch?is_active=${isActive}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ids)
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    alert(error.detail || 'æ“ä½œå¤±è´¥');
                    return;
                }
                
                loadWeiboBoards();
                loadSources();
            } catch (e) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        async function loadPendingRss() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('pending-rss-list');
            
            try {
                const res = await fetch(`${API_BASE}/feeds/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.feeds.length ? data.feeds.map(f => `
                    <tr>
                        <td>${escapeHtml(f.title)}</td>
                        <td><a href="${f.feed_url}" target="_blank" style="color: #4ecdc4;">${escapeHtml(f.feed_url)}</a></td>
                        <td>${formatDate(f.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="approveRssFeed(${f.id})">æ‰¹å‡†</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRssFeed(${f.id})">æ‹’ç»</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="4" style="text-align: center; color: #888;">æš‚æ— å¾…å®¡æ‰¹çš„ RSS æº</td></tr>';
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="4">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        async function approveRssFeed(feedId) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/rss/${feedId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: true })
                });
                loadPendingRss();
            } catch (e) {
                alert('å®¡æ‰¹å¤±è´¥');
            }
        }

        function showAddRssModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>æ·»åŠ  RSS æº</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">Ã—</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Feed URL *</label>
                            <input type="url" class="form-input" id="new-rss-url" placeholder="https://example.com/feed.xml" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" class="form-input" id="new-rss-title" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨è·å–">
                        </div>
                        <div class="form-group">
                            <label class="form-label">åˆ†ç±»</label>
                            <input type="text" class="form-input" id="new-rss-category" value="å…¶ä»–">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="addRssFeed()">æ·»åŠ </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addRssFeed() {
            const token = localStorage.getItem('access_token');
            const feedUrl = document.getElementById('new-rss-url').value;
            const title = document.getElementById('new-rss-title').value;
            const category = document.getElementById('new-rss-category').value;
            
            if (!feedUrl) {
                alert('è¯·è¾“å…¥ Feed URL');
                return;
            }
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/rss`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ feed_url: feedUrl, title, category })
                });
                
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadRssFeeds();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'æ·»åŠ å¤±è´¥');
                }
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥');
            }
        }

        function showEditRssModal(feedId, title, feedUrl, category, siteUrl) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="width: 500px;">
                    <div class="modal-header">
                        <h3>ç¼–è¾‘ RSS æº</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label">æ ‡é¢˜</label>
                            <input type="text" class="form-input" id="edit-rss-title" value="${escapeHtml(title)}">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label">Feed URL</label>
                            <input type="text" class="form-input" id="edit-rss-url" value="${escapeHtml(feedUrl)}">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label">åˆ†ç±»</label>
                            <input type="text" class="form-input" id="edit-rss-category" value="${escapeHtml(category)}">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label">ç½‘ç«™ URL</label>
                            <input type="text" class="form-input" id="edit-rss-site-url" value="${escapeHtml(siteUrl)}">
                        </div>
                        <button class="btn btn-primary" onclick="saveEditRss(${feedId})">ä¿å­˜</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveEditRss(feedId) {
            const token = localStorage.getItem('access_token');
            const data = {
                title: document.getElementById('edit-rss-title').value,
                feed_url: document.getElementById('edit-rss-url').value,
                category: document.getElementById('edit-rss-category').value,
                site_url: document.getElementById('edit-rss-site-url').value,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/sources/rss/${feedId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadRssFeeds();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'ä¿å­˜å¤±è´¥');
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        function toggleSelectAll(type) {
            const checkboxes = document.querySelectorAll(`#${type}-list input[type="checkbox"]`);
            const selectAll = document.getElementById(`${type}-select-all`);
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        // Crawlers
        function switchCrawlerTab(tab) {
            currentCrawlerTab = tab;
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            loadCrawlers();
        }

        async function loadCrawlers() {
            const token = localStorage.getItem('access_token');
            const container = document.getElementById('crawler-list');
            document.getElementById('crawler-title').textContent = currentCrawlerTab === 'arxiv' ? 'ArXiv ç±»ç›®é…ç½®' : 'RSS æºé…ç½®';

            if (currentCrawlerTab === 'arxiv') {
                try {
                    const res = await fetch(`${ADMIN_BASE}/sources/arxiv?page_size=500`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();
                    const cats = data.categories || [];

                    container.innerHTML = `
                        <div style="margin-bottom: 12px; display: flex; gap: 8px;">
                            <input type="text" class="form-input" id="crawler-arxiv-search" placeholder="æœç´¢ç±»ç›®..." style="flex:1;" oninput="filterCrawlerList()">
                        </div>
                        <div class="category-grid" id="crawler-arxiv-grid">
                            ${cats.map(c => `
                                <div class="category-item ${c.is_active ? 'enabled' : ''}" data-code="${(c.code||'').toLowerCase()}" data-name="${(c.name||'').toLowerCase()}">
                                    <div>
                                        <code>${c.code}</code>
                                        <span style="margin-left: 8px; color: #333;">${c.name}</span>
                                    </div>
                                    <input type="checkbox"
                                        data-id="${c.id}"
                                        data-code="${c.code}"
                                        ${c.is_active ? 'checked' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } catch (e) {
                    container.innerHTML = '<p>åŠ è½½å¤±è´¥</p>';
                }
            } else {
                try {
                    const res = await fetch(`${ADMIN_BASE}/sources/rss?page_size=500`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();
                    const feeds = data.feeds || [];

                    container.innerHTML = `
                        <div style="margin-bottom: 12px; display: flex; gap: 8px;">
                            <input type="text" class="form-input" id="crawler-rss-search" placeholder="æœç´¢RSSæº..." style="flex:1;" oninput="filterCrawlerList()">
                            <button class="btn btn-primary btn-sm" onclick="showAddRssModal()">+ æ·»åŠ  RSS æº</button>
                        </div>
                        <div class="category-grid" id="crawler-rss-grid">
                            ${feeds.map(f => `
                                <div class="category-item ${f.is_active ? 'enabled' : ''}" data-name="${(f.title||'').toLowerCase()}" data-cat="${(f.category||'').toLowerCase()}">
                                    <div>
                                        <strong>${escapeHtml(f.title)}</strong>
                                        <span style="margin-left: 8px; color: #888;">${f.category || ''}</span>
                                    </div>
                                    <input type="checkbox"
                                        data-id="${f.id}"
                                        ${f.is_active ? 'checked' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } catch (e) {
                    container.innerHTML = '<p>åŠ è½½å¤±è´¥</p>';
                }
            }
        }

        function filterCrawlerList() {
            const searchId = currentCrawlerTab === 'arxiv' ? 'crawler-arxiv-search' : 'crawler-rss-search';
            const gridId = currentCrawlerTab === 'arxiv' ? 'crawler-arxiv-grid' : 'crawler-rss-grid';
            const keyword = (document.getElementById(searchId)?.value || '').toLowerCase();
            const grid = document.getElementById(gridId);
            if (!grid) return;
            grid.querySelectorAll('.category-item').forEach(item => {
                const code = item.dataset.code || '';
                const name = item.dataset.name || '';
                const cat = item.dataset.cat || '';
                const match = !keyword || code.includes(keyword) || name.includes(keyword) || cat.includes(keyword);
                item.style.display = match ? '' : 'none';
            });
        }

        async function saveCrawlConfig() {
            const token = localStorage.getItem('access_token');

            if (currentCrawlerTab === 'arxiv') {
                const checkboxes = document.querySelectorAll('#crawler-arxiv-grid input[type="checkbox"]');
                const enableIds = [];
                const disableIds = [];
                checkboxes.forEach(cb => {
                    const id = parseInt(cb.dataset.id);
                    if (cb.checked) enableIds.push(id);
                    else disableIds.push(id);
                });

                try {
                    if (enableIds.length > 0) {
                        await fetch(`${ADMIN_BASE}/sources/arxiv/batch?is_active=true&${enableIds.map(id => 'category_ids=' + id).join('&')}`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                    }
                    if (disableIds.length > 0) {
                        await fetch(`${ADMIN_BASE}/sources/arxiv/batch?is_active=false&${disableIds.map(id => 'category_ids=' + id).join('&')}`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                    }
                    alert('ArXiv æŠ“å–é…ç½®å·²ä¿å­˜');
                } catch (e) {
                    alert('ä¿å­˜å¤±è´¥: ' + e.message);
                }
            } else {
                const checkboxes = document.querySelectorAll('#crawler-rss-grid input[type="checkbox"]');
                try {
                    for (const cb of checkboxes) {
                        await fetch(`${ADMIN_BASE}/sources/rss/${cb.dataset.id}`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ is_active: cb.checked })
                        });
                    }
                    alert('RSS æŠ“å–é…ç½®å·²ä¿å­˜');
                } catch (e) {
                    alert('ä¿å­˜å¤±è´¥: ' + e.message);
                }
            }
        }

        async function triggerCrawl() {
            const token = localStorage.getItem('access_token');
            const sourceType = currentCrawlerTab === 'arxiv' ? 'arxiv' : 'rss';

            try {
                const res = await fetch(`${ADMIN_BASE}/crawler/trigger`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_type: sourceType })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(`æŠ“å–å®Œæˆï¼æ–°å¢ ${data.new_articles || 0} ç¯‡æ–‡ç« ï¼Œè€—æ—¶ ${data.duration || '?'}s`);
                } else {
                    alert(data.detail || 'æŠ“å–å¤±è´¥');
                }
            } catch (e) {
                alert('è§¦å‘æŠ“å–å¤±è´¥: ' + e.message);
            }
        }

        // Users
        async function loadUsers() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const tbody = document.getElementById('user-list');
                tbody.innerHTML = data.users.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td>${escapeHtml(u.username)}</td>
                        <td>${escapeHtml(u.email)}</td>
                        <td><span class="badge badge-info">${u.roles.join(', ') || 'æ— è§’è‰²'}</span></td>
                        <td><span class="badge ${u.is_active ? 'badge-success' : 'badge-danger'}">${u.is_active ? 'æ­£å¸¸' : 'ç¦ç”¨'}</span></td>
                        <td>${formatDate(u.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="showChangeRoleModal(${u.id}, '${u.username}', '${u.roles[0] || ''}')">ä¿®æ”¹è§’è‰²</button>
                            <button class="btn btn-sm ${u.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleUser(${u.id}, ${u.is_active})">
                                ${u.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load users:', e);
            }
        }

        async function toggleUser(userId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/users/${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: !isActive })
                });
                loadUsers();
            } catch (e) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        async function showChangeRoleModal(userId, username, currentRole) {
            const token = localStorage.getItem('access_token');
            // è·å–æ‰€æœ‰è§’è‰²
            let roles = [];
            try {
                const res = await fetch(`${ADMIN_BASE}/roles`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                roles = data.roles || [];
            } catch (e) {
                alert('è·å–è§’è‰²åˆ—è¡¨å¤±è´¥');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="width: 400px;">
                    <div class="modal-header">
                        <h3>ä¿®æ”¹ç”¨æˆ·è§’è‰²</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 12px;">ç”¨æˆ·: <strong>${escapeHtml(username)}</strong></p>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label">é€‰æ‹©è§’è‰²</label>
                            <select class="form-select" id="change-role-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                ${roles.map(r => `<option value="${escapeHtml(r.name)}" ${r.name === currentRole ? 'selected' : ''}>${escapeHtml(r.name)} - ${escapeHtml(r.description)}</option>`).join('')}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveUserRole(${userId})">ä¿å­˜</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveUserRole(userId) {
            const token = localStorage.getItem('access_token');
            const roleName = document.getElementById('change-role-select').value;
            try {
                const res = await fetch(`${ADMIN_BASE}/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role_name: roleName })
                });
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadUsers();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'ä¿®æ”¹å¤±è´¥');
                }
            } catch (e) {
                alert('ä¿®æ”¹è§’è‰²å¤±è´¥');
            }
        }

        // Email Config
        let currentEmailTab = 'general';
        let emailConfigs = [];

        function switchEmailTab(tab) {
            currentEmailTab = tab;
            document.querySelectorAll('#section-email .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.email-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`email-${tab}-panel`).style.display = 'block';
            if (tab === 'configs') loadEmailConfigs();
        }

        async function loadEmailSettings() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/email/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const settings = data.settings || {};

                document.getElementById('email-enabled').checked = settings.email_enabled || false;
                document.getElementById('email-frequency').value = settings.push_frequency || 'daily';
                document.getElementById('email-time').value = settings.push_time || '09:00';
                document.getElementById('email-max-articles').value = settings.max_articles_per_email || 20;
            } catch (e) {
                console.error('Failed to load email settings:', e);
            }
        }

        async function saveEmailSettings() {
            const token = localStorage.getItem('access_token');
            const settings = {
                email_enabled: document.getElementById('email-enabled').checked,
                push_frequency: document.getElementById('email-frequency').value,
                push_time: document.getElementById('email-time').value,
                max_articles_per_email: parseInt(document.getElementById('email-max-articles').value) || 20,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/email/settings`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (res.ok) {
                    alert('è®¾ç½®å·²ä¿å­˜');
                } else {
                    const err = await res.json();
                    alert(err.detail || 'ä¿å­˜å¤±è´¥');
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        async function loadEmailConfigs() {
            const token = localStorage.getItem('access_token');
            const filter = document.getElementById('email-config-filter').value;
            
            try {
                const url = filter ? `${ADMIN_BASE}/email/configs?backend_type=${filter}` : `${ADMIN_BASE}/email/configs`;
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                emailConfigs = data.configs || [];

                const tbody = document.getElementById('email-config-list');
                if (emailConfigs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">æš‚æ— é…ç½®ï¼Œç‚¹å‡»"æ–°å»ºé…ç½®"æ·»åŠ </td></tr>';
                    return;
                }

                tbody.innerHTML = emailConfigs.map(config => `
                    <tr>
                        <td><span class="badge badge-info">${config.priority}</span></td>
                        <td>${escapeHtml(config.name)}</td>
                        <td><span class="badge" style="background: ${getBackendColor(config.backend_type)}; color: white;">${config.backend_type.toUpperCase()}</span></td>
                        <td>${escapeHtml(config.sender_email || '-')}</td>
                        <td><span class="badge ${config.is_active ? 'badge-success' : 'badge-danger'}">${config.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editEmailConfig(${config.id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm ${config.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleEmailConfig(${config.id}, ${config.is_active})">${config.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                            <button class="btn btn-sm" onclick="testEmailConfig(${config.id})">æµ‹è¯•</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEmailConfig(${config.id}, '${escapeHtml(config.name)}')">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load email configs:', e);
            }
        }

        function getBackendColor(type) {
            const colors = { smtp: '#f39c12', sendgrid: '#1a82c4', mailgun: '#e21b5c', brevo: '#0b99e5' };
            return colors[type] || '#6b7280';
        }

        function showAddEmailConfigModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'email-config-modal';
            modal.innerHTML = `
                <div class="modal-content" style="width: 500px;">
                    <div class="modal-header">
                        <h3>æ–°å»ºé‚®ä»¶é…ç½®</h3>
                        <span class="modal-close" onclick="document.getElementById('email-config-modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">åç«¯ç±»å‹</label>
                            <select class="form-select" id="new-backend-type" onchange="updateConfigForm()">
                                <option value="smtp">SMTP</option>
                                <option value="sendgrid">SendGrid</option>
                                <option value="mailgun">Mailgun</option>
                                <option value="brevo">Brevo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é…ç½®åç§°</label>
                            <input type="text" class="form-input" id="new-config-name" placeholder="å¦‚ï¼šä¸»é‚®ç®±ã€å¤‡ä»½é‚®ç®±">
                        </div>
                        <div id="backend-specific-fields"></div>
                        <div class="form-group">
                            <label class="form-label">å‘ä»¶äººé‚®ç®±</label>
                            <input type="email" class="form-input" id="new-sender-email" placeholder="noreply@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä¼˜å…ˆçº§</label>
                            <input type="number" class="form-input" id="new-priority" value="1" style="width: 100px;">
                            <p style="font-size: 12px; color: #888; margin-top: 4px;">æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="new-is-active" checked>
                                å¯ç”¨æ­¤é…ç½®
                            </label>
                        </div>
                        <div style="text-align: right; margin-top: 16px;">
                            <button class="btn" onclick="document.getElementById('email-config-modal').remove()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" style="margin-left: 8px;" onclick="createEmailConfig()">åˆ›å»º</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            updateConfigForm();
        }

        function updateConfigForm() {
            const type = document.getElementById('new-backend-type').value;
            const container = document.getElementById('backend-specific-fields');
            
            if (type === 'smtp') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">SMTP æœåŠ¡å™¨</label>
                        <input type="text" class="form-input" id="new-smtp-host" placeholder="smtp.example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">SMTP ç«¯å£</label>
                        <input type="number" class="form-input" id="new-smtp-port" value="587" style="width: 100px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç”¨æˆ·å</label>
                        <input type="text" class="form-input" id="new-smtp-user" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¯†ç /æˆæƒç </label>
                        <input type="password" class="form-input" id="new-smtp-password">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 16px;">
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="new-smtp-use-tls" checked>
                                ä½¿ç”¨ TLS (STARTTLS)
                            </span>
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="new-smtp-use-ssl">
                                ä½¿ç”¨ SSL ç›´è¿
                            </span>
                        </label>
                        <p style="font-size: 12px; color: #666; margin-top: 4px;">
                            TLS é€‚ç”¨äºç«¯å£ 587ï¼ŒSSL é€‚ç”¨äºç«¯å£ 465ã€‚ä¸¤è€…äº’æ–¥ï¼ŒSSL ä¼˜å…ˆã€‚
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SSL ç«¯å£åˆ—è¡¨ (é€—å·åˆ†éš”)</label>
                        <input type="text" class="form-input" id="new-smtp-ssl-ports" value="465" style="width: 150px;" placeholder="465,993">
                    </div>
                `;
            } else if (type === 'sendgrid') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">SendGrid API Key</label>
                        <input type="password" class="form-input" id="new-sendgrid-api-key" placeholder="SG.xxxxx">
                    </div>
                `;
            } else if (type === 'mailgun') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Mailgun API Key</label>
                        <input type="password" class="form-input" id="new-mailgun-api-key" placeholder="key-xxxxx">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mailgun Domain</label>
                        <input type="text" class="form-input" id="new-mailgun-domain" placeholder="mg.example.com">
                    </div>
                `;
            } else if (type === 'brevo') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Brevo API Key</label>
                        <input type="password" class="form-input" id="new-brevo-api-key" placeholder="xkeysib-xxxxx">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å‘ä»¶äººåç§°</label>
                        <input type="text" class="form-input" id="new-brevo-from-name" value="ResearchPulse">
                    </div>
                `;
            }
        }

        async function createEmailConfig() {
            const token = localStorage.getItem('access_token');
            const type = document.getElementById('new-backend-type').value;
            
            const config = {
                backend_type: type,
                name: document.getElementById('new-config-name').value,
                sender_email: document.getElementById('new-sender-email').value,
                priority: parseInt(document.getElementById('new-priority').value) || 1,
                is_active: document.getElementById('new-is-active').checked,
            };

            // Add backend-specific fields
            if (type === 'smtp') {
                config.smtp_host = document.getElementById('new-smtp-host').value;
                config.smtp_port = parseInt(document.getElementById('new-smtp-port').value) || 587;
                config.smtp_user = document.getElementById('new-smtp-user').value;
                config.smtp_password = document.getElementById('new-smtp-password').value;
                config.smtp_use_tls = document.getElementById('new-smtp-use-tls').checked;
                config.smtp_use_ssl = document.getElementById('new-smtp-use-ssl').checked;
                config.smtp_ssl_ports = document.getElementById('new-smtp-ssl-ports').value || '465';
            } else if (type === 'sendgrid') {
                config.sendgrid_api_key = document.getElementById('new-sendgrid-api-key').value;
            } else if (type === 'mailgun') {
                config.mailgun_api_key = document.getElementById('new-mailgun-api-key').value;
                config.mailgun_domain = document.getElementById('new-mailgun-domain').value;
            } else if (type === 'brevo') {
                config.brevo_api_key = document.getElementById('new-brevo-api-key').value;
                config.brevo_from_name = document.getElementById('new-brevo-from-name').value;
            }

            try {
                const res = await fetch(`${ADMIN_BASE}/email/configs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (res.ok) {
                    document.getElementById('email-config-modal').remove();
                    loadEmailConfigs();
                    alert('é…ç½®åˆ›å»ºæˆåŠŸ');
                } else {
                    const err = await res.json();
                    alert(err.detail || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (e) {
                alert('åˆ›å»ºå¤±è´¥');
            }
        }

        async function editEmailConfig(configId) {
            const config = emailConfigs.find(c => c.id === configId);
            if (!config) return;

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'email-edit-modal';
            
            let specificFields = '';
            if (config.backend_type === 'smtp') {
                specificFields = `
                    <div class="form-group">
                        <label class="form-label">SMTP æœåŠ¡å™¨</label>
                        <input type="text" class="form-input" id="edit-smtp-host" value="${config.smtp_host || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">SMTP ç«¯å£</label>
                        <input type="number" class="form-input" id="edit-smtp-port" value="${config.smtp_port || 587}" style="width: 100px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç”¨æˆ·å</label>
                        <input type="text" class="form-input" id="edit-smtp-user" value="${config.smtp_user || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¯†ç  (ç•™ç©ºä¿æŒä¸å˜)</label>
                        <input type="password" class="form-input" id="edit-smtp-password" placeholder="${config.smtp_password || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 16px;">
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="edit-smtp-use-tls" ${config.smtp_use_tls !== false ? 'checked' : ''}>
                                ä½¿ç”¨ TLS (STARTTLS)
                            </span>
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="edit-smtp-use-ssl" ${config.smtp_use_ssl === true ? 'checked' : ''}>
                                ä½¿ç”¨ SSL ç›´è¿
                            </span>
                        </label>
                        <p style="font-size: 12px; color: #666; margin-top: 4px;">
                            TLS é€‚ç”¨äºç«¯å£ 587ï¼ŒSSL é€‚ç”¨äºç«¯å£ 465ã€‚ä¸¤è€…äº’æ–¥ï¼ŒSSL ä¼˜å…ˆã€‚
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SSL ç«¯å£åˆ—è¡¨ (é€—å·åˆ†éš”)</label>
                        <input type="text" class="form-input" id="edit-smtp-ssl-ports" value="${config.smtp_ssl_ports || '465'}" style="width: 150px;" placeholder="465,993">
                    </div>
                `;
            } else if (config.backend_type === 'sendgrid') {
                specificFields = `
                    <div class="form-group">
                        <label class="form-label">API Key (ç•™ç©ºä¿æŒä¸å˜)</label>
                        <input type="password" class="form-input" id="edit-sendgrid-api-key" placeholder="${config.sendgrid_api_key || ''}">
                    </div>
                `;
            } else if (config.backend_type === 'mailgun') {
                specificFields = `
                    <div class="form-group">
                        <label class="form-label">API Key (ç•™ç©ºä¿æŒä¸å˜)</label>
                        <input type="password" class="form-input" id="edit-mailgun-api-key" placeholder="${config.mailgun_api_key || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Domain</label>
                        <input type="text" class="form-input" id="edit-mailgun-domain" value="${config.mailgun_domain || ''}">
                    </div>
                `;
            } else if (config.backend_type === 'brevo') {
                specificFields = `
                    <div class="form-group">
                        <label class="form-label">API Key (ç•™ç©ºä¿æŒä¸å˜)</label>
                        <input type="password" class="form-input" id="edit-brevo-api-key" placeholder="${config.brevo_api_key || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å‘ä»¶äººåç§°</label>
                        <input type="text" class="form-input" id="edit-brevo-from-name" value="${config.brevo_from_name || 'ResearchPulse'}">
                    </div>
                `;
            }

            modal.innerHTML = `
                <div class="modal-content" style="width: 500px;">
                    <div class="modal-header">
                        <h3>ç¼–è¾‘ ${config.name}</h3>
                        <span class="modal-close" onclick="document.getElementById('email-edit-modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">é…ç½®åç§°</label>
                            <input type="text" class="form-input" id="edit-config-name" value="${config.name}">
                        </div>
                        ${specificFields}
                        <div class="form-group">
                            <label class="form-label">å‘ä»¶äººé‚®ç®±</label>
                            <input type="email" class="form-input" id="edit-sender-email" value="${config.sender_email || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä¼˜å…ˆçº§</label>
                            <input type="number" class="form-input" id="edit-priority" value="${config.priority}" style="width: 100px;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="edit-is-active" ${config.is_active ? 'checked' : ''}>
                                å¯ç”¨æ­¤é…ç½®
                            </label>
                        </div>
                        <div style="text-align: right; margin-top: 16px;">
                            <button class="btn" onclick="document.getElementById('email-edit-modal').remove()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" style="margin-left: 8px;" onclick="saveEmailConfig(${configId})">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveEmailConfig(configId) {
            const token = localStorage.getItem('access_token');
            const config = emailConfigs.find(c => c.id === configId);
            
            const update = {
                name: document.getElementById('edit-config-name').value,
                sender_email: document.getElementById('edit-sender-email').value,
                priority: parseInt(document.getElementById('edit-priority').value) || 0,
                is_active: document.getElementById('edit-is-active').checked,
            };

            // Add backend-specific fields
            if (config.backend_type === 'smtp') {
                update.smtp_host = document.getElementById('edit-smtp-host').value;
                update.smtp_port = parseInt(document.getElementById('edit-smtp-port').value) || 587;
                update.smtp_user = document.getElementById('edit-smtp-user').value;
                update.smtp_use_tls = document.getElementById('edit-smtp-use-tls').checked;
                update.smtp_use_ssl = document.getElementById('edit-smtp-use-ssl').checked;
                update.smtp_ssl_ports = document.getElementById('edit-smtp-ssl-ports').value;
                const pwd = document.getElementById('edit-smtp-password').value;
                if (pwd && !pwd.startsWith('****')) update.smtp_password = pwd;
            } else if (config.backend_type === 'sendgrid') {
                const key = document.getElementById('edit-sendgrid-api-key').value;
                if (key && !key.startsWith('****')) update.sendgrid_api_key = key;
            } else if (config.backend_type === 'mailgun') {
                const key = document.getElementById('edit-mailgun-api-key').value;
                if (key && !key.startsWith('****')) update.mailgun_api_key = key;
                update.mailgun_domain = document.getElementById('edit-mailgun-domain').value;
            } else if (config.backend_type === 'brevo') {
                const key = document.getElementById('edit-brevo-api-key').value;
                if (key && !key.startsWith('****')) update.brevo_api_key = key;
                update.brevo_from_name = document.getElementById('edit-brevo-from-name').value;
            }

            try {
                const res = await fetch(`${ADMIN_BASE}/email/configs/${configId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(update)
                });

                if (res.ok) {
                    document.getElementById('email-edit-modal').remove();
                    loadEmailConfigs();
                    alert('é…ç½®å·²æ›´æ–°');
                } else {
                    const err = await res.json();
                    alert(err.detail || 'æ›´æ–°å¤±è´¥');
                }
            } catch (e) {
                alert('æ›´æ–°å¤±è´¥');
            }
        }

        async function toggleEmailConfig(configId, currentActive) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/email/configs/${configId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: !currentActive })
                });

                if (res.ok) {
                    loadEmailConfigs();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'æ“ä½œå¤±è´¥');
                }
            } catch (e) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        async function testEmailConfig(configId) {
            const testEmail = prompt('è¯·è¾“å…¥æµ‹è¯•é‚®ä»¶æ¥æ”¶åœ°å€ï¼š');
            if (!testEmail) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/email/configs/${configId}/test?test_email=${encodeURIComponent(testEmail)}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await res.json();
                if (res.ok) {
                    alert(data.message || 'æµ‹è¯•é‚®ä»¶å·²å‘é€');
                } else {
                    alert(data.detail || 'å‘é€å¤±è´¥');
                }
            } catch (e) {
                alert('å‘é€å¤±è´¥');
            }
        }

        async function deleteEmailConfig(configId, configName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é…ç½® "${configName}" å—ï¼Ÿ`)) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/email/configs/${configId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    loadEmailConfigs();
                    alert('é…ç½®å·²åˆ é™¤');
                } else {
                    const err = await res.json();
                    alert(err.detail || 'åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        async function loadEmailConfig() {
            await loadEmailSettings();
        }

        // Config
        let currentConfigTab = 'retention';
        let allConfigs = {};

        function switchConfigTab(tab) {
            currentConfigTab = tab;
            document.querySelectorAll('#section-config .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.config-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`config-${tab}-panel`).style.display = 'block';

            if (tab === 'features') loadFeaturesList();
        }

        async function loadConfig() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/config/groups`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                allConfigs = data.groups || {};

                // Populate retention settings
                const retention = allConfigs.retention || {};
                document.getElementById('config-retention-active-days').value = retention['retention.active_days'] || 7;
                document.getElementById('config-retention-archive-days').value = retention['retention.archive_days'] || 30;
                document.getElementById('config-backup-enabled').checked = (retention['retention.backup_enabled'] || 'true') === 'true';

                // Populate scheduler settings
                const scheduler = allConfigs.scheduler || {};
                document.getElementById('config-crawl-interval').value = scheduler['scheduler.crawl_interval_hours'] || 6;
                document.getElementById('config-cleanup-hour').value = scheduler['scheduler.cleanup_hour'] || 3;
                document.getElementById('config-backup-hour').value = scheduler['scheduler.backup_hour'] || 4;
                document.getElementById('config-ai-interval').value = scheduler['scheduler.ai_process_interval_hours'] || 1;
                document.getElementById('config-embedding-interval').value = scheduler['scheduler.embedding_interval_hours'] || 2;

                // Populate advanced settings
                const cache = allConfigs.cache || {};
                document.getElementById('config-cache-enabled').checked = (cache['cache.enabled'] || 'false') === 'true';
                document.getElementById('config-cache-ttl').value = cache['cache.default_ttl'] || 300;

                const jwt = allConfigs.jwt || {};
                document.getElementById('config-jwt-access-expire').value = jwt['jwt.access_token_expire_minutes'] || 30;
                document.getElementById('config-jwt-refresh-expire').value = jwt['jwt.refresh_token_expire_days'] || 7;

                // Load features list
                loadFeaturesList();
            } catch (e) {
                console.error('Failed to load config:', e);
            }
        }

        async function loadFeaturesList() {
            const token = localStorage.getItem('access_token');
            const container = document.getElementById('features-list');

            try {
                const res = await fetch(`${ADMIN_BASE}/features`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const features = data.features || [];

                const featureNames = {
                    'feature.ai_processor': 'AI æ–‡ç« å¤„ç†',
                    'feature.embedding': 'å‘é‡åµŒå…¥',
                    'feature.event_clustering': 'äº‹ä»¶èšç±»',
                    'feature.topic_radar': 'è¯é¢˜é›·è¾¾',
                    'feature.action_items': 'è¡ŒåŠ¨é¡¹æå–',
                    'feature.report_generation': 'æŠ¥å‘Šç”Ÿæˆ',
                    'feature.crawler': 'æ•°æ®çˆ¬å–',
                    'feature.backup': 'è‡ªåŠ¨å¤‡ä»½',
                    'feature.cleanup': 'æ•°æ®æ¸…ç†',
                    'feature.email_notification': 'é‚®ä»¶é€šçŸ¥'
                };

                container.innerHTML = `
                    <div class="toggle-list">
                        ${features.map(f => `
                            <div class="toggle-item">
                                <div class="toggle-info">
                                    <h4>${featureNames[f.key] || f.key}</h4>
                                    <p>${f.key}</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" 
                                        ${f.enabled ? 'checked' : ''} 
                                        onchange="toggleFeature('${f.key}', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                container.innerHTML = '<p>åŠ è½½å¤±è´¥</p>';
            }
        }

        async function toggleFeature(featureKey, enabled) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/features/${featureKey}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
            } catch (e) {
                alert('æ“ä½œå¤±è´¥');
                loadFeaturesList();
            }
        }

        async function saveConfigGroup(group) {
            const token = localStorage.getItem('access_token');
            const configs = {};

            if (group === 'retention') {
                configs['retention.active_days'] = document.getElementById('config-retention-active-days').value;
                configs['retention.archive_days'] = document.getElementById('config-retention-archive-days').value;
                configs['retention.backup_enabled'] = document.getElementById('config-backup-enabled').checked ? 'true' : 'false';
            } else if (group === 'scheduler') {
                configs['scheduler.crawl_interval_hours'] = document.getElementById('config-crawl-interval').value;
                configs['scheduler.cleanup_hour'] = document.getElementById('config-cleanup-hour').value;
                configs['scheduler.backup_hour'] = document.getElementById('config-backup-hour').value;
                configs['scheduler.ai_process_interval_hours'] = document.getElementById('config-ai-interval').value;
                configs['scheduler.embedding_interval_hours'] = document.getElementById('config-embedding-interval').value;
            } else if (group === 'advanced') {
                configs['cache.enabled'] = document.getElementById('config-cache-enabled').checked ? 'true' : 'false';
                configs['cache.default_ttl'] = document.getElementById('config-cache-ttl').value;
                configs['jwt.access_token_expire_minutes'] = document.getElementById('config-jwt-access-expire').value;
                configs['jwt.refresh_token_expire_days'] = document.getElementById('config-jwt-refresh-expire').value;
            }

            try {
                const res = await fetch(`${ADMIN_BASE}/config/batch`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ configs })
                });

                if (res.ok) {
                    alert('é…ç½®å·²ä¿å­˜');
                } else {
                    const err = await res.json();
                    alert(err.detail || 'ä¿å­˜å¤±è´¥');
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        async function saveConfig() {
            saveConfigGroup(currentConfigTab);
        }

        // Backups Management
        let currentBackupPage = 1;

        async function loadBackups() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('backup-list');

            try {
                const res = await fetch(`${ADMIN_BASE}/backups?page=${currentBackupPage}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const backups = data.backups || [];

                if (backups.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">æš‚æ— å¤‡ä»½è®°å½•</td></tr>';
                    return;
                }

                tbody.innerHTML = backups.map(b => `
                    <tr>
                        <td>${b.id}</td>
                        <td>${formatDate(b.backup_date)}</td>
                        <td>${formatSize(b.backup_size)}</td>
                        <td>${b.article_count}</td>
                        <td><span class="badge ${b.status === 'completed' ? 'badge-success' : 'badge-warning'}">${b.status}</span></td>
                        <td>
                            <button class="btn btn-sm" onclick="downloadBackup(${b.id})">ä¸‹è½½</button>
                            <button class="btn btn-sm btn-success" onclick="restoreBackup(${b.id})">æ¢å¤</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBackup(${b.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        function formatSize(bytes) {
            if (!bytes) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return `${bytes.toFixed(1)} ${units[i]}`;
        }

        async function createManualBackup() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/backups/create`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (res.ok) {
                    alert(`å¤‡ä»½å®Œæˆï¼\nå¤‡ä»½æ–‡ç« æ•°: ${data.result?.articles_backed_up || 0}\nåˆ é™¤æ–‡ç« æ•°: ${data.result?.articles_deleted || 0}`);
                    loadBackups();
                } else {
                    alert(data.message || 'å¤‡ä»½å¤±è´¥');
                }
            } catch (e) {
                alert('å¤‡ä»½å¤±è´¥');
            }
        }

        async function downloadBackup(backupId) {
            window.open(`${ADMIN_BASE}/backups/${backupId}/download?token=${localStorage.getItem('access_token')}`, '_blank');
        }

        async function restoreBackup(backupId) {
            if (!confirm('ç¡®å®šè¦ä»å¤‡ä»½æ¢å¤å—ï¼Ÿè¿™ä¼šå°†å¤‡ä»½ä¸­çš„æ–‡ç« é‡æ–°æ’å…¥æ•°æ®åº“ã€‚')) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/backups/${backupId}/restore`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (res.ok) {
                    alert(`æ¢å¤å®Œæˆï¼\næ¢å¤: ${data.restored_count}\nè·³è¿‡: ${data.skipped_count}`);
                } else {
                    alert(data.detail || 'æ¢å¤å¤±è´¥');
                }
            } catch (e) {
                alert('æ¢å¤å¤±è´¥');
            }
        }

        async function deleteBackup(backupId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¤‡ä»½è®°å½•å—ï¼Ÿ')) return;
            const deleteFile = confirm('æ˜¯å¦åŒæ—¶åˆ é™¤å¤‡ä»½æ–‡ä»¶ï¼Ÿ');

            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/backups/${backupId}?delete_file=${deleteFile}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadBackups();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // Audit Logs Management
        let currentAuditPage = 1;

        async function loadAuditLogs() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('audit-list');

            const action = document.getElementById('audit-action-filter').value;
            const resourceType = document.getElementById('audit-resource-filter').value;
            const userId = document.getElementById('audit-user-filter').value;

            let url = `${ADMIN_BASE}/audit-logs?page=${currentAuditPage}&page_size=20`;
            if (action) url += `&action=${encodeURIComponent(action)}`;
            if (resourceType) url += `&resource_type=${encodeURIComponent(resourceType)}`;
            if (userId) url += `&user_id=${userId}`;

            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const logs = data.logs || [];

                document.getElementById('audit-total').textContent = `å…± ${data.total || 0} æ¡è®°å½•`;

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">æš‚æ— è®°å½•</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td>${formatDateTime(log.created_at)}</td>
                        <td>${log.user_id || '-'}</td>
                        <td><span class="badge badge-info">${escapeHtml(log.action)}</span></td>
                        <td>${escapeHtml(log.resource_type)}</td>
                        <td>${escapeHtml(log.resource_id) || '-'}</td>
                        <td>${escapeHtml(log.ip_address) || '-'}</td>
                        <td>
                            <button class="btn btn-sm" onclick="showAuditDetails('${encodeURIComponent(JSON.stringify(log.details || {}))}')">æŸ¥çœ‹</button>
                        </td>
                    </tr>
                `).join('');

                // Load filter options
                loadAuditFilters();

                // Pagination
                const totalPages = Math.ceil((data.total || 0) / 20);
                renderAuditPagination(totalPages);
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="7">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        function formatDateTime(iso) {
            if (!iso) return '-';
            return new Date(iso).toLocaleString('zh-CN');
        }

        async function loadAuditFilters() {
            const token = localStorage.getItem('access_token');

            try {
                // Load actions
                const actionsRes = await fetch(`${ADMIN_BASE}/audit-logs/actions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const actionsData = await actionsRes.json();
                const actionSelect = document.getElementById('audit-action-filter');
                const currentAction = actionSelect.value;
                actionSelect.innerHTML = '<option value="">å…¨éƒ¨</option>' +
                    actionsData.actions.map(a => `<option value="${a}">${a}</option>`).join('');
                actionSelect.value = currentAction;

                // Load resource types
                const typesRes = await fetch(`${ADMIN_BASE}/audit-logs/resource-types`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const typesData = await typesRes.json();
                const typeSelect = document.getElementById('audit-resource-filter');
                const currentType = typeSelect.value;
                typeSelect.innerHTML = '<option value="">å…¨éƒ¨</option>' +
                    typesData.resource_types.map(t => `<option value="${t}">${t}</option>`).join('');
                typeSelect.value = currentType;
            } catch (e) {
                console.error('Failed to load audit filters:', e);
            }
        }

        function renderAuditPagination(totalPages) {
            const container = document.getElementById('audit-pagination');
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="btn ${i === currentAuditPage ? 'btn-primary' : ''}" onclick="goToAuditPage(${i})">${i}</button> `;
            }
            container.innerHTML = html;
        }

        function goToAuditPage(page) {
            currentAuditPage = page;
            loadAuditLogs();
        }

        function resetAuditFilters() {
            document.getElementById('audit-action-filter').value = '';
            document.getElementById('audit-resource-filter').value = '';
            document.getElementById('audit-user-filter').value = '';
            currentAuditPage = 1;
            loadAuditLogs();
        }

        function showAuditDetails(encodedDetails) {
            const details = JSON.parse(decodeURIComponent(encodedDetails));
            alert(JSON.stringify(details, null, 2) || 'æ— è¯¦æƒ…');
        }

        // AI Configuration
        let currentAITab = 'general';
        let aiConfig = {};

        function switchAITab(tab) {
            currentAITab = tab;
            document.querySelectorAll('#section-ai .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.ai-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`ai-${tab}-panel`).style.display = 'block';
        }

        async function loadAIConfig() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/ai/config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                aiConfig = data.config || {};

                // Populate general settings
                document.getElementById('ai-provider').value = aiConfig.provider || 'ollama';
                document.getElementById('ai-cache-enabled').checked = aiConfig.cache_enabled !== false;
                document.getElementById('ai-cache-ttl').value = aiConfig.cache_ttl || 86400;
                document.getElementById('ai-max-content').value = aiConfig.max_content_length || 1500;
                document.getElementById('ai-max-title').value = aiConfig.max_title_length || 200;
                document.getElementById('ai-thinking-enabled').checked = aiConfig.thinking_enabled || false;
                document.getElementById('ai-concurrent-enabled').checked = aiConfig.concurrent_enabled || false;

                // Populate Ollama settings
                document.getElementById('ai-ollama-url').value = aiConfig.ollama_base_url || 'http://localhost:11434';
                document.getElementById('ai-ollama-model').value = aiConfig.ollama_model || 'qwen3:32b';
                document.getElementById('ai-ollama-model-light').value = aiConfig.ollama_model_light || '';
                document.getElementById('ai-ollama-timeout').value = aiConfig.ollama_timeout || 120;

                // Populate OpenAI settings
                document.getElementById('ai-openai-model').value = aiConfig.openai_model || 'gpt-4o';
                document.getElementById('ai-openai-model-light').value = aiConfig.openai_model_light || 'gpt-4o-mini';
                document.getElementById('ai-openai-timeout').value = aiConfig.openai_timeout || 60;

                // Populate Claude settings
                document.getElementById('ai-claude-model').value = aiConfig.claude_model || 'claude-sonnet-4-20250514';
                document.getElementById('ai-claude-model-light').value = aiConfig.claude_model_light || 'claude-haiku-4-20250514';
                document.getElementById('ai-claude-timeout').value = aiConfig.claude_timeout || 60;
            } catch (e) {
                console.error('Failed to load AI config:', e);
            }
        }

        async function saveAIGeneral() {
            const token = localStorage.getItem('access_token');
            const config = {
                provider: document.getElementById('ai-provider').value,
                cache_enabled: document.getElementById('ai-cache-enabled').checked,
                cache_ttl: parseInt(document.getElementById('ai-cache-ttl').value) || 86400,
                max_content_length: parseInt(document.getElementById('ai-max-content').value) || 1500,
                max_title_length: parseInt(document.getElementById('ai-max-title').value) || 200,
                thinking_enabled: document.getElementById('ai-thinking-enabled').checked,
                concurrent_enabled: document.getElementById('ai-concurrent-enabled').checked,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/ai/config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                if (res.ok) alert('è®¾ç½®å·²ä¿å­˜');
                else alert('ä¿å­˜å¤±è´¥');
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        async function saveAIOllama() {
            const token = localStorage.getItem('access_token');
            const config = {
                ollama_base_url: document.getElementById('ai-ollama-url').value,
                ollama_model: document.getElementById('ai-ollama-model').value,
                ollama_model_light: document.getElementById('ai-ollama-model-light').value,
                ollama_timeout: parseInt(document.getElementById('ai-ollama-timeout').value) || 120,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/ai/config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                if (res.ok) alert('Ollama é…ç½®å·²ä¿å­˜');
                else alert('ä¿å­˜å¤±è´¥');
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        async function saveAIOpenAI() {
            const token = localStorage.getItem('access_token');
            const config = {
                openai_model: document.getElementById('ai-openai-model').value,
                openai_model_light: document.getElementById('ai-openai-model-light').value,
                openai_timeout: parseInt(document.getElementById('ai-openai-timeout').value) || 60,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/ai/config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                if (res.ok) alert('OpenAI é…ç½®å·²ä¿å­˜');
                else alert('ä¿å­˜å¤±è´¥');
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        async function saveAIClaude() {
            const token = localStorage.getItem('access_token');
            const config = {
                claude_model: document.getElementById('ai-claude-model').value,
                claude_model_light: document.getElementById('ai-claude-model-light').value,
                claude_timeout: parseInt(document.getElementById('ai-claude-timeout').value) || 60,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/ai/config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                if (res.ok) alert('Claude é…ç½®å·²ä¿å­˜');
                else alert('ä¿å­˜å¤±è´¥');
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        async function testAIConnection() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/ai/test`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) alert(data.message || 'æµ‹è¯•æˆåŠŸ');
                else alert(data.detail || 'æµ‹è¯•å¤±è´¥');
            } catch (e) {
                alert('æµ‹è¯•å¤±è´¥');
            }
        }

        // Embedding Management
        let embeddingConfig = {};

        async function loadEmbeddingConfig() {
            const token = localStorage.getItem('access_token');
            try {
                // Load config
                const res = await fetch(`${ADMIN_BASE}/config/groups`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const embedding = data.groups?.embedding || {};

                document.getElementById('embedding-provider').value = embedding['embedding.provider'] || 'sentence-transformers';
                document.getElementById('embedding-model').value = embedding['embedding.model'] || 'all-MiniLM-L6-v2';
                document.getElementById('embedding-threshold').value = embedding['embedding.similarity_threshold'] || '0.85';
                document.getElementById('milvus-host').value = embedding['embedding.milvus_host'] || 'localhost';
                document.getElementById('milvus-port').value = embedding['embedding.milvus_port'] || '19530';
                document.getElementById('milvus-collection').value = embedding['embedding.milvus_collection'] || 'article_embeddings';

                // Load stats
                const statsRes = await fetch(`${ADMIN_BASE}/embeddings/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const statsData = await statsRes.json();
                const stats = statsData.stats || {};

                document.getElementById('stat-embedding-total').textContent = stats.total_articles || '-';
                document.getElementById('stat-embedding-computed').textContent = stats.embedded_count || '-';
                document.getElementById('stat-embedding-missing').textContent = stats.missing_count || '-';
                document.getElementById('stat-embedding-provider').textContent = embedding['embedding.provider'] || '-';
            } catch (e) {
                console.error('Failed to load embedding config:', e);
            }
        }

        async function saveEmbeddingConfig() {
            const token = localStorage.getItem('access_token');
            const configs = {
                'embedding.provider': document.getElementById('embedding-provider').value,
                'embedding.model': document.getElementById('embedding-model').value,
                'embedding.similarity_threshold': document.getElementById('embedding-threshold').value,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/config/batch`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ configs })
                });
                if (res.ok) alert('åµŒå…¥é…ç½®å·²ä¿å­˜');
                else alert('ä¿å­˜å¤±è´¥');
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        async function saveMilvusConfig() {
            const token = localStorage.getItem('access_token');
            const configs = {
                'embedding.milvus_host': document.getElementById('milvus-host').value,
                'embedding.milvus_port': document.getElementById('milvus-port').value,
                'embedding.milvus_collection': document.getElementById('milvus-collection').value,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/config/batch`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ configs })
                });
                if (res.ok) alert('Milvus é…ç½®å·²ä¿å­˜');
                else alert('ä¿å­˜å¤±è´¥');
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        async function testMilvusConnection() {
            alert('Milvus è¿æ¥æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­');
        }

        async function recomputeMissingEmbeddings() {
            if (!confirm('ç¡®å®šè¦è®¡ç®—ç¼ºå¤±çš„åµŒå…¥å‘é‡å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) return;
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/embeddings/recompute?all=false`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) alert(data.message || 'ä»»åŠ¡å·²æäº¤');
                else alert(data.detail || 'æäº¤å¤±è´¥');
            } catch (e) {
                alert('æäº¤å¤±è´¥');
            }
        }

        async function recomputeAllEmbeddings() {
            if (!confirm('ç¡®å®šè¦é‡æ–°è®¡ç®—æ‰€æœ‰åµŒå…¥å‘é‡å—ï¼Ÿè¿™å°†æ¶ˆè€—å¤§é‡æ—¶é—´å’Œèµ„æºï¼')) return;
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/embeddings/recompute?all=true`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) alert(data.message || 'ä»»åŠ¡å·²æäº¤');
                else alert(data.detail || 'æäº¤å¤±è´¥');
            } catch (e) {
                alert('æäº¤å¤±è´¥');
            }
        }

        // Events Management
        let currentEventTab = 'list';
        let currentEventPage = 1;
        let selectedEvents = new Set();

        function switchEventTab(tab) {
            currentEventTab = tab;
            document.querySelectorAll('#section-events .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.event-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`event-${tab}-panel`).style.display = 'block';
        }

        async function loadEvents() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('event-list');
            const search = document.getElementById('event-search').value;
            const isActive = document.getElementById('event-active-filter').value;

            let url = `${ADMIN_BASE}/events?page=${currentEventPage}&page_size=15`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (isActive) url += `&is_active=${isActive}`;

            try {
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();

                document.getElementById('event-total').textContent = `å…± ${data.total || 0} ä¸ªäº‹ä»¶`;

                const events = data.events || [];
                if (events.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">æš‚æ— äº‹ä»¶</td></tr>';
                    return;
                }

                tbody.innerHTML = events.map(e => `
                    <tr>
                        <td><input type="checkbox" class="event-checkbox" data-id="${e.id}" ${selectedEvents.has(e.id) ? 'checked' : ''}></td>
                        <td><a href="#" onclick="viewEventDetail(${e.id})">${escapeHtml(e.title)}</a></td>
                        <td>${e.category || '-'}</td>
                        <td>${e.article_count}</td>
                        <td>${formatDate(e.last_updated_at)}</td>
                        <td><span class="badge ${e.is_active ? 'badge-success' : 'badge-warning'}">${e.is_active ? 'æ´»è·ƒ' : 'ä¸æ´»è·ƒ'}</span></td>
                        <td>
                            <button class="btn btn-sm" onclick="viewEventDetail(${e.id})">æŸ¥çœ‹</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEvent(${e.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="7">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        function toggleEventSelectAll() {
            const selectAll = document.getElementById('event-select-all').checked;
            document.querySelectorAll('.event-checkbox').forEach(cb => {
                cb.checked = selectAll;
                if (selectAll) selectedEvents.add(parseInt(cb.dataset.id));
                else selectedEvents.delete(parseInt(cb.dataset.id));
            });
        }

        async function mergeSelectedEvents() {
            if (selectedEvents.size < 2) {
                alert('è¯·é€‰æ‹©è‡³å°‘ 2 ä¸ªäº‹ä»¶è¿›è¡Œåˆå¹¶');
                return;
            }
            if (!confirm(`ç¡®å®šè¦åˆå¹¶é€‰ä¸­çš„ ${selectedEvents.size} ä¸ªäº‹ä»¶å—ï¼Ÿ`)) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/events/merge`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ source_event_ids: Array.from(selectedEvents) })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(data.message);
                    selectedEvents.clear();
                    loadEvents();
                } else {
                    alert(data.detail || 'åˆå¹¶å¤±è´¥');
                }
            } catch (e) {
                alert('åˆå¹¶å¤±è´¥');
            }
        }

        async function viewEventDetail(eventId) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/events/${eventId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const event = data.event;

                let details = `äº‹ä»¶: ${event.title}\n\n`;
                details += `æ–‡ç« æ•°: ${event.article_count}\n`;
                details += `åˆ†ç±»: ${event.category || '-'}\n\n`;
                details += `å…³è”æ–‡ç« :\n`;
                event.articles.forEach((a, i) => {
                    details += `${i + 1}. ${a.title}\n`;
                });

                alert(details);
            } catch (e) {
                alert('è·å–äº‹ä»¶è¯¦æƒ…å¤±è´¥');
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤äº‹ä»¶å—ï¼Ÿå…³è”çš„æ–‡ç« ä¸ä¼šè¢«åˆ é™¤ã€‚')) return;

            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/events/${eventId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadEvents();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        async function loadEventConfig() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/events/config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const config = data.config || {};

                document.getElementById('event-rule-weight').value = config.rule_weight || 0.4;
                document.getElementById('event-semantic-weight').value = config.semantic_weight || 0.6;
                document.getElementById('event-min-similarity').value = config.min_similarity || 0.7;
            } catch (e) {
                console.error('Failed to load event config:', e);
            }
        }

        async function saveEventConfig() {
            const token = localStorage.getItem('access_token');
            const ruleWeight = document.getElementById('event-rule-weight').value;
            const semanticWeight = document.getElementById('event-semantic-weight').value;
            const minSimilarity = document.getElementById('event-min-similarity').value;

            try {
                const res = await fetch(`${ADMIN_BASE}/events/config?rule_weight=${ruleWeight}&semantic_weight=${semanticWeight}&min_similarity=${minSimilarity}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) alert('é…ç½®å·²ä¿å­˜');
                else alert('ä¿å­˜å¤±è´¥');
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        // Topics Management
        async function loadTopics() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('topic-list');

            try {
                const res = await fetch(`${ADMIN_BASE}/topics`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const topics = data.topics || [];

                if (topics.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">æš‚æ— ä¸»é¢˜</td></tr>';
                    return;
                }

                tbody.innerHTML = topics.map(t => `
                    <tr>
                        <td>${escapeHtml(t.name)}</td>
                        <td><span class="badge ${t.is_manual ? 'badge-info' : 'badge-success'}">${t.is_manual ? 'æ‰‹åŠ¨' : 'è‡ªåŠ¨'}</span></td>
                        <td>${(t.keywords || []).slice(0, 5).join(', ')}</td>
                        <td>${t.article_count || 0}</td>
                        <td>${formatDate(t.created_at)}</td>
                        <td>
                            <button class="btn btn-sm" onclick="editTopic(${t.id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTopic(${t.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        function showAddTopicModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>åˆ›å»ºä¸»é¢˜</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">Ã—</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">ä¸»é¢˜åç§°</label>
                            <input type="text" class="form-input" id="new-topic-name" placeholder="ä¾‹å¦‚ï¼šå¤§è¯­è¨€æ¨¡å‹">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å…³é”®è¯ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                            <input type="text" class="form-input" id="new-topic-keywords" placeholder="ä¾‹å¦‚ï¼šLLM, GPT, å¤§æ¨¡å‹">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                            <textarea class="form-input" id="new-topic-description" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="createTopic()">åˆ›å»º</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function createTopic() {
            const token = localStorage.getItem('access_token');
            const name = document.getElementById('new-topic-name').value;
            const keywords = document.getElementById('new-topic-keywords').value.split(',').map(k => k.trim()).filter(k => k);
            const description = document.getElementById('new-topic-description').value;

            if (!name) {
                alert('è¯·è¾“å…¥ä¸»é¢˜åç§°');
                return;
            }

            try {
                const res = await fetch(`${ADMIN_BASE}/topics`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, keywords, description, is_manual: true })
                });
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadTopics();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (e) {
                alert('åˆ›å»ºå¤±è´¥');
            }
        }

        async function deleteTopic(topicId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä¸»é¢˜å—ï¼Ÿ')) return;

            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/topics/${topicId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadTopics();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        function editTopic(topicId) {
            alert('ä¸»é¢˜ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­');
        }

        // Reports Management
        async function loadReports() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('report-list');

            try {
                const res = await fetch(`${ADMIN_BASE}/reports`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const reports = data.reports || [];

                if (reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888;">æš‚æ— æŠ¥å‘Š</td></tr>';
                    return;
                }

                tbody.innerHTML = reports.map(r => `
                    <tr>
                        <td>${escapeHtml(r.title)}</td>
                        <td><span class="badge badge-info">${r.report_type || 'å‘¨æŠ¥'}</span></td>
                        <td>${r.date_range || '-'}</td>
                        <td>${formatDate(r.created_at)}</td>
                        <td>
                            <button class="btn btn-sm" onclick="viewReport(${r.id})">æŸ¥çœ‹</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteReport(${r.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        async function generateReport() {
            const token = localStorage.getItem('access_token');
            const reportType = document.getElementById('report-type').value;

            try {
                const res = await fetch(`${ADMIN_BASE}/reports/generate?report_type=${reportType}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    alert('æŠ¥å‘Šå·²ç”Ÿæˆ');
                    loadReports();
                } else {
                    alert(data.detail || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (e) {
                alert('ç”Ÿæˆå¤±è´¥');
            }
        }

        async function viewReport(reportId) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/reports/${reportId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                alert(JSON.stringify(data.report, null, 2));
            } catch (e) {
                alert('è·å–æŠ¥å‘Šå¤±è´¥');
            }
        }

        async function deleteReport(reportId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æŠ¥å‘Šå—ï¼Ÿ')) return;

            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/reports/${reportId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadReports();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // Roles Management
        async function loadRoles() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/roles`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const tbody = document.getElementById('role-list');
                const builtinRoles = ['superuser', 'admin', 'user', 'guest'];
                tbody.innerHTML = data.roles.map(r => `
                    <tr>
                        <td>${r.id}</td>
                        <td><span class="badge badge-info">${escapeHtml(r.name)}</span></td>
                        <td>${escapeHtml(r.description || '')}</td>
                        <td>${r.permissions ? r.permissions.length : 0}</td>
                        <td>${r.user_count || 0}</td>
                        <td>${formatDate(r.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="showEditRoleModal(${r.id})">ç¼–è¾‘</button>
                            ${builtinRoles.includes(r.name) ? '' : `<button class="btn btn-sm btn-danger" onclick="deleteRole(${r.id}, '${escapeHtml(r.name)}')">åˆ é™¤</button>`}
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load roles:', e);
            }
        }

        async function showAddRoleModal() {
            const token = localStorage.getItem('access_token');
            let permissionsData = { grouped: {} };
            try {
                const res = await fetch(`${ADMIN_BASE}/permissions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                permissionsData = await res.json();
            } catch (e) {
                console.error('Failed to load permissions:', e);
            }

            const grouped = permissionsData.grouped || {};
            let permHtml = '';
            for (const [resource, perms] of Object.entries(grouped)) {
                permHtml += `<div style="margin-bottom: 12px;">
                    <div style="font-weight: 600; font-size: 13px; color: #333; margin-bottom: 6px; border-bottom: 1px solid #eee; padding-bottom: 4px;">
                        ${escapeHtml(resource)}
                        <label style="font-weight: normal; font-size: 12px; margin-left: 8px; cursor: pointer;">
                            <input type="checkbox" onchange="toggleResourcePerms(this, 'add', '${resource}')"> å…¨é€‰
                        </label>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${perms.map(p => `
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; min-width: 140px; cursor: pointer;" class="perm-item-add" data-resource="${resource}">
                                <input type="checkbox" name="add-perm" value="${p.id}">
                                ${escapeHtml(p.action)}
                                <span style="color: #999; font-size: 11px;">${escapeHtml(p.description || '')}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>`;
            }

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'role-add-modal';
            modal.innerHTML = `
                <div class="modal-content" style="width: 700px;">
                    <div class="modal-header">
                        <h3>æ–°å»ºè§’è‰²</h3>
                        <span class="modal-close" onclick="document.getElementById('role-add-modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">è§’è‰²åç§°</label>
                            <input type="text" class="form-input" id="add-role-name" placeholder="ä¾‹å¦‚: editor, reviewer">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è§’è‰²æè¿°</label>
                            <input type="text" class="form-input" id="add-role-desc" placeholder="ç®€è¦æè¿°è¯¥è§’è‰²çš„ç”¨é€”">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æƒé™åˆ†é…</label>
                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px;">
                                ${permHtml}
                            </div>
                        </div>
                        <div style="text-align: right; margin-top: 16px;">
                            <button class="btn" onclick="document.getElementById('role-add-modal').remove()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" style="margin-left: 8px;" onclick="saveNewRole()">åˆ›å»º</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function toggleResourcePerms(checkbox, prefix, resource) {
            const checked = checkbox.checked;
            document.querySelectorAll(`.perm-item-${prefix}[data-resource="${resource}"] input[type="checkbox"]`).forEach(cb => {
                cb.checked = checked;
            });
        }

        async function saveNewRole() {
            const name = document.getElementById('add-role-name').value.trim();
            const description = document.getElementById('add-role-desc').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥è§’è‰²åç§°');
                return;
            }
            const permissionIds = [];
            document.querySelectorAll('input[name="add-perm"]:checked').forEach(cb => {
                permissionIds.push(parseInt(cb.value));
            });

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/roles`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, permission_ids: permissionIds })
                });
                if (!res.ok) {
                    const err = await res.json();
                    alert('åˆ›å»ºå¤±è´¥: ' + (err.detail || JSON.stringify(err)));
                    return;
                }
                document.getElementById('role-add-modal').remove();
                loadRoles();
                alert('è§’è‰²åˆ›å»ºæˆåŠŸ');
            } catch (e) {
                alert('åˆ›å»ºå¤±è´¥: ' + e.message);
            }
        }

        async function showEditRoleModal(roleId) {
            const token = localStorage.getItem('access_token');
            let roleData = null;
            let permissionsData = { grouped: {} };

            try {
                const [rolesRes, permsRes] = await Promise.all([
                    fetch(`${ADMIN_BASE}/roles`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${ADMIN_BASE}/permissions`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                const rolesData = await rolesRes.json();
                permissionsData = await permsRes.json();
                roleData = rolesData.roles.find(r => r.id === roleId);
            } catch (e) {
                console.error('Failed to load role data:', e);
                alert('åŠ è½½è§’è‰²æ•°æ®å¤±è´¥');
                return;
            }

            if (!roleData) {
                alert('æœªæ‰¾åˆ°è¯¥è§’è‰²');
                return;
            }

            const currentPermIds = new Set((roleData.permissions || []).map(p => p.id));
            const builtinRoles = ['superuser', 'admin', 'user', 'guest'];
            const isBuiltin = builtinRoles.includes(roleData.name);
            const grouped = permissionsData.grouped || {};

            let permHtml = '';
            for (const [resource, perms] of Object.entries(grouped)) {
                const allChecked = perms.every(p => currentPermIds.has(p.id));
                permHtml += `<div style="margin-bottom: 12px;">
                    <div style="font-weight: 600; font-size: 13px; color: #333; margin-bottom: 6px; border-bottom: 1px solid #eee; padding-bottom: 4px;">
                        ${escapeHtml(resource)}
                        <label style="font-weight: normal; font-size: 12px; margin-left: 8px; cursor: pointer;">
                            <input type="checkbox" ${allChecked ? 'checked' : ''} onchange="toggleResourcePerms(this, 'edit', '${resource}')"> å…¨é€‰
                        </label>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${perms.map(p => `
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; min-width: 140px; cursor: pointer;" class="perm-item-edit" data-resource="${resource}">
                                <input type="checkbox" name="edit-perm" value="${p.id}" ${currentPermIds.has(p.id) ? 'checked' : ''}>
                                ${escapeHtml(p.action)}
                                <span style="color: #999; font-size: 11px;">${escapeHtml(p.description || '')}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>`;
            }

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'role-edit-modal';
            modal.innerHTML = `
                <div class="modal-content" style="width: 700px;">
                    <div class="modal-header">
                        <h3>ç¼–è¾‘è§’è‰²: ${escapeHtml(roleData.name)}</h3>
                        <span class="modal-close" onclick="document.getElementById('role-edit-modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">è§’è‰²åç§°</label>
                            <input type="text" class="form-input" id="edit-role-name" value="${escapeHtml(roleData.name)}" ${isBuiltin ? 'disabled' : ''}>
                            ${isBuiltin ? '<span style="font-size: 11px; color: #999;">å†…ç½®è§’è‰²åç§°ä¸å¯ä¿®æ”¹</span>' : ''}
                        </div>
                        <div class="form-group">
                            <label class="form-label">è§’è‰²æè¿°</label>
                            <input type="text" class="form-input" id="edit-role-desc" value="${escapeHtml(roleData.description || '')}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æƒé™åˆ†é… (å·²é€‰ <span id="edit-perm-count">${currentPermIds.size}</span> é¡¹)</label>
                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px;">
                                ${permHtml}
                            </div>
                        </div>
                        <div style="text-align: right; margin-top: 16px;">
                            <button class="btn" onclick="document.getElementById('role-edit-modal').remove()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" style="margin-left: 8px;" onclick="saveEditRole(${roleId})">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Live count update
            modal.querySelectorAll('input[name="edit-perm"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    const count = modal.querySelectorAll('input[name="edit-perm"]:checked').length;
                    document.getElementById('edit-perm-count').textContent = count;
                });
            });
        }

        async function saveEditRole(roleId) {
            const name = document.getElementById('edit-role-name').value.trim();
            const description = document.getElementById('edit-role-desc').value.trim();
            if (!name) {
                alert('è§’è‰²åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }
            const permissionIds = [];
            document.querySelectorAll('input[name="edit-perm"]:checked').forEach(cb => {
                permissionIds.push(parseInt(cb.value));
            });

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/roles/${roleId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, permission_ids: permissionIds })
                });
                if (!res.ok) {
                    const err = await res.json();
                    alert('ä¿å­˜å¤±è´¥: ' + (err.detail || JSON.stringify(err)));
                    return;
                }
                document.getElementById('role-edit-modal').remove();
                loadRoles();
                alert('è§’è‰²æ›´æ–°æˆåŠŸ');
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        async function deleteRole(roleId, roleName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰² "${roleName}" å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚`)) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/roles/${roleId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    const err = await res.json();
                    alert('åˆ é™¤å¤±è´¥: ' + (err.detail || JSON.stringify(err)));
                    return;
                }
                loadRoles();
                alert('è§’è‰²å·²åˆ é™¤');
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // HackerNews Management
        async function loadHackerNewsSources() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('hackernews-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/hackernews`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.sources?.length ? data.sources.map(b => `
                    <tr>
                        <td><input type="checkbox" data-id="${b.id}" class="hackernews-checkbox"></td>
                        <td>${escapeHtml(b.feed_name)}</td>
                        <td><code>${escapeHtml(b.feed_type)}</code></td>
                        <td><span class="badge ${b.is_active ? 'badge-success' : 'badge-warning'}">${b.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</span></td>
                        <td>${b.last_fetched_at ? formatDate(b.last_fetched_at) : 'ä»æœª'}</td>
                        <td>
                            <button class="btn btn-sm ${b.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleHackerNewsBoard(${b.id}, ${!b.is_active})">
                                ${b.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="6" style="text-align: center; color: #888;">æš‚æ—  HackerNews æ¿å—</td></tr>';
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        async function toggleHackerNewsBoard(boardId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/hackernews/${boardId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    alert(error.detail || 'æ“ä½œå¤±è´¥');
                    return;
                }
                
                loadHackerNewsSources();
                loadSources();
            } catch (e) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        async function batchToggleHackerNews(isActive) {
            const token = localStorage.getItem('access_token');
            const checkboxes = document.querySelectorAll('.hackernews-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            
            if (ids.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„æ¿å—');
                return;
            }
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/hackernews/batch?is_active=${isActive}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ids)
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    alert(error.detail || 'æ“ä½œå¤±è´¥');
                    return;
                }
                
                loadHackerNewsSources();
                loadSources();
            } catch (e) {
                alert('æ‰¹é‡æ“ä½œå¤±è´¥');
            }
        }

        // Reddit Management
        async function loadRedditSources() {
            const token = localStorage.getItem('access_token');
            const search = document.getElementById('reddit-search')?.value || '';
            const tbody = document.getElementById('reddit-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/reddit?search=${encodeURIComponent(search)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.sources?.length ? data.sources.map(s => `
                    <tr>
                        <td><input type="checkbox" data-id="${s.id}" class="reddit-checkbox"></td>
                        <td><strong>r/${escapeHtml(s.subreddit)}</strong></td>
                        <td>${escapeHtml(s.description || '-')}</td>
                        <td><span class="badge ${s.is_active ? 'badge-success' : 'badge-warning'}">${s.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</span></td>
                        <td>${s.last_fetched_at ? formatDate(s.last_fetched_at) : 'ä»æœª'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="showEditRedditModal(${s.id}, '${escapeHtml(s.subreddit).replace(/'/g, "\\'")}', '${escapeHtml(s.description || '').replace(/'/g, "\\'")}')">ç¼–è¾‘</button>
                            <button class="btn btn-sm ${s.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleRedditSource(${s.id}, ${!s.is_active})">
                                ${s.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRedditSource(${s.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="6" style="text-align: center; color: #888;">æš‚æ—  Reddit è®¢é˜…æº</td></tr>';
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        function showAddRedditModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>æ·»åŠ  Reddit è®¢é˜…æº</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">Ã—</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Subreddit åç§° *</label>
                            <input type="text" class="form-input" id="new-reddit-subreddit" placeholder="ä¾‹å¦‚ï¼šprogramming æˆ– programming" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <input type="text" class="form-input" id="new-reddit-description" placeholder="å¯é€‰æè¿°">
                        </div>
                        <p style="font-size: 12px; color: #888;">
                            æç¤ºï¼šè¾“å…¥ subreddit åç§°ï¼Œä¸éœ€è¦ r/ å‰ç¼€ã€‚ç³»ç»Ÿå°†ä½¿ç”¨ Reddit çš„å…¬å¼€ RSS æ¥å£æŠ“å–å†…å®¹ã€‚
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="addRedditSource()">æ·»åŠ </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addRedditSource() {
            const token = localStorage.getItem('access_token');
            const subreddit = document.getElementById('new-reddit-subreddit').value.replace(/^r\//, '');
            const description = document.getElementById('new-reddit-description').value;
            
            if (!subreddit) {
                alert('è¯·å¡«å†™ Subreddit åç§°');
                return;
            }
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/reddit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ subreddit, description })
                });
                
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadRedditSources();
                    loadSources();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'æ·»åŠ å¤±è´¥');
                }
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥');
            }
        }

        function showEditRedditModal(sourceId, subreddit, description) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>ç¼–è¾‘ Reddit è®¢é˜…æº</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">Ã—</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Subreddit åç§°</label>
                            <input type="text" class="form-input" id="edit-reddit-subreddit" value="${subreddit}" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <input type="text" class="form-input" id="edit-reddit-description" value="${description}">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="updateRedditSource(${sourceId})">ä¿å­˜</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function updateRedditSource(sourceId) {
            const token = localStorage.getItem('access_token');
            const description = document.getElementById('edit-reddit-description').value;
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/reddit/${sourceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ description })
                });
                
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadRedditSources();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'æ›´æ–°å¤±è´¥');
                }
            } catch (e) {
                alert('æ›´æ–°å¤±è´¥');
            }
        }

        async function toggleRedditSource(sourceId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/reddit/${sourceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                loadRedditSources();
                loadSources();
            } catch (e) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        async function deleteRedditSource(sourceId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ Reddit è®¢é˜…æºå—ï¼Ÿ')) return;
            
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/reddit/${sourceId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadRedditSources();
                loadSources();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // Twitter Management
        async function loadTwitterSources() {
            const token = localStorage.getItem('access_token');
            const search = document.getElementById('twitter-search')?.value || '';
            const tbody = document.getElementById('twitter-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/twitter?search=${encodeURIComponent(search)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.users?.length ? data.users.map(u => `
                    <tr>
                        <td><input type="checkbox" data-id="${u.id}" class="twitter-checkbox"></td>
                        <td><strong>@${escapeHtml(u.username)}</strong></td>
                        <td>${escapeHtml(u.display_name || '-')}</td>
                        <td><span class="badge ${u.is_active ? 'badge-success' : 'badge-warning'}">${u.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</span></td>
                        <td>${u.last_fetched_at ? formatDate(u.last_fetched_at) : 'ä»æœª'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="showEditTwitterModal(${u.id}, '${escapeHtml(u.username).replace(/'/g, "\\'")}', '${escapeHtml(u.display_name || '').replace(/'/g, "\\'")}')">ç¼–è¾‘</button>
                            <button class="btn btn-sm ${u.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleTwitterSource(${u.id}, ${!u.is_active})">
                                ${u.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTwitterSource(${u.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="6" style="text-align: center; color: #888;">æš‚æ—  Twitter ç”¨æˆ·è®¢é˜…</td></tr>';
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        function showAddTwitterModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>æ·»åŠ  Twitter ç”¨æˆ·è®¢é˜…</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">Ã—</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">ç”¨æˆ·å *</label>
                            <input type="text" class="form-input" id="new-twitter-username" placeholder="ä¾‹å¦‚ï¼šelonmusk" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ˜¾ç¤ºåç§°</label>
                            <input type="text" class="form-input" id="new-twitter-displayname" placeholder="å¯é€‰">
                        </div>
                        <p style="font-size: 12px; color: #888;">
                            æç¤ºï¼šè¾“å…¥ Twitter ç”¨æˆ·åï¼Œä¸éœ€è¦ @ ç¬¦å·ã€‚è¯·ç¡®ä¿å·²é…ç½® Twitter API å‡­è¯ã€‚
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="addTwitterSource()">æ·»åŠ </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addTwitterSource() {
            const token = localStorage.getItem('access_token');
            const username = document.getElementById('new-twitter-username').value.replace(/^@/, '');
            const display_name = document.getElementById('new-twitter-displayname').value;
            
            if (!username) {
                alert('è¯·å¡«å†™ç”¨æˆ·å');
                return;
            }
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/twitter`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, display_name })
                });
                
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadTwitterSources();
                    loadSources();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'æ·»åŠ å¤±è´¥');
                }
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥');
            }
        }

        function showEditTwitterModal(sourceId, username, displayName) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>ç¼–è¾‘ Twitter ç”¨æˆ·è®¢é˜…</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">Ã—</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">ç”¨æˆ·å</label>
                            <input type="text" class="form-input" id="edit-twitter-username" value="${username}" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ˜¾ç¤ºåç§°</label>
                            <input type="text" class="form-input" id="edit-twitter-displayname" value="${displayName}">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="updateTwitterSource(${sourceId})">ä¿å­˜</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function updateTwitterSource(sourceId) {
            const token = localStorage.getItem('access_token');
            const display_name = document.getElementById('edit-twitter-displayname').value;
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/twitter/${sourceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ display_name })
                });
                
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadTwitterSources();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'æ›´æ–°å¤±è´¥');
                }
            } catch (e) {
                alert('æ›´æ–°å¤±è´¥');
            }
        }

        async function toggleTwitterSource(sourceId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/twitter/${sourceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                loadTwitterSources();
                loadSources();
            } catch (e) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        async function deleteTwitterSource(sourceId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ Twitter ç”¨æˆ·è®¢é˜…å—ï¼Ÿ')) return;
            
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/twitter/${sourceId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadTwitterSources();
                loadSources();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // Utils
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(iso) {
            if (!iso) return '';
            return new Date(iso).toLocaleDateString('zh-CN');
        }
    </script>
</body>
</html>
