<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - ResearchPulse</title>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // 动态检测代理前缀（提前执行，供静态 HTML 使用）
        (function() {
            var path = window.location.pathname;
            var rpIndex = path.indexOf('/researchpulse');
            var prefix = rpIndex > 0 ? path.substring(0, rpIndex) : '';
            window.APP_BASE = prefix + '/researchpulse';
            window.API_BASE = prefix + '/researchpulse/api';
            window.AUTH_BASE = prefix + '/api/v1';
            window.ADMIN_BASE = prefix + '/api/v1/admin';
        })();
    </script>
    <style>
        /* ============================================
           CSS Design Tokens / Variables
           ============================================ */
        :root {
            /* 主色调 */
            --color-primary: #1a1a2e;
            --color-primary-hover: #2d2d4a;
            --color-accent: #4ecdc4;
            --color-accent-light: rgba(78, 205, 196, 0.2);

            /* 背景色 */
            --bg-body: #f0f2f5;
            --bg-card: white;
            --bg-sidebar: #1a1a2e;
            --bg-hover: rgba(255, 255, 255, 0.05);
            --bg-table-hover: #f9fafb;
            --bg-input: white;
            --bg-disabled: #ccc;
            --bg-category: #f9fafb;
            --bg-category-enabled: #ecfdf5;
            --bg-tabs: #f5f5f5;
            --bg-info: #e3f2fd;
            --bg-info-light: #f0f9ff;
            --bg-success-light: #ecfdf5;

            /* 文字色 */
            --text-primary: #1a1a2e;
            --text-secondary: #666;
            --text-muted: #888;
            --text-light: #999;
            --text-inverse: white;
            --text-nav: rgba(255, 255, 255, 0.7);
            --text-table: #333;

            /* 边框色 */
            --border-light: #f0f0f0;
            --border-input: #e0e0e0;
            --border-divider: rgba(255, 255, 255, 0.1);

            /* 状态色 */
            --color-success: #10b981;
            --color-danger: #ef4444;
            --color-warning: #d97706;
            --color-info: #2563eb;

            /* Badge 颜色 */
            --badge-success-bg: #dcfce7;
            --badge-success-text: #059669;
            --badge-danger-bg: #fee2e2;
            --badge-danger-text: #dc2626;
            --badge-info-bg: #dbeafe;
            --badge-info-text: #2563eb;
            --badge-warning-bg: #fef3c7;
            --badge-warning-text: #d97706;

            /* 间距 */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --spacing-2xl: 24px;

            /* 圆角 */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
            --radius-full: 24px;

            /* 阴影 */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
            --shadow-modal: 0 0 0 1px rgba(0, 0, 0, 0.05);

            /* 侧边栏 */
            --sidebar-width: 240px;
            --sidebar-mobile-width: 280px;

            /* 过渡 */
            --transition-fast: 0.2s;
            --transition-normal: 0.3s;

            /* 字体 */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background: var(--bg-body); min-height: 100vh; }

        .layout { display: grid; grid-template-columns: var(--sidebar-width) 1fr; min-height: 100vh; }

        /* Sidebar */
        .sidebar { background: var(--bg-sidebar); color: var(--text-inverse); padding: 0; }
        .sidebar-header { padding: var(--spacing-xl); border-bottom: 1px solid var(--border-divider); }
        .sidebar-header h2 { font-size: 18px; }
        .sidebar-nav { padding: var(--spacing-md) 0; }

        /* Navigation Groups */
        .nav-group { padding: var(--spacing-sm) 0; }
        .nav-group-title {
            padding: var(--spacing-sm) var(--spacing-xl) 6px;
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .nav-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: var(--spacing-sm) var(--spacing-md);
        }

        .nav-item { display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md) var(--spacing-xl); color: var(--text-nav); text-decoration: none; font-size: 14px; transition: all var(--transition-fast); }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-inverse); }
        .nav-item.active { background: var(--color-accent-light); color: var(--color-accent); border-right: 3px solid var(--color-accent); }
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .nav-icon svg {
            width: 18px;
            height: 18px;
            stroke-width: 1.5;
        }
        .nav-item-home {
            margin-top: var(--spacing-sm);
        }

        /* Main Content */
        .main { padding: var(--spacing-2xl); overflow-y: auto; }
        .page-header { margin-bottom: var(--spacing-2xl); }
        .page-header h1 { font-size: 24px; color: var(--text-primary); margin-bottom: var(--spacing-sm); }
        .page-header p { color: var(--text-secondary); font-size: 14px; }

        /* Cards */
        .card { background: var(--bg-card); border-radius: var(--radius-xl); box-shadow: var(--shadow-sm); margin-bottom: var(--spacing-2xl); }
        .card-header { padding: var(--spacing-xl) var(--spacing-2xl); border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { font-size: 16px; color: var(--text-primary); }
        .card-body { padding: var(--spacing-2xl); }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--spacing-lg); margin-bottom: var(--spacing-2xl); }
        .stat-card { background: var(--bg-card); border-radius: var(--radius-xl); padding: var(--spacing-xl); box-shadow: var(--shadow-sm); position: relative; }
        .stat-card.clickable { cursor: pointer; transition: all var(--transition-fast); }
        .stat-card.clickable:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .stat-card .stat-link { font-size: 12px; color: var(--color-accent); margin-top: var(--spacing-sm); display: none; }
        .stat-card.clickable .stat-link { display: block; }
        .stat-value { font-size: 28px; font-weight: 600; color: var(--text-primary); }
        .stat-label { font-size: 13px; color: var(--text-muted); margin-top: var(--spacing-xs); }

        /* Table */
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: var(--spacing-md) var(--spacing-lg); text-align: left; border-bottom: 1px solid var(--border-light); }
        .table th { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .table td { font-size: 14px; color: var(--text-table); }
        .table tr:hover { background: var(--bg-table-hover); }

        /* Buttons */
        .btn { padding: var(--spacing-sm) var(--spacing-lg); border-radius: var(--radius-md); font-size: 13px; cursor: pointer; border: none; transition: all var(--transition-fast); }
        .btn-primary { background: var(--color-primary); color: var(--text-inverse); }
        .btn-primary:hover { background: var(--color-primary-hover); }
        .btn-success { background: var(--color-success); color: var(--text-inverse); }
        .btn-danger { background: var(--color-danger); color: var(--text-inverse); }
        .btn-sm { padding: var(--spacing-xs) var(--spacing-md); font-size: 12px; }

        /* Badge */
        .badge { padding: var(--spacing-xs) 10px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 500; }
        .badge-success { background: var(--badge-success-bg); color: var(--badge-success-text); }
        .badge-danger { background: var(--badge-danger-bg); color: var(--badge-danger-text); }
        .badge-info { background: var(--badge-info-bg); color: var(--badge-info-text); }
        .badge-warning { background: var(--badge-warning-bg); color: var(--badge-warning-text); }

        /* Form */
        .form-group { margin-bottom: var(--spacing-lg); }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-table); margin-bottom: 6px; }
        .form-input { width: 100%; padding: 10px var(--spacing-md); border: 1px solid var(--border-input); border-radius: var(--radius-md); font-size: 14px; }
        .form-input:focus { outline: none; border-color: var(--color-accent); }
        .form-select { width: 100%; padding: 10px var(--spacing-md); border: 1px solid var(--border-input); border-radius: var(--radius-md); font-size: 14px; background: var(--bg-input); }

        /* Tabs */
        .tabs { display: flex; gap: var(--spacing-xs); background: var(--bg-tabs); padding: var(--spacing-xs); border-radius: var(--radius-lg); margin-bottom: var(--spacing-xl); }
        .tab { padding: var(--spacing-sm) var(--spacing-lg); border: none; background: transparent; border-radius: var(--radius-md); font-size: 13px; cursor: pointer; }
        .tab.active { background: var(--bg-card); box-shadow: var(--shadow-sm); }

        /* Toggle */
        .toggle-item { display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md) 0; border-bottom: 1px solid var(--border-light); }
        .toggle-item:last-child { border-bottom: none; }
        .toggle-info h4 { font-size: 14px; font-weight: 500; margin-bottom: var(--spacing-xs); }
        .toggle-info p { font-size: 12px; color: var(--text-muted); margin: 0; }
        .toggle-switch { position: relative; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-disabled); transition: var(--transition-normal); border-radius: var(--radius-full); }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: var(--text-inverse); transition: var(--transition-normal); border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--color-accent); }
        input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* Category list */
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--spacing-sm); max-height: 400px; overflow-y: auto; padding-right: var(--spacing-sm); }
        .category-item { display: flex; align-items: center; justify-content: space-between; padding: 10px var(--spacing-md); background: var(--bg-category); border-radius: var(--radius-md); font-size: 13px; }
        .category-item.enabled { background: var(--bg-category-enabled); }
        .category-item code { font-family: monospace; color: var(--text-secondary); }
        .category-item input[type="checkbox"] { width: 16px; height: 16px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-card); border-radius: var(--radius-xl); width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: var(--spacing-xl) var(--spacing-2xl); border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; }
        .modal-close { font-size: 24px; cursor: pointer; color: var(--text-light); }
        .modal-body { padding: var(--spacing-2xl); }
        .modal-footer { padding: var(--spacing-lg) var(--spacing-2xl); border-top: 1px solid var(--border-light); display: flex; justify-content: flex-end; gap: var(--spacing-sm); }

        .toggle-list { max-height: 500px; overflow-y: auto; }
        .config-panel { animation: fadeIn var(--transition-fast) ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Mobile Header */
        .mobile-header { display: none; background: var(--bg-sidebar); color: var(--text-inverse); padding: var(--spacing-md) var(--spacing-lg); position: sticky; top: 0; z-index: 100; }
        .mobile-header-inner { display: flex; justify-content: space-between; align-items: center; }
        .mobile-header h2 { font-size: 16px; }

        /* Hamburger Menu Button */
        .mobile-menu-btn { display: none; width: 44px; height: 44px; background: transparent; border: none; cursor: pointer; padding: 10px; flex-direction: column; justify-content: center; align-items: center; gap: 5px; }
        .mobile-menu-btn span { display: block; width: 24px; height: 2px; background: var(--text-inverse); transition: all var(--transition-normal); border-radius: 2px; }
        .mobile-menu-btn.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .mobile-menu-btn.active span:nth-child(2) { opacity: 0; }
        .mobile-menu-btn.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }

        /* Mobile Overlay */
        .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; }
        .mobile-overlay.show { display: block; }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            .layout { grid-template-columns: 1fr; }

            .mobile-header { display: block; }
            .mobile-menu-btn { display: flex; }

            .sidebar {
                position: fixed;
                left: calc(var(--sidebar-mobile-width) * -1);
                top: 0;
                width: var(--sidebar-mobile-width);
                height: 100vh;
                z-index: 999;
                transition: left var(--transition-normal) ease;
                overflow-y: auto;
            }
            .sidebar.open { left: 0; }

            .main { padding: var(--spacing-lg); }
            .page-header h1 { font-size: 20px; }
            .page-header p { font-size: 13px; }

            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); }
            .stat-card { padding: var(--spacing-lg); }
            .stat-value { font-size: 22px; }

            .card-header { padding: var(--spacing-lg); flex-wrap: wrap; gap: var(--spacing-sm); }
            .card-header h3 { font-size: 14px; }
            .card-body { padding: var(--spacing-lg); overflow-x: auto; }

            .table { min-width: 600px; }

            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .tab { padding: var(--spacing-sm) var(--spacing-md); font-size: 12px; white-space: nowrap; }

            .category-grid { grid-template-columns: 1fr; }

            .form-group { margin-bottom: var(--spacing-md); }
            .form-input, .form-select { padding: var(--spacing-md); font-size: 16px; }

            .btn { padding: 10px 14px; }
            .btn-sm { padding: 6px 10px; font-size: 11px; }

            .modal-content { width: 100%; max-width: 100%; border-radius: 0; max-height: 100vh; }
            .modal-header { padding: var(--spacing-lg); }
            .modal-body { padding: var(--spacing-lg); }
        }

        /* ============================================
           Skeleton Loading Styles
           ============================================ */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: var(--radius-md);
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Stats Card Skeleton */
        .skeleton-stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
        }
        .skeleton-stat-value {
            width: 60%;
            height: 32px;
            margin-bottom: var(--spacing-sm);
        }
        .skeleton-stat-label {
            width: 40%;
            height: 16px;
        }

        /* Table Skeleton */
        .skeleton-table {
            width: 100%;
        }
        .skeleton-table-row {
            display: flex;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-light);
            gap: var(--spacing-md);
        }
        .skeleton-table-row:last-child {
            border-bottom: none;
        }
        .skeleton-cell {
            height: 16px;
            flex: 1;
        }
        .skeleton-cell-sm {
            flex: 0.5;
        }
        .skeleton-cell-lg {
            flex: 1.5;
        }

        /* Card Content Skeleton */
        .skeleton-card-header {
            padding: var(--spacing-xl) var(--spacing-2xl);
            border-bottom: 1px solid var(--border-light);
        }
        .skeleton-card-title {
            width: 200px;
            height: 20px;
        }
        .skeleton-card-body {
            padding: var(--spacing-2xl);
        }
        .skeleton-line {
            height: 14px;
            margin-bottom: var(--spacing-md);
        }
        .skeleton-line:last-child {
            width: 60%;
            margin-bottom: 0;
        }

        /* List Item Skeleton */
        .skeleton-list-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
            gap: var(--spacing-md);
        }
        .skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .skeleton-content {
            flex: 1;
        }
        .skeleton-title {
            width: 70%;
            height: 16px;
            margin-bottom: var(--spacing-sm);
        }
        .skeleton-text {
            width: 50%;
            height: 12px;
        }

        /* ============================================
           Table Enhancement Styles
           ============================================ */
        /* Sortable Table Headers */
        .table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 24px;
        }
        .table th.sortable:hover {
            color: var(--text-primary);
        }
        .table th.sortable::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid var(--text-muted);
            opacity: 0.3;
            transition: opacity var(--transition-fast);
        }
        .table th.sortable:hover::after {
            opacity: 0.6;
        }
        .table th.sortable.asc::after {
            border-top: none;
            border-bottom: 4px solid var(--color-accent);
            opacity: 1;
        }
        .table th.sortable.desc::after {
            border-top: 4px solid var(--color-accent);
            opacity: 1;
        }

        /* Table Footer / Pagination */
        .table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--border-light);
            font-size: 13px;
            color: var(--text-muted);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        .pagination {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        .pagination-btn {
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-input);
            border-radius: var(--radius-md);
            background: var(--bg-card);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 13px;
        }
        .pagination-btn:hover:not(:disabled) {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-btn.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--text-inverse);
        }
        .pagination-btn svg {
            width: 16px;
            height: 16px;
        }
        .page-size-select {
            padding: 6px var(--spacing-sm);
            border: 1px solid var(--border-input);
            border-radius: var(--radius-md);
            font-size: 13px;
            background: var(--bg-card);
            cursor: pointer;
        }

        /* Empty State */
        .empty-state {
            padding: 48px var(--spacing-2xl);
            text-align: center;
            color: var(--text-muted);
        }
        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--spacing-lg);
            opacity: 0.5;
        }
        .empty-state-icon svg {
            width: 64px;
            height: 64px;
        }
        .empty-state-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }
        .empty-state-desc {
            font-size: 14px;
            margin-bottom: var(--spacing-lg);
        }

        /* Bulk Actions Bar */
        .bulk-actions {
            display: none;
            padding: var(--spacing-md) var(--spacing-lg);
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-md);
        }
        .bulk-actions.show {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }
        .bulk-actions-text {
            font-size: 13px;
            color: var(--color-info);
        }
        .bulk-actions-text strong {
            font-weight: 600;
        }

        /* Selected Row */
        .table tr.selected {
            background: #ecfdf5;
        }
        .table tr.selected:hover {
            background: #d1fae5;
        }

        /* Checkbox Column */
        .table .checkbox-col {
            width: 40px;
        }
        .table .checkbox-col input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* ============================================
           Form Enhancement Styles
           ============================================ */
        /* Form Validation States */
        .form-label.required::after {
            content: '*';
            color: var(--color-danger);
            margin-left: 4px;
        }
        .form-input.error {
            border-color: var(--color-danger);
        }
        .form-input.success {
            border-color: var(--color-success);
            padding-right: 36px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2310b981' stroke-width='2'%3E%3Cpath d='M20 6L9 17l-5-5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }
        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .form-error {
            font-size: 12px;
            color: var(--color-danger);
            margin-top: 4px;
            display: none;
        }
        .form-group.has-error .form-error {
            display: block;
        }
        .form-group.has-error .form-input {
            border-color: var(--color-danger);
        }
        .form-group.has-success .form-input {
            border-color: var(--color-success);
        }

        /* Password Strength Indicator */
        .password-strength {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }
        .password-strength-bar {
            flex: 1;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            transition: background var(--transition-fast);
        }
        .password-strength-bar.weak {
            background: var(--color-danger);
        }
        .password-strength-bar.medium {
            background: var(--color-warning);
        }
        .password-strength-bar.strong {
            background: var(--color-success);
        }
        .password-strength-text {
            font-size: 11px;
            margin-top: 4px;
        }
        .password-strength-text.weak {
            color: var(--color-danger);
        }
        .password-strength-text.medium {
            color: var(--color-warning);
        }
        .password-strength-text.strong {
            color: var(--color-success);
        }

        /* Character Counter */
        .char-counter {
            font-size: 11px;
            color: var(--text-muted);
            text-align: right;
            margin-top: 2px;
        }
        .char-counter.warning {
            color: var(--color-warning);
        }
        .char-counter.error {
            color: var(--color-danger);
        }

        /* Loading Button State */
        .btn.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }
        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: btn-spin 0.6s linear infinite;
            left: 50%;
            top: 50%;
            margin: -8px 0 0 -8px;
        }
        @keyframes btn-spin {
            to { transform: rotate(360deg); }
        }

        /* Form Feedback */
        .form-feedback {
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            display: none;
        }
        .form-feedback.show {
            display: block;
        }
        .form-feedback.success {
            background: var(--badge-success-bg);
            color: var(--badge-success-text);
            border: 1px solid var(--badge-success-text);
        }
        .form-feedback.error {
            background: var(--badge-danger-bg);
            color: var(--badge-danger-text);
            border: 1px solid var(--badge-danger-text);
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="mobile-header-inner">
            <h2>管理后台</h2>
            <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </div>

    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>

    <div class="layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>管理后台</h2>
            </div>
            <nav class="sidebar-nav">
                <!-- 概览 -->
                <div class="nav-group">
                    <div class="nav-group-title">概览</div>
                    <a href="#" class="nav-item active" data-section="dashboard">
                        <span class="nav-icon"><i data-lucide="layout-dashboard"></i></span>
                        <span>仪表盘</span>
                    </a>
                </div>

                <!-- 数据管理 -->
                <div class="nav-group">
                    <div class="nav-group-title">数据管理</div>
                    <a href="#" class="nav-item" data-section="sources">
                        <span class="nav-icon"><i data-lucide="database"></i></span>
                        <span>数据源管理</span>
                    </a>
                    <a href="#" class="nav-item" data-section="crawlers">
                        <span class="nav-icon"><i data-lucide="webhook"></i></span>
                        <span>抓取配置</span>
                    </a>
                </div>

                <!-- 内容处理 -->
                <div class="nav-group">
                    <div class="nav-group-title">内容处理</div>
                    <a href="#" class="nav-item" data-section="ai">
                        <span class="nav-icon"><i data-lucide="bot"></i></span>
                        <span>AI 配置</span>
                    </a>
                    <a href="#" class="nav-item" data-section="embedding">
                        <span class="nav-icon"><i data-lucide="brain"></i></span>
                        <span>向量嵌入</span>
                    </a>
                    <a href="#" class="nav-item" data-section="events">
                        <span class="nav-icon"><i data-lucide="newspaper"></i></span>
                        <span>事件管理</span>
                    </a>
                    <a href="#" class="nav-item" data-section="topics">
                        <span class="nav-icon"><i data-lucide="tags"></i></span>
                        <span>主题管理</span>
                    </a>
                </div>

                <!-- 用户与权限 -->
                <div class="nav-group">
                    <div class="nav-group-title">用户与权限</div>
                    <a href="#" class="nav-item" data-section="users">
                        <span class="nav-icon"><i data-lucide="users"></i></span>
                        <span>用户管理</span>
                    </a>
                    <a href="#" class="nav-item" data-section="roles">
                        <span class="nav-icon"><i data-lucide="shield"></i></span>
                        <span>角色管理</span>
                    </a>
                    <a href="#" class="nav-item" data-section="audit">
                        <span class="nav-icon"><i data-lucide="clipboard-list"></i></span>
                        <span>审计日志</span>
                    </a>
                </div>

                <!-- 系统运维 -->
                <div class="nav-group">
                    <div class="nav-group-title">系统运维</div>
                    <a href="#" class="nav-item" data-section="email">
                        <span class="nav-icon"><i data-lucide="mail"></i></span>
                        <span>邮件推送</span>
                    </a>
                    <a href="#" class="nav-item" data-section="reports">
                        <span class="nav-icon"><i data-lucide="file-text"></i></span>
                        <span>报告管理</span>
                    </a>
                    <a href="#" class="nav-item" data-section="backups">
                        <span class="nav-icon"><i data-lucide="hard-drive"></i></span>
                        <span>备份管理</span>
                    </a>
                    <a href="#" class="nav-item" data-section="config">
                        <span class="nav-icon"><i data-lucide="settings"></i></span>
                        <span>系统配置</span>
                    </a>
                    <a href="#" class="nav-item" data-section="pipeline">
                        <span class="nav-icon"><i data-lucide="git-branch"></i></span>
                        <span>Pipeline 监控</span>
                    </a>
                </div>

                <!-- 返回首页 -->
                <div class="nav-divider"></div>
                <a href="#" class="nav-item nav-item-home" onclick="location.href=APP_BASE+'/'; return false;">
                    <span class="nav-icon"><i data-lucide="home"></i></span>
                    <span>返回首页</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main">
            <!-- Dashboard Section -->
            <div id="section-dashboard" class="section">
                <div class="page-header">
                    <h1>仪表盘</h1>
                    <p>系统概览和统计数据</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-users">0</div>
                        <div class="stat-label">注册用户</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-articles">0</div>
                        <div class="stat-label">文章总数</div>
                    </div>
                    <div class="stat-card clickable" onclick="switchSection('sources')">
                        <div class="stat-value" id="stat-sources">0</div>
                        <div class="stat-label">数据源</div>
                        <div class="stat-link">查看详情 →</div>
                    </div>
                    <div class="stat-card clickable" onclick="showSubscriptionsModal()">
                        <div class="stat-value" id="stat-subscriptions">0</div>
                        <div class="stat-label">用户订阅</div>
                        <div class="stat-link">查看详情 →</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>最近抓取的文章</h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>标题</th>
                                    <th>来源</th>
                                    <th>分类</th>
                                    <th>抓取时间</th>
                                </tr>
                            </thead>
                            <tbody id="recent-articles"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Subscriptions Detail Modal -->
                <div class="modal" id="subscriptions-modal">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h2>用户订阅统计</h2>
                            <button class="modal-close" onclick="document.getElementById('subscriptions-modal').style.display='none'">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="subscriptions-detail">
                                <div style="text-align:center;padding:20px;color:#888;">加载中...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sources Section -->
            <div id="section-sources" class="section" style="display:none;">
                <div class="page-header">
                    <h1>数据源管理</h1>
                    <p>管理 ArXiv 分类、RSS 源、微信公众号和微博热搜</p>
                </div>

                <div class="stats-grid" id="sources-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-arxiv-total">0</div>
                        <div class="stat-label">ArXiv 分类总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-arxiv-active">0</div>
                        <div class="stat-label">ArXiv 活跃分类</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-rss-total">0</div>
                        <div class="stat-label">RSS 源总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-rss-active">0</div>
                        <div class="stat-label">RSS 活跃源</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-weibo-total">0</div>
                        <div class="stat-label">微博榜单总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-weibo-active">0</div>
                        <div class="stat-label">微博活跃榜单</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-hackernews-total">0</div>
                        <div class="stat-label">HackerNews 板块总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-hackernews-active">0</div>
                        <div class="stat-label">HackerNews 活跃板块</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-reddit-total">0</div>
                        <div class="stat-label">Reddit 订阅源总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-reddit-active">0</div>
                        <div class="stat-label">Reddit 活跃源</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-twitter-total">0</div>
                        <div class="stat-label">Twitter 用户总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-twitter-active">0</div>
                        <div class="stat-label">Twitter 活跃用户</div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchSourceTab('arxiv')">ArXiv 分类</button>
                    <button class="tab" onclick="switchSourceTab('rss')">RSS 源</button>
                    <button class="tab" onclick="switchSourceTab('wechat')">微信公众号</button>
                    <button class="tab" onclick="switchSourceTab('weibo')">微博热搜</button>
                    <button class="tab" onclick="switchSourceTab('pending')">待审批 RSS</button>
                    <button class="tab" onclick="switchSourceTab('hackernews')">HackerNews</button>
                    <button class="tab" onclick="switchSourceTab('reddit')">Reddit</button>
                    <button class="tab" onclick="switchSourceTab('twitter')">Twitter</button>
                </div>

                <!-- ArXiv Categories -->
                <div id="source-arxiv" class="source-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3>ArXiv 分类管理</h3>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="batchToggleArxiv(true)">批量启用</button>
                                <button class="btn btn-sm" onclick="batchToggleArxiv(false)">批量禁用</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <input type="text" class="form-input" id="arxiv-search" placeholder="搜索分类代码或名称..." oninput="loadArxivCategories()">
                            </div>
                            <div id="arxiv-list" style="max-height: 500px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>

                <!-- RSS Feeds -->
                <div id="source-rss" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>RSS 源管理</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddRssModal()">添加 RSS 源</button>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                <input type="text" class="form-input" id="rss-search" placeholder="搜索..." style="flex: 1;" oninput="loadRssFeeds()">
                                <select class="form-select" id="rss-category-filter" style="width: 150px;" onchange="loadRssFeeds()">
                                    <option value="">全部分类</option>
                                </select>
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="rss-select-all" onchange="toggleSelectAll('rss')"></th>
                                        <th>标题</th>
                                        <th>分类</th>
                                        <th>状态</th>
                                        <th>最后抓取</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="rss-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- WeChat Accounts -->
                <div id="source-wechat" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>微信公众号管理</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddWechatModal()">添加公众号</button>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>名称</th>
                                        <th>账号 ID</th>
                                        <th>状态</th>
                                        <th>最后抓取</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="wechat-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Weibo Hot Search -->
                <div id="source-weibo" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>微博热搜榜单管理</h3>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="batchToggleWeibo(true)">批量启用</button>
                                <button class="btn btn-sm" onclick="batchToggleWeibo(false)">批量禁用</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 4px; font-size: 13px;">
                                <strong>说明：</strong>热搜榜为公开接口，无需登录即可抓取。其他榜单（要闻、文娱、体育、游戏）需要配置微博登录 Cookie。
                                <br>请在系统配置中设置 <code>WEIBO_COOKIE</code> 环境变量，格式为 <code>SUB=xxx; SUBP=xxx; ...</code>
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="weibo-select-all" onchange="toggleSelectAll('weibo')"></th>
                                        <th>榜单名称</th>
                                        <th>榜单类型</th>
                                        <th>认证要求</th>
                                        <th>状态</th>
                                        <th>最后抓取</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="weibo-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- HackerNews -->
                <div id="source-hackernews" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>HackerNews 板块管理</h3>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="batchToggleHackerNews(true)">批量启用</button>
                                <button class="btn btn-sm" onclick="batchToggleHackerNews(false)">批量禁用</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 4px; font-size: 13px;">
                                <strong>说明：</strong>HackerNews 提供公开 API，无需认证即可抓取。支持的板块包括 Top Stories、New Stories、Best Stories、Ask HN、Show HN、Jobs 等。
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="hackernews-select-all" onchange="toggleSelectAll('hackernews')"></th>
                                        <th>板块名称</th>
                                        <th>板块类型</th>
                                        <th>状态</th>
                                        <th>最后抓取</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="hackernews-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reddit -->
                <div id="source-reddit" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>Reddit 订阅源管理</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddRedditModal()">添加 Reddit 源</button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 4px; font-size: 13px;">
                                <strong>说明：</strong>Reddit 使用公开 RSS 接口，无需 API 密钥。支持订阅 subreddit，格式如 <code>programming</code> 或 <code>r/programming</code>。
                            </div>
                            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                <input type="text" class="form-input" id="reddit-search" placeholder="搜索 subreddit..." style="flex: 1;" oninput="loadRedditSources()">
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="reddit-select-all" onchange="toggleSelectAll('reddit')"></th>
                                        <th>Subreddit</th>
                                        <th>描述</th>
                                        <th>状态</th>
                                        <th>最后抓取</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="reddit-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Twitter -->
                <div id="source-twitter" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>Twitter 用户订阅管理</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddTwitterModal()">添加 Twitter 用户</button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 4px; font-size: 13px;">
                                <strong>说明：</strong>Twitter 数据抓取需要配置 API 凭证。请在系统配置中设置 <code>TWITTER_BEARER_TOKEN</code> 或 <code>TWITTER_API_KEY</code> 等环境变量。
                            </div>
                            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                <input type="text" class="form-input" id="twitter-search" placeholder="搜索用户名..." style="flex: 1;" oninput="loadTwitterSources()">
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="twitter-select-all" onchange="toggleSelectAll('twitter')"></th>
                                        <th>用户名</th>
                                        <th>显示名称</th>
                                        <th>状态</th>
                                        <th>最后抓取</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="twitter-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pending RSS -->
                <div id="source-pending" class="source-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>待审批 RSS 源</h3>
                            <span style="color: #888; font-size: 13px;">用户提交的 RSS 源，审核通过后将加入抓取列表</span>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>标题</th>
                                        <th>Feed URL</th>
                                        <th>提交时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="pending-rss-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crawlers Section -->
            <div id="section-crawlers" class="section" style="display:none;">
                <div class="page-header">
                    <h1>抓取配置</h1>
                    <p>配置数据源和抓取规则</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchCrawlerTab('arxiv')">ArXiv 类目</button>
                    <button class="tab" onclick="switchCrawlerTab('rss')">RSS 源</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 id="crawler-title">ArXiv 类目配置</h3>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="saveCrawlConfig()">保存配置</button>
                            <button class="btn btn-success btn-sm" onclick="triggerCrawl()">立即抓取</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="auto-subscribe" checked>
                                用户订阅后自动启用类目抓取
                            </label>
                        </div>
                        <p style="font-size: 12px; color: #888; margin-bottom: 16px;">
                            勾选的类目会定期抓取。默认抓取: cs.LG, cs.CV, cs.IR, cs.CL, cs.DC
                        </p>
                        <div id="crawler-list"></div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="section-users" class="section" style="display:none;">
                <div class="page-header">
                    <h1>用户管理</h1>
                    <p>管理系统用户和权限</p>
                </div>

                <!-- 搜索筛选栏 -->
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-body" style="padding: 12px 16px;">
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                            <input type="text" id="user-search-input" placeholder="搜索用户名/邮箱" 
                                class="form-input" style="max-width: 200px;" 
                                onkeypress="if(event.key==='Enter')searchUsers()">
                            <select id="user-role-filter" class="form-select" style="max-width: 120px;" onchange="searchUsers()">
                                <option value="">全部角色</option>
                            </select>
                            <select id="user-status-filter" class="form-select" style="max-width: 120px;" onchange="searchUsers()">
                                <option value="">全部状态</option>
                                <option value="true">已激活</option>
                                <option value="false">已禁用</option>
                            </select>
                            <button class="btn btn-primary" onclick="searchUsers()">搜索</button>
                            <button class="btn btn-secondary" onclick="resetUserSearch()">重置</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户名</th>
                                    <th>邮箱</th>
                                    <th>角色</th>
                                    <th>状态</th>
                                    <th>注册时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="user-list"></tbody>
                        </table>
                    </div>
                </div>

                <!-- 用户分页 -->
                <div class="pagination" id="user-pagination" style="display:none;"></div>
            </div>

            <!-- Email Section -->
            <div id="section-email" class="section" style="display:none;">
                <div class="page-header">
                    <h1>邮件推送</h1>
                    <p>配置邮件推送功能，支持多种邮件后端和多配置优先级failover</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchEmailTab('general')">推送设置</button>
                    <button class="tab" onclick="switchEmailTab('configs')">配置列表</button>
                </div>

                <!-- General Settings -->
                <div id="email-general-panel" class="email-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3>全局推送设置</h3>
                        </div>
                        <div class="card-body">
                            <div class="toggle-item">
                                <div class="toggle-info">
                                    <h4>启用邮件推送</h4>
                                    <p>定期向用户推送订阅的新文章</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="email-enabled">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="form-group" style="margin-top: 16px;">
                                <label class="form-label">推送频率</label>
                                <select class="form-select" id="email-frequency">
                                    <option value="daily">每天</option>
                                    <option value="weekly">每周</option>
                                    <option value="instant">实时</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">推送时间</label>
                                <input type="time" class="form-input" id="email-time" value="09:00">
                            </div>

                            <div class="form-group">
                                <label class="form-label">每封邮件最大文章数</label>
                                <input type="number" class="form-input" id="email-max-articles" value="20">
                            </div>

                            <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                                <p style="font-size: 13px; color: #0369a1; margin: 0;">
                                    💡 <strong>优先级机制：</strong>系统按优先级顺序尝试发送邮件，优先使用数字小的配置。如果发送失败，自动切换到下一个配置，直到成功或全部失败。
                                </p>
                            </div>

                            <button class="btn btn-primary" onclick="saveEmailSettings()">保存设置</button>
                        </div>
                    </div>
                </div>

                <!-- Configurations List -->
                <div id="email-configs-panel" class="email-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>邮件发送配置</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddEmailConfigModal()">新建配置</button>
                        </div>
                        <div class="card-body">
                            <!-- Filter -->
                            <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center;">
                                <select class="form-select" id="email-config-filter" style="width: auto;" onchange="loadEmailConfigs()">
                                    <option value="">全部类型</option>
                                    <option value="smtp">SMTP</option>
                                    <option value="sendgrid">SendGrid</option>
                                    <option value="mailgun">Mailgun</option>
                                    <option value="brevo">Brevo</option>
                                </select>
                            </div>

                            <!-- Config List Table -->
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>优先级</th>
                                        <th>名称</th>
                                        <th>类型</th>
                                        <th>发件邮箱</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="email-config-list">
                                    <tr><td colspan="6">加载中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Configuration Section -->
            <div id="section-ai" class="section" style="display:none;">
                <div class="page-header">
                    <h1>AI 配置</h1>
                    <p>配置 AI 处理器，支持 Ollama、OpenAI、Claude</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchAITab('general')">通用设置</button>
                    <button class="tab" onclick="switchAITab('ollama')">Ollama</button>
                    <button class="tab" onclick="switchAITab('openai')">OpenAI</button>
                    <button class="tab" onclick="switchAITab('claude')">Claude</button>
                </div>

                <!-- General Settings -->
                <div id="ai-general-panel" class="ai-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3>通用设置</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">AI Provider</label>
                                <select class="form-select" id="ai-provider">
                                    <option value="ollama">Ollama (本地)</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="claude">Claude</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="ai-cache-enabled" checked>
                                    启用缓存
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">缓存 TTL（秒）</label>
                                <input type="number" class="form-input" id="ai-cache-ttl" value="86400">
                            </div>
                            <div class="form-group">
                                <label class="form-label">最大内容长度</label>
                                <input type="number" class="form-input" id="ai-max-content" value="1500">
                            </div>
                            <div class="form-group">
                                <label class="form-label">最大标题长度</label>
                                <input type="number" class="form-input" id="ai-max-title" value="200">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="ai-thinking-enabled">
                                    启用思考模式（通用）
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="ai-concurrent-enabled">
                                    启用并发处理
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="ai-no-think">
                                    模型禁用思考 (/no_think)
                                </label>
                                <small style="color:#888; display:block; margin-top:2px;">适用于 qwen3 等支持 thinking 的模型，在 prompt 前插入 /no_think 指令以减少 token 消耗</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">最大生成 Token 数</label>
                                <input type="number" class="form-input" id="ai-num-predict" value="512" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">简单任务 Token 数</label>
                                <input type="number" class="form-input" id="ai-num-predict-simple" value="256" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">最大重试次数</label>
                                <input type="number" class="form-input" id="ai-max-retries" value="3" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">重试基础延迟（秒）</label>
                                <input type="number" class="form-input" id="ai-retry-base-delay" value="1.0" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">批处理并发度</label>
                                <input type="number" class="form-input" id="ai-batch-concurrency" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">降级回退 Provider</label>
                                <input type="text" class="form-input" id="ai-fallback-provider" placeholder="如 openai（留空则不回退）">
                            </div>
                            <div class="form-group">
                                <label class="form-label">重型任务 Worker 数</label>
                                <input type="number" class="form-input" id="ai-workers-heavy" value="2" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">筛选任务 Worker 数</label>
                                <input type="number" class="form-input" id="ai-workers-screen" value="4" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">翻译最大 Token 数</label>
                                <input type="number" class="form-input" id="ai-translate-max-tokens" value="4096" min="1">
                                <small style="color:#888; display:block; margin-top:2px;">英文摘要自动翻译为中文时的最大输出 token 限制</small>
                            </div>
                            <button class="btn btn-primary" onclick="saveAIGeneral()">保存设置</button>
                            <button class="btn" onclick="testAIConnection()">测试连接</button>
                        </div>
                    </div>
                </div>

                <!-- Ollama Settings -->
                <div id="ai-ollama-panel" class="ai-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>Ollama 配置</h3>
                        </div>
                        <div class="card-body">
                            <p style="color: #888; margin-bottom: 16px;">
                                API Key 可在此处配置，也可通过环境变量 OLLAMA_API_KEY 设置（推荐）
                            </p>
                            <div class="form-group">
                                <label class="form-label">Base URL</label>
                                <input type="text" class="form-input" id="ai-ollama-url" value="http://localhost:11434">
                            </div>
                            <div class="form-group">
                                <label class="form-label">主模型</label>
                                <input type="text" class="form-input" id="ai-ollama-model" value="qwen3:32b">
                            </div>
                            <div class="form-group">
                                <label class="form-label">轻量模型（可选）</label>
                                <input type="text" class="form-input" id="ai-ollama-model-light" placeholder="用于简单任务">
                            </div>
                            <div class="form-group">
                                <label class="form-label">超时时间（秒）</label>
                                <input type="number" class="form-input" id="ai-ollama-timeout" value="120">
                            </div>
                            <div class="form-group">
                                <label class="form-label">API Key（可选）</label>
                                <input type="password" class="form-input" id="ai-ollama-api-key" placeholder="留空则不使用认证">
                            </div>
                            <button class="btn btn-primary" onclick="saveAIOllama()">保存配置</button>
                        </div>
                    </div>
                </div>

                <!-- OpenAI Settings -->
                <div id="ai-openai-panel" class="ai-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>OpenAI 配置</h3>
                        </div>
                        <div class="card-body">
                            <p style="color: #888; margin-bottom: 16px;">
                                API Key 可在此处配置，也可通过环境变量 OPENAI_API_KEY 设置（推荐）
                            </p>
                            <div class="form-group">
                                <label class="form-label">API Key</label>
                                <input type="password" class="form-input" id="ai-openai-api-key" placeholder="sk-...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Base URL</label>
                                <input type="text" class="form-input" id="ai-openai-base-url" placeholder="https://api.openai.com/v1">
                                <small style="color: #666;">用于代理或兼容 API（如 Azure OpenAI）</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">主模型</label>
                                <input type="text" class="form-input" id="ai-openai-model" value="gpt-4o">
                            </div>
                            <div class="form-group">
                                <label class="form-label">轻量模型</label>
                                <input type="text" class="form-input" id="ai-openai-model-light" value="gpt-4o-mini">
                            </div>
                            <div class="form-group">
                                <label class="form-label">超时时间（秒）</label>
                                <input type="number" class="form-input" id="ai-openai-timeout" value="60">
                            </div>
                            <button class="btn btn-primary" onclick="saveAIOpenAI()">保存配置</button>
                        </div>
                    </div>
                </div>

                <!-- Claude Settings -->
                <div id="ai-claude-panel" class="ai-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>Claude 配置</h3>
                        </div>
                        <div class="card-body">
                            <p style="color: #888; margin-bottom: 16px;">
                                API Key 可在此处配置，也可通过环境变量 ANTHROPIC_API_KEY 设置（推荐）
                            </p>
                            <div class="form-group">
                                <label class="form-label">API Key</label>
                                <input type="password" class="form-input" id="ai-claude-api-key" placeholder="sk-ant-...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">主模型</label>
                                <input type="text" class="form-input" id="ai-claude-model" value="claude-sonnet-4-20250514">
                            </div>
                            <div class="form-group">
                                <label class="form-label">轻量模型</label>
                                <input type="text" class="form-input" id="ai-claude-model-light" value="claude-haiku-4-20250514">
                            </div>
                            <div class="form-group">
                                <label class="form-label">超时时间（秒）</label>
                                <input type="number" class="form-input" id="ai-claude-timeout" value="60">
                            </div>
                            <button class="btn btn-primary" onclick="saveAIClaude()">保存配置</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Embedding Section -->
            <div id="section-embedding" class="section" style="display:none;">
                <div class="page-header">
                    <h1>向量嵌入</h1>
                    <p>管理向量嵌入配置和统计</p>
                </div>

                <div class="stats-grid" id="embedding-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-embedding-total">-</div>
                        <div class="stat-label">总文章数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-embedding-computed">-</div>
                        <div class="stat-label">已嵌入数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-embedding-missing">-</div>
                        <div class="stat-label">未嵌入数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-embedding-provider">-</div>
                        <div class="stat-label">Provider</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>嵌入配置</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Provider</label>
                            <select class="form-select" id="embedding-provider">
                                <option value="sentence-transformers">sentence-transformers</option>
                                <option value="openai">OpenAI</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">模型</label>
                            <input type="text" class="form-input" id="embedding-model" value="all-MiniLM-L6-v2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">相似度阈值</label>
                            <input type="number" class="form-input" id="embedding-threshold" value="0.85" step="0.01">
                        </div>
                        <button class="btn btn-primary" onclick="saveEmbeddingConfig()">保存配置</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Milvus 配置</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 12px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Host</label>
                                <input type="text" class="form-input" id="milvus-host" value="localhost">
                            </div>
                            <div class="form-group" style="width: 120px;">
                                <label class="form-label">Port</label>
                                <input type="number" class="form-input" id="milvus-port" value="19530">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Collection</label>
                            <input type="text" class="form-input" id="milvus-collection" value="article_embeddings">
                        </div>
                        <button class="btn btn-primary" onclick="saveMilvusConfig()">保存配置</button>
                        <button class="btn" onclick="testMilvusConnection()">测试连接</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>批量操作</h3>
                    </div>
                    <div class="card-body">
                        <p style="margin-bottom: 16px; color: #666;">
                            重新计算嵌入向量可能会消耗较多时间和资源。
                        </p>
                        <button class="btn" onclick="recomputeMissingEmbeddings()">计算缺失嵌入</button>
                        <button class="btn btn-danger" style="margin-left: 8px;" onclick="recomputeAllEmbeddings()">全部重新计算</button>
                    </div>
                </div>
            </div>

            <!-- Events Section -->
            <div id="section-events" class="section" style="display:none;">
                <div class="page-header">
                    <h1>事件管理</h1>
                    <p>管理事件聚类，查看、编辑、合并相关文章</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchEventTab('list')">事件列表</button>
                    <button class="tab" onclick="switchEventTab('config')">聚类配置</button>
                </div>

                <div id="event-list-panel" class="event-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3>事件列表</h3>
                            <span id="event-total" style="color: #888; font-size: 13px;">共 0 个事件</span>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                <input type="text" class="form-input" id="event-search" placeholder="搜索事件..." style="flex: 1;" oninput="loadEvents()">
                                <select class="form-select" id="event-active-filter" style="width: 120px;" onchange="loadEvents()">
                                    <option value="">全部状态</option>
                                    <option value="true">活跃</option>
                                    <option value="false">不活跃</option>
                                </select>
                                <button class="btn btn-primary" onclick="mergeSelectedEvents()">合并选中</button>
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="event-select-all" onchange="toggleEventSelectAll()"></th>
                                        <th>标题</th>
                                        <th>分类</th>
                                        <th>文章数</th>
                                        <th>最后更新</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="event-list">
                                    <tr><td colspan="7">加载中...</td></tr>
                                </tbody>
                            </table>
                            <div id="event-pagination" style="margin-top: 16px; display: flex; justify-content: center; gap: 8px;"></div>
                        </div>
                    </div>
                </div>

                <div id="event-config-panel" class="event-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>聚类配置</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">规则权重</label>
                                <input type="number" class="form-input" id="event-rule-weight" value="0.4" step="0.1" min="0" max="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">语义权重</label>
                                <input type="number" class="form-input" id="event-semantic-weight" value="0.6" step="0.1" min="0" max="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">最小相似度</label>
                                <input type="number" class="form-input" id="event-min-similarity" value="0.7" step="0.05" min="0" max="1">
                            </div>
                            <button class="btn btn-primary" onclick="saveEventConfig()">保存配置</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Topics Section -->
            <div id="section-topics" class="section" style="display:none;">
                <div class="page-header">
                    <h1>主题管理</h1>
                    <p>管理研究主题，支持手动创建和自动发现</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>主题列表</h3>
                        <button class="btn btn-primary btn-sm" onclick="showAddTopicModal()">创建主题</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>主题名称</th>
                                    <th>类型</th>
                                    <th>关键词</th>
                                    <th>文章数</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="topic-list">
                                <tr><td colspan="6">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="section-reports" class="section" style="display:none;">
                <div class="page-header">
                    <h1>报告管理</h1>
                    <p>生成和管理研究报告</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>生成报告</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">报告类型</label>
                                <select class="form-select" id="report-type">
                                    <option value="weekly">周报</option>
                                    <option value="monthly">月报</option>
                                </select>
                            </div>
                            <div class="form-group" style="display: flex; align-items: flex-end;">
                                <button class="btn btn-primary" onclick="generateReport()">生成报告</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>报告列表</h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>报告名称</th>
                                    <th>类型</th>
                                    <th>时间范围</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="report-list">
                                <tr><td colspan="5">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Config Section -->
            <div id="section-config" class="section" style="display:none;">
                <div class="page-header">
                    <h1>系统配置</h1>
                    <p>管理系统参数和功能设置</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchConfigTab('retention')">数据保留</button>
                    <button class="tab" onclick="switchConfigTab('scheduler')">调度设置</button>
                    <button class="tab" onclick="switchConfigTab('pipeline')">Pipeline 管理</button>
                    <button class="tab" onclick="switchConfigTab('features')">功能开关</button>
                    <button class="tab" onclick="switchConfigTab('advanced')">高级设置</button>
                </div>

                <!-- Retention Config -->
                <div id="config-retention-panel" class="config-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3>数据保留设置</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">文章保留天数</label>
                                <input type="number" class="form-input" id="config-retention-active-days" value="7">
                                <p style="font-size: 12px; color: #888; margin-top: 4px;">超过此天数的文章将被清理</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">备份保留天数</label>
                                <input type="number" class="form-input" id="config-retention-archive-days" value="30">
                                <p style="font-size: 12px; color: #888; margin-top: 4px;">备份数据保留时间</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="config-backup-enabled" checked>
                                    启用自动备份
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="saveConfigGroup('retention')">保存配置</button>
                        </div>
                    </div>
                </div>

                <!-- Scheduler Config -->
                <div id="config-scheduler-panel" class="config-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>基础调度设置</h3>
                            <span style="color:#888;font-size:13px;">爬取、清理、备份、邮件通知的调度配置（Pipeline 相关配置在「Pipeline 管理」中）</span>
                        </div>
                        <div class="card-body">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                <div class="form-group">
                                    <label class="form-label">爬取间隔（小时）</label>
                                    <input type="number" class="form-input" id="config-crawl-interval" value="6" min="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">爬取基准时间（小时，0-23）</label>
                                    <input type="number" class="form-input" id="config-crawl-base-hour" value="0" min="0" max="23">
                                    <small class="form-hint">如设为 23 且间隔 6h，则在 23:00、05:00、11:00、17:00 执行</small>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">数据清理时间（小时，0-23）</label>
                                    <input type="number" class="form-input" id="config-cleanup-hour" value="3">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">备份时间（小时，0-23）</label>
                                    <input type="number" class="form-input" id="config-backup-hour" value="4">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">邮件通知时间（小时，0-23）</label>
                                    <input type="number" class="form-input" id="config-notification-hour" value="9" min="0" max="23">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">邮件通知时间（分钟，0-59）</label>
                                    <input type="number" class="form-input" id="config-notification-minute" value="0" min="0" max="59">
                                </div>
                            </div>
                            <button class="btn btn-primary" style="margin-top:12px;" onclick="saveConfigGroup('scheduler')">保存配置</button>
                        </div>
                    </div>
                </div>

                <!-- Pipeline Config -->
                <div id="config-pipeline-panel" class="config-panel" style="display:none;">
                    <div class="page-header" style="margin-bottom:16px;">
                        <h3 style="margin:0;">Pipeline 功能管理</h3>
                        <span style="color:#888;font-size:13px;">管理 Pipeline 各模块的功能开关、调度配置和手动触发</span>
                    </div>

                    <!-- Pipeline Modules -->
                    <div id="pipeline-modules-container">
                        <div style="text-align:center;color:#888;padding:40px;">加载中...</div>
                    </div>

                    <!-- Worker Config -->
                    <div class="card" style="margin-top:16px;">
                        <div class="card-header">
                            <h3>Worker 配置</h3>
                        </div>
                        <div class="card-body">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                <div class="form-group">
                                    <label class="form-label">Worker 轮询间隔（分钟）</label>
                                    <input type="number" class="form-input" id="config-pipeline-worker-interval" value="10" min="1">
                                    <small class="form-hint">Pipeline 队列处理间隔</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" style="margin-top:16px;" onclick="saveAllPipelineConfig()">保存所有配置</button>
                </div>

                <!-- Features Config -->
                <div id="config-features-panel" class="config-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>系统功能开关</h3>
                            <span style="color: #888; font-size: 13px;">启用或禁用系统功能模块（Pipeline 相关功能在「Pipeline 管理」中）</span>
                        </div>
                        <div class="card-body" id="features-list">
                            <p>加载中...</p>
                        </div>
                    </div>
                </div>

                <!-- Advanced Config -->
                <div id="config-advanced-panel" class="config-panel" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3>高级设置</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="config-cache-enabled">
                                    启用缓存
                                </label>
                                <p style="font-size: 12px; color: #888; margin-top: 4px;">启用后可提高响应速度</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">缓存 TTL（秒）</label>
                                <input type="number" class="form-input" id="config-cache-ttl" value="300">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Access Token 过期时间（分钟）</label>
                                <input type="number" class="form-input" id="config-jwt-access-expire" value="30">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Refresh Token 过期时间（天）</label>
                                <input type="number" class="form-input" id="config-jwt-refresh-expire" value="7">
                            </div>
                            <button class="btn btn-primary" onclick="saveConfigGroup('advanced')">保存配置</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backups Section -->
            <div id="section-backups" class="section" style="display:none;">
                <div class="page-header">
                    <h1>备份管理</h1>
                    <p>管理数据备份，支持创建、下载和恢复</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>手动备份</h3>
                    </div>
                    <div class="card-body">
                        <p style="margin-bottom: 16px; color: #666;">
                            点击下方按钮将立即执行一次数据备份。备份将导出超过保留期限的文章为 JSON 文件。
                        </p>
                        <button class="btn btn-primary" onclick="createManualBackup()">创建备份</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>备份列表</h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>备份时间</th>
                                    <th>文件大小</th>
                                    <th>文章数</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="backup-list">
                                <tr><td colspan="6">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Audit Logs Section -->
            <div id="section-audit" class="section" style="display:none;">
                <div class="page-header">
                    <h1>审计日志</h1>
                    <p>查看用户操作记录，支持筛选和导出</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>筛选条件</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 150px;">
                                <label class="form-label">操作类型</label>
                                <select class="form-select" id="audit-action-filter">
                                    <option value="">全部</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 150px;">
                                <label class="form-label">资源类型</label>
                                <select class="form-select" id="audit-resource-filter">
                                    <option value="">全部</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 150px;">
                                <label class="form-label">用户 ID</label>
                                <input type="number" class="form-input" id="audit-user-filter" placeholder="用户 ID">
                            </div>
                            <div class="form-group" style="display: flex; align-items: flex-end;">
                                <button class="btn btn-primary" onclick="loadAuditLogs()">筛选</button>
                                <button class="btn" style="margin-left: 8px;" onclick="resetAuditFilters()">重置</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>操作记录</h3>
                        <span id="audit-total" style="color: #888; font-size: 13px;">共 0 条记录</span>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>用户</th>
                                    <th>操作</th>
                                    <th>资源类型</th>
                                    <th>资源 ID</th>
                                    <th>IP 地址</th>
                                    <th>详情</th>
                                </tr>
                            </thead>
                            <tbody id="audit-list">
                                <tr><td colspan="7">加载中...</td></tr>
                            </tbody>
                        </table>
                        <div id="audit-pagination" style="margin-top: 16px; display: flex; justify-content: center; gap: 8px;"></div>
                    </div>
                </div>
            </div>
            <!-- Roles Management Section -->
            <div id="section-roles" class="section" style="display:none;">
                <div class="page-header">
                    <h1>角色管理</h1>
                    <p>管理系统角色与权限分配，支持创建自定义角色并配置细粒度权限</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>角色列表</h3>
                        <button class="btn btn-primary" onclick="showAddRoleModal()">新建角色</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>角色名称</th>
                                    <th>描述</th>
                                    <th>权限数量</th>
                                    <th>用户数量</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="role-list">
                                <tr><td colspan="7">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pipeline Monitoring Section -->
            <div id="section-pipeline" class="section" style="display:none;">
                <div class="page-header">
                    <h1>Pipeline 监控</h1>
                    <p>AI 处理流水线运行状态监控与管理</p>
                </div>

                <!-- Pipeline Stats -->
                <div class="stats-grid" id="pipeline-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="pl-stat-ai">-</div>
                        <div class="stat-label">AI 已处理</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pl-stat-embed">-</div>
                        <div class="stat-label">已向量化</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pl-stat-events">-</div>
                        <div class="stat-label">事件聚类</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pl-stat-topics">-</div>
                        <div class="stat-label">话题发现</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pl-stat-topic-match">-</div>
                        <div class="stat-label">话题匹配</div>
                    </div>
                </div>

                <!-- Pipeline Stage Details -->
                <div class="card">
                    <div class="card-header">
                        <h3>Pipeline 流程概览</h3>
                        <button class="btn btn-primary" onclick="refreshPipelineStats()">刷新</button>
                    </div>
                    <div class="card-body">
                        <div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:20px 0;flex-wrap:wrap;">
                            <div style="text-align:center;padding:16px 20px;background:#f0f9ff;border-radius:8px;min-width:120px;">
                                <div style="font-size:13px;color:#2563eb;font-weight:600;">1. AI 分析</div>
                                <div style="font-size:11px;color:#888;margin-top:4px;" id="pl-schedule-ai">加载中...</div>
                                <div style="font-size:18px;font-weight:600;margin-top:8px;" id="pl-detail-ai">-</div>
                            </div>
                            <div style="font-size:20px;color:#ddd;">→</div>
                            <div style="text-align:center;padding:16px 20px;background:#faf5ff;border-radius:8px;min-width:120px;">
                                <div style="font-size:13px;color:#7c3aed;font-weight:600;">2. 向量化</div>
                                <div style="font-size:11px;color:#888;margin-top:4px;" id="pl-schedule-embed">加载中...</div>
                                <div style="font-size:18px;font-weight:600;margin-top:8px;" id="pl-detail-embed">-</div>
                            </div>
                            <div style="font-size:20px;color:#ddd;">→</div>
                            <div style="text-align:center;padding:16px 20px;background:#ecfdf5;border-radius:8px;min-width:120px;">
                                <div style="font-size:13px;color:#059669;font-weight:600;">3. 事件聚类</div>
                                <div style="font-size:11px;color:#888;margin-top:4px;" id="pl-schedule-events">加载中...</div>
                                <div style="font-size:18px;font-weight:600;margin-top:8px;" id="pl-detail-events">-</div>
                            </div>
                            <div style="font-size:20px;color:#ddd;">→</div>
                            <div style="text-align:center;padding:16px 20px;background:#fffbeb;border-radius:8px;min-width:120px;">
                                <div style="font-size:13px;color:#d97706;font-weight:600;">4. 话题发现</div>
                                <div style="font-size:11px;color:#888;margin-top:4px;" id="pl-schedule-topics">加载中...</div>
                                <div style="font-size:18px;font-weight:600;margin-top:8px;" id="pl-detail-topics">-</div>
                            </div>
                            <div style="font-size:20px;color:#ddd;">→</div>
                            <div style="text-align:center;padding:16px 20px;background:#fef3c7;border-radius:8px;min-width:120px;">
                                <div style="font-size:13px;color:#b45309;font-weight:600;">5. 话题匹配</div>
                                <div style="font-size:11px;color:#888;margin-top:4px;" id="pl-schedule-topic-match">加载中...</div>
                                <div style="font-size:18px;font-weight:600;margin-top:8px;" id="pl-detail-topic-match">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Token Usage -->
                <div class="card">
                    <div class="card-header">
                        <h3>Token 消耗统计</h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>提供商</th>
                                    <th>模型</th>
                                    <th>调用次数</th>
                                    <th>缓存命中</th>
                                    <th>输入字符</th>
                                    <th>输出字符</th>
                                </tr>
                            </thead>
                            <tbody id="token-stats-body">
                                <tr><td colspan="7" style="text-align:center;color:#888;">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Processing Logs -->
                <div class="card">
                    <div class="card-header">
                        <h3>最近处理日志</h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>文章ID</th>
                                    <th>提供商</th>
                                    <th>模型</th>
                                    <th>任务类型</th>
                                    <th>耗时(ms)</th>
                                    <th>状态</th>
                                    <th>缓存</th>
                                    <th>时间</th>
                                </tr>
                            </thead>
                            <tbody id="processing-logs-body">
                                <tr><td colspan="8" style="text-align:center;color:#888;">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Feature Flags -->
                <div clas                    </div>
                </div>
            </div>

        </div>
    </div>

<script>
        // APP_BASE 等变量已在 <head> 中定义

        let currentCrawlerTab = 'arxiv';
        let currentSourceTab = 'arxiv';
        let currentUser = null;

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const btn = document.getElementById('mobile-menu-btn');

            const isOpen = sidebar.classList.contains('open');
            if (isOpen) {
                closeMobileMenu();
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('show');
                btn.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const btn = document.getElementById('mobile-menu-btn');

            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            btn.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            checkAuth();
        });

        async function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('请先登录');
                location.href = APP_BASE + '/';
                return;
            }

            try {
                const res = await fetch(`${AUTH_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    currentUser = await res.json();
                    if (!currentUser.is_superuser && !currentUser.roles?.includes('admin')) {
                        alert('需要管理员权限');
                        location.href = APP_BASE + '/';
                        return;
                    }
                    loadDashboard();
                } else {
                    localStorage.removeItem('access_token');
                    location.href = APP_BASE + '/';
                }
            } catch (e) {
                location.href = APP_BASE + '/';
            }
        }

        // Sections
        function switchSection(name, clickedElement) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(`section-${name}`).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (clickedElement) {
                clickedElement.classList.add('active');
            }
            closeMobileMenu();  // Close mobile menu after section switch

            if (name === 'sources') loadSources();
            if (name === 'crawlers') loadCrawlers();
            if (name === 'users') { loadUsers(); loadUserRoleFilter(); }
            if (name === 'email') loadEmailConfig();
            if (name === 'config') loadConfig();
            if (name === 'backups') loadBackups();
            if (name === 'audit') loadAuditLogs();
            if (name === 'ai') loadAIConfig();
            if (name === 'embedding') loadEmbeddingConfig();
            if (name === 'events') loadEvents();
            if (name === 'topics') loadTopics();
            if (name === 'reports') loadReports();
            if (name === 'roles') loadRoles();
            if (name === 'pipeline') loadPipelineMonitor();
        }

        // Navigation click handler (event delegation)
        document.querySelector('.sidebar-nav').addEventListener('click', function(e) {
            const navItem = e.target.closest('.nav-item');
            if (navItem && navItem.hasAttribute('data-section')) {
                e.preventDefault();
                const section = navItem.getAttribute('data-section');
                switchSection(section, navItem);
            }
        });

        // ============================================
        // Skeleton Loading Utilities
        // ============================================
        const Skeleton = {
            // Generate skeleton for stat cards
            stats(count = 4) {
                return Array(count).fill(`
                    <div class="skeleton-stat-card">
                        <div class="skeleton skeleton-stat-value"></div>
                        <div class="skeleton skeleton-stat-label"></div>
                    </div>
                `).join('');
            },

            // Generate skeleton for table rows
            tableRows(rows = 5, cols = 4) {
                return Array(rows).fill(`
                    <div class="skeleton-table-row">
                        ${Array(cols).fill('<div class="skeleton skeleton-cell"></div>').join('')}
                    </div>
                `).join('');
            },

            // Generate skeleton for list items
            listItems(count = 5) {
                return Array(count).fill(`
                    <div class="skeleton-list-item">
                        <div class="skeleton skeleton-avatar"></div>
                        <div class="skeleton-content">
                            <div class="skeleton skeleton-title"></div>
                            <div class="skeleton skeleton-text"></div>
                        </div>
                    </div>
                `).join('');
            },

            // Generate skeleton for card content
            cardContent(lines = 3) {
                return `
                    <div class="skeleton-card-body">
                        ${Array(lines).fill('<div class="skeleton skeleton-line"></div>').join('')}
                    </div>
                `;
            },

            // Show skeleton in element
            show(elementId, skeletonHtml) {
                const el = document.getElementById(elementId);
                if (el) {
                    el.innerHTML = skeletonHtml;
                }
            }
        };

        // ============================================
        // Table Enhancement Utilities
        // ============================================
        const TableEnhance = {
            // Render empty state
            emptyState(icon, title, desc) {
                return `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i data-lucide="${icon}"></i>
                        </div>
                        <div class="empty-state-title">${title}</div>
                        <div class="empty-state-desc">${desc}</div>
                    </div>
                `;
            },

            // Render pagination
            pagination(currentPage, totalPages, totalItems, pageSize, onPageChange, onPageSizeChange) {
                const start = (currentPage - 1) * pageSize + 1;
                const end = Math.min(currentPage * pageSize, totalItems);

                let pageButtons = '';
                const maxVisible = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
                let endPage = Math.min(totalPages, startPage + maxVisible - 1);

                if (endPage - startPage < maxVisible - 1) {
                    startPage = Math.max(1, endPage - maxVisible + 1);
                }

                for (let i = startPage; i <= endPage; i++) {
                    pageButtons += `
                        <button class="pagination-btn ${i === currentPage ? 'active' : ''}"
                                onclick="${onPageChange}(${i})">${i}</button>
                    `;
                }

                return `
                    <div class="table-footer">
                        <span>显示 ${start}-${end} 条，共 ${totalItems} 条</span>
                        <div class="pagination">
                            <select class="page-size-select" onchange="${onPageSizeChange}(this.value)">
                                <option value="10" ${pageSize === 10 ? 'selected' : ''}>10条/页</option>
                                <option value="20" ${pageSize === 20 ? 'selected' : ''}>20条/页</option>
                                <option value="50" ${pageSize === 50 ? 'selected' : ''}>50条/页</option>
                                <option value="100" ${pageSize === 100 ? 'selected' : ''}>100条/页</option>
                            </select>
                            <button class="pagination-btn" onclick="${onPageChange}(${currentPage - 1})"
                                    ${currentPage === 1 ? 'disabled' : ''}>
                                <i data-lucide="chevron-left"></i>
                            </button>
                            ${pageButtons}
                            <button class="pagination-btn" onclick="${onPageChange}(${currentPage + 1})"
                                    ${currentPage === totalPages ? 'disabled' : ''}>
                                <i data-lucide="chevron-right"></i>
                            </button>
                        </div>
                    </div>
                `;
            },

            // Initialize icons after rendering
            initIcons() {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        };

        // ============================================
        // Form Validation Utilities
        // ============================================
        const Validators = {
            required: (value) => value.trim() !== '' || '此字段为必填项',
            email: (value) => !value || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value) || '请输入有效的邮箱地址',
            minLength: (min) => (value) => !value || value.length >= min || `最少需要 ${min} 个字符`,
            maxLength: (max) => (value) => !value || value.length <= max || `最多允许 ${max} 个字符`,
            url: (value) => {
                if (!value) return true;
                try { new URL(value); return true; }
                catch { return '请输入有效的URL'; }
            },
            number: (value) => !value || !isNaN(Number(value)) || '请输入有效的数字',
            min: (minVal) => (value) => !value || Number(value) >= minVal || `最小值为 ${minVal}`,
            max: (maxVal) => (value) => !value || Number(value) <= maxVal || `最大值为 ${maxVal}`,
            pattern: (regex, message) => (value) => !value || regex.test(value) || message,
            password: (value) => {
                if (!value) return true;
                if (value.length < 8) return '密码至少8个字符';
                if (!/[A-Z]/.test(value)) return '密码需要包含大写字母';
                if (!/[a-z]/.test(value)) return '密码需要包含小写字母';
                if (!/[0-9]/.test(value)) return '密码需要包含数字';
                return true;
            }
        };

        const FormEnhance = {
            // Password strength checker
            passwordStrength(password) {
                if (!password) return { level: 'none', bars: 0 };
                let score = 0;
                if (password.length >= 8) score++;
                if (password.length >= 12) score++;
                if (/[A-Z]/.test(password)) score++;
                if (/[a-z]/.test(password)) score++;
                if (/[0-9]/.test(password)) score++;
                if (/[^A-Za-z0-9]/.test(password)) score++;

                if (score <= 2) return { level: 'weak', bars: 1, text: '弱' };
                if (score <= 4) return { level: 'medium', bars: 2, text: '中等' };
                return { level: 'strong', bars: 3, text: '强' };
            },

            // Render password strength indicator
            renderPasswordStrength(password) {
                const { level, bars, text } = this.passwordStrength(password);
                return `
                    <div class="password-strength">
                        <div class="password-strength-bar ${level === 'weak' ? level : ''}"></div>
                        <div class="password-strength-bar ${level === 'medium' ? level : ''}"></div>
                        <div class="password-strength-bar ${level === 'strong' ? level : ''}"></div>
                    </div>
                    <div class="password-strength-text ${level}">${text ? '密码强度：' + text : ''}</div>
                `;
            },

            // Character counter
            charCounter(current, max) {
                const remaining = max - current;
                const warning = remaining < 10;
                const error = remaining < 0;
                return `
                    <div class="char-counter ${warning ? 'warning' : ''} ${error ? 'error' : ''}">
                        ${current}/${max}
                    </div>
                `;
            },

            // Validate a field
            validateField(input, rules) {
                const value = input.value;
                const group = input.closest('.form-group');
                const errorEl = group?.querySelector('.form-error');

                for (const rule of rules) {
                    const result = rule(value);
                    if (result !== true) {
                        group?.classList.add('has-error');
                        group?.classList.remove('has-success');
                        if (errorEl) errorEl.textContent = result;
                        return false;
                    }
                }

                group?.classList.remove('has-error');
                group?.classList.add('has-success');
                return true;
            },

            // Validate all fields in a form
            validateForm(form, fieldRules) {
                let valid = true;
                for (const [fieldName, rules] of Object.entries(fieldRules)) {
                    const input = form.querySelector(`[name="${fieldName}"]`);
                    if (input && !this.validateField(input, rules)) {
                        valid = false;
                    }
                }
                return valid;
            },

            // Set button loading state
            setButtonLoading(btn, loading) {
                if (loading) {
                    btn.classList.add('loading');
                    btn.disabled = true;
                } else {
                    btn.classList.remove('loading');
                    btn.disabled = false;
                }
            },

            // Show feedback message
            showFeedback(containerId, type, message) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.className = `form-feedback show ${type}`;
                    container.textContent = message;
                }
            },

            // Clear feedback
            clearFeedback(containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.className = 'form-feedback';
                    container.textContent = '';
                }
            }
        };

        // Dashboard
        async function loadDashboard() {
            const token = localStorage.getItem('access_token');

            // Show skeleton while loading
            Skeleton.show('recent-articles', Skeleton.tableRows(5, 4));

            try {
                const res = await fetch(`${ADMIN_BASE}/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                document.getElementById('stat-users').textContent = data.users || 0;
                document.getElementById('stat-articles').textContent = data.articles || 0;
                document.getElementById('stat-sources').textContent = data.sources || 0;
                document.getElementById('stat-subscriptions').textContent = data.subscriptions || 0;

                // Recent articles
                const artsRes = await fetch(`${API_BASE}/articles?page_size=5`);
                const artsData = await artsRes.json();
                const tbody = document.getElementById('recent-articles');
                tbody.innerHTML = artsData.articles.map(a => `
                    <tr>
                        <td>${escapeHtml(a.title.substring(0, 40))}...</td>
                        <td><span class="badge badge-info">${a.source_type}</span></td>
                        <td>${a.category || '-'}</td>
                        <td>${formatDate(a.crawl_time)}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load dashboard:', e);
            }
        }

        // Subscriptions Detail Modal
        async function showSubscriptionsModal() {
            const modal = document.getElementById('subscriptions-modal');
            modal.style.display = 'flex';
            
            const detailDiv = document.getElementById('subscriptions-detail');
            detailDiv.innerHTML = '<div style="text-align:center;padding:20px;color:#888;">加载中...</div>';

            try {
                const token = localStorage.getItem('access_token');
                // 获取各类型订阅统计
                const [rssRes, arxivRes] = await Promise.all([
                    fetch(`${API_BASE}/subscriptions`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${ADMIN_BASE}/sources/arxiv?page_size=500`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                const rssData = await rssRes.json();
                const arxivData = await arxivRes.json();

                // 统计各类型订阅数
                const subStats = {};
                if (rssData.subscriptions) {
                    rssData.subscriptions.forEach(sub => {
                        const type = sub.source_type || 'other';
                        subStats[type] = (subStats[type] || 0) + 1;
                    });
                }

                const typeNames = {
                    'arxiv': 'ArXiv 分类',
                    'rss': 'RSS 订阅',
                    'wechat': '微信公众号',
                    'weibo': '微博热搜',
                    'hackernews': 'HackerNews',
                    'reddit': 'Reddit',
                    'twitter': 'Twitter'
                };

                const totalSubs = Object.values(subStats).reduce((a, b) => a + b, 0);

                let html = `
                    <div style="margin-bottom: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px;">
                        <strong>总订阅数：${totalSubs}</strong>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>来源类型</th>
                                <th>订阅数量</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                Object.entries(subStats).forEach(([type, count]) => {
                    html += `
                        <tr>
                            <td>${typeNames[type] || type}</td>
                            <td>${count}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                
                // 显示活跃数据源
                const activeArxiv = (arxivData.categories || []).filter(c => c.is_active).length;
                html += `
                    <div style="margin-top: 16px; padding: 12px; background: #ecfdf5; border-radius: 8px;">
                        <h4 style="margin: 0 0 8px 0; font-size: 14px;">数据源状态</h4>
                        <div style="font-size: 13px; color: #666;">
                            ArXiv 活跃分类: <strong>${activeArxiv}</strong> / ${(arxivData.categories || []).length}
                        </div>
                    </div>
                `;

                detailDiv.innerHTML = html;
            } catch (e) {
                detailDiv.innerHTML = '<div style="text-align:center;padding:20px;color:#dc2626;">加载失败</div>';
            }
        }

        // Sources Management
        function switchSourceTab(tab) {
            currentSourceTab = tab;
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.source-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`source-${tab}`).style.display = 'block';
            
            if (tab === 'arxiv') loadArxivCategories();
            if (tab === 'rss') loadRssFeeds();
            if (tab === 'wechat') loadWechatAccounts();
            if (tab === 'weibo') loadWeiboBoards();
            if (tab === 'pending') loadPendingRss();
            if (tab === 'hackernews') loadHackerNewsSources();
            if (tab === 'reddit') loadRedditSources();
            if (tab === 'twitter') loadTwitterSources();
        }

        async function loadSources() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                document.getElementById('stat-arxiv-total').textContent = data.arxiv?.total || 0;
                document.getElementById('stat-arxiv-active').textContent = data.arxiv?.active || 0;
                document.getElementById('stat-rss-total').textContent = data.rss?.total || 0;
                document.getElementById('stat-rss-active').textContent = data.rss?.active || 0;
                document.getElementById('stat-weibo-total').textContent = data.weibo?.total || 0;
                document.getElementById('stat-weibo-active').textContent = data.weibo?.active || 0;
                document.getElementById('stat-hackernews-total').textContent = data.hackernews?.total || 0;
                document.getElementById('stat-hackernews-active').textContent = data.hackernews?.active || 0;
                document.getElementById('stat-reddit-total').textContent = data.reddit?.total || 0;
                document.getElementById('stat-reddit-active').textContent = data.reddit?.active || 0;
                document.getElementById('stat-twitter-total').textContent = data.twitter?.total || 0;
                document.getElementById('stat-twitter-active').textContent = data.twitter?.active || 0;
                
                loadArxivCategories();
            } catch (e) {
                console.error('Failed to load sources:', e);
            }
        }

        async function loadArxivCategories() {
            const token = localStorage.getItem('access_token');
            const search = document.getElementById('arxiv-search')?.value || '';
            const container = document.getElementById('arxiv-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/arxiv?search=${encodeURIComponent(search)}&page_size=200`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                container.innerHTML = `
                    <div class="category-grid">
                        ${data.categories.map(c => `
                            <div class="category-item ${c.is_active ? 'enabled' : ''}">
                                <div>
                                    <code>${c.code}</code>
                                    <span style="margin-left: 8px; color: #333;">${c.name}</span>
                                </div>
                                <input type="checkbox" 
                                    data-id="${c.id}"
                                    ${c.is_active ? 'checked' : ''}
                                    onchange="toggleArxivCategory(${c.id}, this.checked)">
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                container.innerHTML = '<p>加载失败</p>';
            }
        }

        async function toggleArxivCategory(categoryId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/arxiv/${categoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                loadSources();
            } catch (e) {
                alert('操作失败');
            }
        }

        async function batchToggleArxiv(isActive) {
            const token = localStorage.getItem('access_token');
            const checkboxes = document.querySelectorAll('#arxiv-list input[type="checkbox"]:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            
            if (ids.length === 0) {
                alert('请先选择要操作的分类');
                return;
            }
            
            try {
                await fetch(`${ADMIN_BASE}/sources/arxiv/batch`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category_ids: ids, is_active: isActive })
                });
                loadArxivCategories();
            } catch (e) {
                alert('批量操作失败');
            }
        }

        async function loadRssFeeds() {
            const token = localStorage.getItem('access_token');
            const search = document.getElementById('rss-search')?.value || '';
            const category = document.getElementById('rss-category-filter')?.value || '';
            const tbody = document.getElementById('rss-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/rss?search=${encodeURIComponent(search)}&category=${encodeURIComponent(category)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.feeds.map(f => `
                    <tr>
                        <td><input type="checkbox" data-id="${f.id}"></td>
                        <td>
                            <strong>${escapeHtml(f.title)}</strong>
                            <br><small style="color: #888;">${escapeHtml(f.feed_url)}</small>
                        </td>
                        <td>${f.category || '-'}</td>
                        <td><span class="badge ${f.is_active ? 'badge-success' : 'badge-warning'}">${f.is_active ? '活跃' : '禁用'}</span></td>
                        <td>${f.last_fetched_at ? formatDate(f.last_fetched_at) : '从未'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="showEditRssModal(${f.id}, '${escapeHtml(f.title).replace(/'/g, "\\'")}', '${escapeHtml(f.feed_url || '').replace(/'/g, "\\'")}', '${escapeHtml(f.category || '').replace(/'/g, "\\'")}', '${escapeHtml(f.site_url || '').replace(/'/g, "\\'")}')">编辑</button>
                            <button class="btn btn-sm ${f.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleRssFeed(${f.id}, ${!f.is_active})">
                                ${f.is_active ? '禁用' : '启用'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRssFeed(${f.id})">删除</button>
                        </td>
                    </tr>
                `).join('');
                
                // Update category filter options
                if (!document.getElementById('rss-category-filter').options.length) {
                    const categories = [...new Set(data.feeds.map(f => f.category).filter(Boolean))];
                    const select = document.getElementById('rss-category-filter');
                    categories.forEach(cat => {
                        const opt = document.createElement('option');
                        opt.value = cat;
                        opt.textContent = cat;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6">加载失败</td></tr>';
            }
        }

        async function toggleRssFeed(feedId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/rss/${feedId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                loadRssFeeds();
            } catch (e) {
                alert('操作失败');
            }
        }

        async function deleteRssFeed(feedId) {
            if (!confirm('确定要删除此 RSS 源吗？')) return;
            
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/rss/${feedId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadRssFeeds();
            } catch (e) {
                alert('删除失败');
            }
        }

        async function loadWechatAccounts() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('wechat-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/wechat`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.accounts.length ? data.accounts.map(a => `
                    <tr>
                        <td>${escapeHtml(a.name)}</td>
                        <td>${escapeHtml(a.account_id)}</td>
                        <td><span class="badge ${a.is_active ? 'badge-success' : 'badge-warning'}">${a.is_active ? '活跃' : '禁用'}</span></td>
                        <td>${a.last_fetched_at ? formatDate(a.last_fetched_at) : '从未'}</td>
                        <td>
                            <button class="btn btn-sm ${a.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleWechatAccount(${a.id}, ${!a.is_active})">
                                ${a.is_active ? '禁用' : '启用'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteWechatAccount(${a.id})">删除</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="5" style="text-align: center; color: #888;">暂无微信公众号</td></tr>';
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5">加载失败</td></tr>';
            }
        }

        async function toggleWechatAccount(accountId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/wechat/${accountId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                loadWechatAccounts();
            } catch (e) {
                alert('操作失败');
            }
        }

        async function deleteWechatAccount(accountId) {
            if (!confirm('确定要删除此公众号吗？')) return;
            
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/wechat/${accountId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadWechatAccounts();
            } catch (e) {
                alert('删除失败');
            }
        }

        function showAddWechatModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>添加微信公众号</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">×</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">公众号名称 *</label>
                            <input type="text" class="form-input" id="new-wechat-name" placeholder="例如：机器之心" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">账号 ID (biz) *</label>
                            <input type="text" class="form-input" id="new-wechat-biz" placeholder="从文章 URL 中获取 __biz 参数" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">分类</label>
                            <input type="text" class="form-input" id="new-wechat-category" value="微信公众号">
                        </div>
                        <p style="font-size: 12px; color: #888;">
                            提示：打开公众号任意文章，从 URL 中找到 __biz 参数值即可。
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">取消</button>
                        <button class="btn btn-primary" onclick="addWechatAccount()">添加</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addWechatAccount() {
            const token = localStorage.getItem('access_token');
            const name = document.getElementById('new-wechat-name').value;
            const biz = document.getElementById('new-wechat-biz').value;
            const category = document.getElementById('new-wechat-category').value;
            
            if (!name || !biz) {
                alert('请填写公众号名称和账号 ID');
                return;
            }
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/wechat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, account_id: biz, category })
                });
                
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadWechatAccounts();
                } else {
                    const err = await res.json();
                    alert(err.detail || '添加失败');
                }
            } catch (e) {
                alert('添加失败');
            }
        }

        // Weibo Hot Search Management
        async function loadWeiboBoards() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('weibo-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/weibo`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.boards.length ? data.boards.map(b => `
                    <tr>
                        <td><input type="checkbox" data-id="${b.id}" class="weibo-checkbox"></td>
                        <td>${escapeHtml(b.board_name)}</td>
                        <td><code>${escapeHtml(b.board_type)}</code></td>
                        <td>
                            ${b.requires_cookie 
                                ? '<span class="badge badge-warning">需要 Cookie</span>' 
                                : '<span class="badge badge-success">公开接口</span>'}
                        </td>
                        <td><span class="badge ${b.is_active ? 'badge-success' : 'badge-warning'}">${b.is_active ? '活跃' : '禁用'}</span></td>
                        <td>${b.last_fetched_at ? formatDate(b.last_fetched_at) : '从未'}</td>
                        <td>
                            <button class="btn btn-sm ${b.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleWeiboBoard(${b.id}, ${!b.is_active})">
                                ${b.is_active ? '禁用' : '启用'}
                            </button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="7" style="text-align: center; color: #888;">暂无微博热搜榜单</td></tr>';
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="7">加载失败</td></tr>';
            }
        }

        async function toggleWeiboBoard(boardId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/weibo/${boardId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    alert(error.detail || '操作失败');
                    return;
                }
                
                loadWeiboBoards();
                loadSources();
            } catch (e) {
                alert('操作失败');
            }
        }

        async function batchToggleWeibo(isActive) {
            const token = localStorage.getItem('access_token');
            const checkboxes = document.querySelectorAll('.weibo-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            
            if (ids.length === 0) {
                alert('请先选择要操作的榜单');
                return;
            }
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/weibo/batch?is_active=${isActive}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ids)
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    alert(error.detail || '操作失败');
                    return;
                }
                
                loadWeiboBoards();
                loadSources();
            } catch (e) {
                alert('操作失败');
            }
        }

        async function loadPendingRss() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('pending-rss-list');
            
            try {
                const res = await fetch(`${API_BASE}/feeds/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.feeds.length ? data.feeds.map(f => `
                    <tr>
                        <td>${escapeHtml(f.title)}</td>
                        <td><a href="${f.feed_url}" target="_blank" style="color: #4ecdc4;">${escapeHtml(f.feed_url)}</a></td>
                        <td>${formatDate(f.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="approveRssFeed(${f.id})">批准</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRssFeed(${f.id})">拒绝</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="4" style="text-align: center; color: #888;">暂无待审批的 RSS 源</td></tr>';
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="4">加载失败</td></tr>';
            }
        }

        async function approveRssFeed(feedId) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/rss/${feedId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: true })
                });
                loadPendingRss();
            } catch (e) {
                alert('审批失败');
            }
        }

        function showAddRssModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>添加 RSS 源</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">×</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Feed URL *</label>
                            <input type="url" class="form-input" id="new-rss-url" placeholder="https://example.com/feed.xml" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">标题（可选）</label>
                            <input type="text" class="form-input" id="new-rss-title" placeholder="留空则自动获取">
                        </div>
                        <div class="form-group">
                            <label class="form-label">分类</label>
                            <input type="text" class="form-input" id="new-rss-category" value="其他">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">取消</button>
                        <button class="btn btn-primary" onclick="addRssFeed()">添加</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addRssFeed() {
            const token = localStorage.getItem('access_token');
            const feedUrl = document.getElementById('new-rss-url').value;
            const title = document.getElementById('new-rss-title').value;
            const category = document.getElementById('new-rss-category').value;
            
            if (!feedUrl) {
                alert('请输入 Feed URL');
                return;
            }
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/rss`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ feed_url: feedUrl, title, category })
                });
                
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadRssFeeds();
                } else {
                    const err = await res.json();
                    alert(err.detail || '添加失败');
                }
            } catch (e) {
                alert('添加失败');
            }
        }

        function showEditRssModal(feedId, title, feedUrl, category, siteUrl) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="width: 500px;">
                    <div class="modal-header">
                        <h3>编辑 RSS 源</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label">标题</label>
                            <input type="text" class="form-input" id="edit-rss-title" value="${escapeHtml(title)}">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label">Feed URL</label>
                            <input type="text" class="form-input" id="edit-rss-url" value="${escapeHtml(feedUrl)}">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label">分类</label>
                            <input type="text" class="form-input" id="edit-rss-category" value="${escapeHtml(category)}">
                        </div>
                        <div class="form-group" style="margin-bottom: 12px;">
                            <label class="form-label">网站 URL</label>
                            <input type="text" class="form-input" id="edit-rss-site-url" value="${escapeHtml(siteUrl)}">
                        </div>
                        <button class="btn btn-primary" onclick="saveEditRss(${feedId})">保存</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveEditRss(feedId) {
            const token = localStorage.getItem('access_token');
            const data = {
                title: document.getElementById('edit-rss-title').value,
                feed_url: document.getElementById('edit-rss-url').value,
                category: document.getElementById('edit-rss-category').value,
                site_url: document.getElementById('edit-rss-site-url').value,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/sources/rss/${feedId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadRssFeeds();
                } else {
                    const err = await res.json();
                    alert(err.detail || '保存失败');
                }
            } catch (e) {
                alert('保存失败');
            }
        }

        function toggleSelectAll(type) {
            const checkboxes = document.querySelectorAll(`#${type}-list input[type="checkbox"]`);
            const selectAll = document.getElementById(`${type}-select-all`);
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        // Crawlers
        function switchCrawlerTab(tab) {
            currentCrawlerTab = tab;
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            loadCrawlers();
        }

        async function loadCrawlers() {
            const token = localStorage.getItem('access_token');
            const container = document.getElementById('crawler-list');
            document.getElementById('crawler-title').textContent = currentCrawlerTab === 'arxiv' ? 'ArXiv 类目配置' : 'RSS 源配置';

            if (currentCrawlerTab === 'arxiv') {
                try {
                    const res = await fetch(`${ADMIN_BASE}/sources/arxiv?page_size=500`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();
                    const cats = data.categories || [];

                    container.innerHTML = `
                        <div style="margin-bottom: 12px; display: flex; gap: 8px;">
                            <input type="text" class="form-input" id="crawler-arxiv-search" placeholder="搜索类目..." style="flex:1;" oninput="filterCrawlerList()">
                        </div>
                        <div class="category-grid" id="crawler-arxiv-grid">
                            ${cats.map(c => `
                                <div class="category-item ${c.is_active ? 'enabled' : ''}" data-code="${(c.code||'').toLowerCase()}" data-name="${(c.name||'').toLowerCase()}">
                                    <div>
                                        <code>${c.code}</code>
                                        <span style="margin-left: 8px; color: #333;">${c.name}</span>
                                    </div>
                                    <input type="checkbox"
                                        data-id="${c.id}"
                                        data-code="${c.code}"
                                        ${c.is_active ? 'checked' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } catch (e) {
                    container.innerHTML = '<p>加载失败</p>';
                }
            } else {
                try {
                    const res = await fetch(`${ADMIN_BASE}/sources/rss?page_size=500`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();
                    const feeds = data.feeds || [];

                    container.innerHTML = `
                        <div style="margin-bottom: 12px; display: flex; gap: 8px;">
                            <input type="text" class="form-input" id="crawler-rss-search" placeholder="搜索RSS源..." style="flex:1;" oninput="filterCrawlerList()">
                            <button class="btn btn-primary btn-sm" onclick="showAddRssModal()">+ 添加 RSS 源</button>
                        </div>
                        <div class="category-grid" id="crawler-rss-grid">
                            ${feeds.map(f => `
                                <div class="category-item ${f.is_active ? 'enabled' : ''}" data-name="${(f.title||'').toLowerCase()}" data-cat="${(f.category||'').toLowerCase()}">
                                    <div>
                                        <strong>${escapeHtml(f.title)}</strong>
                                        <span style="margin-left: 8px; color: #888;">${f.category || ''}</span>
                                    </div>
                                    <input type="checkbox"
                                        data-id="${f.id}"
                                        ${f.is_active ? 'checked' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } catch (e) {
                    container.innerHTML = '<p>加载失败</p>';
                }
            }
        }

        function filterCrawlerList() {
            const searchId = currentCrawlerTab === 'arxiv' ? 'crawler-arxiv-search' : 'crawler-rss-search';
            const gridId = currentCrawlerTab === 'arxiv' ? 'crawler-arxiv-grid' : 'crawler-rss-grid';
            const keyword = (document.getElementById(searchId)?.value || '').toLowerCase();
            const grid = document.getElementById(gridId);
            if (!grid) return;
            grid.querySelectorAll('.category-item').forEach(item => {
                const code = item.dataset.code || '';
                const name = item.dataset.name || '';
                const cat = item.dataset.cat || '';
                const match = !keyword || code.includes(keyword) || name.includes(keyword) || cat.includes(keyword);
                item.style.display = match ? '' : 'none';
            });
        }

        async function saveCrawlConfig() {
            const token = localStorage.getItem('access_token');

            if (currentCrawlerTab === 'arxiv') {
                const checkboxes = document.querySelectorAll('#crawler-arxiv-grid input[type="checkbox"]');
                const enableIds = [];
                const disableIds = [];
                checkboxes.forEach(cb => {
                    const id = parseInt(cb.dataset.id);
                    if (cb.checked) enableIds.push(id);
                    else disableIds.push(id);
                });

                try {
                    if (enableIds.length > 0) {
                        await fetch(`${ADMIN_BASE}/sources/arxiv/batch?is_active=true&${enableIds.map(id => 'category_ids=' + id).join('&')}`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                    }
                    if (disableIds.length > 0) {
                        await fetch(`${ADMIN_BASE}/sources/arxiv/batch?is_active=false&${disableIds.map(id => 'category_ids=' + id).join('&')}`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                    }
                    alert('ArXiv 抓取配置已保存');
                } catch (e) {
                    alert('保存失败: ' + e.message);
                }
            } else {
                const checkboxes = document.querySelectorAll('#crawler-rss-grid input[type="checkbox"]');
                try {
                    for (const cb of checkboxes) {
                        await fetch(`${ADMIN_BASE}/sources/rss/${cb.dataset.id}`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ is_active: cb.checked })
                        });
                    }
                    alert('RSS 抓取配置已保存');
                } catch (e) {
                    alert('保存失败: ' + e.message);
                }
            }
        }

        async function triggerCrawl() {
            const token = localStorage.getItem('access_token');
            const sourceType = currentCrawlerTab === 'arxiv' ? 'arxiv' : 'rss';

            try {
                const res = await fetch(`${ADMIN_BASE}/crawler/trigger`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_type: sourceType })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(`抓取完成！新增 ${data.new_articles || 0} 篇文章，耗时 ${data.duration || '?'}s`);
                } else {
                    alert(data.detail || '抓取失败');
                }
            } catch (e) {
                alert('触发抓取失败: ' + e.message);
            }
        }

        // Users
        let currentUserPage = 1;

        async function loadUsers(page = 1) {
            currentUserPage = page;
            const token = localStorage.getItem('access_token');
            
            // 获取筛选参数
            const search = document.getElementById('user-search-input')?.value || '';
            const role = document.getElementById('user-role-filter')?.value || '';
            const status = document.getElementById('user-status-filter')?.value || '';

            // 构建查询参数
            const params = new URLSearchParams({ page, page_size: 20 });
            if (search) params.append('search', search);
            if (role) params.append('role', role);
            if (status) params.append('is_active', status);

            try {
                const res = await fetch(`${ADMIN_BASE}/users?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const tbody = document.getElementById('user-list');
                tbody.innerHTML = data.users.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td>${escapeHtml(u.username)}</td>
                        <td>${escapeHtml(u.email)}</td>
                        <td><span class="badge badge-info">${u.roles.join(', ') || '无角色'}</span></td>
                        <td><span class="badge ${u.is_active ? 'badge-success' : 'badge-danger'}">${u.is_active ? '正常' : '禁用'}</span></td>
                        <td>${formatDate(u.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="showChangeRoleModal(${u.id}, '${u.username}', '${u.roles[0] || ''}')">修改角色</button>
                            <button class="btn btn-sm ${u.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleUser(${u.id}, ${u.is_active})">
                                ${u.is_active ? '禁用' : '启用'}
                            </button>
                        </td>
                    </tr>
                `).join('');

                // 渲染分页
                renderUserPagination(data.total);
            } catch (e) {
                console.error('Failed to load users:', e);
            }
        }

        function renderUserPagination(total) {
            const container = document.getElementById('user-pagination');
            const totalPages = Math.ceil(total / 20);
            
            if (totalPages <= 1) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            let html = '';
            
            // 上一页
            html += `<button class="page-btn" onclick="loadUsers(${currentUserPage - 1})" ${currentUserPage === 1 ? 'disabled' : ''}>上一页</button>`;
            
            // 页码
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                html += `<button class="page-btn ${i === currentUserPage ? 'active' : ''}" onclick="loadUsers(${i})">${i}</button>`;
            }
            
            if (totalPages > 5) {
                html += `<span style="padding: 8px;">...</span>`;
                html += `<button class="page-btn" onclick="loadUsers(${totalPages})">${totalPages}</button>`;
            }
            
            // 下一页
            html += `<button class="page-btn" onclick="loadUsers(${currentUserPage + 1})" ${currentUserPage === totalPages ? 'disabled' : ''}>下一页</button>`;
            
            html += `<span class="page-info">共 ${total} 条</span>`;
            container.innerHTML = html;
        }

        function searchUsers() {
            loadUsers(1);
        }

        function resetUserSearch() {
            document.getElementById('user-search-input').value = '';
            document.getElementById('user-role-filter').value = '';
            document.getElementById('user-status-filter').value = '';
            loadUsers(1);
        }

        async function loadUserRoleFilter() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/roles`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const select = document.getElementById('user-role-filter');
                data.roles.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.name;
                    opt.textContent = r.name;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load roles for filter:', e);
            }
        }

        async function toggleUser(userId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/users/${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: !isActive })
                });
                loadUsers();
            } catch (e) {
                alert('操作失败');
            }
        }

        async function showChangeRoleModal(userId, username, currentRole) {
            const token = localStorage.getItem('access_token');
            // 获取所有角色
            let roles = [];
            try {
                const res = await fetch(`${ADMIN_BASE}/roles`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                roles = data.roles || [];
            } catch (e) {
                alert('获取角色列表失败');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="width: 400px;">
                    <div class="modal-header">
                        <h3>修改用户角色</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 12px;">用户: <strong>${escapeHtml(username)}</strong></p>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label">选择角色</label>
                            <select class="form-select" id="change-role-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                ${roles.map(r => `<option value="${escapeHtml(r.name)}" ${r.name === currentRole ? 'selected' : ''}>${escapeHtml(r.name)} - ${escapeHtml(r.description)}</option>`).join('')}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveUserRole(${userId})">保存</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveUserRole(userId) {
            const token = localStorage.getItem('access_token');
            const roleName = document.getElementById('change-role-select').value;
            try {
                const res = await fetch(`${ADMIN_BASE}/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role_name: roleName })
                });
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadUsers();
                } else {
                    const err = await res.json();
                    alert(err.detail || '修改失败');
                }
            } catch (e) {
                alert('修改角色失败');
            }
        }

        // Email Config
        let currentEmailTab = 'general';
        let emailConfigs = [];

        function switchEmailTab(tab) {
            currentEmailTab = tab;
            document.querySelectorAll('#section-email .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.email-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`email-${tab}-panel`).style.display = 'block';
            if (tab === 'configs') loadEmailConfigs();
        }

        async function loadEmailSettings() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/email/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const settings = data.settings || {};

                document.getElementById('email-enabled').checked = settings.email_enabled || false;
                document.getElementById('email-frequency').value = settings.push_frequency || 'daily';
                document.getElementById('email-time').value = settings.push_time || '09:00';
                document.getElementById('email-max-articles').value = settings.max_articles_per_email || 20;
            } catch (e) {
                console.error('Failed to load email settings:', e);
            }
        }

        async function saveEmailSettings() {
            const token = localStorage.getItem('access_token');
            const settings = {
                email_enabled: document.getElementById('email-enabled').checked,
                push_frequency: document.getElementById('email-frequency').value,
                push_time: document.getElementById('email-time').value,
                max_articles_per_email: parseInt(document.getElementById('email-max-articles').value) || 20,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/email/settings`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (res.ok) {
                    alert('设置已保存');
                } else {
                    const err = await res.json();
                    alert(err.detail || '保存失败');
                }
            } catch (e) {
                alert('保存失败');
            }
        }

        async function loadEmailConfigs() {
            const token = localStorage.getItem('access_token');
            const filter = document.getElementById('email-config-filter').value;
            
            try {
                const url = filter ? `${ADMIN_BASE}/email/configs?backend_type=${filter}` : `${ADMIN_BASE}/email/configs`;
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                emailConfigs = data.configs || [];

                const tbody = document.getElementById('email-config-list');
                if (emailConfigs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">暂无配置，点击"新建配置"添加</td></tr>';
                    return;
                }

                tbody.innerHTML = emailConfigs.map(config => `
                    <tr>
                        <td><span class="badge badge-info">${config.priority}</span></td>
                        <td>${escapeHtml(config.name)}</td>
                        <td><span class="badge" style="background: ${getBackendColor(config.backend_type)}; color: white;">${config.backend_type.toUpperCase()}</span></td>
                        <td>${escapeHtml(config.sender_email || '-')}</td>
                        <td><span class="badge ${config.is_active ? 'badge-success' : 'badge-danger'}">${config.is_active ? '启用' : '禁用'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editEmailConfig(${config.id})">编辑</button>
                            <button class="btn btn-sm ${config.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleEmailConfig(${config.id}, ${config.is_active})">${config.is_active ? '禁用' : '启用'}</button>
                            <button class="btn btn-sm" onclick="testEmailConfig(${config.id})">测试</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEmailConfig(${config.id}, '${escapeHtml(config.name)}')">删除</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load email configs:', e);
            }
        }

        function getBackendColor(type) {
            const colors = { smtp: '#f39c12', sendgrid: '#1a82c4', mailgun: '#e21b5c', brevo: '#0b99e5' };
            return colors[type] || '#6b7280';
        }

        function showAddEmailConfigModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'email-config-modal';
            modal.innerHTML = `
                <div class="modal-content" style="width: 500px;">
                    <div class="modal-header">
                        <h3>新建邮件配置</h3>
                        <span class="modal-close" onclick="document.getElementById('email-config-modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">后端类型</label>
                            <select class="form-select" id="new-backend-type" onchange="updateConfigForm()">
                                <option value="smtp">SMTP</option>
                                <option value="sendgrid">SendGrid</option>
                                <option value="mailgun">Mailgun</option>
                                <option value="brevo">Brevo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">配置名称</label>
                            <input type="text" class="form-input" id="new-config-name" placeholder="如：主邮箱、备份邮箱">
                        </div>
                        <div id="backend-specific-fields"></div>
                        <div class="form-group">
                            <label class="form-label">发件人邮箱</label>
                            <input type="email" class="form-input" id="new-sender-email" placeholder="noreply@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">优先级</label>
                            <input type="number" class="form-input" id="new-priority" value="1" style="width: 100px;">
                            <p style="font-size: 12px; color: #888; margin-top: 4px;">数字越小优先级越高</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="new-is-active" checked>
                                启用此配置
                            </label>
                        </div>
                        <div style="text-align: right; margin-top: 16px;">
                            <button class="btn" onclick="document.getElementById('email-config-modal').remove()">取消</button>
                            <button class="btn btn-primary" style="margin-left: 8px;" onclick="createEmailConfig()">创建</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            updateConfigForm();
        }

        function updateConfigForm() {
            const type = document.getElementById('new-backend-type').value;
            const container = document.getElementById('backend-specific-fields');
            
            if (type === 'smtp') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">SMTP 服务器</label>
                        <input type="text" class="form-input" id="new-smtp-host" placeholder="smtp.example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">SMTP 端口</label>
                        <input type="number" class="form-input" id="new-smtp-port" value="587" style="width: 100px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">用户名</label>
                        <input type="text" class="form-input" id="new-smtp-user" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">密码/授权码</label>
                        <input type="password" class="form-input" id="new-smtp-password">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 16px;">
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="new-smtp-use-tls" checked>
                                使用 TLS (STARTTLS)
                            </span>
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="new-smtp-use-ssl">
                                使用 SSL 直连
                            </span>
                        </label>
                        <p style="font-size: 12px; color: #666; margin-top: 4px;">
                            TLS 适用于端口 587，SSL 适用于端口 465。两者互斥，SSL 优先。
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SSL 端口列表 (逗号分隔)</label>
                        <input type="text" class="form-input" id="new-smtp-ssl-ports" value="465" style="width: 150px;" placeholder="465,993">
                    </div>
                `;
            } else if (type === 'sendgrid') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">SendGrid API Key</label>
                        <input type="password" class="form-input" id="new-sendgrid-api-key" placeholder="SG.xxxxx">
                    </div>
                `;
            } else if (type === 'mailgun') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Mailgun API Key</label>
                        <input type="password" class="form-input" id="new-mailgun-api-key" placeholder="key-xxxxx">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mailgun Domain</label>
                        <input type="text" class="form-input" id="new-mailgun-domain" placeholder="mg.example.com">
                    </div>
                `;
            } else if (type === 'brevo') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Brevo API Key</label>
                        <input type="password" class="form-input" id="new-brevo-api-key" placeholder="xkeysib-xxxxx">
                    </div>
                    <div class="form-group">
                        <label class="form-label">发件人名称</label>
                        <input type="text" class="form-input" id="new-brevo-from-name" value="ResearchPulse">
                    </div>
                `;
            }
        }

        async function createEmailConfig() {
            const token = localStorage.getItem('access_token');
            const type = document.getElementById('new-backend-type').value;
            
            const config = {
                backend_type: type,
                name: document.getElementById('new-config-name').value,
                sender_email: document.getElementById('new-sender-email').value,
                priority: parseInt(document.getElementById('new-priority').value) || 1,
                is_active: document.getElementById('new-is-active').checked,
            };

            // Add backend-specific fields
            if (type === 'smtp') {
                config.smtp_host = document.getElementById('new-smtp-host').value;
                config.smtp_port = parseInt(document.getElementById('new-smtp-port').value) || 587;
                config.smtp_user = document.getElementById('new-smtp-user').value;
                config.smtp_password = document.getElementById('new-smtp-password').value;
                config.smtp_use_tls = document.getElementById('new-smtp-use-tls').checked;
                config.smtp_use_ssl = document.getElementById('new-smtp-use-ssl').checked;
                config.smtp_ssl_ports = document.getElementById('new-smtp-ssl-ports').value || '465';
            } else if (type === 'sendgrid') {
                config.sendgrid_api_key = document.getElementById('new-sendgrid-api-key').value;
            } else if (type === 'mailgun') {
                config.mailgun_api_key = document.getElementById('new-mailgun-api-key').value;
                config.mailgun_domain = document.getElementById('new-mailgun-domain').value;
            } else if (type === 'brevo') {
                config.brevo_api_key = document.getElementById('new-brevo-api-key').value;
                config.brevo_from_name = document.getElementById('new-brevo-from-name').value;
            }

            try {
                const res = await fetch(`${ADMIN_BASE}/email/configs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (res.ok) {
                    document.getElementById('email-config-modal').remove();
                    loadEmailConfigs();
                    alert('配置创建成功');
                } else {
                    const err = await res.json();
                    alert(err.detail || '创建失败');
                }
            } catch (e) {
                alert('创建失败');
            }
        }

        async function editEmailConfig(configId) {
            const config = emailConfigs.find(c => c.id === configId);
            if (!config) return;

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'email-edit-modal';
            
            let specificFields = '';
            if (config.backend_type === 'smtp') {
                specificFields = `
                    <div class="form-group">
                        <label class="form-label">SMTP 服务器</label>
                        <input type="text" class="form-input" id="edit-smtp-host" value="${config.smtp_host || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">SMTP 端口</label>
                        <input type="number" class="form-input" id="edit-smtp-port" value="${config.smtp_port || 587}" style="width: 100px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">用户名</label>
                        <input type="text" class="form-input" id="edit-smtp-user" value="${config.smtp_user || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">密码 (留空保持不变)</label>
                        <input type="password" class="form-input" id="edit-smtp-password" placeholder="${config.smtp_password || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 16px;">
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="edit-smtp-use-tls" ${config.smtp_use_tls !== false ? 'checked' : ''}>
                                使用 TLS (STARTTLS)
                            </span>
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="edit-smtp-use-ssl" ${config.smtp_use_ssl === true ? 'checked' : ''}>
                                使用 SSL 直连
                            </span>
                        </label>
                        <p style="font-size: 12px; color: #666; margin-top: 4px;">
                            TLS 适用于端口 587，SSL 适用于端口 465。两者互斥，SSL 优先。
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SSL 端口列表 (逗号分隔)</label>
                        <input type="text" class="form-input" id="edit-smtp-ssl-ports" value="${config.smtp_ssl_ports || '465'}" style="width: 150px;" placeholder="465,993">
                    </div>
                `;
            } else if (config.backend_type === 'sendgrid') {
                specificFields = `
                    <div class="form-group">
                        <label class="form-label">API Key (留空保持不变)</label>
                        <input type="password" class="form-input" id="edit-sendgrid-api-key" placeholder="${config.sendgrid_api_key || ''}">
                    </div>
                `;
            } else if (config.backend_type === 'mailgun') {
                specificFields = `
                    <div class="form-group">
                        <label class="form-label">API Key (留空保持不变)</label>
                        <input type="password" class="form-input" id="edit-mailgun-api-key" placeholder="${config.mailgun_api_key || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Domain</label>
                        <input type="text" class="form-input" id="edit-mailgun-domain" value="${config.mailgun_domain || ''}">
                    </div>
                `;
            } else if (config.backend_type === 'brevo') {
                specificFields = `
                    <div class="form-group">
                        <label class="form-label">API Key (留空保持不变)</label>
                        <input type="password" class="form-input" id="edit-brevo-api-key" placeholder="${config.brevo_api_key || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">发件人名称</label>
                        <input type="text" class="form-input" id="edit-brevo-from-name" value="${config.brevo_from_name || 'ResearchPulse'}">
                    </div>
                `;
            }

            modal.innerHTML = `
                <div class="modal-content" style="width: 500px;">
                    <div class="modal-header">
                        <h3>编辑 ${config.name}</h3>
                        <span class="modal-close" onclick="document.getElementById('email-edit-modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">配置名称</label>
                            <input type="text" class="form-input" id="edit-config-name" value="${config.name}">
                        </div>
                        ${specificFields}
                        <div class="form-group">
                            <label class="form-label">发件人邮箱</label>
                            <input type="email" class="form-input" id="edit-sender-email" value="${config.sender_email || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">优先级</label>
                            <input type="number" class="form-input" id="edit-priority" value="${config.priority}" style="width: 100px;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="edit-is-active" ${config.is_active ? 'checked' : ''}>
                                启用此配置
                            </label>
                        </div>
                        <div style="text-align: right; margin-top: 16px;">
                            <button class="btn" onclick="document.getElementById('email-edit-modal').remove()">取消</button>
                            <button class="btn btn-primary" style="margin-left: 8px;" onclick="saveEmailConfig(${configId})">保存</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveEmailConfig(configId) {
            const token = localStorage.getItem('access_token');
            const config = emailConfigs.find(c => c.id === configId);
            
            const update = {
                name: document.getElementById('edit-config-name').value,
                sender_email: document.getElementById('edit-sender-email').value,
                priority: parseInt(document.getElementById('edit-priority').value) || 0,
                is_active: document.getElementById('edit-is-active').checked,
            };

            // Add backend-specific fields
            if (config.backend_type === 'smtp') {
                update.smtp_host = document.getElementById('edit-smtp-host').value;
                update.smtp_port = parseInt(document.getElementById('edit-smtp-port').value) || 587;
                update.smtp_user = document.getElementById('edit-smtp-user').value;
                update.smtp_use_tls = document.getElementById('edit-smtp-use-tls').checked;
                update.smtp_use_ssl = document.getElementById('edit-smtp-use-ssl').checked;
                update.smtp_ssl_ports = document.getElementById('edit-smtp-ssl-ports').value;
                const pwd = document.getElementById('edit-smtp-password').value;
                if (pwd && !pwd.startsWith('****')) update.smtp_password = pwd;
            } else if (config.backend_type === 'sendgrid') {
                const key = document.getElementById('edit-sendgrid-api-key').value;
                if (key && !key.startsWith('****')) update.sendgrid_api_key = key;
            } else if (config.backend_type === 'mailgun') {
                const key = document.getElementById('edit-mailgun-api-key').value;
                if (key && !key.startsWith('****')) update.mailgun_api_key = key;
                update.mailgun_domain = document.getElementById('edit-mailgun-domain').value;
            } else if (config.backend_type === 'brevo') {
                const key = document.getElementById('edit-brevo-api-key').value;
                if (key && !key.startsWith('****')) update.brevo_api_key = key;
                update.brevo_from_name = document.getElementById('edit-brevo-from-name').value;
            }

            try {
                const res = await fetch(`${ADMIN_BASE}/email/configs/${configId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(update)
                });

                if (res.ok) {
                    document.getElementById('email-edit-modal').remove();
                    loadEmailConfigs();
                    alert('配置已更新');
                } else {
                    const err = await res.json();
                    alert(err.detail || '更新失败');
                }
            } catch (e) {
                alert('更新失败');
            }
        }

        async function toggleEmailConfig(configId, currentActive) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/email/configs/${configId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: !currentActive })
                });

                if (res.ok) {
                    loadEmailConfigs();
                } else {
                    const err = await res.json();
                    alert(err.detail || '操作失败');
                }
            } catch (e) {
                alert('操作失败');
            }
        }

        async function testEmailConfig(configId) {
            const testEmail = prompt('请输入测试邮件接收地址：');
            if (!testEmail) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/email/configs/${configId}/test?test_email=${encodeURIComponent(testEmail)}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await res.json();
                if (res.ok) {
                    alert(data.message || '测试邮件已发送');
                } else {
                    alert(data.detail || '发送失败');
                }
            } catch (e) {
                alert('发送失败');
            }
        }

        async function deleteEmailConfig(configId, configName) {
            if (!confirm(`确定要删除配置 "${configName}" 吗？`)) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/email/configs/${configId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    loadEmailConfigs();
                    alert('配置已删除');
                } else {
                    const err = await res.json();
                    alert(err.detail || '删除失败');
                }
            } catch (e) {
                alert('删除失败');
            }
        }

        async function loadEmailConfig() {
            await loadEmailSettings();
        }

        // Config
        let currentConfigTab = 'retention';
        let allConfigs = {};

        function switchConfigTab(tab) {
            currentConfigTab = tab;
            document.querySelectorAll('#section-config .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.config-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`config-${tab}-panel`).style.display = 'block';

            if (tab === 'features') loadFeaturesList();
        }

        async function loadConfig() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/config/groups`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                allConfigs = data.groups || {};

                // Populate retention settings
                const retention = allConfigs.retention || {};
                document.getElementById('config-retention-active-days').value = retention['retention.active_days'] || 7;
                document.getElementById('config-retention-archive-days').value = retention['retention.archive_days'] || 30;
                document.getElementById('config-backup-enabled').checked = (retention['retention.backup_enabled'] || 'true') === 'true';

                // Populate scheduler settings (基础调度，Pipeline 相关配置在 Pipeline 管理)
                const scheduler = allConfigs.scheduler || {};
                document.getElementById('config-crawl-interval').value = scheduler['scheduler.crawl_interval_hours'] || 6;
                document.getElementById('config-crawl-base-hour').value = scheduler['scheduler.crawl_base_hour'] || 0;
                document.getElementById('config-cleanup-hour').value = scheduler['scheduler.cleanup_hour'] || 3;
                document.getElementById('config-backup-hour').value = scheduler['scheduler.backup_hour'] || 4;
                document.getElementById('config-notification-hour').value = scheduler['scheduler.notification_hour'] || 9;
                document.getElementById('config-notification-minute').value = scheduler['scheduler.notification_minute'] || 0;

                // Load pipeline modules
                loadPipelineFeatureToggles();

                // Populate advanced settings
                const cache = allConfigs.cache || {};
                document.getElementById('config-cache-enabled').checked = (cache['cache.enabled'] || 'false') === 'true';
                document.getElementById('config-cache-ttl').value = cache['cache.default_ttl'] || 300;

                const jwt = allConfigs.jwt || {};
                document.getElementById('config-jwt-access-expire').value = jwt['jwt.access_token_expire_minutes'] || 30;
                document.getElementById('config-jwt-refresh-expire').value = jwt['jwt.refresh_token_expire_days'] || 7;

                // Load features list
                loadFeaturesList();
            } catch (e) {
                console.error('Failed to load config:', e);
            }
        }

        async function loadPipelineFeatureToggles() {
            // 已重构为 loadPipelineModules()
            await loadPipelineModules();
        }

        // Pipeline 模块配置
        const PIPELINE_MODULES = [
            {
                key: 'feature.ai_processor',
                name: 'AI 文章处理',
                desc: '对文章进行摘要、分类、评分',
                scheduleType: 'interval',
                scheduleConfig: { intervalKey: 'scheduler.ai_process_interval_hours', baseKey: 'scheduler.ai_process_base_hour' },
                batchKey: 'pipeline.ai_batch_limit',
                triggerEndpoint: '/scheduler/jobs/ai_process_job/trigger',
                statsQuery: 'ai_processed'
            },
            {
                key: 'feature.translate',
                name: '标题翻译',
                desc: '翻译 arXiv 英文标题为中文（AI 分析时自动调用）',
                scheduleType: 'manual',
                batchKey: 'pipeline.translate_batch_limit',
                triggerEndpoint: '/pipeline/translate',
                isTranslate: true
            },
            {
                key: 'feature.embedding',
                name: '向量嵌入',
                desc: '计算文章向量用于语义搜索',
                scheduleType: 'interval',
                scheduleConfig: { intervalKey: 'scheduler.embedding_interval_hours', baseKey: 'scheduler.embedding_base_hour' },
                batchKey: 'pipeline.embedding_batch_limit',
                triggerEndpoint: '/scheduler/jobs/embedding_job/trigger',
                statsQuery: 'embedding'
            },
            {
                key: 'feature.event_clustering',
                name: '事件聚类',
                desc: '聚类相似文章形成事件',
                scheduleType: 'cron',
                scheduleConfig: { hourKey: 'scheduler.event_cluster_hour' },
                batchKey: 'pipeline.event_batch_limit',
                triggerEndpoint: '/scheduler/jobs/event_cluster_job/trigger',
                statsQuery: 'events'
            },
            {
                key: 'feature.topic_radar',
                name: '话题雷达',
                desc: '发现热门话题趋势',
                scheduleType: 'cron_weekly',
                scheduleConfig: { dayKey: 'scheduler.topic_discovery_day', hourKey: 'scheduler.topic_discovery_hour' },
                triggerEndpoint: '/scheduler/jobs/topic_discovery_job/trigger',
                statsQuery: 'topics'
            },
            {
                key: 'feature.topic_match',
                name: '话题匹配',
                desc: '将文章自动关联到已有话题',
                scheduleType: 'interval',
                scheduleConfig: { intervalKey: 'scheduler.topic_match_interval_hours', baseKey: 'scheduler.topic_match_base_hour' },
                batchKey: 'scheduler.topic_match_limit',
                triggerEndpoint: '/topic/match',
                statsQuery: 'topic_match'
            },
            {
                key: 'feature.action_items',
                name: '行动项提取',
                desc: '从文章中提取可执行的行动建议',
                scheduleType: 'interval',
                scheduleConfig: { intervalKey: 'scheduler.action_extract_interval_hours', baseKey: 'scheduler.action_extract_base_hour' },
                batchKey: 'pipeline.action_batch_limit',
                triggerEndpoint: '/scheduler/jobs/action_extract_job/trigger'
            },
            {
                key: 'feature.report_generation',
                name: '报告生成',
                desc: '生成周报和月报',
                scheduleType: 'cron_weekly',
                scheduleConfig: { dayKey: 'scheduler.report_weekly_day', hourKey: 'scheduler.report_weekly_hour' },
                triggerEndpoint: '/scheduler/jobs/weekly_report_job/trigger'
            }
        ];

        // 存储 Pipeline 配置数据
        let pipelineConfigData = {};
        let pipelineFeaturesData = {};

        async function loadPipelineModules() {
            const token = localStorage.getItem('access_token');
            const container = document.getElementById('pipeline-modules-container');

            try {
                // 并行加载配置和功能状态
                const [configRes, featuresRes] = await Promise.all([
                    fetch(`${ADMIN_BASE}/config/groups`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${ADMIN_BASE}/features`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                const configData = await configRes.json();
                const featuresData = await featuresRes.json();

                pipelineConfigData = configData.groups || {};
                pipelineFeaturesData = {};
                (featuresData.features || []).forEach(f => {
                    pipelineFeaturesData[f.key] = f.enabled;
                });

                renderPipelineModules();
            } catch (e) {
                console.error('Failed to load pipeline modules:', e);
                container.innerHTML = '<div style="text-align:center;color:#dc2626;padding:40px;">加载失败</div>';
            }
        }

        function renderPipelineModules() {
            const container = document.getElementById('pipeline-modules-container');
            const scheduler = pipelineConfigData.scheduler || {};
            const pipeline = pipelineConfigData.pipeline || {};

            const dayNames = { mon: '周一', tue: '周二', wed: '周三', thu: '周四', fri: '周五', sat: '周六', sun: '周日' };

            container.innerHTML = PIPELINE_MODULES.map(module => {
                const enabled = pipelineFeaturesData[module.key] || false;
                // 批次配置可能在 pipeline 或 scheduler 前缀下，使用完整 key 查找
                let batchValue = 100;
                if (module.batchKey) {
                    if (module.batchKey.startsWith('scheduler.')) {
                        batchValue = scheduler[module.batchKey] || 100;
                    } else if (module.batchKey.startsWith('pipeline.')) {
                        batchValue = pipeline[module.batchKey] || 100;
                    }
                }
                const moduleStyle = enabled ? '' : 'opacity:0.6;';

                // 调度配置
                let scheduleHtml = '';
                if (module.scheduleType === 'interval') {
                    const interval = scheduler[module.scheduleConfig.intervalKey] || 1;
                    const baseHour = scheduler[module.scheduleConfig.baseKey] || 0;
                    scheduleHtml = `
                        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                            <span style="font-size:12px;color:#888;">每隔</span>
                            <input type="number" class="form-input" style="width:60px;" value="${interval}" min="1" id="sched-${module.key}-interval">
                            <span style="font-size:12px;color:#888;">小时，基准时间</span>
                            <input type="number" class="form-input" style="width:60px;" value="${baseHour}" min="0" max="23" id="sched-${module.key}-base">
                            <span style="font-size:12px;color:#888;">点</span>
                        </div>
                    `;
                } else if (module.scheduleType === 'cron') {
                    const hour = scheduler[module.scheduleConfig.hourKey] || 2;
                    scheduleHtml = `
                        <div style="display:flex;gap:12px;align-items:center;">
                            <span style="font-size:12px;color:#888;">每日</span>
                            <input type="number" class="form-input" style="width:60px;" value="${hour}" min="0" max="23" id="sched-${module.key}-hour">
                            <span style="font-size:12px;color:#888;">:00</span>
                        </div>
                    `;
                } else if (module.scheduleType === 'cron_weekly') {
                    const day = scheduler[module.scheduleConfig.dayKey] || 'mon';
                    const hour = scheduler[module.scheduleConfig.hourKey] || 1;
                    scheduleHtml = `
                        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                            <span style="font-size:12px;color:#888;">每</span>
                            <select class="form-input" style="width:80px;" id="sched-${module.key}-day">
                                ${['mon','tue','wed','thu','fri','sat','sun'].map(d => `<option value="${d}" ${d===day?'selected':''}>${dayNames[d]}</option>`).join('')}
                            </select>
                            <input type="number" class="form-input" style="width:60px;" value="${hour}" min="0" max="23" id="sched-${module.key}-hour">
                            <span style="font-size:12px;color:#888;">:00</span>
                        </div>
                    `;
                } else if (module.scheduleType === 'manual') {
                    scheduleHtml = `<span style="font-size:12px;color:#888;">手动触发（AI 分析时自动调用）</span>`;
                }

                // 批次配置
                let batchHtml = '';
                if (module.batchKey) {
                    batchHtml = `
                        <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
                            <span style="font-size:12px;color:#888;">批次上限:</span>
                            <input type="number" class="form-input" style="width:80px;" value="${batchValue}" min="1" id="batch-${module.key}">
                            <span style="font-size:12px;color:#888;">篇</span>
                        </div>
                    `;
                }

                return `
                    <div class="card" style="margin-bottom:12px;${moduleStyle}">
                        <div class="card-body" style="padding:16px;">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;">
                                <div>
                                    <h4 style="margin:0 0 4px 0;font-size:15px;">${module.name}</h4>
                                    <p style="margin:0;font-size:12px;color:#888;">${module.desc}</p>
                                </div>
                                <div style="display:flex;gap:8px;align-items:center;">
                                    <label class="toggle-switch" style="margin:0;">
                                        <input type="checkbox" ${enabled ? 'checked' : ''} onchange="togglePipelineModule('${module.key}', this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <button class="btn btn-sm ${enabled ? 'btn-primary' : ''}" style="font-size:12px;padding:4px 10px;" ${!enabled ? 'disabled' : ''} onclick="triggerPipelineModule('${module.key}')">
                                        触发
                                    </button>
                                </div>
                            </div>
                            <div style="border-top:1px solid #eee;padding-top:12px;">
                                ${scheduleHtml}
                                ${batchHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // 加载 Worker 配置
            document.getElementById('config-pipeline-worker-interval').value = pipeline['pipeline.worker_interval_minutes'] || 10;
        }

        async function togglePipelineModule(key, enabled) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/features/${key}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                if (res.ok) {
                    pipelineFeaturesData[key] = enabled;
                    renderPipelineModules();
                } else {
                    alert('更新失败');
                }
            } catch (e) {
                alert('更新失败');
            }
        }

        async function triggerPipelineModule(key) {
            const token = localStorage.getItem('access_token');
            const module = PIPELINE_MODULES.find(m => m.key === key);
            if (!module) return;

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '执行中...';

            try {
                let endpoint = module.triggerEndpoint;
                let options = {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                };

                // 翻译需要传递 limit 参数
                if (module.isTranslate) {
                    const batchInput = document.getElementById(`batch-${key}`);
                    const limit = batchInput ? batchInput.value : 100;
                    endpoint = `${ADMIN_BASE}${endpoint}?limit=${limit}`;
                } else {
                    endpoint = `${ADMIN_BASE}${endpoint}`;
                }

                const res = await fetch(endpoint, options);
                const data = await res.json();

                if (res.ok) {
                    let msg = data.message || '执行成功';
                    if (data.translated !== undefined) {
                        msg = `翻译完成: ${data.translated} 篇成功, ${data.skipped} 篇跳过`;
                    }
                    alert(msg);
                } else {
                    alert('执行失败: ' + (data.detail || '未知错误'));
                }
            } catch (e) {
                alert('执行失败: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function saveAllPipelineConfig() {
            const token = localStorage.getItem('access_token');
            const configs = {};
            const scheduler = pipelineConfigData.scheduler || {};
            const pipeline = pipelineConfigData.pipeline || {};

            // 收集所有模块的配置
            PIPELINE_MODULES.forEach(module => {
                if (module.scheduleType === 'interval') {
                    const intervalEl = document.getElementById(`sched-${module.key}-interval`);
                    const baseEl = document.getElementById(`sched-${module.key}-base`);
                    if (intervalEl) configs[module.scheduleConfig.intervalKey] = intervalEl.value;
                    if (baseEl) configs[module.scheduleConfig.baseKey] = baseEl.value;
                } else if (module.scheduleType === 'cron') {
                    const hourEl = document.getElementById(`sched-${module.key}-hour`);
                    if (hourEl) configs[module.scheduleConfig.hourKey] = hourEl.value;
                } else if (module.scheduleType === 'cron_weekly') {
                    const dayEl = document.getElementById(`sched-${module.key}-day`);
                    const hourEl = document.getElementById(`sched-${module.key}-hour`);
                    if (dayEl) configs[module.scheduleConfig.dayKey] = dayEl.value;
                    if (hourEl) configs[module.scheduleConfig.hourKey] = hourEl.value;
                }

                if (module.batchKey) {
                    const batchEl = document.getElementById(`batch-${module.key}`);
                    if (batchEl) configs[module.batchKey] = batchEl.value;
                }
            });

            // Worker 配置
            configs['pipeline.worker_interval_minutes'] = document.getElementById('config-pipeline-worker-interval').value;

            try {
                const res = await fetch(`${ADMIN_BASE}/batch-config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ configs })
                });

                if (res.ok) {
                    alert('配置保存成功');
                    await loadPipelineModules();
                } else {
                    const err = await res.json();
                    alert('保存失败: ' + (err.detail || '未知错误'));
                }
            } catch (e) {
                alert('保存失败: ' + e.message);
            }
        }

        async function togglePipelineFeature(key, enabled) {
            // 已重构为 togglePipelineModule
            await togglePipelineModule(key, enabled);
        }

        async function loadFeaturesList() {
            const token = localStorage.getItem('access_token');
            const container = document.getElementById('features-list');

            try {
                const res = await fetch(`${ADMIN_BASE}/features`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const features = data.features || [];

                // Pipeline 相关功能已移至 Pipeline 管理，这里只显示非 Pipeline 功能
                const pipelineFeatures = [
                    'feature.ai_processor',
                    'feature.embedding',
                    'feature.event_clustering',
                    'feature.topic_radar',
                    'feature.action_items',
                    'feature.report_generation'
                ];

                const featureNames = {
                    'feature.crawler': '数据爬取',
                    'feature.backup': '自动备份',
                    'feature.cleanup': '数据清理',
                    'feature.email_notification': '邮件通知'
                };

                const systemFeatures = features.filter(f => !pipelineFeatures.includes(f.key));

                container.innerHTML = `
                    <div class="toggle-list">
                        ${systemFeatures.map(f => `
                            <div class="toggle-item">
                                <div class="toggle-info">
                                    <h4>${featureNames[f.key] || f.key}</h4>
                                    <p>${f.key}</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox"
                                        ${f.enabled ? 'checked' : ''}
                                        onchange="toggleFeature('${f.key}', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                container.innerHTML = '<p>加载失败</p>';
            }
        }

        async function toggleFeature(featureKey, enabled) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/features/${featureKey}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
            } catch (e) {
                alert('操作失败');
                loadFeaturesList();
            }
        }

        async function saveConfigGroup(group) {
            const token = localStorage.getItem('access_token');
            const configs = {};

            if (group === 'retention') {
                configs['retention.active_days'] = document.getElementById('config-retention-active-days').value;
                configs['retention.archive_days'] = document.getElementById('config-retention-archive-days').value;
                configs['retention.backup_enabled'] = document.getElementById('config-backup-enabled').checked ? 'true' : 'false';
            } else if (group === 'scheduler') {
                // 基础调度配置（Pipeline 相关配置在 Pipeline 管理中保存）
                configs['scheduler.crawl_interval_hours'] = document.getElementById('config-crawl-interval').value;
                configs['scheduler.crawl_base_hour'] = document.getElementById('config-crawl-base-hour').value;
                configs['scheduler.cleanup_hour'] = document.getElementById('config-cleanup-hour').value;
                configs['scheduler.backup_hour'] = document.getElementById('config-backup-hour').value;
                configs['scheduler.notification_hour'] = document.getElementById('config-notification-hour').value;
                configs['scheduler.notification_minute'] = document.getElementById('config-notification-minute').value;
            } else if (group === 'pipeline') {
                // 已移至 saveAllPipelineConfig()
            } else if (group === 'advanced') {
                configs['cache.enabled'] = document.getElementById('config-cache-enabled').checked ? 'true' : 'false';
                configs['cache.default_ttl'] = document.getElementById('config-cache-ttl').value;
                configs['jwt.access_token_expire_minutes'] = document.getElementById('config-jwt-access-expire').value;
                configs['jwt.refresh_token_expire_days'] = document.getElementById('config-jwt-refresh-expire').value;
            }

            try {
                const res = await fetch(`${ADMIN_BASE}/batch-config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ configs })
                });

                if (res.ok) {
                    const data = await res.json();
                    let msg = '配置已保存';
                    if (data.rescheduled_jobs && data.rescheduled_jobs.length > 0) {
                        msg += '\n已重新调度任务: ' + [...new Set(data.rescheduled_jobs)].join(', ');
                    }
                    alert(msg);
                } else {
                    const err = await res.json();
                    alert(err.detail || JSON.stringify(err) || '保存失败');
                }
            } catch (e) {
                alert('保存失败');
            }
        }

        async function saveConfig() {
            saveConfigGroup(currentConfigTab);
        }

        // Backups Management
        let currentBackupPage = 1;

        async function loadBackups() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('backup-list');

            try {
                const res = await fetch(`${ADMIN_BASE}/backups?page=${currentBackupPage}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const backups = data.backups || [];

                if (backups.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">暂无备份记录</td></tr>';
                    return;
                }

                tbody.innerHTML = backups.map(b => `
                    <tr>
                        <td>${b.id}</td>
                        <td>${formatDate(b.backup_date)}</td>
                        <td>${formatSize(b.backup_size)}</td>
                        <td>${b.article_count}</td>
                        <td><span class="badge ${b.status === 'completed' ? 'badge-success' : 'badge-warning'}">${b.status}</span></td>
                        <td>
                            <button class="btn btn-sm" onclick="downloadBackup(${b.id})">下载</button>
                            <button class="btn btn-sm btn-success" onclick="restoreBackup(${b.id})">恢复</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBackup(${b.id})">删除</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6">加载失败</td></tr>';
            }
        }

        function formatSize(bytes) {
            if (!bytes) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return `${bytes.toFixed(1)} ${units[i]}`;
        }

        async function createManualBackup() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/backups/create`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (res.ok) {
                    alert(`备份完成！\n备份文章数: ${data.result?.articles_backed_up || 0}\n删除文章数: ${data.result?.articles_deleted || 0}`);
                    loadBackups();
                } else {
                    alert(data.message || '备份失败');
                }
            } catch (e) {
                alert('备份失败');
            }
        }

        async function downloadBackup(backupId) {
            window.open(`${ADMIN_BASE}/backups/${backupId}/download?token=${localStorage.getItem('access_token')}`, '_blank');
        }

        async function restoreBackup(backupId) {
            if (!confirm('确定要从备份恢复吗？这会将备份中的文章重新插入数据库。')) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/backups/${backupId}/restore`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (res.ok) {
                    alert(`恢复完成！\n恢复: ${data.restored_count}\n跳过: ${data.skipped_count}`);
                } else {
                    alert(data.detail || '恢复失败');
                }
            } catch (e) {
                alert('恢复失败');
            }
        }

        async function deleteBackup(backupId) {
            if (!confirm('确定要删除此备份记录吗？')) return;
            const deleteFile = confirm('是否同时删除备份文件？');

            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/backups/${backupId}?delete_file=${deleteFile}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadBackups();
            } catch (e) {
                alert('删除失败');
            }
        }

        // Audit Logs Management
        let currentAuditPage = 1;

        async function loadAuditLogs() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('audit-list');

            const action = document.getElementById('audit-action-filter').value;
            const resourceType = document.getElementById('audit-resource-filter').value;
            const userId = document.getElementById('audit-user-filter').value;

            let url = `${ADMIN_BASE}/audit-logs?page=${currentAuditPage}&page_size=20`;
            if (action) url += `&action=${encodeURIComponent(action)}`;
            if (resourceType) url += `&resource_type=${encodeURIComponent(resourceType)}`;
            if (userId) url += `&user_id=${userId}`;

            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const logs = data.logs || [];

                document.getElementById('audit-total').textContent = `共 ${data.total || 0} 条记录`;

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">暂无记录</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td>${formatDateTime(log.created_at)}</td>
                        <td>${log.user_id || '-'}</td>
                        <td><span class="badge badge-info">${escapeHtml(log.action)}</span></td>
                        <td>${escapeHtml(log.resource_type)}</td>
                        <td>${escapeHtml(log.resource_id) || '-'}</td>
                        <td>${escapeHtml(log.ip_address) || '-'}</td>
                        <td>
                            <button class="btn btn-sm" onclick="showAuditDetails('${encodeURIComponent(JSON.stringify(log.details || {}))}')">查看</button>
                        </td>
                    </tr>
                `).join('');

                // Load filter options
                loadAuditFilters();

                // Pagination
                const totalPages = Math.ceil((data.total || 0) / 20);
                renderAuditPagination(totalPages);
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="7">加载失败</td></tr>';
            }
        }

        function formatDateTime(iso) {
            if (!iso) return '-';
            return new Date(iso).toLocaleString('zh-CN');
        }

        async function loadAuditFilters() {
            const token = localStorage.getItem('access_token');

            try {
                // Load actions
                const actionsRes = await fetch(`${ADMIN_BASE}/audit-logs/actions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const actionsData = await actionsRes.json();
                const actionSelect = document.getElementById('audit-action-filter');
                const currentAction = actionSelect.value;
                actionSelect.innerHTML = '<option value="">全部</option>' +
                    actionsData.actions.map(a => `<option value="${a}">${a}</option>`).join('');
                actionSelect.value = currentAction;

                // Load resource types
                const typesRes = await fetch(`${ADMIN_BASE}/audit-logs/resource-types`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const typesData = await typesRes.json();
                const typeSelect = document.getElementById('audit-resource-filter');
                const currentType = typeSelect.value;
                typeSelect.innerHTML = '<option value="">全部</option>' +
                    typesData.resource_types.map(t => `<option value="${t}">${t}</option>`).join('');
                typeSelect.value = currentType;
            } catch (e) {
                console.error('Failed to load audit filters:', e);
            }
        }

        function renderAuditPagination(totalPages) {
            const container = document.getElementById('audit-pagination');
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="btn ${i === currentAuditPage ? 'btn-primary' : ''}" onclick="goToAuditPage(${i})">${i}</button> `;
            }
            container.innerHTML = html;
        }

        function goToAuditPage(page) {
            currentAuditPage = page;
            loadAuditLogs();
        }

        function resetAuditFilters() {
            document.getElementById('audit-action-filter').value = '';
            document.getElementById('audit-resource-filter').value = '';
            document.getElementById('audit-user-filter').value = '';
            currentAuditPage = 1;
            loadAuditLogs();
        }

        function showAuditDetails(encodedDetails) {
            const details = JSON.parse(decodeURIComponent(encodedDetails));
            alert(JSON.stringify(details, null, 2) || '无详情');
        }

        // AI Configuration
        let currentAITab = 'general';
        let aiConfig = {};

        function switchAITab(tab) {
            currentAITab = tab;
            document.querySelectorAll('#section-ai .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.ai-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`ai-${tab}-panel`).style.display = 'block';
        }

        async function loadAIConfig() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/ai/config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                aiConfig = data.config || {};

                // Populate general settings
                document.getElementById('ai-provider').value = aiConfig.provider || 'ollama';
                document.getElementById('ai-cache-enabled').checked = aiConfig.cache_enabled !== false;
                document.getElementById('ai-cache-ttl').value = aiConfig.cache_ttl || 86400;
                document.getElementById('ai-max-content').value = aiConfig.max_content_length || 1500;
                document.getElementById('ai-max-title').value = aiConfig.max_title_length || 200;
                document.getElementById('ai-thinking-enabled').checked = aiConfig.thinking_enabled || false;
                document.getElementById('ai-concurrent-enabled').checked = aiConfig.concurrent_enabled || false;
                document.getElementById('ai-no-think').checked = aiConfig.no_think || false;
                document.getElementById('ai-num-predict').value = aiConfig.num_predict || 512;
                document.getElementById('ai-num-predict-simple').value = aiConfig.num_predict_simple || 256;
                document.getElementById('ai-max-retries').value = aiConfig.max_retries || 3;
                document.getElementById('ai-retry-base-delay').value = aiConfig.retry_base_delay || 1.0;
                document.getElementById('ai-batch-concurrency').value = aiConfig.batch_concurrency || 1;
                document.getElementById('ai-fallback-provider').value = aiConfig.fallback_provider || '';
                document.getElementById('ai-workers-heavy').value = aiConfig.workers_heavy || 2;
                document.getElementById('ai-workers-screen').value = aiConfig.workers_screen || 4;
                document.getElementById('ai-translate-max-tokens').value = aiConfig.translate_max_tokens || 4096;

                // Populate Ollama settings
                document.getElementById('ai-ollama-url').value = aiConfig.ollama_base_url || 'http://localhost:11434';
                document.getElementById('ai-ollama-model').value = aiConfig.ollama_model || 'qwen3:32b';
                document.getElementById('ai-ollama-model-light').value = aiConfig.ollama_model_light || '';
                document.getElementById('ai-ollama-timeout').value = aiConfig.ollama_timeout || 120;
                document.getElementById('ai-ollama-api-key').value = aiConfig.ollama_api_key === '***' ? '' : (aiConfig.ollama_api_key || '');

                // Populate OpenAI settings
                document.getElementById('ai-openai-api-key').value = aiConfig.openai_api_key === '***' ? '' : (aiConfig.openai_api_key || '');
                document.getElementById('ai-openai-base-url').value = aiConfig.openai_base_url || '';
                document.getElementById('ai-openai-model').value = aiConfig.openai_model || 'gpt-4o';
                document.getElementById('ai-openai-model-light').value = aiConfig.openai_model_light || 'gpt-4o-mini';
                document.getElementById('ai-openai-timeout').value = aiConfig.openai_timeout || 60;

                // Populate Claude settings
                document.getElementById('ai-claude-api-key').value = aiConfig.claude_api_key === '***' ? '' : (aiConfig.claude_api_key || '');
                document.getElementById('ai-claude-model').value = aiConfig.claude_model || 'claude-sonnet-4-20250514';
                document.getElementById('ai-claude-model-light').value = aiConfig.claude_model_light || 'claude-haiku-4-20250514';
                document.getElementById('ai-claude-timeout').value = aiConfig.claude_timeout || 60;
            } catch (e) {
                console.error('Failed to load AI config:', e);
            }
        }

        async function saveAIGeneral() {
            const token = localStorage.getItem('access_token');
            const config = {
                provider: document.getElementById('ai-provider').value,
                cache_enabled: document.getElementById('ai-cache-enabled').checked,
                cache_ttl: parseInt(document.getElementById('ai-cache-ttl').value) || 86400,
                max_content_length: parseInt(document.getElementById('ai-max-content').value) || 1500,
                max_title_length: parseInt(document.getElementById('ai-max-title').value) || 200,
                thinking_enabled: document.getElementById('ai-thinking-enabled').checked,
                concurrent_enabled: document.getElementById('ai-concurrent-enabled').checked,
                no_think: document.getElementById('ai-no-think').checked,
                num_predict: parseInt(document.getElementById('ai-num-predict').value) || 512,
                num_predict_simple: parseInt(document.getElementById('ai-num-predict-simple').value) || 256,
                max_retries: parseInt(document.getElementById('ai-max-retries').value) || 3,
                retry_base_delay: parseFloat(document.getElementById('ai-retry-base-delay').value) || 1.0,
                batch_concurrency: parseInt(document.getElementById('ai-batch-concurrency').value) || 1,
                fallback_provider: document.getElementById('ai-fallback-provider').value,
                workers_heavy: parseInt(document.getElementById('ai-workers-heavy').value) || 2,
                workers_screen: parseInt(document.getElementById('ai-workers-screen').value) || 4,
                translate_max_tokens: parseInt(document.getElementById('ai-translate-max-tokens').value) || 4096,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/ai/config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                if (res.ok) alert('设置已保存');
                else alert('保存失败');
            } catch (e) {
                alert('保存失败');
            }
        }

        async function saveAIOllama() {
            const token = localStorage.getItem('access_token');
            const config = {
                ollama_base_url: document.getElementById('ai-ollama-url').value,
                ollama_model: document.getElementById('ai-ollama-model').value,
                ollama_model_light: document.getElementById('ai-ollama-model-light').value,
                ollama_timeout: parseInt(document.getElementById('ai-ollama-timeout').value) || 120,
            };
            const apiKey = document.getElementById('ai-ollama-api-key').value;
            if (apiKey) config.ollama_api_key = apiKey;

            try {
                const res = await fetch(`${ADMIN_BASE}/ai/config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                if (res.ok) alert('Ollama 配置已保存');
                else alert('保存失败');
            } catch (e) {
                alert('保存失败');
            }
        }

        async function saveAIOpenAI() {
            const token = localStorage.getItem('access_token');
            const config = {
                openai_model: document.getElementById('ai-openai-model').value,
                openai_model_light: document.getElementById('ai-openai-model-light').value,
                openai_timeout: parseInt(document.getElementById('ai-openai-timeout').value) || 60,
            };
            const openaiKey = document.getElementById('ai-openai-api-key').value;
            if (openaiKey) config.openai_api_key = openaiKey;
            const openaiBaseUrl = document.getElementById('ai-openai-base-url').value;
            if (openaiBaseUrl) config.openai_base_url = openaiBaseUrl;

            try {
                const res = await fetch(`${ADMIN_BASE}/ai/config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                if (res.ok) alert('OpenAI 配置已保存');
                else alert('保存失败');
            } catch (e) {
                alert('保存失败');
            }
        }

        async function saveAIClaude() {
            const token = localStorage.getItem('access_token');
            const config = {
                claude_model: document.getElementById('ai-claude-model').value,
                claude_model_light: document.getElementById('ai-claude-model-light').value,
                claude_timeout: parseInt(document.getElementById('ai-claude-timeout').value) || 60,
            };
            const claudeKey = document.getElementById('ai-claude-api-key').value;
            if (claudeKey) config.claude_api_key = claudeKey;

            try {
                const res = await fetch(`${ADMIN_BASE}/ai/config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                if (res.ok) alert('Claude 配置已保存');
                else alert('保存失败');
            } catch (e) {
                alert('保存失败');
            }
        }

        async function testAIConnection() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/ai/test`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) alert(data.message || '测试成功');
                else alert(data.detail || '测试失败');
            } catch (e) {
                alert('测试失败');
            }
        }

        // Embedding Management
        let embeddingConfig = {};

        async function loadEmbeddingConfig() {
            const token = localStorage.getItem('access_token');
            try {
                // Load config
                const res = await fetch(`${ADMIN_BASE}/config/groups`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const embedding = data.groups?.embedding || {};

                document.getElementById('embedding-provider').value = embedding['embedding.provider'] || 'sentence-transformers';
                document.getElementById('embedding-model').value = embedding['embedding.model'] || 'all-MiniLM-L6-v2';
                document.getElementById('embedding-threshold').value = embedding['embedding.similarity_threshold'] || '0.85';
                document.getElementById('milvus-host').value = embedding['embedding.milvus_host'] || 'localhost';
                document.getElementById('milvus-port').value = embedding['embedding.milvus_port'] || '19530';
                document.getElementById('milvus-collection').value = embedding['embedding.milvus_collection'] || 'article_embeddings';

                // Load stats
                const statsRes = await fetch(`${ADMIN_BASE}/embeddings/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const statsData = await statsRes.json();
                const stats = statsData.stats || {};

                document.getElementById('stat-embedding-total').textContent = stats.total_articles || '-';
                document.getElementById('stat-embedding-computed').textContent = stats.embedded_count || '-';
                document.getElementById('stat-embedding-missing').textContent = stats.missing_count || '-';
                document.getElementById('stat-embedding-provider').textContent = embedding['embedding.provider'] || '-';
            } catch (e) {
                console.error('Failed to load embedding config:', e);
            }
        }

        async function saveEmbeddingConfig() {
            const token = localStorage.getItem('access_token');
            const configs = {
                'embedding.provider': document.getElementById('embedding-provider').value,
                'embedding.model': document.getElementById('embedding-model').value,
                'embedding.similarity_threshold': document.getElementById('embedding-threshold').value,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/batch-config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ configs })
                });
                if (res.ok) alert('嵌入配置已保存');
                else alert('保存失败');
            } catch (e) {
                alert('保存失败');
            }
        }

        async function saveMilvusConfig() {
            const token = localStorage.getItem('access_token');
            const configs = {
                'embedding.milvus_host': document.getElementById('milvus-host').value,
                'embedding.milvus_port': document.getElementById('milvus-port').value,
                'embedding.milvus_collection': document.getElementById('milvus-collection').value,
            };

            try {
                const res = await fetch(`${ADMIN_BASE}/batch-config`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ configs })
                });
                if (res.ok) alert('Milvus 配置已保存');
                else alert('保存失败');
            } catch (e) {
                alert('保存失败');
            }
        }

        async function testMilvusConnection() {
            alert('Milvus 连接测试功能开发中');
        }

        async function recomputeMissingEmbeddings() {
            if (!confirm('确定要计算缺失的嵌入向量吗？这可能需要一些时间。')) return;
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/embeddings/recompute?all=false`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) alert(data.message || '任务已提交');
                else alert(data.detail || '提交失败');
            } catch (e) {
                alert('提交失败');
            }
        }

        async function recomputeAllEmbeddings() {
            if (!confirm('确定要重新计算所有嵌入向量吗？这将消耗大量时间和资源！')) return;
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/embeddings/recompute?all=true`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) alert(data.message || '任务已提交');
                else alert(data.detail || '提交失败');
            } catch (e) {
                alert('提交失败');
            }
        }

        // Events Management
        let currentEventTab = 'list';
        let currentEventPage = 1;
        let selectedEvents = new Set();

        function switchEventTab(tab) {
            currentEventTab = tab;
            document.querySelectorAll('#section-events .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.event-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`event-${tab}-panel`).style.display = 'block';
        }

        async function loadEvents() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('event-list');
            const search = document.getElementById('event-search').value;
            const isActive = document.getElementById('event-active-filter').value;

            let url = `${ADMIN_BASE}/events?page=${currentEventPage}&page_size=15`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (isActive) url += `&is_active=${isActive}`;

            try {
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();

                document.getElementById('event-total').textContent = `共 ${data.total || 0} 个事件`;

                const events = data.events || [];
                if (events.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">暂无事件</td></tr>';
                    return;
                }

                tbody.innerHTML = events.map(e => `
                    <tr>
                        <td><input type="checkbox" class="event-checkbox" data-id="${e.id}" ${selectedEvents.has(e.id) ? 'checked' : ''}></td>
                        <td><a href="#" onclick="viewEventDetail(${e.id})">${escapeHtml(e.title)}</a></td>
                        <td>${e.category || '-'}</td>
                        <td>${e.article_count}</td>
                        <td>${formatDate(e.last_updated_at)}</td>
                        <td><span class="badge ${e.is_active ? 'badge-success' : 'badge-warning'}">${e.is_active ? '活跃' : '不活跃'}</span></td>
                        <td>
                            <button class="btn btn-sm" onclick="viewEventDetail(${e.id})">查看</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEvent(${e.id})">删除</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="7">加载失败</td></tr>';
            }
        }

        function toggleEventSelectAll() {
            const selectAll = document.getElementById('event-select-all').checked;
            document.querySelectorAll('.event-checkbox').forEach(cb => {
                cb.checked = selectAll;
                if (selectAll) selectedEvents.add(parseInt(cb.dataset.id));
                else selectedEvents.delete(parseInt(cb.dataset.id));
            });
        }

        async function mergeSelectedEvents() {
            if (selectedEvents.size < 2) {
                alert('请选择至少 2 个事件进行合并');
                return;
            }
            if (!confirm(`确定要合并选中的 ${selectedEvents.size} 个事件吗？`)) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/events/merge`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ source_event_ids: Array.from(selectedEvents) })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(data.message);
                    selectedEvents.clear();
                    loadEvents();
                } else {
                    alert(data.detail || '合并失败');
                }
            } catch (e) {
                alert('合并失败');
            }
        }

        async function viewEventDetail(eventId) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/events/${eventId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const event = data.event;

                let details = `事件: ${event.title}\n\n`;
                details += `文章数: ${event.article_count}\n`;
                details += `分类: ${event.category || '-'}\n\n`;
                details += `关联文章:\n`;
                event.articles.forEach((a, i) => {
                    details += `${i + 1}. ${a.title}\n`;
                });

                alert(details);
            } catch (e) {
                alert('获取事件详情失败');
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('确定要删除此事件吗？关联的文章不会被删除。')) return;

            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/events/${eventId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadEvents();
            } catch (e) {
                alert('删除失败');
            }
        }

        async function loadEventConfig() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/events/config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const config = data.config || {};

                document.getElementById('event-rule-weight').value = config.rule_weight || 0.4;
                document.getElementById('event-semantic-weight').value = config.semantic_weight || 0.6;
                document.getElementById('event-min-similarity').value = config.min_similarity || 0.7;
            } catch (e) {
                console.error('Failed to load event config:', e);
            }
        }

        async function saveEventConfig() {
            const token = localStorage.getItem('access_token');
            const ruleWeight = document.getElementById('event-rule-weight').value;
            const semanticWeight = document.getElementById('event-semantic-weight').value;
            const minSimilarity = document.getElementById('event-min-similarity').value;

            try {
                const res = await fetch(`${ADMIN_BASE}/events/config?rule_weight=${ruleWeight}&semantic_weight=${semanticWeight}&min_similarity=${minSimilarity}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) alert('配置已保存');
                else alert('保存失败');
            } catch (e) {
                alert('保存失败');
            }
        }

        // Topics Management
        async function loadTopics() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('topic-list');

            try {
                const res = await fetch(`${ADMIN_BASE}/topics`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const topics = data.topics || [];

                if (topics.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">暂无主题</td></tr>';
                    return;
                }

                tbody.innerHTML = topics.map(t => `
                    <tr>
                        <td>${escapeHtml(t.name)}</td>
                        <td><span class="badge ${t.is_manual ? 'badge-info' : 'badge-success'}">${t.is_manual ? '手动' : '自动'}</span></td>
                        <td>${(t.keywords || []).slice(0, 5).join(', ')}</td>
                        <td>${t.article_count || 0}</td>
                        <td>${formatDate(t.created_at)}</td>
                        <td>
                            <button class="btn btn-sm" onclick="editTopic(${t.id})">编辑</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTopic(${t.id})">删除</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6">加载失败</td></tr>';
            }
        }

        function showAddTopicModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>创建主题</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">×</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">主题名称</label>
                            <input type="text" class="form-input" id="new-topic-name" placeholder="例如：大语言模型">
                        </div>
                        <div class="form-group">
                            <label class="form-label">关键词（逗号分隔）</label>
                            <input type="text" class="form-input" id="new-topic-keywords" placeholder="例如：LLM, GPT, 大模型">
                        </div>
                        <div class="form-group">
                            <label class="form-label">描述（可选）</label>
                            <textarea class="form-input" id="new-topic-description" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">取消</button>
                        <button class="btn btn-primary" onclick="createTopic()">创建</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function createTopic() {
            const token = localStorage.getItem('access_token');
            const name = document.getElementById('new-topic-name').value;
            const keywords = document.getElementById('new-topic-keywords').value.split(',').map(k => k.trim()).filter(k => k);
            const description = document.getElementById('new-topic-description').value;

            if (!name) {
                alert('请输入主题名称');
                return;
            }

            try {
                const res = await fetch(`${ADMIN_BASE}/topics`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, keywords, description, is_manual: true })
                });
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadTopics();
                } else {
                    const err = await res.json();
                    alert(err.detail || '创建失败');
                }
            } catch (e) {
                alert('创建失败');
            }
        }

        async function deleteTopic(topicId) {
            if (!confirm('确定要删除此主题吗？')) return;

            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/topics/${topicId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadTopics();
            } catch (e) {
                alert('删除失败');
            }
        }

        function editTopic(topicId) {
            alert('主题编辑功能开发中');
        }

        // Reports Management
        async function loadReports() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('report-list');

            try {
                const res = await fetch(`${ADMIN_BASE}/reports`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const reports = data.reports || [];

                if (reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888;">暂无报告</td></tr>';
                    return;
                }

                tbody.innerHTML = reports.map(r => `
                    <tr>
                        <td>${escapeHtml(r.title)}</td>
                        <td><span class="badge badge-info">${r.report_type || '周报'}</span></td>
                        <td>${r.date_range || '-'}</td>
                        <td>${formatDate(r.created_at)}</td>
                        <td>
                            <button class="btn btn-sm" onclick="viewReport(${r.id})">查看</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteReport(${r.id})">删除</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5">加载失败</td></tr>';
            }
        }

        async function generateReport() {
            const token = localStorage.getItem('access_token');
            const reportType = document.getElementById('report-type').value;

            try {
                const res = await fetch(`${ADMIN_BASE}/reports/generate?report_type=${reportType}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    alert('报告已生成');
                    loadReports();
                } else {
                    alert(data.detail || '生成失败');
                }
            } catch (e) {
                alert('生成失败');
            }
        }

        async function viewReport(reportId) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/reports/${reportId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                alert(JSON.stringify(data.report, null, 2));
            } catch (e) {
                alert('获取报告失败');
            }
        }

        async function deleteReport(reportId) {
            if (!confirm('确定要删除此报告吗？')) return;

            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/reports/${reportId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadReports();
            } catch (e) {
                alert('删除失败');
            }
        }

        // Roles Management
        async function loadRoles() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/roles`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const tbody = document.getElementById('role-list');
                const builtinRoles = ['superuser', 'admin', 'user', 'guest'];
                tbody.innerHTML = data.roles.map(r => `
                    <tr>
                        <td>${r.id}</td>
                        <td><span class="badge badge-info">${escapeHtml(r.name)}</span></td>
                        <td>${escapeHtml(r.description || '')}</td>
                        <td>${r.permissions ? r.permissions.length : 0}</td>
                        <td>${r.user_count || 0}</td>
                        <td>${formatDate(r.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="showEditRoleModal(${r.id})">编辑</button>
                            ${builtinRoles.includes(r.name) ? '' : `<button class="btn btn-sm btn-danger" onclick="deleteRole(${r.id}, '${escapeHtml(r.name)}')">删除</button>`}
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load roles:', e);
            }
        }

        async function showAddRoleModal() {
            const token = localStorage.getItem('access_token');
            let permissionsData = { grouped: {} };
            try {
                const res = await fetch(`${ADMIN_BASE}/permissions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                permissionsData = await res.json();
            } catch (e) {
                console.error('Failed to load permissions:', e);
            }

            const grouped = permissionsData.grouped || {};
            let permHtml = '';
            for (const [resource, perms] of Object.entries(grouped)) {
                permHtml += `<div style="margin-bottom: 12px;">
                    <div style="font-weight: 600; font-size: 13px; color: #333; margin-bottom: 6px; border-bottom: 1px solid #eee; padding-bottom: 4px;">
                        ${escapeHtml(resource)}
                        <label style="font-weight: normal; font-size: 12px; margin-left: 8px; cursor: pointer;">
                            <input type="checkbox" onchange="toggleResourcePerms(this, 'add', '${resource}')"> 全选
                        </label>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${perms.map(p => `
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; min-width: 140px; cursor: pointer;" class="perm-item-add" data-resource="${resource}">
                                <input type="checkbox" name="add-perm" value="${p.id}">
                                ${escapeHtml(p.action)}
                                <span style="color: #999; font-size: 11px;">${escapeHtml(p.description || '')}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>`;
            }

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'role-add-modal';
            modal.innerHTML = `
                <div class="modal-content" style="width: 700px;">
                    <div class="modal-header">
                        <h3>新建角色</h3>
                        <span class="modal-close" onclick="document.getElementById('role-add-modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">角色名称</label>
                            <input type="text" class="form-input" id="add-role-name" placeholder="例如: editor, reviewer">
                        </div>
                        <div class="form-group">
                            <label class="form-label">角色描述</label>
                            <input type="text" class="form-input" id="add-role-desc" placeholder="简要描述该角色的用途">
                        </div>
                        <div class="form-group">
                            <label class="form-label">权限分配</label>
                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px;">
                                ${permHtml}
                            </div>
                        </div>
                        <div style="text-align: right; margin-top: 16px;">
                            <button class="btn" onclick="document.getElementById('role-add-modal').remove()">取消</button>
                            <button class="btn btn-primary" style="margin-left: 8px;" onclick="saveNewRole()">创建</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function toggleResourcePerms(checkbox, prefix, resource) {
            const checked = checkbox.checked;
            document.querySelectorAll(`.perm-item-${prefix}[data-resource="${resource}"] input[type="checkbox"]`).forEach(cb => {
                cb.checked = checked;
            });
        }

        async function saveNewRole() {
            const name = document.getElementById('add-role-name').value.trim();
            const description = document.getElementById('add-role-desc').value.trim();
            if (!name) {
                alert('请输入角色名称');
                return;
            }
            const permissionIds = [];
            document.querySelectorAll('input[name="add-perm"]:checked').forEach(cb => {
                permissionIds.push(parseInt(cb.value));
            });

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/roles`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, permission_ids: permissionIds })
                });
                if (!res.ok) {
                    const err = await res.json();
                    alert('创建失败: ' + (err.detail || JSON.stringify(err)));
                    return;
                }
                document.getElementById('role-add-modal').remove();
                loadRoles();
                alert('角色创建成功');
            } catch (e) {
                alert('创建失败: ' + e.message);
            }
        }

        async function showEditRoleModal(roleId) {
            const token = localStorage.getItem('access_token');
            let roleData = null;
            let permissionsData = { grouped: {} };

            try {
                const [rolesRes, permsRes] = await Promise.all([
                    fetch(`${ADMIN_BASE}/roles`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${ADMIN_BASE}/permissions`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                const rolesData = await rolesRes.json();
                permissionsData = await permsRes.json();
                roleData = rolesData.roles.find(r => r.id === roleId);
            } catch (e) {
                console.error('Failed to load role data:', e);
                alert('加载角色数据失败');
                return;
            }

            if (!roleData) {
                alert('未找到该角色');
                return;
            }

            const currentPermIds = new Set((roleData.permissions || []).map(p => p.id));
            const builtinRoles = ['superuser', 'admin', 'user', 'guest'];
            const isBuiltin = builtinRoles.includes(roleData.name);
            const grouped = permissionsData.grouped || {};

            let permHtml = '';
            for (const [resource, perms] of Object.entries(grouped)) {
                const allChecked = perms.every(p => currentPermIds.has(p.id));
                permHtml += `<div style="margin-bottom: 12px;">
                    <div style="font-weight: 600; font-size: 13px; color: #333; margin-bottom: 6px; border-bottom: 1px solid #eee; padding-bottom: 4px;">
                        ${escapeHtml(resource)}
                        <label style="font-weight: normal; font-size: 12px; margin-left: 8px; cursor: pointer;">
                            <input type="checkbox" ${allChecked ? 'checked' : ''} onchange="toggleResourcePerms(this, 'edit', '${resource}')"> 全选
                        </label>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${perms.map(p => `
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; min-width: 140px; cursor: pointer;" class="perm-item-edit" data-resource="${resource}">
                                <input type="checkbox" name="edit-perm" value="${p.id}" ${currentPermIds.has(p.id) ? 'checked' : ''}>
                                ${escapeHtml(p.action)}
                                <span style="color: #999; font-size: 11px;">${escapeHtml(p.description || '')}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>`;
            }

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'role-edit-modal';
            modal.innerHTML = `
                <div class="modal-content" style="width: 700px;">
                    <div class="modal-header">
                        <h3>编辑角色: ${escapeHtml(roleData.name)}</h3>
                        <span class="modal-close" onclick="document.getElementById('role-edit-modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">角色名称</label>
                            <input type="text" class="form-input" id="edit-role-name" value="${escapeHtml(roleData.name)}" ${isBuiltin ? 'disabled' : ''}>
                            ${isBuiltin ? '<span style="font-size: 11px; color: #999;">内置角色名称不可修改</span>' : ''}
                        </div>
                        <div class="form-group">
                            <label class="form-label">角色描述</label>
                            <input type="text" class="form-input" id="edit-role-desc" value="${escapeHtml(roleData.description || '')}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">权限分配 (已选 <span id="edit-perm-count">${currentPermIds.size}</span> 项)</label>
                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px;">
                                ${permHtml}
                            </div>
                        </div>
                        <div style="text-align: right; margin-top: 16px;">
                            <button class="btn" onclick="document.getElementById('role-edit-modal').remove()">取消</button>
                            <button class="btn btn-primary" style="margin-left: 8px;" onclick="saveEditRole(${roleId})">保存</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Live count update
            modal.querySelectorAll('input[name="edit-perm"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    const count = modal.querySelectorAll('input[name="edit-perm"]:checked').length;
                    document.getElementById('edit-perm-count').textContent = count;
                });
            });
        }

        async function saveEditRole(roleId) {
            const name = document.getElementById('edit-role-name').value.trim();
            const description = document.getElementById('edit-role-desc').value.trim();
            if (!name) {
                alert('角色名称不能为空');
                return;
            }
            const permissionIds = [];
            document.querySelectorAll('input[name="edit-perm"]:checked').forEach(cb => {
                permissionIds.push(parseInt(cb.value));
            });

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/roles/${roleId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, permission_ids: permissionIds })
                });
                if (!res.ok) {
                    const err = await res.json();
                    alert('保存失败: ' + (err.detail || JSON.stringify(err)));
                    return;
                }
                document.getElementById('role-edit-modal').remove();
                loadRoles();
                alert('角色更新成功');
            } catch (e) {
                alert('保存失败: ' + e.message);
            }
        }

        async function deleteRole(roleId, roleName) {
            if (!confirm(`确定要删除角色 "${roleName}" 吗？删除后无法恢复。`)) return;

            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/roles/${roleId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    const err = await res.json();
                    alert('删除失败: ' + (err.detail || JSON.stringify(err)));
                    return;
                }
                loadRoles();
                alert('角色已删除');
            } catch (e) {
                alert('删除失败: ' + e.message);
            }
        }

        // HackerNews Management
        async function loadHackerNewsSources() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('hackernews-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/hackernews`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.sources?.length ? data.sources.map(b => `
                    <tr>
                        <td><input type="checkbox" data-id="${b.id}" class="hackernews-checkbox"></td>
                        <td>${escapeHtml(b.feed_name)}</td>
                        <td><code>${escapeHtml(b.feed_type)}</code></td>
                        <td><span class="badge ${b.is_active ? 'badge-success' : 'badge-warning'}">${b.is_active ? '活跃' : '禁用'}</span></td>
                        <td>${b.last_fetched_at ? formatDate(b.last_fetched_at) : '从未'}</td>
                        <td>
                            <button class="btn btn-sm ${b.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleHackerNewsBoard(${b.id}, ${!b.is_active})">
                                ${b.is_active ? '禁用' : '启用'}
                            </button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="6" style="text-align: center; color: #888;">暂无 HackerNews 板块</td></tr>';
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6">加载失败</td></tr>';
            }
        }

        async function toggleHackerNewsBoard(boardId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/hackernews/${boardId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    alert(error.detail || '操作失败');
                    return;
                }
                
                loadHackerNewsSources();
                loadSources();
            } catch (e) {
                alert('操作失败');
            }
        }

        async function batchToggleHackerNews(isActive) {
            const token = localStorage.getItem('access_token');
            const checkboxes = document.querySelectorAll('.hackernews-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            
            if (ids.length === 0) {
                alert('请先选择要操作的板块');
                return;
            }
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/hackernews/batch?is_active=${isActive}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ids)
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    alert(error.detail || '操作失败');
                    return;
                }
                
                loadHackerNewsSources();
                loadSources();
            } catch (e) {
                alert('批量操作失败');
            }
        }

        // Reddit Management
        async function loadRedditSources() {
            const token = localStorage.getItem('access_token');
            const search = document.getElementById('reddit-search')?.value || '';
            const tbody = document.getElementById('reddit-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/reddit?search=${encodeURIComponent(search)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.sources?.length ? data.sources.map(s => `
                    <tr>
                        <td><input type="checkbox" data-id="${s.id}" class="reddit-checkbox"></td>
                        <td><strong>r/${escapeHtml(s.subreddit)}</strong></td>
                        <td>${escapeHtml(s.description || '-')}</td>
                        <td><span class="badge ${s.is_active ? 'badge-success' : 'badge-warning'}">${s.is_active ? '活跃' : '禁用'}</span></td>
                        <td>${s.last_fetched_at ? formatDate(s.last_fetched_at) : '从未'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="showEditRedditModal(${s.id}, '${escapeHtml(s.subreddit).replace(/'/g, "\\'")}', '${escapeHtml(s.description || '').replace(/'/g, "\\'")}')">编辑</button>
                            <button class="btn btn-sm ${s.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleRedditSource(${s.id}, ${!s.is_active})">
                                ${s.is_active ? '禁用' : '启用'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRedditSource(${s.id})">删除</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="6" style="text-align: center; color: #888;">暂无 Reddit 订阅源</td></tr>';
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6">加载失败</td></tr>';
            }
        }

        function showAddRedditModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>添加 Reddit 订阅源</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">×</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Subreddit 名称 *</label>
                            <input type="text" class="form-input" id="new-reddit-subreddit" placeholder="例如：programming 或 programming" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">描述</label>
                            <input type="text" class="form-input" id="new-reddit-description" placeholder="可选描述">
                        </div>
                        <p style="font-size: 12px; color: #888;">
                            提示：输入 subreddit 名称，不需要 r/ 前缀。系统将使用 Reddit 的公开 RSS 接口抓取内容。
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">取消</button>
                        <button class="btn btn-primary" onclick="addRedditSource()">添加</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addRedditSource() {
            const token = localStorage.getItem('access_token');
            const subreddit = document.getElementById('new-reddit-subreddit').value.replace(/^r\//, '');
            const description = document.getElementById('new-reddit-description').value;
            
            if (!subreddit) {
                alert('请填写 Subreddit 名称');
                return;
            }
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/reddit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ subreddit, description })
                });
                
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadRedditSources();
                    loadSources();
                } else {
                    const err = await res.json();
                    alert(err.detail || '添加失败');
                }
            } catch (e) {
                alert('添加失败');
            }
        }

        function showEditRedditModal(sourceId, subreddit, description) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>编辑 Reddit 订阅源</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">×</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Subreddit 名称</label>
                            <input type="text" class="form-input" id="edit-reddit-subreddit" value="${subreddit}" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">描述</label>
                            <input type="text" class="form-input" id="edit-reddit-description" value="${description}">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">取消</button>
                        <button class="btn btn-primary" onclick="updateRedditSource(${sourceId})">保存</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function updateRedditSource(sourceId) {
            const token = localStorage.getItem('access_token');
            const description = document.getElementById('edit-reddit-description').value;
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/reddit/${sourceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ description })
                });
                
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadRedditSources();
                } else {
                    const err = await res.json();
                    alert(err.detail || '更新失败');
                }
            } catch (e) {
                alert('更新失败');
            }
        }

        async function toggleRedditSource(sourceId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/reddit/${sourceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                loadRedditSources();
                loadSources();
            } catch (e) {
                alert('操作失败');
            }
        }

        async function deleteRedditSource(sourceId) {
            if (!confirm('确定要删除此 Reddit 订阅源吗？')) return;
            
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/reddit/${sourceId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadRedditSources();
                loadSources();
            } catch (e) {
                alert('删除失败');
            }
        }

        // Twitter Management
        async function loadTwitterSources() {
            const token = localStorage.getItem('access_token');
            const search = document.getElementById('twitter-search')?.value || '';
            const tbody = document.getElementById('twitter-list');
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/twitter?search=${encodeURIComponent(search)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                tbody.innerHTML = data.users?.length ? data.users.map(u => `
                    <tr>
                        <td><input type="checkbox" data-id="${u.id}" class="twitter-checkbox"></td>
                        <td><strong>@${escapeHtml(u.username)}</strong></td>
                        <td>${escapeHtml(u.display_name || '-')}</td>
                        <td><span class="badge ${u.is_active ? 'badge-success' : 'badge-warning'}">${u.is_active ? '活跃' : '禁用'}</span></td>
                        <td>${u.last_fetched_at ? formatDate(u.last_fetched_at) : '从未'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="showEditTwitterModal(${u.id}, '${escapeHtml(u.username).replace(/'/g, "\\'")}', '${escapeHtml(u.display_name || '').replace(/'/g, "\\'")}')">编辑</button>
                            <button class="btn btn-sm ${u.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleTwitterSource(${u.id}, ${!u.is_active})">
                                ${u.is_active ? '禁用' : '启用'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTwitterSource(${u.id})">删除</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="6" style="text-align: center; color: #888;">暂无 Twitter 用户订阅</td></tr>';
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6">加载失败</td></tr>';
            }
        }

        function showAddTwitterModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>添加 Twitter 用户订阅</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">×</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">用户名 *</label>
                            <input type="text" class="form-input" id="new-twitter-username" placeholder="例如：elonmusk" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">显示名称</label>
                            <input type="text" class="form-input" id="new-twitter-displayname" placeholder="可选">
                        </div>
                        <p style="font-size: 12px; color: #888;">
                            提示：输入 Twitter 用户名，不需要 @ 符号。请确保已配置 Twitter API 凭证。
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">取消</button>
                        <button class="btn btn-primary" onclick="addTwitterSource()">添加</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addTwitterSource() {
            const token = localStorage.getItem('access_token');
            const username = document.getElementById('new-twitter-username').value.replace(/^@/, '');
            const display_name = document.getElementById('new-twitter-displayname').value;
            
            if (!username) {
                alert('请填写用户名');
                return;
            }
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/twitter`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, display_name })
                });
                
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadTwitterSources();
                    loadSources();
                } else {
                    const err = await res.json();
                    alert(err.detail || '添加失败');
                }
            } catch (e) {
                alert('添加失败');
            }
        }

        function showEditTwitterModal(sourceId, username, displayName) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>编辑 Twitter 用户订阅</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">×</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">用户名</label>
                            <input type="text" class="form-input" id="edit-twitter-username" value="${username}" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">显示名称</label>
                            <input type="text" class="form-input" id="edit-twitter-displayname" value="${displayName}">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal').remove()">取消</button>
                        <button class="btn btn-primary" onclick="updateTwitterSource(${sourceId})">保存</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function updateTwitterSource(sourceId) {
            const token = localStorage.getItem('access_token');
            const display_name = document.getElementById('edit-twitter-displayname').value;
            
            try {
                const res = await fetch(`${ADMIN_BASE}/sources/twitter/${sourceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ display_name })
                });
                
                if (res.ok) {
                    document.querySelector('.modal').remove();
                    loadTwitterSources();
                } else {
                    const err = await res.json();
                    alert(err.detail || '更新失败');
                }
            } catch (e) {
                alert('更新失败');
            }
        }

        async function toggleTwitterSource(sourceId, isActive) {
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/twitter/${sourceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: isActive })
                });
                loadTwitterSources();
                loadSources();
            } catch (e) {
                alert('操作失败');
            }
        }

        async function deleteTwitterSource(sourceId) {
            if (!confirm('确定要删除此 Twitter 用户订阅吗？')) return;
            
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${ADMIN_BASE}/sources/twitter/${sourceId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadTwitterSources();
                loadSources();
            } catch (e) {
                alert('删除失败');
            }
        }

        // Utils
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(iso) {
            if (!iso) return '';
            return new Date(iso).toLocaleDateString('zh-CN');
        }

        // ============================================================================
        // Pipeline Monitoring Functions
        // ============================================================================

        async function loadPipelineMonitor() {
            await Promise.all([
                refreshPipelineStats(),
                loadTokenStats(),
                loadProcessingLogs(),
            ]);
        }

        async function refreshPipelineStats() {
            const token = localStorage.getItem('access_token');
            const headers = { 'Authorization': `Bearer ${token}` };

            try {
                // Get overall dashboard stats for article count
                const statsRes = await fetch(`${ADMIN_BASE}/stats`, { headers });
                const stats = statsRes.ok ? await statsRes.json() : {};
                const totalArticles = stats.articles || 0;

                // Get AI processed count (articles with ai_processed_at not null)
                // We query the articles API with a small page to get counts
                const aiRes = await fetch(`${API_BASE}/articles?page_size=1`, { headers });
                const aiData = aiRes.ok ? await aiRes.json() : { total: 0 };

                // Try to get embedding stats
                let embedCount = '-';
                try {
                    const embedRes = await fetch(`${API_BASE}/embedding/stats`, { headers });
                    if (embedRes.ok) {
                        const embedData = await embedRes.json();
                        embedCount = embedData.total_embeddings || embedData.total || 0;
                    }
                } catch(e) {}

                // Try to get event count
                let eventCount = '-';
                try {
                    const eventRes = await fetch(`${API_BASE}/events?limit=1&offset=0&active_only=false`, { headers });
                    if (eventRes.ok) {
                        const eventData = await eventRes.json();
                        eventCount = eventData.total || 0;
                    }
                } catch(e) {}

                // Try to get topic count
                let topicCount = '-';
                try {
                    const topicRes = await fetch(`${API_BASE}/topics?limit=1&offset=0`, { headers });
                    if (topicRes.ok) {
                        const topicData = await topicRes.json();
                        topicCount = topicData.total || 0;
                    }
                } catch(e) {}

                document.getElementById('pl-stat-ai').textContent = totalArticles;
                document.getElementById('pl-stat-embed').textContent = embedCount;
                document.getElementById('pl-stat-events').textContent = eventCount;
                document.getElementById('pl-stat-topics').textContent = topicCount;

                document.getElementById('pl-detail-ai').textContent = totalArticles + ' 篇';
                document.getElementById('pl-detail-embed').textContent = embedCount + ' 篇';
                document.getElementById('pl-detail-events').textContent = eventCount + ' 个';
                document.getElementById('pl-detail-topics').textContent = topicCount + ' 个';

                // 加载调度配置并更新显示
                await loadPipelineScheduleDisplay();
            } catch(e) {
                console.error('Failed to load pipeline stats:', e);
            }
        }

        // 加载并显示调度配置
        async function loadPipelineScheduleDisplay() {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`${ADMIN_BASE}/config/groups`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const scheduler = (data.groups || {}).scheduler || {};

                // AI 分析调度
                const aiInterval = scheduler['scheduler.ai_process_interval_hours'] || 1;
                const aiBaseHour = scheduler['scheduler.ai_process_base_hour'] || 0;
                document.getElementById('pl-schedule-ai').textContent = `每${aiInterval}小时 (${aiBaseHour}:00 起)`;

                // 向量化调度
                const embedInterval = scheduler['scheduler.embedding_interval_hours'] || 2;
                const embedBaseHour = scheduler['scheduler.embedding_base_hour'] || 0;
                document.getElementById('pl-schedule-embed').textContent = `每${embedInterval}小时 (${embedBaseHour}:00 起)`;

                // 事件聚类调度
                const eventHour = scheduler['scheduler.event_cluster_hour'] || 2;
                document.getElementById('pl-schedule-events').textContent = `每日 ${eventHour}:00`;

                // 话题发现调度
                const topicDay = scheduler['scheduler.topic_discovery_day'] || 'mon';
                const topicHour = scheduler['scheduler.topic_discovery_hour'] || 1;
                const dayNames = { mon: '周一', tue: '周二', wed: '周三', thu: '周四', fri: '周五', sat: '周六', sun: '周日' };
                document.getElementById('pl-schedule-topics').textContent = `${dayNames[topicDay] || '周一'} ${topicHour}:00`;
            } catch (e) {
                console.error('Failed to load schedule config:', e);
            }
        }

        async function loadTokenStats() {
            const token = localStorage.getItem('access_token');
            const headers = { 'Authorization': `Bearer ${token}` };
            const tbody = document.getElementById('token-stats-body');

            try {
                const res = await fetch(`${API_BASE}/ai/token-stats?days=7`, { headers });
                if (!res.ok) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#999;">无法加载 Token 统计（功能可能未启用）</td></tr>`;
                    return;
                }
                const data = await res.json();
                const stats = data.stats || data || [];

                if (!Array.isArray(stats) || stats.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#999;">暂无 Token 消耗数据</td></tr>`;
                    return;
                }

                tbody.innerHTML = stats.slice(0, 20).map(s => `
                    <tr>
                        <td>${escapeHtml(s.date || '-')}</td>
                        <td>${escapeHtml(s.provider || '-')}</td>
                        <td>${escapeHtml(s.model || '-')}</td>
                        <td>${s.total_calls || 0}</td>
                        <td>${s.cached_calls || 0}</td>
                        <td>${(s.total_input_chars || 0).toLocaleString()}</td>
                        <td>${(s.total_output_chars || 0).toLocaleString()}</td>
                    </tr>
                `).join('');
            } catch(e) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#dc2626;">加载失败</td></tr>`;
            }
        }

        async function loadProcessingLogs() {
            const token = localStorage.getItem('access_token');
            const headers = { 'Authorization': `Bearer ${token}` };
            const tbody = document.getElementById('processing-logs-body');

            try {
                // Try the AI status endpoint or a logs endpoint
                const res = await fetch(`${ADMIN_BASE}/ai-logs?limit=20`, { headers });
                if (!res.ok) {
                    // Fallback: show a message
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#999;">处理日志端点暂未开放</td></tr>`;
                    return;
                }
                const data = await res.json();
                const logs = data.logs || data || [];

                if (!Array.isArray(logs) || logs.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#999;">暂无处理日志</td></tr>`;
                    return;
                }

                tbody.innerHTML = logs.slice(0, 20).map(l => {
                    const statusBadge = l.success
                        ? '<span class="badge badge-success">成功</span>'
                        : `<span class="badge badge-danger" title="${escapeHtml(l.error_message || '')}">失败</span>`;
                    const cacheBadge = l.cached
                        ? '<span class="badge badge-info">缓存</span>'
                        : '<span class="badge badge-warning">实时</span>';
                    return `
                        <tr>
                            <td>${l.article_id || '-'}</td>
                            <td>${escapeHtml(l.provider || '-')}</td>
                            <td>${escapeHtml(l.model || '-')}</td>
                            <td>${escapeHtml(l.task_type || '-')}</td>
                            <td>${l.duration_ms || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>${cacheBadge}</td>
                            <td>${l.created_at ? formatDate(l.created_at) : '-'}</td>
                        </tr>
                    `;
                }).join('');
            } catch(e) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#999;">处理日志端点暂未开放</td></tr>`;
            }
        }
    </script>
</body>
</html>
