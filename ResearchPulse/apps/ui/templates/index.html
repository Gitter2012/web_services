<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResearchPulse - å­¦æœ¯èµ„è®¯èšåˆ</title>
    <script>
        // åŠ¨æ€æ£€æµ‹ä»£ç†å‰ç¼€ï¼ˆæå‰æ‰§è¡Œï¼Œä¾›é™æ€ HTML ä½¿ç”¨ï¼‰
        (function() {
            var path = window.location.pathname;
            var rpIndex = path.indexOf('/researchpulse');
            var prefix = rpIndex > 0 ? path.substring(0, rpIndex) : '';
            window.APP_BASE = prefix + '/researchpulse';
            window.API_BASE = prefix + '/researchpulse/api';
            window.AUTH_BASE = prefix + '/api/v1';
        })();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }

        /* Header */
        .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-inner { max-width: 1400px; margin: 0 auto; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo h1 { font-size: 22px; font-weight: 600; }
        .logo .badge { background: #e94560; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .nav { display: flex; gap: 24px; }
        .nav a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; transition: color 0.2s; }
        .nav a:hover { color: white; }
        .nav a.active { color: #4ecdc4; }
        .auth-area { display: flex; align-items: center; gap: 16px; }
        .auth-area .user-info { display: flex; align-items: center; gap: 8px; color: #4ecdc4; font-size: 14px; }
        .auth-area a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; }
        .auth-area a:hover { color: white; }

        /* Main Layout */
        .main-container { max-width: 1400px; margin: 0 auto; padding: 24px; display: grid; grid-template-columns: 280px 1fr; gap: 24px; }

        /* Sidebar */
        .sidebar { background: white; border-radius: 12px; padding: 20px; height: fit-content; position: sticky; top: 80px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .sidebar-section { margin-bottom: 24px; }
        .sidebar-section:last-child { margin-bottom: 0; }
        .sidebar-title { font-size: 13px; font-weight: 600; color: #666; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Filter Controls */
        .filter-group { margin-bottom: 16px; }
        .filter-group:last-child { margin-bottom: 0; }
        .filter-label { font-size: 12px; color: #888; margin-bottom: 6px; display: block; }
        .filter-select { width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: border-color 0.2s; }
        .filter-select:focus { outline: none; border-color: #4ecdc4; }
        .filter-input { width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s; }
        .filter-input:focus { outline: none; border-color: #4ecdc4; }

        /* Source Filter Cards */
        .source-cards { display: flex; flex-direction: column; gap: 8px; }
        .source-card { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .source-card:hover { border-color: #4ecdc4; background: #f8fffe; }
        .source-card.active { border-color: #4ecdc4; background: #e8fbf9; }
        .source-card .icon { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: white; }
        .source-card .icon.arxiv { background: #b31b1b; }
        .source-card .icon.rss { background: #f39c12; }
        .source-card .icon.wechat { background: #07c160; }
        .source-card .icon.weibo { background: #e6162d; }
        .source-card .icon.hackernews { background: #ff6600; }
        .source-card .icon.reddit { background: #ff4500; }
        .source-card .icon.twitter { background: #1da1f2; }
        .source-card .info { flex: 1; }
        .source-card .name { font-size: 14px; font-weight: 500; color: #333; }
        .source-card .count { font-size: 12px; color: #888; }
        .source-card .check { color: #4ecdc4; font-size: 18px; }

        /* Category Tags */
        .category-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .category-tag { padding: 6px 12px; background: #f5f5f5; border-radius: 16px; font-size: 12px; color: #666; cursor: pointer; transition: all 0.2s; }
        .category-tag:hover { background: #e8e8e8; }
        .category-tag.active { background: #4ecdc4; color: white; }

        /* Content Area */
        .content { min-width: 0; }

        /* Stats Bar */
        .stats-bar { background: white; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .stats-left { display: flex; gap: 24px; }
        .stat-item { display: flex; align-items: center; gap: 8px; }
        .stat-value { font-size: 24px; font-weight: 600; color: #1a1a2e; }
        .stat-label { font-size: 12px; color: #888; }
        .sort-select { padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px; }

        /* Article List */
        .article-list { display: flex; flex-direction: column; gap: 16px; }
        .article-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: box-shadow 0.2s; }
        .article-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        .article-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .article-title { font-size: 17px; font-weight: 600; color: #1a1a2e; line-height: 1.4; }
        .article-title a { color: inherit; text-decoration: none; }
        .article-title a:hover { color: #4ecdc4; }
        .article-source { display: flex; align-items: center; gap: 8px; flex-shrink: 0; margin-left: 16px; max-width: 200px; }
        .source-badge { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .source-badge.arxiv { background: #fef2f2; color: #b91c1c; text-transform: uppercase; }
        .source-badge.rss { background: #fffbeb; color: #d97706; }
        .source-badge.wechat { background: #ecfdf5; color: #059669; }
        .source-badge.weibo { background: #fef2f2; color: #dc2626; }
        .source-badge.hackernews { background: #fff7ed; color: #ea580c; }
        .source-badge.reddit { background: #fef2f2; color: #dc2626; }
        .source-badge.twitter { background: #eff6ff; color: #2563eb; }

        .source-card .icon.wechat { background: #059669; color: white; }

        .article-meta { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 12px; font-size: 13px; color: #666; }
        .article-meta span { display: flex; align-items: center; gap: 4px; }
        .article-meta .icon { font-size: 14px; }

        .article-content { color: #444; line-height: 1.8; font-size: 14px; white-space: pre-wrap; word-break: break-word; }
        .article-content.collapsed { max-height: 80px; overflow: hidden; position: relative; }
        .article-content.collapsed::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: linear-gradient(transparent, white); }
        
        .expand-btn { color: #4ecdc4; font-size: 12px; cursor: pointer; margin-top: 4px; }
        .expand-btn:hover { text-decoration: underline; }

        .article-footer { margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .article-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag { padding: 4px 10px; background: #f5f5f5; border-radius: 4px; font-size: 11px; color: #666; }
        .article-actions { display: flex; gap: 8px; }
        .action-btn { padding: 6px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 12px; background: white; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .action-btn:hover { background: #f5f5f5; }
        .action-btn.starred { border-color: #fbbf24; background: #fffbeb; color: #d97706; }

        /* Export Button */
        .export-btn { width: 100%; padding: 10px 16px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; transition: all 0.2s; }
        .export-btn:hover { background: #f5f5f5; border-color: #4ecdc4; color: #4ecdc4; }

        /* ArXiv Specific Fields */
        .arxiv-details { background: #fafafa; border-radius: 8px; padding: 12px 16px; margin-top: 12px; }
        .arxiv-details .row { display: flex; gap: 24px; font-size: 12px; color: #666; }
        .arxiv-details .label { color: #888; }
        .arxiv-details .value { color: #333; }

        /* Pagination */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; padding: 16px; background: white; border-radius: 12px; }
        .page-btn { padding: 8px 14px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .page-btn:hover { background: #f5f5f5; }
        .page-btn.active { background: #1a1a2e; color: white; border-color: #1a1a2e; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 14px; color: #666; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 32px; border-radius: 16px; width: 400px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h2 { font-size: 20px; }
        .modal-close { font-size: 24px; cursor: pointer; color: #999; }
        .modal-body input { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .modal-body input:focus { outline: none; border-color: #4ecdc4; }
        .modal-body button { width: 100%; padding: 12px; background: #1a1a2e; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
        .modal-body button:hover { background: #2d2d4a; }
        .modal-body .input-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .modal-body .input-row input { flex: 1; margin-bottom: 0; }
        .modal-body .input-row button { width: auto; min-width: 90px; margin-bottom: 0; background: #4ecdc4; }
        .modal-body .input-row button:hover { background: #3dbdb5; }
        .modal-body .input-row button:disabled { background: #9ca3af; cursor: not-allowed; }
        .modal-body .success-msg { color: #059669; font-size: 13px; margin-bottom: 12px; padding: 8px 12px; background: #ecfdf5; border-radius: 6px; display: none; }
        .error-msg { color: #dc2626; font-size: 13px; margin-bottom: 12px; }
        .switch-link { text-align: center; margin-top: 16px; font-size: 13px; color: #666; }
        .switch-link a { color: #4ecdc4; cursor: pointer; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: #888; }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state .text { font-size: 16px; }

        /* Mobile Overlay */
        .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; }
        .mobile-overlay.show { display: block; }

        /* Hamburger Menu Button */
        .mobile-menu-btn { display: none; width: 44px; height: 44px; background: transparent; border: none; cursor: pointer; padding: 10px; flex-direction: column; justify-content: center; align-items: center; gap: 5px; }
        .mobile-menu-btn span { display: block; width: 24px; height: 2px; background: white; transition: all 0.3s; border-radius: 2px; }
        .mobile-menu-btn.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .mobile-menu-btn.active span:nth-child(2) { opacity: 0; }
        .mobile-menu-btn.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }

        /* Mobile Navigation Dropdown */
        .mobile-nav { display: none; position: fixed; top: 60px; left: 0; right: 0; background: #1a1a2e; padding: 16px; z-index: 997; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .mobile-nav.show { display: block; }
        .mobile-nav a { display: block; color: rgba(255,255,255,0.8); text-decoration: none; padding: 12px 16px; font-size: 15px; border-radius: 6px; }
        .mobile-nav a:hover, .mobile-nav a.active { background: rgba(78,205,196,0.2); color: #4ecdc4; }

        /* Responsive - Tablet */
        @media (max-width: 1024px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar { position: static; }
        }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            .header-inner { padding: 12px 16px; }
            .logo h1 { font-size: 18px; }
            .nav { display: none; }
            .mobile-menu-btn { display: flex; }
            .auth-area { gap: 8px; }
            .auth-area a { font-size: 13px; }

            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                width: 280px;
                height: 100vh;
                z-index: 999;
                border-radius: 0;
                transition: left 0.3s ease;
                overflow-y: auto;
            }
            .sidebar.open { left: 0; }

            .main-container { padding: 16px; }

            .stats-bar { flex-direction: column; gap: 12px; align-items: flex-start; }
            .stats-left { gap: 16px; }
            .stat-value { font-size: 20px; }

            .article-card { padding: 16px; }
            .article-title { font-size: 15px; }
            .article-header { flex-direction: column; gap: 8px; }
            .article-source { margin-left: 0; max-width: 100%; }
            .source-badge { max-width: 120px; }
            .article-meta { gap: 12px; font-size: 12px; }
            .article-content { font-size: 13px; }
            .article-footer { flex-direction: column; gap: 12px; align-items: flex-start; }
            .article-actions { width: 100%; justify-content: flex-start; }
            .action-btn { padding: 8px 12px; font-size: 11px; }

            .pagination { flex-wrap: wrap; gap: 6px; padding: 12px; }
            .page-btn { padding: 6px 10px; font-size: 12px; }

            .modal-content { width: 100%; max-width: 100%; border-radius: 0; padding: 24px; }
            .modal-body .input-row { flex-direction: column; }
            .modal-body .input-row input { width: 100%; }
            .modal-body .input-row button { width: 100%; min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-inner">
            <div class="logo">
                <h1>ResearchPulse</h1>
                <span class="badge">V1.0.0</span>
            </div>
            <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav" id="nav-menu">
                <a href="#" onclick="location.href=APP_BASE+'/'; return false;">é¦–é¡µ</a>
                <!-- è®¢é˜…ç®¡ç†å’Œç®¡ç†åå°ä»…å¯¹ç™»å½•ç”¨æˆ·æ˜¾ç¤º -->
            </div>
            <div class="auth-area" id="auth-area">
                <a href="#" onclick="showModal('login')">ç™»å½•</a>
                <a href="#" onclick="showModal('register')">æ³¨å†Œ</a>
            </div>
        </div>
    </div>

    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>
    <div class="mobile-nav" id="mobile-nav"></div>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">æ¥æºç­›é€‰</div>
                <div class="source-cards" id="source-cards">
                    <div class="source-card active" data-source="" onclick="selectSource('')">
                        <div class="icon" style="background: #1a1a2e;">ALL</div>
                        <div class="info">
                            <div class="name">å…¨éƒ¨æ¥æº</div>
                            <div class="count" id="count-all">0 ç¯‡</div>
                        </div>
                    </div>
                    <div class="source-card" data-source="arxiv" onclick="selectSource('arxiv')">
                        <div class="icon arxiv">AX</div>
                        <div class="info">
                            <div class="name">arXiv</div>
                            <div class="count" id="count-arxiv">0 ç¯‡</div>
                        </div>
                    </div>
                    <div class="source-card" data-source="rss" onclick="selectSource('rss')">
                        <div class="icon rss">RSS</div>
                        <div class="info">
                            <div class="name">RSS è®¢é˜…</div>
                            <div class="count" id="count-rss">0 ç¯‡</div>
                        </div>
                    </div>
                    <div class="source-card" data-source="wechat" onclick="selectSource('wechat')">
                        <div class="icon wechat">å¾®</div>
                        <div class="info">
                            <div class="name">å¾®ä¿¡</div>
                            <div class="count" id="count-wechat">0 ç¯‡</div>
                        </div>
                    </div>
                    <div class="source-card" data-source="weibo" onclick="selectSource('weibo')">
                        <div class="icon weibo">å¾®</div>
                        <div class="info">
                            <div class="name">å¾®åšçƒ­æœ</div>
                            <div class="count" id="count-weibo">0 ç¯‡</div>
                        </div>
                    </div>
                    <div class="source-card" data-source="hackernews" onclick="selectSource('hackernews')">
                        <div class="icon hackernews">HN</div>
                        <div class="info">
                            <div class="name">HackerNews</div>
                            <div class="count" id="count-hackernews">0 ç¯‡</div>
                        </div>
                    </div>
                    <div class="source-card" data-source="reddit" onclick="selectSource('reddit')">
                        <div class="icon reddit">RD</div>
                        <div class="info">
                            <div class="name">Reddit</div>
                            <div class="count" id="count-reddit">0 ç¯‡</div>
                        </div>
                    </div>
                    <div class="source-card" data-source="twitter" onclick="selectSource('twitter')">
                        <div class="icon twitter">TW</div>
                        <div class="info">
                            <div class="name">Twitter</div>
                            <div class="count" id="count-twitter">0 ç¯‡</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">åˆ†ç±»ç­›é€‰</div>
                <div class="filter-group">
                    <select class="filter-select" id="category-select" onchange="applyFilters()">
                        <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    </select>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">å…³é”®è¯æœç´¢</div>
                <div class="filter-group">
                    <input type="text" class="filter-input" id="keyword-input" placeholder="æœç´¢æ ‡é¢˜ã€æ‘˜è¦..." onkeypress="if(event.key==='Enter')applyFilters()">
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">æ—¶é—´èŒƒå›´</div>
                <div class="filter-group">
                    <select class="filter-select" id="time-range" onchange="applyFilters()">
                        <option value="">å…¨éƒ¨æ—¶é—´</option>
                        <option value="1">æœ€è¿‘1å¤©</option>
                        <option value="3">æœ€è¿‘3å¤©</option>
                        <option value="7">æœ€è¿‘7å¤©</option>
                    </select>
                </div>
            </div>

            <!-- å¯¼å‡ºåŠŸèƒ½ä»…å¯¹ç™»å½•ç”¨æˆ·æ˜¾ç¤º -->
            <div class="sidebar-section" id="export-section" style="display: none;">
                <div class="sidebar-title">å¯¼å‡º</div>
                <div class="filter-group">
                    <button class="export-btn" onclick="exportMarkdown()">
                        ğŸ“¥ å¯¼å‡º Markdown
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <div class="stats-bar">
                <div class="stats-left">
                    <div class="stat-item">
                        <span class="stat-value" id="total-count">0</span>
                        <span class="stat-label">ç¯‡æ–‡ç« </span>
                    </div>
                </div>
                <select class="sort-select" id="sort-select" onchange="applyFilters()">
                    <option value="publish_time">æŒ‰å‘å¸ƒæ—¶é—´</option>
                    <option value="crawl_time">æŒ‰æŠ“å–æ—¶é—´</option>
                </select>
            </div>

            <div class="article-list" id="article-list">
                <div class="empty-state">
                    <div class="icon">ğŸ“š</div>
                    <div class="text">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç™»å½•</h2>
                <span class="modal-close" onclick="hideModal('login')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="login-error" class="error-msg"></div>
                <input type="text" id="login-username" placeholder="ç”¨æˆ·åæˆ–é‚®ç®±">
                <input type="password" id="login-password" placeholder="å¯†ç ">
                <button onclick="doLogin()">ç™»å½•</button>
                <div class="switch-link">
                    <a onclick="hideModal('login');showModal('reset-password')" style="float: left;">å¿˜è®°å¯†ç ï¼Ÿ</a>
                    æ²¡æœ‰è´¦å·ï¼Ÿ<a onclick="hideModal('login');showModal('register')">ç«‹å³æ³¨å†Œ</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal" id="reset-password-modal">
        <div class="modal-content" style="width: 420px;">
            <div class="modal-header">
                <h2>é‡ç½®å¯†ç </h2>
                <span class="modal-close" onclick="hideModal('reset-password')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="reset-error" class="error-msg"></div>
                <div id="reset-success" class="success-msg"></div>

                <!-- Step 1: Send Reset Code -->
                <div id="reset-step1">
                    <div class="input-row">
                        <input type="email" id="reset-email" placeholder="æ³¨å†Œé‚®ç®±åœ°å€">
                        <button id="send-reset-btn" onclick="sendResetCode()">å‘é€éªŒè¯ç </button>
                    </div>
                    <div id="reset-code-row" style="display: none;">
                        <div class="input-row">
                            <input type="text" id="reset-code" placeholder="6ä½éªŒè¯ç " maxlength="6" style="letter-spacing: 4px; text-align: center;">
                            <button onclick="verifyResetCode()">éªŒè¯</button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: New Password -->
                <div id="reset-step2" style="display: none;">
                    <input type="password" id="reset-new-password" placeholder="æ–°å¯†ç  (è‡³å°‘6ä½)">
                    <input type="password" id="reset-confirm-password" placeholder="ç¡®è®¤æ–°å¯†ç ">
                    <button onclick="doResetPassword()">é‡ç½®å¯†ç </button>
                </div>

                <div class="switch-link">æƒ³èµ·å¯†ç äº†ï¼Ÿ<a onclick="hideModal('reset-password');showModal('login')">è¿”å›ç™»å½•</a></div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="register-modal">
        <div class="modal-content" style="width: 420px;">
            <div class="modal-header">
                <h2>æ³¨å†Œ</h2>
                <span class="modal-close" onclick="hideModal('register')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="register-error" class="error-msg"></div>
                <div id="register-success" class="success-msg"></div>

                <!-- Step 1: Email Verification -->
                <div id="register-step1">
                    <div class="input-row">
                        <input type="email" id="reg-email" placeholder="é‚®ç®±åœ°å€">
                        <button id="send-code-btn" onclick="sendVerificationCode()">å‘é€éªŒè¯ç </button>
                    </div>
                    <div id="code-input-row" style="display: none;">
                        <div class="input-row">
                            <input type="text" id="reg-code" placeholder="6ä½éªŒè¯ç " maxlength="6" style="letter-spacing: 4px; text-align: center;">
                            <button onclick="verifyEmail()">éªŒè¯</button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Registration Form -->
                <div id="register-step2" style="display: none;">
                    <input type="text" id="reg-username" placeholder="ç”¨æˆ·å (3-50ä½å­—æ¯æ•°å­—)">
                    <input type="password" id="reg-password" placeholder="å¯†ç  (è‡³å°‘6ä½)">
                    <button onclick="doRegister()">æ³¨å†Œ</button>
                </div>

                <div class="switch-link">å·²æœ‰è´¦å·ï¼Ÿ<a onclick="hideModal('register');showModal('login')">ç«‹å³ç™»å½•</a></div>
            </div>
        </div>
    </div>

    <script>
        // APP_BASE ç­‰å˜é‡å·²åœ¨ <head> ä¸­å®šä¹‰

        let currentPage = 1;
        let pageSize = 20;
        let totalArticles = 0;
        let currentUser = null;
        let currentSource = '';
        let userStars = new Set();
        let categoryNames = {};  // åˆ†ç±»ä»£ç åˆ°åç§°çš„æ˜ å°„

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const mobileNav = document.getElementById('mobile-nav');
            const btn = document.getElementById('mobile-menu-btn');

            const isOpen = sidebar.classList.contains('open');
            if (isOpen) {
                closeMobileMenu();
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('show');
                mobileNav.classList.add('show');
                btn.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const mobileNav = document.getElementById('mobile-nav');
            const btn = document.getElementById('mobile-menu-btn');

            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            mobileNav.classList.remove('show');
            btn.classList.remove('active');
            document.body.style.overflow = '';
        }

        function updateMobileNav(user) {
            const mobileNav = document.getElementById('mobile-nav');
            let html = `<a href="${APP_BASE}/">é¦–é¡µ</a>`;
            if (user) {
                html += `<a href="${APP_BASE}/subscriptions">è®¢é˜…ç®¡ç†</a>`;
                if (user.is_superuser) {
                    html += `<a href="${APP_BASE}/admin">ç®¡ç†åå°</a>`;
                }
                html += `<a href="#" onclick="logout(); return false;">é€€å‡ºç™»å½•</a>`;
            } else {
                html += `<a href="#" onclick="showModal('login'); closeMobileMenu(); return false;">ç™»å½•</a>`;
                html += `<a href="#" onclick="showModal('register'); closeMobileMenu(); return false;">æ³¨å†Œ</a>`;
            }
            mobileNav.innerHTML = html;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthState();
            loadCategoryNames();  // é¢„åŠ è½½åˆ†ç±»åç§°æ˜ å°„
            loadCategories();
            loadStats();
            // loadArticles() åœ¨ checkAuthState æˆåŠŸåè°ƒç”¨
        });

        // Auth Functions
        async function checkAuthState() {
            const token = localStorage.getItem('access_token');
            if (token) {
                try {
                    const res = await fetch(`${AUTH_BASE}/auth/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        currentUser = await res.json();
                        updateAuthUI();
                        loadUserStars();
                        // ç™»å½•æˆåŠŸåæ‰åŠ è½½æ–‡ç« åˆ—è¡¨
                        loadArticles();
                        return;  // æˆåŠŸè·å–ç”¨æˆ·ä¿¡æ¯åç›´æ¥è¿”å›
                    } else {
                        localStorage.removeItem('access_token');
                    }
                } catch (e) {
                    localStorage.removeItem('access_token');
                }
            }
            // åªæœ‰åœ¨æœªç™»å½•æˆ– token æ— æ•ˆæ—¶æ‰è®¾ç½® currentUser ä¸º null å¹¶æ›´æ–° UI
            currentUser = null;
            updateAuthUI();
            // æ˜¾ç¤ºæœªç™»å½•æç¤º
            showLoginPrompt();
        }

        function updateAuthUI() {
            const area = document.getElementById('auth-area');
            const navMenu = document.getElementById('nav-menu');
            const exportSection = document.getElementById('export-section');

            if (currentUser) {
                // å·²ç™»å½•ç”¨æˆ·æ˜¾ç¤ºç”¨æˆ·åå’Œé€€å‡ºæŒ‰é’®
                area.innerHTML = `
                    <span class="user-info">ğŸ‘¤ ${currentUser.username}</span>
                    <a href="#" onclick="logout()">é€€å‡º</a>
                `;

                // æ˜¾ç¤ºå¯¼å‡ºåŠŸèƒ½
                exportSection.style.display = 'block';

                // æ˜¾ç¤ºè®¢é˜…ç®¡ç†
                let navHtml = `<a href="${APP_BASE}/">é¦–é¡µ</a>`;
                navHtml += '<a href="#" onclick="goTo(\'subscriptions\')">è®¢é˜…ç®¡ç†</a>';
                // ä»…è¶…çº§ç®¡ç†å‘˜æ˜¾ç¤ºç®¡ç†åå°
                if (currentUser.is_superuser) {
                    navHtml += '<a href="#" onclick="goTo(\'admin\')">ç®¡ç†åå°</a>';
                }
                navMenu.innerHTML = navHtml;
                updateMobileNav(currentUser);
            } else {
                // æœªç™»å½•ç”¨æˆ·æ˜¾ç¤ºç™»å½•/æ³¨å†ŒæŒ‰é’®
                area.innerHTML = `
                    <a href="#" onclick="showModal('login')">ç™»å½•</a>
                    <a href="#" onclick="showModal('register')">æ³¨å†Œ</a>
                `;

                // éšè—å¯¼å‡ºåŠŸèƒ½ã€è®¢é˜…ç®¡ç†å’Œç®¡ç†åå°
                exportSection.style.display = 'none';
                navMenu.innerHTML = `<a href="${APP_BASE}/">é¦–é¡µ</a>`;
                updateMobileNav(null);
            }
        }

        async function loadUserStars() {
            // TODO: Load user's starred articles
        }

        function showModal(type) {
            document.getElementById(`${type}-modal`).classList.add('active');
            document.getElementById(`${type}-error`).textContent = '';
        }

        function hideModal(type) {
            document.getElementById(`${type}-modal`).classList.remove('active');
        }

        async function doLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            if (!username || !password) {
                errorEl.textContent = 'è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ';
                return;
            }

            try {
                const res = await fetch(`${AUTH_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('access_token', data.access_token);
                    // ç™»å½•æˆåŠŸåè·å–å®Œæ•´ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…æ‹¬ is_superuserï¼‰
                    await checkAuthState();
                    hideModal('login');
                } else {
                    errorEl.textContent = data.detail || 'ç™»å½•å¤±è´¥';
                }
            } catch (e) {
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯';
            }
        }

        // éªŒè¯ç ç›¸å…³å˜é‡
        let verificationToken = null;
        let countdownTimer = null;
        let countdownSeconds = 0;

        // å‘é€éªŒè¯ç 
        async function sendVerificationCode() {
            const email = document.getElementById('reg-email').value;
            const errorEl = document.getElementById('register-error');
            const successEl = document.getElementById('register-success');
            const btn = document.getElementById('send-code-btn');

            if (!email) {
                errorEl.textContent = 'è¯·è¾“å…¥é‚®ç®±åœ°å€';
                return;
            }

            // ç®€å•çš„é‚®ç®±æ ¼å¼éªŒè¯
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errorEl.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€';
                return;
            }

            errorEl.textContent = '';
            successEl.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'å‘é€ä¸­...';

            try {
                const res = await fetch(`${AUTH_BASE}/auth/send-verification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                if (res.ok) {
                    // æ˜¾ç¤ºéªŒè¯ç è¾“å…¥æ¡†
                    document.getElementById('code-input-row').style.display = 'block';
                    successEl.textContent = 'éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œè¯·æŸ¥æ”¶';
                    successEl.style.display = 'block';
                    // å¼€å§‹å€’è®¡æ—¶
                    startCountdown(120);
                } else if (res.status === 429) {
                    // é¢‘ç‡é™åˆ¶
                    errorEl.textContent = data.detail || 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
                    btn.disabled = false;
                    btn.textContent = 'å‘é€éªŒè¯ç ';
                    // å¦‚æœæœ‰é‡è¯•æ—¶é—´ï¼Œå¼€å§‹å€’è®¡æ—¶
                    const retryAfter = data.retry_after || 120;
                    startCountdown(retryAfter);
                } else {
                    errorEl.textContent = data.detail || 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•';
                    btn.disabled = false;
                    btn.textContent = 'å‘é€éªŒè¯ç ';
                }
            } catch (e) {
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                btn.disabled = false;
                btn.textContent = 'å‘é€éªŒè¯ç ';
            }
        }

        // å€’è®¡æ—¶
        function startCountdown(seconds) {
            countdownSeconds = seconds;
            const btn = document.getElementById('send-code-btn');
            btn.disabled = true;

            if (countdownTimer) {
                clearInterval(countdownTimer);
            }

            updateCountdownDisplay();
            countdownTimer = setInterval(() => {
                countdownSeconds--;
                if (countdownSeconds <= 0) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                    btn.disabled = false;
                    btn.textContent = 'å‘é€éªŒè¯ç ';
                } else {
                    updateCountdownDisplay();
                }
            }, 1000);
        }

        function updateCountdownDisplay() {
            const btn = document.getElementById('send-code-btn');
            btn.textContent = `${countdownSeconds}ç§’åé‡å‘`;
        }

        // éªŒè¯é‚®ç®±
        async function verifyEmail() {
            const email = document.getElementById('reg-email').value;
            const code = document.getElementById('reg-code').value;
            const errorEl = document.getElementById('register-error');
            const successEl = document.getElementById('register-success');

            if (!code || code.length !== 6) {
                errorEl.textContent = 'è¯·è¾“å…¥6ä½éªŒè¯ç ';
                return;
            }

            errorEl.textContent = '';
            successEl.style.display = 'none';

            try {
                const res = await fetch(`${AUTH_BASE}/auth/verify-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                });
                const data = await res.json();

                if (res.ok) {
                    verificationToken = data.verification_token;
                    successEl.textContent = 'é‚®ç®±éªŒè¯æˆåŠŸï¼è¯·è®¾ç½®ç”¨æˆ·åå’Œå¯†ç ';
                    successEl.style.display = 'block';
                    // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
                    document.getElementById('register-step1').style.display = 'none';
                    document.getElementById('register-step2').style.display = 'block';
                } else {
                    errorEl.textContent = data.detail || 'éªŒè¯å¤±è´¥';
                }
            } catch (e) {
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
            }
        }

        async function doRegister() {
            const username = document.getElementById('reg-username').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const errorEl = document.getElementById('register-error');

            if (!username || !password) {
                errorEl.textContent = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ';
                return;
            }

            if (!verificationToken) {
                errorEl.textContent = 'è¯·å…ˆéªŒè¯é‚®ç®±';
                return;
            }

            try {
                const res = await fetch(`${AUTH_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        verification_token: verificationToken
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    // é‡ç½®æ³¨å†Œè¡¨å•
                    resetRegisterForm();
                    hideModal('register');
                    showModal('login');
                    document.getElementById('login-username').value = username;
                } else {
                    errorEl.textContent = data.detail || 'æ³¨å†Œå¤±è´¥';
                }
            } catch (e) {
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯';
            }
        }

        // é‡ç½®æ³¨å†Œè¡¨å•
        function resetRegisterForm() {
            verificationToken = null;
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            document.getElementById('reg-email').value = '';
            document.getElementById('reg-code').value = '';
            document.getElementById('reg-username').value = '';
            document.getElementById('reg-password').value = '';
            document.getElementById('register-step1').style.display = 'block';
            document.getElementById('register-step2').style.display = 'none';
            document.getElementById('code-input-row').style.display = 'none';
            document.getElementById('register-error').textContent = '';
            document.getElementById('register-success').style.display = 'none';
            const btn = document.getElementById('send-code-btn');
            btn.disabled = false;
            btn.textContent = 'å‘é€éªŒè¯ç ';
        }

        // =========================================================================
        // å¯†ç é‡ç½®ç›¸å…³å‡½æ•°
        // =========================================================================
        let resetToken = null;
        let resetCountdownTimer = null;
        let resetCountdownSeconds = 0;

        // å‘é€å¯†ç é‡ç½®éªŒè¯ç 
        async function sendResetCode() {
            const email = document.getElementById('reset-email').value;
            const errorEl = document.getElementById('reset-error');
            const successEl = document.getElementById('reset-success');
            const btn = document.getElementById('send-reset-btn');

            if (!email) {
                errorEl.textContent = 'è¯·è¾“å…¥é‚®ç®±åœ°å€';
                return;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errorEl.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€';
                return;
            }

            errorEl.textContent = '';
            successEl.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'å‘é€ä¸­...';

            try {
                const res = await fetch(`${AUTH_BASE}/auth/send-password-reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('reset-code-row').style.display = 'block';
                    successEl.textContent = 'éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œè¯·æŸ¥æ”¶';
                    successEl.style.display = 'block';
                    startResetCountdown(120);
                } else if (res.status === 429) {
                    errorEl.textContent = data.detail || 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
                    btn.disabled = false;
                    btn.textContent = 'å‘é€éªŒè¯ç ';
                    const retryAfter = data.retry_after || 120;
                    startResetCountdown(retryAfter);
                } else {
                    errorEl.textContent = data.detail || 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•';
                    btn.disabled = false;
                    btn.textContent = 'å‘é€éªŒè¯ç ';
                }
            } catch (e) {
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                btn.disabled = false;
                btn.textContent = 'å‘é€éªŒè¯ç ';
            }
        }

        // å¯†ç é‡ç½®å€’è®¡æ—¶
        function startResetCountdown(seconds) {
            resetCountdownSeconds = seconds;
            const btn = document.getElementById('send-reset-btn');
            btn.disabled = true;

            if (resetCountdownTimer) {
                clearInterval(resetCountdownTimer);
            }

            updateResetCountdownDisplay();
            resetCountdownTimer = setInterval(() => {
                resetCountdownSeconds--;
                if (resetCountdownSeconds <= 0) {
                    clearInterval(resetCountdownTimer);
                    resetCountdownTimer = null;
                    btn.disabled = false;
                    btn.textContent = 'å‘é€éªŒè¯ç ';
                } else {
                    updateResetCountdownDisplay();
                }
            }, 1000);
        }

        function updateResetCountdownDisplay() {
            const btn = document.getElementById('send-reset-btn');
            btn.textContent = `${resetCountdownSeconds}ç§’åé‡å‘`;
        }

        // éªŒè¯å¯†ç é‡ç½®ç 
        async function verifyResetCode() {
            const email = document.getElementById('reset-email').value;
            const code = document.getElementById('reset-code').value;
            const errorEl = document.getElementById('reset-error');
            const successEl = document.getElementById('reset-success');

            if (!code || code.length !== 6) {
                errorEl.textContent = 'è¯·è¾“å…¥6ä½éªŒè¯ç ';
                return;
            }

            errorEl.textContent = '';
            successEl.style.display = 'none';

            try {
                const res = await fetch(`${AUTH_BASE}/auth/verify-password-reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                });
                const data = await res.json();

                if (res.ok) {
                    resetToken = data.reset_token;
                    successEl.textContent = 'éªŒè¯æˆåŠŸï¼è¯·è®¾ç½®æ–°å¯†ç ';
                    successEl.style.display = 'block';
                    document.getElementById('reset-step1').style.display = 'none';
                    document.getElementById('reset-step2').style.display = 'block';
                } else {
                    errorEl.textContent = data.detail || 'éªŒè¯å¤±è´¥';
                }
            } catch (e) {
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
            }
        }

        // æ‰§è¡Œå¯†ç é‡ç½®
        async function doResetPassword() {
            const email = document.getElementById('reset-email').value;
            const newPassword = document.getElementById('reset-new-password').value;
            const confirmPassword = document.getElementById('reset-confirm-password').value;
            const errorEl = document.getElementById('reset-error');

            if (!newPassword || newPassword.length < 6) {
                errorEl.textContent = 'å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                return;
            }

            if (!resetToken) {
                errorEl.textContent = 'è¯·å…ˆéªŒè¯é‚®ç®±';
                return;
            }

            errorEl.textContent = '';

            try {
                const res = await fetch(`${AUTH_BASE}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        new_password: newPassword,
                        reset_token: resetToken
                    })
                });
                const data = await res.json();

                if (res.ok) {
                    // é‡ç½®æˆåŠŸï¼Œæ¸…ç†è¡¨å•å¹¶è·³è½¬åˆ°ç™»å½•
                    resetResetPasswordForm();
                    hideModal('reset-password');
                    showModal('login');
                    document.getElementById('login-username').value = email;
                    document.getElementById('login-error').textContent = '';
                    alert('å¯†ç é‡ç½®æˆåŠŸï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•');
                } else {
                    errorEl.textContent = data.detail || 'é‡ç½®å¤±è´¥';
                }
            } catch (e) {
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯';
            }
        }

        // é‡ç½®å¯†ç é‡ç½®è¡¨å•
        function resetResetPasswordForm() {
            resetToken = null;
            if (resetCountdownTimer) {
                clearInterval(resetCountdownTimer);
                resetCountdownTimer = null;
            }
            document.getElementById('reset-email').value = '';
            document.getElementById('reset-code').value = '';
            document.getElementById('reset-new-password').value = '';
            document.getElementById('reset-confirm-password').value = '';
            document.getElementById('reset-step1').style.display = 'block';
            document.getElementById('reset-step2').style.display = 'none';
            document.getElementById('reset-code-row').style.display = 'none';
            document.getElementById('reset-error').textContent = '';
            document.getElementById('reset-success').style.display = 'none';
            const btn = document.getElementById('send-reset-btn');
            btn.disabled = false;
            btn.textContent = 'å‘é€éªŒè¯ç ';
        }

        function logout() {
            localStorage.removeItem('access_token');
            currentUser = null;
            userStars.clear();
            updateAuthUI();
            showLoginPrompt();
        }

        function goTo(page) {
            if (!currentUser) {
                showModal('login');
                return;
            }
            // ç®¡ç†åå°ä»…è¶…çº§ç®¡ç†å‘˜å¯è®¿é—®
            if (page === 'admin' && !currentUser.is_superuser) {
                alert('æ‚¨æ²¡æœ‰æƒé™è®¿é—®ç®¡ç†åå°');
                return;
            }
            // Navigate to page
            if (page === 'subscriptions') {
                location.href = APP_BASE + '/subscriptions';
            } else if (page === 'admin') {
                location.href = APP_BASE + '/admin';
            }
        }

        // Filter Functions
        function selectSource(source) {
            currentSource = source;
            document.querySelectorAll('.source-card').forEach(card => {
                card.classList.toggle('active', card.dataset.source === source);
            });
            currentPage = 1;
            // Reset category when source changes
            document.getElementById('category-select').innerHTML = '<option value="">å…¨éƒ¨åˆ†ç±»</option>';
            loadCategories(source);
            loadArticles();
        }

        function applyFilters() {
            currentPage = 1;
            loadArticles();
        }

        // Data Loading
        async function loadCategoryNames() {
            // åŠ è½½ ArXiv åˆ†ç±»åç§°æ˜ å°„ï¼Œç”¨äºæ˜¾ç¤ºä¸»ç±»ç›®å…¨ç§°
            try {
                const res = await fetch(`${API_BASE}/categories?source_type=arxiv`);
                const data = await res.json();
                if (data.categories) {
                    data.categories.forEach(cat => {
                        categoryNames[cat.code] = cat.name || cat.code;
                    });
                }
            } catch (e) {
                console.error('Failed to load category names:', e);
            }
        }

        async function loadCategories(sourceType = '') {
            try {
                const params = new URLSearchParams();
                if (sourceType) {
                    params.append('source_type', sourceType);
                }
                const res = await fetch(`${API_BASE}/categories?${params}`);
                const data = await res.json();
                const select = document.getElementById('category-select');
                
                // Clear existing options except the first one
                select.innerHTML = '<option value="">å…¨éƒ¨åˆ†ç±»</option>';
                
                data.categories.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.code;
                    opt.textContent = cat.name ? `${cat.code} - ${cat.name}` : cat.code;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load categories:', e);
            }
        }

        async function loadStats() {
            try {
                // Load counts for each source
                const sources = ['', 'arxiv', 'rss', 'wechat', 'weibo', 'hackernews', 'reddit', 'twitter'];
                for (const src of sources) {
                    const params = new URLSearchParams({ page_size: 1 });
                    if (src) params.append('source_type', src);
                    const res = await fetch(`${API_BASE}/articles?${params}`);
                    const data = await res.json();
                    const el = document.getElementById(src ? `count-${src}` : 'count-all');
                    if (el) el.textContent = `${data.total} ç¯‡`;
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        function exportMarkdown() {
            const category = document.getElementById('category-select').value;
            const timeRange = document.getElementById('time-range').value;
            const sort = document.getElementById('sort-select').value;

            const params = new URLSearchParams({ page_size: 100 });
            if (currentSource) params.append('source_type', currentSource);
            if (category) params.append('category', category);

            // Time range filter
            if (timeRange) {
                const date = new Date();
                date.setDate(date.getDate() - parseInt(timeRange));
                params.append('from_date', date.toISOString().split('T')[0]);
            }

            // Open download link
            const url = `${API_BASE}/export/markdown?${params}`;
            window.open(url, '_blank');
        }

        async function loadArticles() {
            const category = document.getElementById('category-select').value;
            const keyword = document.getElementById('keyword-input').value;
            const timeRange = document.getElementById('time-range').value;
            const sort = document.getElementById('sort-select').value;

            const params = new URLSearchParams({ page: currentPage, page_size: pageSize });
            if (currentSource) params.append('source_type', currentSource);
            if (category) params.append('category', category);
            if (keyword) params.append('keyword', keyword);
            if (sort) params.append('sort', sort);

            // Time range filter
            if (timeRange) {
                const date = new Date();
                date.setDate(date.getDate() - parseInt(timeRange));
                params.append('from_date', date.toISOString().split('T')[0]);
            }

            try {
                const response = await fetch(`${API_BASE}/articles?${params}`);
                const data = await response.json();

                totalArticles = data.total;
                document.getElementById('total-count').textContent = data.total;
                renderArticles(data.articles);
                renderPagination();
            } catch (error) {
                console.error('Failed to load articles:', error);
                document.getElementById('article-list').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">âŒ</div>
                        <div class="text">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>
                    </div>
                `;
            }
        }

        function renderArticles(articles) {
            const container = document.getElementById('article-list');

            if (articles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“­</div>
                        <div class="text">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ–‡ç« </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = articles.map(article => renderArticle(article)).join('');
        }

        // æ˜¾ç¤ºæœªç™»å½•æç¤º
        function showLoginPrompt() {
            const container = document.getElementById('article-list');
            container.innerHTML = `
                <div class="empty-state" style="padding: 80px 20px;">
                    <div class="icon" style="font-size: 64px;">ğŸ”</div>
                    <div class="text" style="font-size: 18px; margin-top: 16px;">è¯·å…ˆç™»å½•æŸ¥çœ‹æ–‡ç« å†…å®¹</div>
                    <div style="margin-top: 24px;">
                        <button onclick="showModal('login')" style="padding: 12px 32px; background: #4ecdc4; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer;">ç™»å½•</button>
                        <button onclick="showModal('register')" style="padding: 12px 32px; background: #1a1a2e; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; margin-left: 12px;">æ³¨å†Œè´¦å·</button>
                    </div>
                </div>
            `;
            // éšè—åˆ†é¡µ
            document.getElementById('pagination').innerHTML = '';
            // æ›´æ–°æ–‡ç« è®¡æ•°
            document.getElementById('total-count').textContent = '-';
        }

        function renderArticle(article) {
            // æ„å»ºæºæ ‡ç­¾ï¼šRSS æ˜¾ç¤ºå…·ä½“æºåç§°ï¼Œå…¶ä»–æ˜¾ç¤ºæºç±»å‹
            let sourceBadge = '';
            const sourceType = article.source_type;

            // æºç±»å‹æ˜¾ç¤ºåç§°æ˜ å°„
            const sourceTypeNames = {
                'arxiv': 'ArXiv',
                'rss': 'RSS',
                'wechat': 'å¾®ä¿¡',
                'weibo': 'å¾®åšçƒ­æœ',
                'hackernews': 'HackerNews',
                'reddit': 'Reddit',
                'twitter': 'Twitter'
            };

            if (sourceType === 'rss' && article.source_name) {
                sourceBadge = `<span class="source-badge ${sourceType}" title="${escapeHtml(article.source_name)}">${escapeHtml(article.source_name)}</span>`;
            } else if (sourceType === 'wechat' && article.wechat_account_name) {
                sourceBadge = `<span class="source-badge ${sourceType}" title="${escapeHtml(article.wechat_account_name)}">${escapeHtml(article.wechat_account_name)}</span>`;
            } else {
                const displayName = sourceTypeNames[sourceType] || sourceType;
                sourceBadge = `<span class="source-badge ${sourceType}">${displayName}</span>`;
            }

            // Clean HTML tags from content/summary for display
            // ä¼˜å…ˆä½¿ç”¨å®Œæ•´æ­£æ–‡ contentï¼Œé™çº§åˆ°æ‘˜è¦ summary
            const cleanSummary = stripHtml(article.content || article.summary || '');
            const hasLongSummary = cleanSummary.length > 300;

            // Format times
            const publishTime = article.publish_time ? formatDate(article.publish_time) : '';
            const updatedTime = article.arxiv_updated_time ? formatDate(article.arxiv_updated_time) : '';
            const crawlTime = article.crawl_time ? formatDate(article.crawl_time) : '';

            // Time display
            let timeDisplay = '';
            if (article.source_type === 'arxiv') {
                timeDisplay = `<span>ğŸ“… å‘å¸ƒ: ${publishTime || 'æœªçŸ¥'}</span>`;
                if (updatedTime && updatedTime !== publishTime) {
                    timeDisplay += `<span>ğŸ”„ æ›´æ–°: ${updatedTime}</span>`;
                }
            } else {
                timeDisplay = `<span>ğŸ“… ${publishTime || crawlTime || 'æœªçŸ¥'}</span>`;
            }

            let tagsArray = [];
            const rawTags = article.tags;
            if (Array.isArray(rawTags)) {
                tagsArray = rawTags;
            } else if (rawTags && typeof rawTags === 'object') {
                // dict ç±»å‹ tagsï¼ˆå¦‚å¾®åšçƒ­æœå…ƒæ•°æ®ï¼‰ï¼Œæå–æœ‰æ„ä¹‰çš„ key-value æ‹¼ä¸ºæ ‡ç­¾
                Object.entries(rawTags).forEach(([k, v]) => {
                    if (v !== '' && v !== 0 && v !== null && v !== undefined) {
                        tagsArray.push(`${k}: ${v}`);
                    }
                });
            }
            const tags = tagsArray.slice(0, 5).map(t => `<span class="tag">${escapeHtml(String(t))}</span>`).join('');

            // ArXiv specific details and actions
            let arxivDetails = '';
            let arxivActions = '';
            if (article.source_type === 'arxiv') {
                const pdfUrl = `https://arxiv.org/pdf/${article.arxiv_id}`;
                const absUrl = `https://arxiv.org/abs/${article.arxiv_id}`;
                // ResearchPulse translation (ä¸­è‹±å¯¹ç…§)
                const translateUrl = `https://hjfy.top/arxiv/${article.arxiv_id}`;
                // Google Translate
                const googleTranslateUrl = `https://arxiv-org.translate.goog/abs/${article.arxiv_id}?_x_tr_sl=en&_x_tr_tl=zh-CN&_x_tr_hl=zh-CN`;

                arxivDetails = `
                    <div class="arxiv-details">
                        <div class="row">
                            <span><span class="label">arXiv ID:</span> <span class="value">${escapeHtml(article.arxiv_id || '')}</span></span>
                            ${article.arxiv_primary_category ? `<span><span class="label">ä¸»ç±»ç›®:</span> <span class="value">${escapeHtml(article.arxiv_primary_category)}${categoryNames[article.arxiv_primary_category] ? ' - ' + escapeHtml(categoryNames[article.arxiv_primary_category]) : ''}</span></span>` : ''}
                        </div>
                    </div>
                `;

                arxivActions = `
                    <a href="${pdfUrl}" target="_blank" class="action-btn">ğŸ“„ PDF</a>
                    <a href="${translateUrl}" target="_blank" class="action-btn">ğŸŒ ä¸­è‹±å¯¹ç…§</a>
                    <a href="${googleTranslateUrl}" target="_blank" class="action-btn">ğŸ” è°·æ­Œç¿»è¯‘</a>
                `;
            }

            // Expand/collapse for long summaries
            const expandBtn = hasLongSummary ? `<div class="expand-btn" onclick="toggleExpand(this)">å±•å¼€å…¨æ–‡</div>` : '';
            const contentClass = hasLongSummary ? 'article-content collapsed' : 'article-content';

            const isStarred = userStars.has(article.id);

            return `
                <div class="article-card">
                    <div class="article-header">
                        <div class="article-title">
                            <a href="${escapeHtml(article.url)}" target="_blank">${escapeHtml(article.title)}</a>
                        </div>
                        <div class="article-source">${sourceBadge}</div>
                    </div>
                    <div class="article-meta">
                        <span>ğŸ‘¤ ${escapeHtml(article.author || 'æœªçŸ¥ä½œè€…')}</span>
                        ${timeDisplay}
                        ${article.category ? `<span>ğŸ“ ${escapeHtml(article.category)}${categoryNames[article.category] ? ' - ' + escapeHtml(categoryNames[article.category]) : ''}</span>` : ''}
                    </div>
                    <div class="${contentClass}" data-full="${escapeHtml(cleanSummary)}">${escapeHtml(cleanSummary)}</div>
                    ${expandBtn}
                    ${arxivDetails}
                    <div class="article-footer">
                        <div class="article-tags">${tags}</div>
                        <div class="article-actions">
                            <button class="action-btn ${isStarred ? 'starred' : ''}" onclick="toggleStar(${article.id})">
                                ${isStarred ? 'â­ å·²æ”¶è—' : 'â˜† æ”¶è—'}
                            </button>
                            ${arxivActions}
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleExpand(btn) {
            const content = btn.previousElementSibling;
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                btn.textContent = 'æ”¶èµ·';
            } else {
                content.classList.add('collapsed');
                btn.textContent = 'å±•å¼€å…¨æ–‡';
            }
        }

        async function toggleStar(articleId) {
            if (!currentUser) {
                showModal('login');
                return;
            }
            // TODO: Implement star toggle
            if (userStars.has(articleId)) {
                userStars.delete(articleId);
            } else {
                userStars.add(articleId);
            }
            loadArticles();
        }

        function renderPagination() {
            const totalPages = Math.ceil(totalArticles / pageSize);
            const container = document.getElementById('pagination');

            if (totalPages <= 1) {
                container.innerHTML = `<span class="page-info">å…± ${totalArticles} ç¯‡</span>`;
                return;
            }

            let html = '';

            // Previous button
            html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;

            // Page numbers
            const start = Math.max(1, currentPage - 2);
            const end = Math.min(totalPages, currentPage + 2);

            if (start > 1) {
                html += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
                if (start > 2) html += `<span class="page-info">...</span>`;
            }

            for (let i = start; i <= end; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            if (end < totalPages) {
                if (end < totalPages - 1) html += `<span class="page-info">...</span>`;
                html += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            // Next button
            html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;

            container.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadArticles();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Utilities
        function stripHtml(html) {
            if (!html) return '';
            // Remove HTML tags
            let text = html.replace(/<[^>]*>/g, ' ');
            // Decode HTML entities
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            text = textarea.value;
            // Normalize whitespace
            return text.replace(/\s+/g, ' ').trim();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }
    </script>
</body>
</html>
