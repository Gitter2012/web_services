<script>
// ========== 工具函数 ==========
function escapeHtml(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

function formatDate(iso) {
    if (!iso) return '';
    try {
        const d = new Date(iso);
        return d.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    } catch (e) { return iso; }
}

function formatDateShort(iso) {
    if (!iso) return '';
    try {
        const d = new Date(iso);
        return d.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
    } catch (e) { return iso; }
}

function logout() {
    localStorage.removeItem('access_token');
    location.reload();
}

function showToast(msg, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// ========== 认证检查 ==========
async function checkAuth() {
    // 获取功能开关状态
    let featureStatus = {};
    try {
        const fsRes = await fetch(`${API_BASE}/feature-status`);
        if (fsRes.ok) featureStatus = await fsRes.json();
    } catch (e) {}

    const token = localStorage.getItem('access_token');
    const area = document.getElementById('auth-area');
    const navMenu = document.getElementById('nav-menu');

    if (token) {
        try {
            const res = await fetch(`${AUTH_BASE}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok) {
                const user = await res.json();
                area.innerHTML = `<span style="color:#4ecdc4;font-size:14px;">&#128100; ${user.username}</span><a href="#" onclick="logout()">退出</a>`;

                // 根据功能开关和用户权限动态显示导航 tab
                if (user.is_superuser || featureStatus.event_clustering) {
                    const link = document.createElement('a');
                    link.href = APP_BASE + '/events';
                    link.textContent = '事件聚类';
                    if (typeof NAV_ACTIVE !== 'undefined' && NAV_ACTIVE === 'events') link.className = 'active';
                    navMenu.appendChild(link);
                }
                if (user.is_superuser || featureStatus.topic_radar) {
                    const link = document.createElement('a');
                    link.href = APP_BASE + '/topics';
                    link.textContent = '话题趋势';
                    if (typeof NAV_ACTIVE !== 'undefined' && NAV_ACTIVE === 'topics') link.className = 'active';
                    navMenu.appendChild(link);
                }
                if (user.is_superuser || featureStatus.action_items) {
                    const link = document.createElement('a');
                    link.href = APP_BASE + '/actions';
                    link.textContent = '行动建议';
                    if (typeof NAV_ACTIVE !== 'undefined' && NAV_ACTIVE === 'actions') link.className = 'active';
                    navMenu.appendChild(link);
                }
                if (user.is_superuser || featureStatus.report_generation) {
                    const link = document.createElement('a');
                    link.href = APP_BASE + '/reports';
                    link.textContent = '报告中心';
                    if (typeof NAV_ACTIVE !== 'undefined' && NAV_ACTIVE === 'reports') link.className = 'active';
                    navMenu.appendChild(link);
                }
                // 每日报告
                const dailyLink = document.createElement('a');
                dailyLink.href = APP_BASE + '/daily-reports';
                dailyLink.textContent = '每日报告';
                if (typeof NAV_ACTIVE !== 'undefined' && NAV_ACTIVE === 'daily-reports') dailyLink.className = 'active';
                navMenu.appendChild(dailyLink);

                if (user.is_superuser) {
                    const adminLink = document.createElement('a');
                    adminLink.href = APP_BASE + '/admin';
                    adminLink.textContent = '管理后台';
                    if (typeof NAV_ACTIVE !== 'undefined' && NAV_ACTIVE === 'admin') adminLink.className = 'active';
                    navMenu.appendChild(adminLink);
                }
                return user;
            }
        } catch (e) {}
    }
    area.innerHTML = `<a href="${APP_BASE}/">登录</a>`;
    return null;
}

// ========== 分页渲染 ==========
function renderPagination(container, totalItems, pageSize, currentPage, onPageChange) {
    const totalPages = Math.ceil(totalItems / pageSize);
    if (totalPages <= 1) {
        container.innerHTML = `<span style="color:#888;font-size:14px;">共 ${totalItems} 条</span>`;
        return;
    }
    let html = `<button class="page-btn" onclick="${onPageChange}(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>上一页</button>`;
    const start = Math.max(1, currentPage - 2);
    const end = Math.min(totalPages, currentPage + 2);
    for (let i = start; i <= end; i++) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="${onPageChange}(${i})">${i}</button>`;
    }
    html += `<button class="page-btn" onclick="${onPageChange}(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>下一页</button>`;
    container.innerHTML = html;
}

// ========== 通用请求头 ==========
function getHeaders() {
    const token = localStorage.getItem('access_token');
    return token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
}

function getAuthHeaders() {
    const token = localStorage.getItem('access_token');
    return token ? { 'Authorization': `Bearer ${token}` } : {};
}
</script>
