<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行动建议 - ResearchPulse</title>
    <script>
        (function() {
            var path = window.location.pathname;
            var rpIndex = path.indexOf('/researchpulse');
            var prefix = rpIndex > 0 ? path.substring(0, rpIndex) : '';
            window.APP_BASE = prefix + '/researchpulse';
            window.API_BASE = prefix + '/researchpulse/api';
            window.AUTH_BASE = prefix + '/api/v1';
        })();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }

        .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-inner { max-width: 1200px; margin: 0 auto; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo h1 { font-size: 22px; font-weight: 600; }
        .logo h1 a { color: white; text-decoration: none; }
        .logo .badge { background: #e94560; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .nav { display: flex; gap: 20px; }
        .nav a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; transition: color 0.2s; }
        .nav a:hover { color: white; }
        .nav a.active { color: #4ecdc4; }
        .auth-area { display: flex; align-items: center; gap: 16px; }
        .auth-area a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; }

        .main { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .page-header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .page-header h2 { font-size: 24px; color: #1a1a2e; }
        .filter-bar { display: flex; gap: 12px; }
        .filter-bar select { padding: 8px 14px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px; background: white; }

        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 12px; padding: 16px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); text-align: center; }
        .stat-card .value { font-size: 28px; font-weight: 600; color: #1a1a2e; }
        .stat-card .label { font-size: 13px; color: #888; margin-top: 4px; }

        .action-list { display: flex; flex-direction: column; gap: 12px; }
        .action-card { background: white; border-radius: 12px; padding: 16px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; transition: box-shadow 0.2s; }
        .action-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .action-card.status-completed { opacity: 0.6; }
        .action-card.status-dismissed { opacity: 0.4; text-decoration: line-through; }
        .action-left { flex: 1; }
        .action-desc { font-size: 14px; color: #333; margin-bottom: 6px; line-height: 1.5; }
        .action-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px; }
        .action-right { display: flex; gap: 8px; flex-shrink: 0; margin-left: 16px; }
        .action-btn { padding: 6px 14px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid #e0e0e0; background: white; transition: all 0.2s; }
        .action-btn.complete { color: #059669; border-color: #dcfce7; }
        .action-btn.complete:hover { background: #dcfce7; }
        .action-btn.dismiss { color: #dc2626; border-color: #fee2e2; }
        .action-btn.dismiss:hover { background: #fee2e2; }

        .priority-badge { padding: 3px 8px; border-radius: 3px; font-size: 11px; font-weight: 600; }
        .priority-badge.high { background: #fee2e2; color: #dc2626; }
        .priority-badge.medium { background: #fef3c7; color: #d97706; }
        .priority-badge.low { background: #dcfce7; color: #059669; }
        .type-badge { padding: 3px 8px; border-radius: 3px; font-size: 11px; background: #ede9fe; color: #7c3aed; }
        .status-badge { padding: 3px 8px; border-radius: 3px; font-size: 11px; }
        .status-badge.pending { background: #fef3c7; color: #d97706; }
        .status-badge.completed { background: #dcfce7; color: #059669; }
        .status-badge.dismissed { background: #f3f4f6; color: #6b7280; }

        .empty-state { text-align: center; padding: 60px 20px; color: #888; }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }

        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 24px; }
        .page-btn { padding: 8px 14px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .page-btn.active { background: #1a1a2e; color: white; border-color: #1a1a2e; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 768px) {
            .header-inner { padding: 12px 16px; }
            .nav { display: none; }
            .main { padding: 16px; }
            .stats-row { grid-template-columns: 1fr; }
            .action-card { flex-direction: column; align-items: flex-start; }
            .action-right { margin-left: 0; margin-top: 12px; }
            .page-header { flex-direction: column; gap: 12px; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-inner">
            <div class="logo">
                <h1><a href="" id="home-link">ResearchPulse</a></h1>
                <span class="badge">v2</span>
            </div>
            <div class="nav" id="nav-menu">
                <a href="" id="nav-home">首页</a>
                <a href="" id="nav-subscriptions">订阅管理</a>
            </div>
            <div class="auth-area" id="auth-area"></div>
        </div>
    </div>

    <div class="main">
        <div class="page-header">
            <h2>行动建议</h2>
            <div class="filter-bar">
                <select id="filter-status" onchange="loadActions()">
                    <option value="">全部状态</option>
                    <option value="pending" selected>待处理</option>
                    <option value="completed">已完成</option>
                    <option value="dismissed">已忽略</option>
                </select>
                <select id="filter-priority" onchange="loadActions()">
                    <option value="">全部优先级</option>
                    <option value="高">高</option>
                    <option value="中">中</option>
                    <option value="低">低</option>
                </select>
            </div>
        </div>
        <div class="stats-row" id="stats-row">
            <div class="stat-card"><div class="value" id="stat-pending">-</div><div class="label">待处理</div></div>
            <div class="stat-card"><div class="value" id="stat-completed">-</div><div class="label">已完成</div></div>
            <div class="stat-card"><div class="value" id="stat-dismissed">-</div><div class="label">已忽略</div></div>
        </div>
        <div class="action-list" id="action-list">
            <div class="empty-state">
                <div class="icon">&#9203;</div>
                <div class="text">加载中...</div>
            </div>
        </div>
        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        document.getElementById('home-link').href = APP_BASE + '/';
        document.getElementById('nav-home').href = APP_BASE + '/';
        document.getElementById('nav-subscriptions').href = APP_BASE + '/subscriptions';

        let currentPage = 1;
        const pageSize = 20;
        let totalActions = 0;

        async function checkAuth() {
            // 获取功能开关状态
            let featureStatus = {};
            try {
                const fsRes = await fetch(`${API_BASE}/feature-status`);
                if (fsRes.ok) featureStatus = await fsRes.json();
            } catch(e) {}

            const token = localStorage.getItem('access_token');
            const area = document.getElementById('auth-area');
            const navMenu = document.getElementById('nav-menu');
            if (token) {
                try {
                    const res = await fetch(`${AUTH_BASE}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` }});
                    if (res.ok) {
                        const user = await res.json();
                        area.innerHTML = `<span style="color:#4ecdc4;font-size:14px;">&#128100; ${user.username}</span><a href="#" onclick="logout()">退出</a>`;
                        // 根据功能开关和用户权限动态显示导航 tab
                        if (user.is_superuser || featureStatus.event_clustering) {
                            const link = document.createElement('a');
                            link.href = APP_BASE + '/events';
                            link.textContent = '事件聚类';
                            navMenu.appendChild(link);
                        }
                        if (user.is_superuser || featureStatus.topic_radar) {
                            const link = document.createElement('a');
                            link.href = APP_BASE + '/topics';
                            link.textContent = '话题趋势';
                            navMenu.appendChild(link);
                        }
                        if (user.is_superuser || featureStatus.action_items) {
                            const link = document.createElement('a');
                            link.href = APP_BASE + '/actions';
                            link.textContent = '行动建议';
                            link.className = 'active';
                            navMenu.appendChild(link);
                        }
                        if (user.is_superuser || featureStatus.report_generation) {
                            const link = document.createElement('a');
                            link.href = APP_BASE + '/reports';
                            link.textContent = '报告中心';
                            navMenu.appendChild(link);
                        }
                        // 每日报告
                        const dailyLink = document.createElement('a');
                        dailyLink.href = APP_BASE + '/daily-reports';
                        dailyLink.textContent = '每日报告';
                        navMenu.appendChild(dailyLink);
                        if (user.is_superuser) {
                            const adminLink = document.createElement('a');
                            adminLink.href = APP_BASE + '/admin';
                            adminLink.textContent = '管理后台';
                            navMenu.appendChild(adminLink);
                        }
                        return;
                    }
                } catch(e) {}
            }
            area.innerHTML = `<a href="${APP_BASE}/">登录</a>`;
        }

        function logout() { localStorage.removeItem('access_token'); location.reload(); }

        function getHeaders() {
            const token = localStorage.getItem('access_token');
            return token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
        }

        async function loadActions() {
            const status = document.getElementById('filter-status').value;
            const priority = document.getElementById('filter-priority').value;
            const offset = (currentPage - 1) * pageSize;

            const params = new URLSearchParams({ limit: pageSize, offset });
            if (status) params.append('status', status);
            if (priority) params.append('priority', priority);

            try {
                const res = await fetch(`${API_BASE}/actions?${params}`, { headers: getHeaders() });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    let errMsg = err.detail || '加载失败，请确认已登录且功能已启用';
                    if (res.status === 503 && err.detail && err.detail.includes('not enabled')) {
                        errMsg = '行动建议功能尚未启用，请联系管理员在管理后台开启此功能。';
                    }
                    document.getElementById('action-list').innerHTML = `<div class="empty-state"><div class="icon">&#128274;</div><div class="text">${errMsg}</div></div>`;
                    return;
                }
                const data = await res.json();
                totalActions = data.total || 0;
                renderActions(data.actions || data.items || []);
                renderPagination();
            } catch(e) {
                document.getElementById('action-list').innerHTML = '<div class="empty-state"><div class="icon">&#10060;</div><div class="text">网络错误</div></div>';
            }

            loadStats();
        }

        async function loadStats() {
            // Try to load counts for each status
            for (const st of ['pending', 'completed', 'dismissed']) {
                try {
                    const res = await fetch(`${API_BASE}/actions?status=${st}&limit=1&offset=0`, { headers: getHeaders() });
                    if (res.ok) {
                        const data = await res.json();
                        const el = document.getElementById(`stat-${st}`);
                        if (el) el.textContent = data.total || 0;
                    }
                } catch(e) {}
            }
        }

        function renderActions(actions) {
            const container = document.getElementById('action-list');
            if (!actions || actions.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">&#9989;</div><div class="text">暂无行动建议</div></div>';
                return;
            }
            container.innerHTML = actions.map(a => {
                const priorityMap = { '高': 'high', '中': 'medium', '低': 'low', 'high': 'high', 'medium': 'medium', 'low': 'low' };
                const pClass = priorityMap[a.priority] || 'medium';
                const statusCls = a.status || 'pending';
                const isPending = statusCls === 'pending';
                return `
                    <div class="action-card status-${statusCls}">
                        <div class="action-left">
                            <div class="action-desc">${escapeHtml(a.description || '')}</div>
                            <div class="action-meta">
                                <span class="priority-badge ${pClass}">${escapeHtml(a.priority || '中')}</span>
                                ${a.type ? `<span class="type-badge">${escapeHtml(a.type)}</span>` : ''}
                                <span class="status-badge ${statusCls}">${statusCls === 'pending' ? '待处理' : statusCls === 'completed' ? '已完成' : '已忽略'}</span>
                                ${a.article_id ? `<span style="color:#888;">文章 #${a.article_id}</span>` : ''}
                            </div>
                        </div>
                        ${isPending ? `
                            <div class="action-right">
                                <button class="action-btn complete" onclick="updateAction(${a.id}, 'completed')">&#9989; 完成</button>
                                <button class="action-btn dismiss" onclick="updateAction(${a.id}, 'dismissed')">&#10005; 忽略</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        async function updateAction(id, newStatus) {
            try {
                const res = await fetch(`${API_BASE}/actions/${id}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({ status: newStatus }),
                });
                if (res.ok) {
                    loadActions();
                } else {
                    const err = await res.json().catch(() => ({}));
                    alert(err.detail || '操作失败');
                }
            } catch(e) {
                alert('网络错误');
            }
        }

        function renderPagination() {
            const totalPages = Math.ceil(totalActions / pageSize);
            const container = document.getElementById('pagination');
            if (totalPages <= 1) { container.innerHTML = `<span style="color:#888;font-size:14px;">共 ${totalActions} 条</span>`; return; }
            let html = `<button class="page-btn" onclick="goToPage(${currentPage-1})" ${currentPage===1?'disabled':''}>上一页</button>`;
            const start = Math.max(1, currentPage - 2), end = Math.min(totalPages, currentPage + 2);
            for (let i = start; i <= end; i++) { html += `<button class="page-btn ${i===currentPage?'active':''}" onclick="goToPage(${i})">${i}</button>`; }
            html += `<button class="page-btn" onclick="goToPage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>下一页</button>`;
            container.innerHTML = html;
        }

        function goToPage(p) { currentPage = p; loadActions(); window.scrollTo({top:0,behavior:'smooth'}); }

        function escapeHtml(str) { if (!str) return ''; const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

        checkAuth();
        loadActions();
    </script>
</body>
</html>
