{% extends "base.html" %}

{% block title %}报告中心 - ResearchPulse{% endblock %}

{% block extra_styles %}
<style>
    .report-list { display: flex; flex-direction: column; gap: 16px; }
    .report-card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: box-shadow 0.2s; overflow: hidden; }
    .report-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .report-header { padding: 20px; cursor: pointer; }
    .report-title { font-size: 17px; font-weight: 600; color: #1a1a2e; margin-bottom: 8px; }
    .report-meta { display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px; color: #666; }
    .report-meta span { display: flex; align-items: center; gap: 4px; }
    .report-type { padding: 3px 10px; border-radius: 3px; font-size: 11px; font-weight: 600; }
    .report-type.weekly { background: #dbeafe; color: #2563eb; }
    .report-type.monthly { background: #ede9fe; color: #7c3aed; }

    .report-content { padding: 0 20px 20px; display: none; border-top: 1px solid #f0f0f0; }
    .report-content.open { display: block; }
    .report-body { padding-top: 16px; font-size: 14px; color: #444; line-height: 1.8; }
    .report-body h1, .report-body h2, .report-body h3 { color: #1a1a2e; margin: 16px 0 8px; }
    .report-body h1 { font-size: 20px; }
    .report-body h2 { font-size: 17px; }
    .report-body h3 { font-size: 15px; }
    .report-body ul, .report-body ol { padding-left: 24px; margin: 8px 0; }
    .report-body li { margin: 4px 0; }
    .report-body p { margin: 8px 0; }
    .report-body code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 13px; }
    .report-body blockquote { border-left: 3px solid #764ba2; padding-left: 12px; color: #666; margin: 8px 0; }

    .report-stats { margin-top: 16px; padding: 16px; background: #faf8ff; border-radius: 8px; }
    .report-stats h4 { font-size: 14px; color: #764ba2; margin-bottom: 10px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
    .stats-item { text-align: center; }
    .stats-item .val { font-size: 20px; font-weight: 600; color: #1a1a2e; }
    .stats-item .lbl { font-size: 11px; color: #888; }

    @media (max-width: 768px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
</style>
{% endblock %}

{% block content %}
<div class="main">
    <div class="page-header">
        <h2>报告中心</h2>
        <div class="filter-bar">
            <select id="filter-type" onchange="loadReports()">
                <option value="">全部类型</option>
                <option value="weekly">周报</option>
                <option value="monthly">月报</option>
            </select>
        </div>
    </div>
    <div class="report-list" id="report-list">
        <div class="empty-state">
            <div class="icon">&#9203;</div>
            <div class="text">加载中...</div>
        </div>
    </div>
    <div class="pagination" id="pagination"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const NAV_ACTIVE = 'reports';
    let currentPage = 1;
    const pageSize = 10;
    let totalReports = 0;

    async function loadReports() {
        const type = document.getElementById('filter-type').value;
        const offset = (currentPage - 1) * pageSize;

        const params = new URLSearchParams({ limit: pageSize, offset });
        if (type) params.append('type', type);

        try {
            const res = await fetch(`${API_BASE}/reports?${params}`, { headers: getAuthHeaders() });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                let errMsg = err.detail || '加载失败，请确认已登录且功能已启用';
                if (res.status === 503 && err.detail && err.detail.includes('not enabled')) {
                    errMsg = '报告生成功能尚未启用，请联系管理员在管理后台开启此功能。';
                }
                document.getElementById('report-list').innerHTML = `<div class="empty-state"><div class="icon">&#128274;</div><div class="text">${errMsg}</div></div>`;
                return;
            }
            const data = await res.json();
            totalReports = data.total || 0;
            renderReports(data.reports || []);
            renderPaginationFn();
        } catch(e) {
            document.getElementById('report-list').innerHTML = '<div class="empty-state"><div class="icon">&#10060;</div><div class="text">网络错误</div></div>';
        }
    }

    function renderReports(reports) {
        const container = document.getElementById('report-list');
        if (!reports || reports.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="icon">&#128203;</div><div class="text">暂无报告数据</div></div>';
            return;
        }
        container.innerHTML = reports.map((r, idx) => {
            const typeClass = r.type || 'weekly';
            const typeLabel = typeClass === 'weekly' ? '周报' : typeClass === 'monthly' ? '月报' : r.type;
            const generated = r.generated_at ? formatDate(r.generated_at) : '';
            const period = (r.period_start && r.period_end) ? `${r.period_start} ~ ${r.period_end}` : '';

            let statsHtml = '';
            if (r.stats && typeof r.stats === 'object') {
                const items = Object.entries(r.stats).map(([k, v]) => {
                    const label = k.replace(/_/g, ' ');
                    return `<div class="stats-item"><div class="val">${typeof v === 'number' ? v : escapeHtml(String(v))}</div><div class="lbl">${escapeHtml(label)}</div></div>`;
                }).join('');
                if (items) {
                    statsHtml = `<div class="report-stats"><h4>统计数据</h4><div class="stats-grid">${items}</div></div>`;
                }
            }

            return `
                <div class="report-card">
                    <div class="report-header" onclick="toggleReport(${idx})">
                        <div class="report-title">${escapeHtml(r.title || '无标题')}</div>
                        <div class="report-meta">
                            <span class="report-type ${typeClass}">${typeLabel}</span>
                            ${period ? `<span>&#128197; ${period}</span>` : ''}
                            ${generated ? `<span>&#128336; 生成时间: ${generated}</span>` : ''}
                        </div>
                    </div>
                    <div class="report-content" id="report-content-${idx}">
                        <div class="report-body">${renderMarkdown(r.content || '')}</div>
                        ${statsHtml}
                    </div>
                </div>
            `;
        }).join('');
    }

    function toggleReport(idx) {
        const el = document.getElementById(`report-content-${idx}`);
        el.classList.toggle('open');
    }

    function renderMarkdown(md) {
        if (!md) return '<p style="color:#999;">暂无内容</p>';
        let html = escapeHtml(md);
        html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
        html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
        html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        html = html.replace(/`(.+?)`/g, '<code>$1</code>');
        html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
        html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
        html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
        html = html.replace(/\n\n/g, '</p><p>');
        html = '<p>' + html + '</p>';
        html = html.replace(/<p>\s*<\/p>/g, '');
        return html;
    }

    function renderPaginationFn() {
        renderPagination(document.getElementById('pagination'), totalReports, pageSize, currentPage, 'goToPage');
    }

    function goToPage(p) { currentPage = p; loadReports(); window.scrollTo({top:0,behavior:'smooth'}); }

    checkAuth().then(() => loadReports());
</script>
{% endblock %}
