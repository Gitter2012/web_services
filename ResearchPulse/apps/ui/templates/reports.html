{% extends "base.html" %}

{% block title %}æŠ¥å‘Šä¸­å¿ƒ - ResearchPulse{% endblock %}

{% block extra_styles %}
<style>
    .report-list { display: flex; flex-direction: column; gap: 16px; }

    /* æŠ¥å‘Šå¡ç‰‡æ ·å¼ */
    .report-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        border: 1px solid #f0f0f0;
        transition: all 0.3s ease;
        overflow: hidden;
    }
    .report-card:hover {
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        border-color: #e0e0e0;
    }

    /* æŠ¥å‘Šå¤´éƒ¨ */
    .report-header {
        padding: 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
    }
    .report-header:hover {
        background: #fafafa;
    }
    .report-info {
        flex: 1;
    }
    .report-title {
        font-size: 17px;
        font-weight: 600;
        color: #1a1a2e;
        margin-bottom: 8px;
    }
    .report-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        font-size: 13px;
        color: #666;
    }
    .report-meta span {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* å±•å¼€ç®­å¤´ */
    .report-expand-icon {
        color: #999;
        transition: transform 0.3s;
        font-size: 12px;
        margin-left: 12px;
    }
    .report-header:hover .report-expand-icon {
        color: #4ecdc4;
    }

    /* æŠ¥å‘Šç±»å‹æ ‡ç­¾ */
    .report-type {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    .report-type.weekly {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    .report-type.monthly {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(245, 87, 108, 0.3);
    }

    /* æŠ¥å‘Šå†…å®¹åŒºåŸŸ */
    .report-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        border-top: none;
        padding: 0 20px;
    }
    .report-content.open {
        max-height: 3000px;
        border-top: 1px solid #f0f0f0;
        padding: 0 20px 20px;
    }

    /* æŠ¥å‘Šæ­£æ–‡æ ·å¼ */
    .report-body {
        padding-top: 20px;
        font-size: 14px;
        color: #444;
        line-height: 1.8;
    }
    .report-body h1 {
        font-size: 22px;
        color: #1a1a2e;
        margin: 0 0 16px 0;
        padding-bottom: 12px;
        border-bottom: 2px solid #4ecdc4;
    }
    .report-body h2 {
        font-size: 18px;
        color: #1a1a2e;
        margin: 24px 0 12px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .report-body h2::before {
        content: '';
        width: 4px;
        height: 20px;
        background: linear-gradient(180deg, #4ecdc4, #44a08d);
        border-radius: 2px;
    }
    .report-body h3 {
        font-size: 16px;
        color: #333;
        margin: 16px 0 8px 0;
    }
    .report-body ul, .report-body ol {
        padding-left: 20px;
        margin: 12px 0;
    }
    .report-body li {
        margin: 8px 0;
        padding-left: 8px;
    }
    .report-body ul li::marker {
        color: #4ecdc4;
    }
    .report-body p {
        margin: 8px 0;
    }
    .report-body code {
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 13px;
    }
    .report-body blockquote {
        border-left: 3px solid #764ba2;
        padding: 12px 16px;
        background: #faf8ff;
        border-radius: 0 8px 8px 0;
        margin: 12px 0;
        color: #666;
    }
    .report-body a {
        color: #2563eb;
        text-decoration: none;
        border-bottom: 1px dashed #2563eb;
        transition: color 0.2s;
    }
    .report-body a:hover {
        color: #1d4ed8;
        border-bottom-style: solid;
    }
    .report-body hr {
        border: none;
        border-top: 1px dashed #e0e0e0;
        margin: 16px 0;
    }

    /* ç»Ÿè®¡åŒºåŸŸ */
    .report-stats {
        margin-top: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        border: 1px solid #e8e8e8;
    }
    .report-stats h4 {
        font-size: 14px;
        color: #1a1a2e;
        margin-bottom: 16px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
    }
    .stats-item {
        background: white;
        padding: 14px 16px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #e8e8e8;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stats-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .stats-item .val {
        font-size: 24px;
        font-weight: 700;
        color: #1a1a2e;
        margin-bottom: 4px;
    }
    .stats-item .lbl {
        font-size: 12px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* ç§»åŠ¨ç«¯å“åº”å¼ */
    @media (max-width: 768px) {
        .report-card { border-radius: 8px; }
        .report-header {
            padding: 16px;
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
        .report-title { font-size: 16px; }
        .report-expand-icon {
            position: absolute;
            right: 16px;
            top: 16px;
        }
        .report-content { padding: 0 16px 16px; }
        .report-body { font-size: 13px; }
        .report-body h1 { font-size: 18px; }
        .report-body h2 { font-size: 16px; }
        .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .stats-item { padding: 12px; }
        .stats-item .val { font-size: 20px; }
        .report-stats { padding: 16px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="main">
    <div class="page-header">
        <h2>æŠ¥å‘Šä¸­å¿ƒ</h2>
        <div class="filter-bar">
            <select id="filter-type" onchange="loadReports()">
                <option value="">å…¨éƒ¨ç±»å‹</option>
                <option value="weekly">å‘¨æŠ¥</option>
                <option value="monthly">æœˆæŠ¥</option>
            </select>
        </div>
    </div>
    <div class="report-list" id="report-list">
        <div class="empty-state">
            <div class="icon">&#9203;</div>
            <div class="text">åŠ è½½ä¸­...</div>
        </div>
    </div>
    <div class="pagination" id="pagination"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const NAV_ACTIVE = 'reports';
    let currentPage = 1;
    const pageSize = 10;
    let totalReports = 0;

    async function loadReports() {
        const type = document.getElementById('filter-type').value;
        const offset = (currentPage - 1) * pageSize;

        const params = new URLSearchParams({ limit: pageSize, offset });
        if (type) params.append('type', type);

        try {
            const res = await fetch(`${API_BASE}/reports?${params}`, { headers: getAuthHeaders() });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                let errMsg = err.detail || 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®è®¤å·²ç™»å½•ä¸”åŠŸèƒ½å·²å¯ç”¨';
                if (res.status === 503 && err.detail && err.detail.includes('not enabled')) {
                    errMsg = 'æŠ¥å‘Šç”ŸæˆåŠŸèƒ½å°šæœªå¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜åœ¨ç®¡ç†åå°å¼€å¯æ­¤åŠŸèƒ½ã€‚';
                }
                document.getElementById('report-list').innerHTML = `<div class="empty-state"><div class="icon">&#128274;</div><div class="text">${errMsg}</div></div>`;
                return;
            }
            const data = await res.json();
            totalReports = data.total || 0;
            renderReports(data.reports || []);
            renderPaginationFn();
        } catch(e) {
            document.getElementById('report-list').innerHTML = '<div class="empty-state"><div class="icon">&#10060;</div><div class="text">ç½‘ç»œé”™è¯¯</div></div>';
        }
    }

    function renderReports(reports) {
        const container = document.getElementById('report-list');
        if (!reports || reports.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="icon">&#128203;</div><div class="text">æš‚æ— æŠ¥å‘Šæ•°æ®</div></div>';
            return;
        }
        container.innerHTML = reports.map((r, idx) => {
            const typeClass = r.type || 'weekly';
            const typeLabel = typeClass === 'weekly' ? 'å‘¨æŠ¥' : typeClass === 'monthly' ? 'æœˆæŠ¥' : r.type;
            const generated = r.generated_at ? formatDate(r.generated_at) : '';
            const period = (r.period_start && r.period_end) ? `${r.period_start} ~ ${r.period_end}` : '';

            let statsHtml = '';
            if (r.stats && typeof r.stats === 'object') {
                // åŸºç¡€æ•°å­—ç»Ÿè®¡
                const basicStats = [];
                if (typeof r.stats.total_items === 'number') {
                    basicStats.push({ label: 'total items', val: r.stats.total_items });
                }
                if (typeof r.stats.high_importance_items === 'number') {
                    basicStats.push({ label: 'high importance items', val: r.stats.high_importance_items });
                }

                // action_review: æ˜¾ç¤ºå®Œæˆç‡
                const ar = r.stats.action_review;
                if (ar && typeof ar === 'object' && ar.total > 0) {
                    basicStats.push({ label: 'action completion', val: `${ar.completion_rate || 0}%` });
                }

                // æ¸²æŸ“åŸºç¡€ç»Ÿè®¡
                if (basicStats.length > 0) {
                    const items = basicStats.map(s =>
                        `<div class="stats-item"><div class="val">${s.val}</div><div class="lbl">${escapeHtml(s.label)}</div></div>`
                    ).join('');
                    statsHtml = `<div class="report-stats"><h4>ç»Ÿè®¡æ•°æ®</h4><div class="stats-grid">${items}</div></div>`;
                }
            }

            return `
                <div class="report-card">
                    <div class="report-header" onclick="toggleReport(${idx})">
                        <div class="report-info">
                            <div class="report-title">${escapeHtml(r.title || 'æ— æ ‡é¢˜')}</div>
                            <div class="report-meta">
                                <span class="report-type ${typeClass}">${typeLabel}</span>
                                ${period ? `<span>ğŸ“… ${period}</span>` : ''}
                                ${generated ? `<span>ğŸ• ${generated}</span>` : ''}
                            </div>
                        </div>
                        <span class="report-expand-icon" id="expand-icon-${idx}">â–¶</span>
                    </div>
                    <div class="report-content" id="report-content-${idx}">
                        <div class="report-body">${renderMarkdown(r.content || '')}</div>
                        ${statsHtml}
                    </div>
                </div>
            `;
        }).join('');
    }

    function toggleReport(idx) {
        const content = document.getElementById(`report-content-${idx}`);
        const icon = document.getElementById(`expand-icon-${idx}`);
        content.classList.toggle('open');
        if (icon) {
            icon.style.transform = content.classList.contains('open') ? 'rotate(90deg)' : 'rotate(0deg)';
        }
    }

    function renderMarkdown(md) {
        if (!md) return '<p style="color:#999;">æš‚æ— å†…å®¹</p>';
        let html = escapeHtml(md);

        // æ ‡é¢˜å¤„ç†
        html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
        html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
        html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

        // åŠ ç²—ã€æ–œä½“ã€ä»£ç 
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        html = html.replace(/`(.+?)`/g, '<code>$1</code>');

        // é“¾æ¥ [text](url)
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');

        // æ— åºåˆ—è¡¨
        html = html.replace(/^- (.+)$/gm, '<uli>$1</uli>');
        html = html.replace(/(<uli>.*<\/uli>\n?)+/g, '<ul>$&</ul>');
        html = html.replace(/<\/?uli>/g, function(m) { return m === '<uli>' ? '<li>' : '</li>'; });

        // æœ‰åºåˆ—è¡¨
        html = html.replace(/^\d+\. (.+)$/gm, '<oli>$1</oli>');
        html = html.replace(/(<oli>.*<\/oli>\n?)+/g, '<ol>$&</ol>');
        html = html.replace(/<\/?oli>/g, function(m) { return m === '<oli>' ? '<li>' : '</li>'; });

        // å¼•ç”¨
        html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');

        // æ°´å¹³çº¿
        html = html.replace(/^---$/gm, '<hr>');

        // æ®µè½
        html = html.replace(/\n\n/g, '</p><p>');
        html = '<p>' + html + '</p>';
        html = html.replace(/<p>\s*<\/p>/g, '');

        return html;
    }

    function renderPaginationFn() {
        renderPagination(document.getElementById('pagination'), totalReports, pageSize, currentPage, 'goToPage');
    }

    function goToPage(p) { currentPage = p; loadReports(); window.scrollTo({top:0,behavior:'smooth'}); }

    checkAuth().then(() => loadReports());
</script>
{% endblock %}
