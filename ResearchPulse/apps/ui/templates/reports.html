<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>报告中心 - ResearchPulse</title>
    <script>
        (function() {
            var path = window.location.pathname;
            var rpIndex = path.indexOf('/researchpulse');
            var prefix = rpIndex > 0 ? path.substring(0, rpIndex) : '';
            window.APP_BASE = prefix + '/researchpulse';
            window.API_BASE = prefix + '/researchpulse/api';
            window.AUTH_BASE = prefix + '/api/v1';
        })();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }

        .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-inner { max-width: 1200px; margin: 0 auto; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo h1 { font-size: 22px; font-weight: 600; }
        .logo h1 a { color: white; text-decoration: none; }
        .logo .badge { background: #e94560; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .nav { display: flex; gap: 20px; }
        .nav a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; transition: color 0.2s; }
        .nav a:hover { color: white; }
        .nav a.active { color: #4ecdc4; }
        .auth-area { display: flex; align-items: center; gap: 16px; }
        .auth-area a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; }

        .main { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .page-header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .page-header h2 { font-size: 24px; color: #1a1a2e; }
        .filter-bar { display: flex; gap: 12px; }
        .filter-bar select, .filter-bar button { padding: 8px 14px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; }
        .filter-bar button { background: #1a1a2e; color: white; border: none; }
        .filter-bar button:hover { background: #2d2d4a; }

        .report-list { display: flex; flex-direction: column; gap: 16px; }
        .report-card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: box-shadow 0.2s; overflow: hidden; }
        .report-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .report-header { padding: 20px; cursor: pointer; }
        .report-title { font-size: 17px; font-weight: 600; color: #1a1a2e; margin-bottom: 8px; }
        .report-meta { display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px; color: #666; }
        .report-meta span { display: flex; align-items: center; gap: 4px; }
        .report-type { padding: 3px 10px; border-radius: 3px; font-size: 11px; font-weight: 600; }
        .report-type.weekly { background: #dbeafe; color: #2563eb; }
        .report-type.monthly { background: #ede9fe; color: #7c3aed; }

        .report-content { padding: 0 20px 20px; display: none; border-top: 1px solid #f0f0f0; }
        .report-content.open { display: block; }
        .report-body { padding-top: 16px; font-size: 14px; color: #444; line-height: 1.8; }
        .report-body h1, .report-body h2, .report-body h3 { color: #1a1a2e; margin: 16px 0 8px; }
        .report-body h1 { font-size: 20px; }
        .report-body h2 { font-size: 17px; }
        .report-body h3 { font-size: 15px; }
        .report-body ul, .report-body ol { padding-left: 24px; margin: 8px 0; }
        .report-body li { margin: 4px 0; }
        .report-body p { margin: 8px 0; }
        .report-body code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 13px; }
        .report-body blockquote { border-left: 3px solid #764ba2; padding-left: 12px; color: #666; margin: 8px 0; }

        .report-stats { margin-top: 16px; padding: 16px; background: #faf8ff; border-radius: 8px; }
        .report-stats h4 { font-size: 14px; color: #764ba2; margin-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .stats-item { text-align: center; }
        .stats-item .val { font-size: 20px; font-weight: 600; color: #1a1a2e; }
        .stats-item .lbl { font-size: 11px; color: #888; }

        .empty-state { text-align: center; padding: 60px 20px; color: #888; }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }

        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 24px; }
        .page-btn { padding: 8px 14px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .page-btn.active { background: #1a1a2e; color: white; border-color: #1a1a2e; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 768px) {
            .header-inner { padding: 12px 16px; }
            .nav { display: none; }
            .main { padding: 16px; }
            .page-header { flex-direction: column; gap: 12px; align-items: flex-start; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-inner">
            <div class="logo">
                <h1><a href="" id="home-link">ResearchPulse</a></h1>
                <span class="badge">v2</span>
            </div>
            <div class="nav" id="nav-menu">
                <a href="" id="nav-home">首页</a>
                <a href="" id="nav-subscriptions">订阅管理</a>
            </div>
            <div class="auth-area" id="auth-area"></div>
        </div>
    </div>

    <div class="main">
        <div class="page-header">
            <h2>报告中心</h2>
            <div class="filter-bar">
                <select id="filter-type" onchange="loadReports()">
                    <option value="">全部类型</option>
                    <option value="weekly">周报</option>
                    <option value="monthly">月报</option>
                </select>
            </div>
        </div>
        <div class="report-list" id="report-list">
            <div class="empty-state">
                <div class="icon">&#9203;</div>
                <div class="text">加载中...</div>
            </div>
        </div>
        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        document.getElementById('home-link').href = APP_BASE + '/';
        document.getElementById('nav-home').href = APP_BASE + '/';
        document.getElementById('nav-subscriptions').href = APP_BASE + '/subscriptions';

        let currentPage = 1;
        const pageSize = 10;
        let totalReports = 0;

        async function checkAuth() {
            // 获取功能开关状态
            let featureStatus = {};
            try {
                const fsRes = await fetch(`${API_BASE}/feature-status`);
                if (fsRes.ok) featureStatus = await fsRes.json();
            } catch(e) {}

            const token = localStorage.getItem('access_token');
            const area = document.getElementById('auth-area');
            const navMenu = document.getElementById('nav-menu');
            if (token) {
                try {
                    const res = await fetch(`${AUTH_BASE}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` }});
                    if (res.ok) {
                        const user = await res.json();
                        area.innerHTML = `<span style="color:#4ecdc4;font-size:14px;">&#128100; ${user.username}</span><a href="#" onclick="logout()">退出</a>`;
                        // 根据功能开关和用户权限动态显示导航 tab
                        if (user.is_superuser || featureStatus.event_clustering) {
                            const link = document.createElement('a');
                            link.href = APP_BASE + '/events';
                            link.textContent = '事件聚类';
                            navMenu.appendChild(link);
                        }
                        if (user.is_superuser || featureStatus.topic_radar) {
                            const link = document.createElement('a');
                            link.href = APP_BASE + '/topics';
                            link.textContent = '话题趋势';
                            navMenu.appendChild(link);
                        }
                        if (user.is_superuser || featureStatus.action_items) {
                            const link = document.createElement('a');
                            link.href = APP_BASE + '/actions';
                            link.textContent = '行动建议';
                            navMenu.appendChild(link);
                        }
                        if (user.is_superuser || featureStatus.report_generation) {
                            const link = document.createElement('a');
                            link.href = APP_BASE + '/reports';
                            link.textContent = '报告中心';
                            link.className = 'active';
                            navMenu.appendChild(link);
                        }
                        if (user.is_superuser) {
                            const adminLink = document.createElement('a');
                            adminLink.href = APP_BASE + '/admin';
                            adminLink.textContent = '管理后台';
                            navMenu.appendChild(adminLink);
                        }
                        return;
                    }
                } catch(e) {}
            }
            area.innerHTML = `<a href="${APP_BASE}/">登录</a>`;
        }

        function logout() { localStorage.removeItem('access_token'); location.reload(); }

        function getHeaders() {
            const token = localStorage.getItem('access_token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        async function loadReports() {
            const type = document.getElementById('filter-type').value;
            const offset = (currentPage - 1) * pageSize;

            const params = new URLSearchParams({ limit: pageSize, offset });
            if (type) params.append('type', type);

            try {
                const res = await fetch(`${API_BASE}/reports?${params}`, { headers: getHeaders() });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    let errMsg = err.detail || '加载失败，请确认已登录且功能已启用';
                    if (res.status === 503 && err.detail && err.detail.includes('not enabled')) {
                        errMsg = '报告生成功能尚未启用，请联系管理员在管理后台开启此功能。';
                    }
                    document.getElementById('report-list').innerHTML = `<div class="empty-state"><div class="icon">&#128274;</div><div class="text">${errMsg}</div></div>`;
                    return;
                }
                const data = await res.json();
                totalReports = data.total || 0;
                renderReports(data.reports || []);
                renderPagination();
            } catch(e) {
                document.getElementById('report-list').innerHTML = '<div class="empty-state"><div class="icon">&#10060;</div><div class="text">网络错误</div></div>';
            }
        }

        function renderReports(reports) {
            const container = document.getElementById('report-list');
            if (!reports || reports.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">&#128203;</div><div class="text">暂无报告数据</div></div>';
                return;
            }
            container.innerHTML = reports.map((r, idx) => {
                const typeClass = r.type || 'weekly';
                const typeLabel = typeClass === 'weekly' ? '周报' : typeClass === 'monthly' ? '月报' : r.type;
                const generated = r.generated_at ? formatDate(r.generated_at) : '';
                const period = (r.period_start && r.period_end) ? `${r.period_start} ~ ${r.period_end}` : '';

                // Parse stats
                let statsHtml = '';
                if (r.stats && typeof r.stats === 'object') {
                    const items = Object.entries(r.stats).map(([k, v]) => {
                        const label = k.replace(/_/g, ' ');
                        return `<div class="stats-item"><div class="val">${typeof v === 'number' ? v : escapeHtml(String(v))}</div><div class="lbl">${escapeHtml(label)}</div></div>`;
                    }).join('');
                    if (items) {
                        statsHtml = `<div class="report-stats"><h4>统计数据</h4><div class="stats-grid">${items}</div></div>`;
                    }
                }

                return `
                    <div class="report-card">
                        <div class="report-header" onclick="toggleReport(${idx})">
                            <div class="report-title">${escapeHtml(r.title || '无标题')}</div>
                            <div class="report-meta">
                                <span class="report-type ${typeClass}">${typeLabel}</span>
                                ${period ? `<span>&#128197; ${period}</span>` : ''}
                                ${generated ? `<span>&#128336; 生成时间: ${generated}</span>` : ''}
                            </div>
                        </div>
                        <div class="report-content" id="report-content-${idx}">
                            <div class="report-body">${renderMarkdown(r.content || '')}</div>
                            ${statsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleReport(idx) {
            const el = document.getElementById(`report-content-${idx}`);
            el.classList.toggle('open');
        }

        function renderMarkdown(md) {
            if (!md) return '<p style="color:#999;">暂无内容</p>';
            // Simple markdown rendering (basic subset)
            let html = escapeHtml(md);
            // Headers
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            // Bold
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Italic
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            // Code
            html = html.replace(/`(.+?)`/g, '<code>$1</code>');
            // List items
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            // Blockquotes
            html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
            // Line breaks -> paragraphs
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            // Clean up empty paragraphs
            html = html.replace(/<p>\s*<\/p>/g, '');
            return html;
        }

        function renderPagination() {
            const totalPages = Math.ceil(totalReports / pageSize);
            const container = document.getElementById('pagination');
            if (totalPages <= 1) { container.innerHTML = `<span style="color:#888;font-size:14px;">共 ${totalReports} 份报告</span>`; return; }
            let html = `<button class="page-btn" onclick="goToPage(${currentPage-1})" ${currentPage===1?'disabled':''}>上一页</button>`;
            const start = Math.max(1, currentPage - 2), end = Math.min(totalPages, currentPage + 2);
            for (let i = start; i <= end; i++) { html += `<button class="page-btn ${i===currentPage?'active':''}" onclick="goToPage(${i})">${i}</button>`; }
            html += `<button class="page-btn" onclick="goToPage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>下一页</button>`;
            container.innerHTML = html;
        }

        function goToPage(p) { currentPage = p; loadReports(); window.scrollTo({top:0,behavior:'smooth'}); }

        function escapeHtml(str) { if (!str) return ''; const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
        function formatDate(iso) { if (!iso) return ''; try { const d = new Date(iso); return d.toLocaleDateString('zh-CN', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); } catch(e) { return iso; } }

        checkAuth();
        loadReports();
    </script>
</body>
</html>
