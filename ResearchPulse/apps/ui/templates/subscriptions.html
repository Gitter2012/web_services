<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢é˜…ç®¡ç† - ResearchPulse</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }

        .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-inner { max-width: 1400px; margin: 0 auto; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo h1 { font-size: 22px; font-weight: 600; }
        .nav { display: flex; gap: 24px; }
        .nav a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; }
        .nav a:hover, .nav a.active { color: white; }
        .auth-area { display: flex; align-items: center; gap: 16px; }
        .auth-area .user-info { display: flex; align-items: center; gap: 8px; color: #4ecdc4; font-size: 14px; }
        .auth-area a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

        .page-header { margin-bottom: 24px; }
        .page-header h2 { font-size: 24px; color: #1a1a2e; margin-bottom: 8px; }
        .page-header p { color: #666; font-size: 14px; }

        .tabs { display: flex; gap: 4px; background: white; padding: 4px; border-radius: 12px; margin-bottom: 24px; }
        .tab { padding: 12px 24px; border: none; background: transparent; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .tab:hover { background: #f5f5f5; }
        .tab.active { background: #1a1a2e; color: white; }

        .content-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }

        .section-title { font-size: 16px; font-weight: 600; color: #1a1a2e; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
        .section-title .count { font-size: 13px; color: #888; font-weight: 400; }

        .search-box { display: flex; gap: 12px; margin-bottom: 20px; }
        .search-box input { flex: 1; padding: 12px 16px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .search-box input:focus { outline: none; border-color: #4ecdc4; }

        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; }
        .item-card { display: flex; align-items: center; gap: 12px; padding: 16px; border: 1px solid #e0e0e0; border-radius: 10px; transition: all 0.2s; }
        .item-card:hover { border-color: #4ecdc4; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .item-card.subscribed { border-color: #4ecdc4; background: #f0fdfb; }
        .item-card.inactive { opacity: 0.7; border-style: dashed; }

        .item-icon { width: 44px; height: 44px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; color: white; flex-shrink: 0; }
        .item-icon.arxiv { background: #b31b1b; }
        .item-icon.rss { background: #f39c12; }
        .item-icon.wechat { background: #07c160; }
        .item-icon.cs { background: #3b82f6; }
        .item-icon.math { background: #8b5cf6; }
        .item-icon.phys { background: #ef4444; }
        .item-icon.stat { background: #10b981; }
        .item-icon.other { background: #6b7280; }

        .item-info { flex: 1; min-width: 0; }
        .item-name { font-size: 14px; font-weight: 500; color: #1a1a2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-desc { font-size: 12px; color: #888; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-badge { display: inline-block; font-size: 11px; padding: 1px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
        .item-badge.inactive { background: #f3f4f6; color: #9ca3af; }
        .item-badge.active { background: #dcfce7; color: #16a34a; }

        .item-action { flex-shrink: 0; }
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-subscribe { background: #4ecdc4; color: white; }
        .btn-subscribe:hover { background: #3dbdb5; }
        .btn-unsubscribe { background: #fee2e2; color: #dc2626; }
        .btn-unsubscribe:hover { background: #fecaca; }

        .empty-state { text-align: center; padding: 40px; color: #888; }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 32px; border-radius: 16px; width: 400px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h2 { font-size: 20px; }
        .modal-close { font-size: 24px; cursor: pointer; color: #999; }
        .modal-body input { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .modal-body button { width: 100%; padding: 12px; background: #1a1a2e; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }

        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; text-align: center; }
        .stat-value { font-size: 32px; font-weight: 600; color: #1a1a2e; }
        .stat-label { font-size: 13px; color: #888; margin-top: 4px; }
        
        .form-group { margin-bottom: 16px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .form-input:focus { outline: none; border-color: #4ecdc4; }
        
        .validation-success { background: #dcfce7; color: #059669; padding: 12px; border-radius: 8px; margin-top: 12px; }
        .validation-error { background: #fee2e2; color: #dc2626; padding: 12px; border-radius: 8px; margin-top: 12px; }

        /* Mobile Overlay */
        .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; }
        .mobile-overlay.show { display: block; }

        /* Hamburger Menu Button */
        .mobile-menu-btn { display: none; width: 44px; height: 44px; background: transparent; border: none; cursor: pointer; padding: 10px; flex-direction: column; justify-content: center; align-items: center; gap: 5px; }
        .mobile-menu-btn span { display: block; width: 24px; height: 2px; background: white; transition: all 0.3s; border-radius: 2px; }
        .mobile-menu-btn.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .mobile-menu-btn.active span:nth-child(2) { opacity: 0; }
        .mobile-menu-btn.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }

        /* Mobile Navigation Dropdown */
        .mobile-nav { display: none; position: fixed; top: 60px; left: 0; right: 0; background: #1a1a2e; padding: 16px; z-index: 997; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .mobile-nav.show { display: block; }
        .mobile-nav a { display: block; color: rgba(255,255,255,0.8); text-decoration: none; padding: 12px 16px; font-size: 15px; border-radius: 6px; }
        .mobile-nav a:hover, .mobile-nav a.active { background: rgba(78,205,196,0.2); color: #4ecdc4; }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            .header-inner { padding: 12px 16px; }
            .logo h1 { font-size: 18px; }
            .nav { display: none; }
            .mobile-menu-btn { display: flex; }
            .auth-area { gap: 8px; font-size: 13px; }

            .container { padding: 16px; }
            .page-header h2 { font-size: 20px; }
            .page-header p { font-size: 13px; }

            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; padding: 4px; gap: 2px; }
            .tab { padding: 10px 16px; font-size: 13px; white-space: nowrap; }

            .stats-row { grid-template-columns: 1fr; gap: 12px; }
            .stat-card { padding: 16px; }
            .stat-value { font-size: 24px; }

            .search-box { flex-direction: column; gap: 8px; }
            .search-box input { padding: 10px 14px; }

            .item-grid { grid-template-columns: 1fr; }
            .item-card { padding: 12px; }
            .item-icon { width: 40px; height: 40px; font-size: 12px; }
            .item-name { font-size: 13px; }
            .item-desc { font-size: 11px; }
            .btn { padding: 8px 12px; font-size: 12px; }

            .content-card { padding: 16px; }

            .modal-content { width: 100%; max-width: 100%; border-radius: 0; padding: 24px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-inner">
            <div class="logo">
                <h1>ResearchPulse</h1>
            </div>
            <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav" id="nav-menu">
                <a href="/researchpulse/">é¦–é¡µ</a>
                <a href="/researchpulse/subscriptions" class="active">è®¢é˜…ç®¡ç†</a>
            </div>
            <div class="auth-area" id="auth-area">
                <span class="user-info">ğŸ‘¤ Loading...</span>
            </div>
        </div>
    </div>

    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>
    <div class="mobile-nav" id="mobile-nav"></div>

    <div class="container">
        <div class="page-header">
            <h2>è®¢é˜…ç®¡ç†</h2>
            <p>ç®¡ç†ä½ å…³æ³¨çš„å†…å®¹æºï¼Œä¸ªæ€§åŒ–ä½ çš„èµ„è®¯æµ</p>
        </div>

        <div class="stats-row" id="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="stat-arxiv">0</div>
                <div class="stat-label">ArXiv ç±»ç›®è®¢é˜…</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-rss">0</div>
                <div class="stat-label">RSS æºè®¢é˜…</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">æ€»è®¢é˜…æ•°</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('arxiv')">ArXiv ç±»ç›®</button>
            <button class="tab" onclick="switchTab('rss')">RSS æº</button>
            <button class="tab" onclick="switchTab('wechat')">å¾®ä¿¡å…¬ä¼—å·</button>
            <button class="tab" onclick="switchTab('add-rss')" style="background: #4ecdc4; color: white;">+ æ·»åŠ  RSS æº</button>
        </div>

        <div class="content-card" id="main-content">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="æœç´¢ ArXiv/RSS/å¾®ä¿¡..." oninput="debouncedSearch()">
                <span id="search-hint" style="font-size: 12px; color: #888; margin-left: 8px;"></span>
            </div>

            <div class="section-title">
                <span id="section-label">ArXiv ç±»ç›®</span>
                <span class="count" id="item-count">0 é¡¹</span>
            </div>

            <div class="item-grid" id="item-grid">
                <div class="empty-state">
                    <div class="icon">â³</div>
                    <div class="text">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- Add RSS Feed Card -->
        <div class="content-card" id="add-rss-content" style="display: none;">
            <div class="section-title">
                <span>æ·»åŠ è‡ªå®šä¹‰ RSS æº</span>
                <span style="color: #888; font-size: 13px; font-weight: 400;">æäº¤åéœ€ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹</span>
            </div>
            
            <div class="form-group" style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px;">RSS Feed URL *</label>
                <input type="url" id="new-feed-url" class="form-input" placeholder="https://example.com/feed.xml" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
            </div>
            
            <div class="form-group" style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px;">æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="new-feed-title" class="form-input" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ä» Feed ä¸­è·å–" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
            </div>
            
            <div class="form-group" style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px;">åˆ†ç±»</label>
                <input type="text" id="new-feed-category" class="form-input" value="ç”¨æˆ·æ·»åŠ " style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button class="btn" onclick="validateRssFeed()" style="background: #6b7280; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;">éªŒè¯</button>
                <button class="btn btn-subscribe" onclick="submitRssFeed()" style="padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;">æäº¤</button>
            </div>
            
            <div id="validation-result" style="margin-top: 16px; display: none;"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è¯·å…ˆç™»å½•</h2>
                <span class="modal-close" onclick="hideModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 16px;">è®¢é˜…åŠŸèƒ½éœ€è¦ç™»å½•åä½¿ç”¨</p>
                <input type="text" id="login-username" placeholder="ç”¨æˆ·å">
                <input type="password" id="login-password" placeholder="å¯†ç ">
                <button onclick="doLogin()">ç™»å½•</button>
            </div>
        </div>
    </div>

    <script>
        // åŠ¨æ€æ£€æµ‹ä»£ç†å‰ç¼€ï¼Œæ”¯æŒåå‘ä»£ç†éƒ¨ç½²
        (function() {
            const path = window.location.pathname;
            // æŸ¥æ‰¾ /researchpulse åœ¨è·¯å¾„ä¸­çš„ä½ç½®
            const rpIndex = path.indexOf('/researchpulse');
            const prefix = rpIndex > 0 ? path.substring(0, rpIndex) : '';
            window.APP_BASE = prefix + '/researchpulse';
            window.API_BASE = prefix + '/researchpulse/api';
            window.AUTH_BASE = prefix + '/api/v1';
        })();

        let currentTab = 'arxiv';
        let currentUser = null;
        let userSubscriptions = new Set();
        let allItems = [];
        let isSearchMode = false;
        let searchDebounceTimer = null;

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const overlay = document.getElementById('mobile-overlay');
            const mobileNav = document.getElementById('mobile-nav');
            const btn = document.getElementById('mobile-menu-btn');

            const isOpen = mobileNav.classList.contains('show');
            if (isOpen) {
                closeMobileMenu();
            } else {
                overlay.classList.add('show');
                mobileNav.classList.add('show');
                btn.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeMobileMenu() {
            const overlay = document.getElementById('mobile-overlay');
            const mobileNav = document.getElementById('mobile-nav');
            const btn = document.getElementById('mobile-menu-btn');

            overlay.classList.remove('show');
            mobileNav.classList.remove('show');
            btn.classList.remove('active');
            document.body.style.overflow = '';
        }

        function updateMobileNav(user) {
            const mobileNav = document.getElementById('mobile-nav');
            let html = '<a href="/researchpulse/">é¦–é¡µ</a>';
            html += '<a href="/researchpulse/subscriptions" class="active">è®¢é˜…ç®¡ç†</a>';
            if (user && user.is_superuser) {
                html += '<a href="/researchpulse/admin">ç®¡ç†åå°</a>';
            }
            if (user) {
                html += `<a href="#" onclick="logout(); return false;">é€€å‡ºç™»å½•</a>`;
            }
            mobileNav.innerHTML = html;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });

        // Auth
        async function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                showLoginModal();
                return;
            }

            try {
                const res = await fetch(`${AUTH_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    currentUser = await res.json();
                    updateAuthUI();
                    updateMobileNav(currentUser);
                    loadSubscriptions();
                    loadItems();
                } else {
                    localStorage.removeItem('access_token');
                    showLoginModal();
                }
            } catch (e) {
                showLoginModal();
            }
        }

        function updateAuthUI() {
            document.getElementById('auth-area').innerHTML = `
                <span class="user-info">ğŸ‘¤ ${currentUser.username}</span>
                <a href="#" onclick="logout()">é€€å‡º</a>
            `;
            
            // æ›´æ–°å¯¼èˆªèœå•ï¼Œä»…è¶…çº§ç®¡ç†å‘˜æ˜¾ç¤ºç®¡ç†åå°
            const navMenu = document.getElementById('nav-menu');
            let navHtml = '<a href="/researchpulse/">é¦–é¡µ</a>';
            navHtml += '<a href="/researchpulse/subscriptions" class="active">è®¢é˜…ç®¡ç†</a>';
            if (currentUser.is_superuser) {
                navHtml += '<a href="/researchpulse/admin">ç®¡ç†åå°</a>';
            }
            navMenu.innerHTML = navHtml;
        }

        function showLoginModal() {
            document.getElementById('login-modal').classList.add('active');
        }

        function hideModal() {
            document.getElementById('login-modal').classList.remove('active');
        }

        async function doLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                const res = await fetch(`${AUTH_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('access_token', data.access_token);
                    hideModal();
                    checkAuth();
                } else {
                    alert(data.detail || 'ç™»å½•å¤±è´¥');
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            location.href = '/researchpulse/';
        }

        // Subscriptions
        async function loadSubscriptions() {
            try {
                const token = localStorage.getItem('access_token');
                const res = await fetch(`${API_BASE}/subscriptions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                userSubscriptions = new Set(data.subscriptions.filter(s => s.is_active).map(s => `${s.source_type}:${s.source_id}`));
                updateStats();
            } catch (e) {
                console.error('Failed to load subscriptions:', e);
            }
        }

        function updateStats() {
            let arxiv = 0, rss = 0;
            userSubscriptions.forEach(s => {
                if (s.startsWith('arxiv:')) arxiv++;
                else if (s.startsWith('rss:')) rss++;
            });
            document.getElementById('stat-arxiv').textContent = arxiv;
            document.getElementById('stat-rss').textContent = rss;
            document.getElementById('stat-total').textContent = arxiv + rss;
        }

        // Tabs
        function switchTab(tab) {
            currentTab = tab;
            isSearchMode = false;  // é€€å‡ºæœç´¢æ¨¡å¼
            document.getElementById('search-input').value = '';
            document.getElementById('search-hint').textContent = '';
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.textContent.toLowerCase().includes(tab)));
            
            // Show/hide add RSS form
            if (tab === 'add-rss') {
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('add-rss-content').style.display = 'block';
                document.getElementById('validation-result').style.display = 'none';
            } else {
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('add-rss-content').style.display = 'none';
                loadItems();
            }
        }

        // Validate RSS Feed
        async function validateRssFeed() {
            const feedUrl = document.getElementById('new-feed-url').value;
            const resultDiv = document.getElementById('validation-result');
            
            if (!feedUrl) {
                resultDiv.className = 'validation-error';
                resultDiv.innerHTML = 'è¯·è¾“å…¥ RSS Feed URL';
                resultDiv.style.display = 'block';
                return;
            }
            
            const token = localStorage.getItem('access_token');
            resultDiv.className = '';
            resultDiv.innerHTML = 'æ­£åœ¨éªŒè¯...';
            resultDiv.style.display = 'block';
            
            try {
                const res = await fetch(`${API_BASE}/feeds/validate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ feed_url: feedUrl })
                });
                
                const data = await res.json();
                
                if (data.valid) {
                    resultDiv.className = 'validation-success';
                    resultDiv.innerHTML = `
                        <strong>âœ“ éªŒè¯æˆåŠŸ</strong><br>
                        <strong>æ ‡é¢˜:</strong> ${escapeHtml(data.title || 'æœªçŸ¥')}<br>
                        <strong>æè¿°:</strong> ${escapeHtml(data.description || 'æ— ')}
                    `;
                    // Auto-fill title if empty
                    if (!document.getElementById('new-feed-title').value && data.title) {
                        document.getElementById('new-feed-title').value = data.title;
                    }
                } else {
                    resultDiv.className = 'validation-error';
                    resultDiv.innerHTML = `<strong>âœ— éªŒè¯å¤±è´¥</strong><br>${escapeHtml(data.error || 'æœªçŸ¥é”™è¯¯')}`;
                }
            } catch (e) {
                resultDiv.className = 'validation-error';
                resultDiv.innerHTML = 'éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ URL æ˜¯å¦æ­£ç¡®';
            }
        }

        // Submit RSS Feed
        async function submitRssFeed() {
            const feedUrl = document.getElementById('new-feed-url').value;
            const title = document.getElementById('new-feed-title').value;
            const category = document.getElementById('new-feed-category').value;
            const resultDiv = document.getElementById('validation-result');
            
            if (!feedUrl) {
                alert('è¯·è¾“å…¥ RSS Feed URL');
                return;
            }
            
            const token = localStorage.getItem('access_token');
            
            try {
                const res = await fetch(`${API_BASE}/feeds/add`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        feed_url: feedUrl, 
                        title: title || null, 
                        category: category 
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    alert(data.message || 'RSS æºå·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹');
                    // Clear form
                    document.getElementById('new-feed-url').value = '';
                    document.getElementById('new-feed-title').value = '';
                    resultDiv.style.display = 'none';
                    // Switch to RSS tab
                    switchTab('rss');
                } else {
                    alert(data.detail || 'æäº¤å¤±è´¥');
                }
            } catch (e) {
                alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // Items
        async function loadItems() {
            const grid = document.getElementById('item-grid');
            grid.innerHTML = '<div class="empty-state"><div class="icon">â³</div><div class="text">åŠ è½½ä¸­...</div></div>';

            try {
                let items = [];
                if (currentTab === 'arxiv') {
                    const res = await fetch(`${API_BASE}/categories`);
                    const data = await res.json();
                    items = data.categories.map(c => ({
                        id: c.id,
                        code: c.code,
                        name: c.name,
                        description: c.description || '',
                        type: 'arxiv'
                    }));
                    document.getElementById('section-label').textContent = 'ArXiv ç±»ç›®';
                } else if (currentTab === 'rss') {
                    const res = await fetch(`${API_BASE}/feeds`);
                    const data = await res.json();
                    items = data.feeds.map(f => ({
                        id: f.id,
                        code: f.id.toString(),
                        name: f.title,
                        description: f.category || '',
                        type: 'rss'
                    }));
                    document.getElementById('section-label').textContent = 'RSS æº';
                } else {
                    items = [];
                    document.getElementById('section-label').textContent = 'å¾®ä¿¡å…¬ä¼—å·';
                }

                allItems = items;
                renderItems(items);
            } catch (e) {
                console.error('Failed to load items:', e);
                grid.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><div class="text">åŠ è½½å¤±è´¥</div></div>';
            }
        }

        function renderItems(items) {
            const grid = document.getElementById('item-grid');
            document.getElementById('item-count').textContent = `${items.length} é¡¹`;

            if (items.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><div class="text">æš‚æ— å†…å®¹</div></div>';
                return;
            }

            grid.innerHTML = items.map(item => {
                const key = `${item.type}:${item.id}`;
                const isSubscribed = userSubscriptions.has(key);
                const iconClass = getIconClass(item);
                const isActive = item.is_active !== false;

                // æ˜¾ç¤ºåç§°ï¼šArXiv æ˜¾ç¤º code - nameï¼Œå…¶ä»–ç±»å‹åªæ˜¾ç¤º name
                const displayName = item.type === 'arxiv' && item.code
                    ? `${item.code} - ${item.name}`
                    : item.name;

                // çŠ¶æ€æ ‡ç­¾ï¼šæœç´¢æ¨¡å¼ä¸‹æ˜¾ç¤ºæ´»è·ƒ/æœªæ¿€æ´»çŠ¶æ€
                const badgeHtml = isSearchMode && !isActive
                    ? '<span class="item-badge inactive">æœªæŠ“å–</span>'
                    : '';

                return `
                    <div class="item-card ${isSubscribed ? 'subscribed' : ''} ${!isActive ? 'inactive' : ''}" data-id="${item.id}" data-type="${item.type}">
                        <div class="item-icon ${iconClass}">${item.type === 'arxiv' ? (item.code || '').split('.')[0].toUpperCase().slice(0,2) : item.type.toUpperCase().slice(0,2)}</div>
                        <div class="item-info">
                            <div class="item-name">${escapeHtml(displayName)}${badgeHtml}</div>
                            <div class="item-desc">${escapeHtml(item.description || '')}</div>
                        </div>
                        <div class="item-action">
                            <button class="btn ${isSubscribed ? 'btn-unsubscribe' : 'btn-subscribe'}" onclick="toggleSubscription('${item.type}', ${item.id})">
                                ${isSubscribed ? 'å–æ¶ˆè®¢é˜…' : 'è®¢é˜…'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getIconClass(item) {
            if (item.type === 'rss') return 'rss';
            if (item.type === 'wechat') return 'wechat';
            const code = item.code || '';
            if (code.startsWith('cs.')) return 'cs';
            if (code.startsWith('math.')) return 'math';
            if (code.startsWith('physics') || code.includes('-ph')) return 'phys';
            if (code.startsWith('stat.')) return 'stat';
            return 'arxiv';
        }

        // é˜²æŠ–æœç´¢
        function debouncedSearch() {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                performSearch();
            }, 300);
        }

        // æ‰§è¡Œæœç´¢
        async function performSearch() {
            const keyword = document.getElementById('search-input').value.trim();
            const hint = document.getElementById('search-hint');

            if (!keyword) {
                // å…³é”®è¯ä¸ºç©ºï¼Œé€€å‡ºæœç´¢æ¨¡å¼ï¼Œæ¢å¤å½“å‰ tab æ•°æ®
                isSearchMode = false;
                hint.textContent = '';
                document.getElementById('section-label').textContent = getSectionLabel(currentTab);
                loadItems();
                return;
            }

            // è¿›å…¥æœç´¢æ¨¡å¼
            isSearchMode = true;
            hint.textContent = 'æœç´¢ä¸­...';

            try {
                const res = await fetch(`${API_BASE}/sources/search?q=${encodeURIComponent(keyword)}&limit=50`);
                const data = await res.json();

                // åˆå¹¶æ‰€æœ‰æœç´¢ç»“æœ
                const allResults = [
                    ...(data.arxiv || []),
                    ...(data.rss || []),
                    ...(data.wechat || [])
                ];

                allItems = allResults;
                document.getElementById('section-label').textContent = `æœç´¢ç»“æœ: "${keyword}"`;
                hint.textContent = `æ‰¾åˆ° ${allResults.length} é¡¹`;

                renderItems(allResults);
            } catch (e) {
                console.error('Search error:', e);
                hint.textContent = 'æœç´¢å¤±è´¥';
            }
        }

        function getSectionLabel(tab) {
            const labels = {
                'arxiv': 'ArXiv ç±»ç›®',
                'rss': 'RSS æº',
                'wechat': 'å¾®ä¿¡å…¬ä¼—å·'
            };
            return labels[tab] || tab;
        }

        function filterItems() {
            // æœ¬åœ°è¿‡æ»¤ï¼ˆç”¨äº tab åˆ‡æ¢åçš„å‰ç«¯è¿‡æ»¤ï¼‰
            const keyword = document.getElementById('search-input').value.toLowerCase();
            if (!keyword) {
                renderItems(allItems);
                return;
            }
            const filtered = allItems.filter(item =>
                (item.code || '').toLowerCase().includes(keyword) ||
                (item.name || '').toLowerCase().includes(keyword) ||
                (item.description || '').toLowerCase().includes(keyword)
            );
            renderItems(filtered);
        }

        async function toggleSubscription(type, id) {
            const key = `${type}:${id}`;
            const token = localStorage.getItem('access_token');

            try {
                let res;
                if (userSubscriptions.has(key)) {
                    // Unsubscribe
                    res = await fetch(`${API_BASE}/subscriptions/${type}/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } else {
                    // Subscribe - ä½¿ç”¨æŸ¥è¯¢å‚æ•°è€Œé JSON body
                    res = await fetch(`${API_BASE}/subscriptions?source_type=${encodeURIComponent(type)}&source_id=${id}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                }

                if (res.ok) {
                    if (userSubscriptions.has(key)) {
                        userSubscriptions.delete(key);
                    } else {
                        userSubscriptions.add(key);
                    }
                    updateStats();
                    renderItems(allItems);
                } else {
                    const data = await res.json().catch(() => ({}));
                    alert(data.detail || 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (e) {
                console.error('Subscription error:', e);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
