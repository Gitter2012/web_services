<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>事件聚类 - ResearchPulse</title>
    <script>
        (function() {
            var path = window.location.pathname;
            var rpIndex = path.indexOf('/researchpulse');
            var prefix = rpIndex > 0 ? path.substring(0, rpIndex) : '';
            window.APP_BASE = prefix + '/researchpulse';
            window.API_BASE = prefix + '/researchpulse/api';
            window.AUTH_BASE = prefix + '/api/v1';
        })();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }

        .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-inner { max-width: 1200px; margin: 0 auto; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo h1 { font-size: 22px; font-weight: 600; }
        .logo h1 a { color: white; text-decoration: none; }
        .logo .badge { background: #e94560; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .nav { display: flex; gap: 20px; }
        .nav a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; transition: color 0.2s; }
        .nav a:hover { color: white; }
        .nav a.active { color: #4ecdc4; }
        .auth-area { display: flex; align-items: center; gap: 16px; }
        .auth-area a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; }

        .main { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .page-header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .page-header h2 { font-size: 24px; color: #1a1a2e; }
        .page-header .filter-bar { display: flex; gap: 12px; align-items: center; }
        .filter-bar select, .filter-bar button { padding: 8px 14px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; }
        .filter-bar button { background: #1a1a2e; color: white; border: none; }
        .filter-bar button:hover { background: #2d2d4a; }

        .event-list { display: flex; flex-direction: column; gap: 16px; }
        .event-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: box-shadow 0.2s; }
        .event-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .event-title { font-size: 18px; font-weight: 600; color: #1a1a2e; margin-bottom: 8px; }
        .event-meta { display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px; color: #666; margin-bottom: 12px; }
        .event-meta span { display: flex; align-items: center; gap: 4px; }
        .event-desc { color: #555; font-size: 14px; line-height: 1.6; margin-bottom: 12px; }
        .event-members { border-top: 1px solid #f0f0f0; padding-top: 12px; }
        .event-members h4 { font-size: 13px; color: #888; margin-bottom: 8px; cursor: pointer; }
        .member-list { display: none; }
        .member-list.open { display: block; }
        .member-item { padding: 8px 0; border-bottom: 1px solid #f8f8f8; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .member-item:last-child { border-bottom: none; }
        .member-item a { color: #1a1a2e; text-decoration: none; }
        .member-item a:hover { color: #4ecdc4; }
        .member-score { font-size: 11px; color: #888; background: #f5f5f5; padding: 2px 8px; border-radius: 10px; }
        .member-method { font-size: 10px; color: #764ba2; background: #ede9fe; padding: 2px 6px; border-radius: 3px; }

        .badge-active { background: #dcfce7; color: #059669; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .badge-inactive { background: #fee2e2; color: #dc2626; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .badge-category { background: #ede9fe; color: #7c3aed; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500; }

        .empty-state { text-align: center; padding: 60px 20px; color: #888; }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }

        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 24px; }
        .page-btn { padding: 8px 14px; border: 1px solid #e0e0e0; background: white; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .page-btn.active { background: #1a1a2e; color: white; border-color: #1a1a2e; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 768px) {
            .header-inner { padding: 12px 16px; }
            .nav { display: none; }
            .main { padding: 16px; }
            .page-header { flex-direction: column; gap: 12px; align-items: flex-start; }
            .event-card { padding: 16px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-inner">
            <div class="logo">
                <h1><a href="" id="home-link">ResearchPulse</a></h1>
                <span class="badge">v2</span>
            </div>
            <div class="nav" id="nav-menu">
                <a href="" id="nav-home">首页</a>
                <a href="" id="nav-subscriptions">订阅管理</a>
                <a href="" class="active" id="nav-events">事件聚类</a>
                <a href="" id="nav-topics">话题趋势</a>
                <a href="" id="nav-actions">行动建议</a>
                <a href="" id="nav-reports">报告中心</a>
            </div>
            <div class="auth-area" id="auth-area"></div>
        </div>
    </div>

    <div class="main">
        <div class="page-header">
            <h2>事件聚类</h2>
            <div class="filter-bar">
                <select id="filter-active" onchange="loadEvents()">
                    <option value="true">仅活跃事件</option>
                    <option value="false">全部事件</option>
                </select>
            </div>
        </div>
        <div class="event-list" id="event-list">
            <div class="empty-state">
                <div class="icon">&#9203;</div>
                <div class="text">加载中...</div>
            </div>
        </div>
        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        // Navigation
        document.getElementById('home-link').href = APP_BASE + '/';
        document.getElementById('nav-home').href = APP_BASE + '/';
        document.getElementById('nav-subscriptions').href = APP_BASE + '/subscriptions';
        document.getElementById('nav-events').href = APP_BASE + '/events';
        document.getElementById('nav-topics').href = APP_BASE + '/topics';
        document.getElementById('nav-actions').href = APP_BASE + '/actions';
        document.getElementById('nav-reports').href = APP_BASE + '/reports';

        let currentPage = 1;
        const pageSize = 20;
        let totalEvents = 0;

        async function checkAuth() {
            const token = localStorage.getItem('access_token');
            const area = document.getElementById('auth-area');
            if (token) {
                try {
                    const res = await fetch(`${AUTH_BASE}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` }});
                    if (res.ok) {
                        const user = await res.json();
                        area.innerHTML = `<span style="color:#4ecdc4;font-size:14px;">&#128100; ${user.username}</span><a href="#" onclick="logout()">退出</a>`;
                        // 超级管理员显示管理后台入口
                        if (user.is_superuser) {
                            const navMenu = document.getElementById('nav-menu');
                            const adminLink = document.createElement('a');
                            adminLink.href = APP_BASE + '/admin';
                            adminLink.textContent = '管理后台';
                            navMenu.appendChild(adminLink);
                        }
                        return;
                    }
                } catch(e) {}
            }
            area.innerHTML = `<a href="${APP_BASE}/">登录</a>`;
        }

        function logout() { localStorage.removeItem('access_token'); location.reload(); }

        async function loadEvents() {
            const activeOnly = document.getElementById('filter-active').value;
            const offset = (currentPage - 1) * pageSize;
            const token = localStorage.getItem('access_token');
            const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

            try {
                const res = await fetch(`${API_BASE}/events?active_only=${activeOnly}&limit=${pageSize}&offset=${offset}`, { headers });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    let errMsg = err.detail || '加载失败，请确认已登录且功能已启用';
                    // 友好处理功能未启用的 503 错误
                    if (res.status === 503 && err.detail && err.detail.includes('not enabled')) {
                        errMsg = '事件聚类功能尚未启用，请联系管理员在管理后台开启此功能。';
                    }
                    document.getElementById('event-list').innerHTML = `<div class="empty-state"><div class="icon">&#128274;</div><div class="text">${errMsg}</div></div>`;
                    return;
                }
                const data = await res.json();
                totalEvents = data.total;
                renderEvents(data.events);
                renderPagination();
            } catch(e) {
                document.getElementById('event-list').innerHTML = `<div class="empty-state"><div class="icon">&#10060;</div><div class="text">网络错误</div></div>`;
            }
        }

        function renderEvents(events) {
            const container = document.getElementById('event-list');
            if (!events || events.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">&#128218;</div><div class="text">暂无事件聚类数据</div></div>';
                return;
            }
            container.innerHTML = events.map((ev, idx) => {
                const statusBadge = ev.is_active ? '<span class="badge-active">活跃</span>' : '<span class="badge-inactive">已结束</span>';
                const categoryBadge = ev.category ? `<span class="badge-category">${escapeHtml(ev.category)}</span>` : '';
                const firstSeen = ev.first_seen_at ? formatDate(ev.first_seen_at) : '未知';
                const lastUpdated = ev.last_updated_at ? formatDate(ev.last_updated_at) : '未知';
                return `
                    <div class="event-card">
                        <div class="event-title">${escapeHtml(ev.title)}</div>
                        <div class="event-meta">
                            ${statusBadge} ${categoryBadge}
                            <span>&#128196; ${ev.article_count || 0} 篇文章</span>
                            <span>&#128197; 首次: ${firstSeen}</span>
                            <span>&#128260; 更新: ${lastUpdated}</span>
                        </div>
                        ${ev.description ? `<div class="event-desc">${escapeHtml(ev.description)}</div>` : ''}
                        <div class="event-members">
                            <h4 onclick="toggleMembers(${idx})">&#9654; 查看关联文章</h4>
                            <div class="member-list" id="members-${idx}">
                                <div style="color:#999;font-size:12px;padding:8px 0;">点击加载详情...</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Store events for detail loading
            window._events = events;
        }

        async function toggleMembers(idx) {
            const el = document.getElementById(`members-${idx}`);
            if (el.classList.contains('open')) {
                el.classList.remove('open');
                return;
            }
            el.classList.add('open');
            const ev = window._events[idx];
            if (!ev || !ev.id) return;

            const token = localStorage.getItem('access_token');
            const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
            try {
                const res = await fetch(`${API_BASE}/events/${ev.id}`, { headers });
                if (!res.ok) { el.innerHTML = '<div style="color:#dc2626;padding:8px 0;font-size:12px;">加载失败</div>'; return; }
                const detail = await res.json();
                if (!detail.members || detail.members.length === 0) {
                    el.innerHTML = '<div style="color:#999;padding:8px 0;font-size:12px;">暂无关联文章</div>';
                    return;
                }
                el.innerHTML = detail.members.map(m => `
                    <div class="member-item">
                        <a href="${APP_BASE}/" title="文章 #${m.article_id}">文章 #${m.article_id}</a>
                        <div>
                            <span class="member-method">${escapeHtml(m.detection_method || '')}</span>
                            <span class="member-score">相似度: ${(m.similarity_score || 0).toFixed(2)}</span>
                        </div>
                    </div>
                `).join('');
            } catch(e) {
                el.innerHTML = '<div style="color:#dc2626;padding:8px 0;font-size:12px;">网络错误</div>';
            }
        }

        function renderPagination() {
            const totalPages = Math.ceil(totalEvents / pageSize);
            const container = document.getElementById('pagination');
            if (totalPages <= 1) { container.innerHTML = `<span style="color:#888;font-size:14px;">共 ${totalEvents} 个事件</span>`; return; }
            let html = `<button class="page-btn" onclick="goToPage(${currentPage-1})" ${currentPage===1?'disabled':''}>上一页</button>`;
            const start = Math.max(1, currentPage - 2), end = Math.min(totalPages, currentPage + 2);
            for (let i = start; i <= end; i++) { html += `<button class="page-btn ${i===currentPage?'active':''}" onclick="goToPage(${i})">${i}</button>`; }
            html += `<button class="page-btn" onclick="goToPage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>下一页</button>`;
            container.innerHTML = html;
        }

        function goToPage(p) { currentPage = p; loadEvents(); window.scrollTo({top:0,behavior:'smooth'}); }

        function escapeHtml(str) { if (!str) return ''; const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
        function formatDate(iso) { if (!iso) return ''; try { const d = new Date(iso); return d.toLocaleDateString('zh-CN', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); } catch(e) { return iso; } }

        checkAuth();
        loadEvents();
    </script>
</body>
</html>
